<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MealCal 2.0</title>
    <style>
        /* CSS Variables for Theme */
        :root {
            --primary-color: #4F46E5;
            --primary-dark: #4338CA;
            --secondary-color: #10B981;
            --danger-color: #EF4444;
            --warning-color: #F59E0B;
            --bg-color: #F9FAFB;
            --card-bg: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --success-color: #10B981;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
             --header-height: 60px;
        }

        [data-theme="dark"] {
            --bg-color: #111827;
            --card-bg: #1F2937;
            --text-primary: #F9FAFB;
            --text-secondary: #9CA3AF;
            --border-color: #374151;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Fixed Header */
.app-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: var(--header-height);
    background-color: var(--card-bg);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    z-index: 1000;
    box-shadow: var(--shadow);
}

.header-left, .header-right {
    display: flex;
    align-items: center;
    gap: 15px;
}

.app-logo {
    font-weight: 800;
    font-size: 20px;
    color: var(--primary-color);
}

.cycle-badge {
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.user-info {
    text-align: right;
    line-height: 1.2;
}

.user-name {
    font-weight: 600;
    font-size: 14px;
}

.user-role {
    font-size: 10px;
    color: var(--text-secondary);
    text-transform: uppercase;
}

.header-clock {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-variant-numeric: tabular-nums;
}

.clock-time {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
}

.clock-date {
    font-size: 11px;
    color: var(--text-secondary);
}

/* Notification Bell */
.notif-btn {
    position: relative;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 5px;
}

.notif-badge {
    position: absolute;
    top: 0;
    right: 0;
    background-color: var(--danger-color);
    color: white;
    font-size: 10px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--card-bg);
}

/* Notification Panel (Slide-in) */
.notif-panel {
    position: fixed;
    top: var(--header-height);
    right: -400px; /* Hidden by default */
    width: 350px;
    height: calc(100vh - var(--header-height));
    background-color: var(--card-bg);
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    z-index: 999;
    transition: right 0.3s ease;
    display: flex;
    flex-direction: column;
}

.notif-panel.active {
    right: 0;
}

.notif-header {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.notif-filters {
    padding: 10px;
    display: flex;
    gap: 8px;
    overflow-x: auto;
    border-bottom: 1px solid var(--border-color);
    -ms-overflow-style: none;
    scrollbar-width: none;
}

.filter-chip {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    border: 1px solid var(--border-color);
    background: var(--bg-color);
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
}

.filter-chip.active {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.notif-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.notif-item {
    padding: 12px;
    border-radius: 8px;
    background-color: var(--bg-color);
    margin-bottom: 8px;
    cursor: pointer;
    border-left: 4px solid var(--border-color);
    transition: transform 0.2s;
}

.notif-item:hover {
    transform: translateX(4px);
    background-color: white; /* slightly lighter in dark mode logic needed */
}

/* Notification Type Colors */
.notif-item.type-deposit { border-left-color: var(--success-color); }
.notif-item.type-expense { border-left-color: var(--danger-color); }
.notif-item.type-meal { border-left-color: var(--warning-color); }
.notif-item.type-other { border-left-color: var(--primary-color); }

.notif-content {
    font-size: 13px;
    margin-bottom: 4px;
}

.notif-meta {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    color: var(--text-secondary);
}

/* Mobile Adjustments */
@media (max-width: 768px) {
    .header-clock { display: none; } /* Hide clock on small screens */
    .notif-panel { width: 100%; right: -100%; }
    .sidebar { z-index: 1001; } /* Sidebar above header on mobile */
}




        /* Sidebar */
        .sidebar {
            width: 260px;
            background-color: var(--card-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            position: fixed;
            top: var(--header-height);
            height: calc(100vh - var(--header-height));
            z-index: 900;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar.mobile-hidden {
            transform: translateX(-100%);
        }

        .cycle-selector {
            margin: 20px 0;
        }

        .cycle-selector select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text-primary);
            font-size: 14px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }

        .nav-icon {
            margin-right: 12px;
            font-size: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 20px;
            padding-bottom: 80px;
             margin-top: var(--header-height);
        }


        /* Split Layout for Deposits */
.split-view-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.history-box {
    max-height: 400px;
    overflow-y: auto;
    background: var(--bg-color);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    padding: 10px;
}

.history-empty {
    text-align: center;
    color: var(--text-secondary);
    font-size: 13px;
    padding: 20px;
}

/* Responsive: Stack on mobile */
@media (max-width: 768px) {
    .split-view-container {
        grid-template-columns: 1fr;
    }
}

        /* Mobile Bottom Nav */
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 10px 0;
            z-index: 1000;
        }

        .bottom-nav-list {
            display: flex;
            justify-content: space-around;
            list-style: none;
        }

        .bottom-nav-item {
            text-align: center;
            flex: 1;
        }

        .bottom-nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 12px;
            padding: 8px;
        }

        .bottom-nav-link.active {
            color: var(--primary-color);
        }

        /* Cards */
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Grid Layout */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-secondary {
            background-color: var(--text-secondary);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }

        .toggle-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--card-bg);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 600;
        }

        .toggle-btn.active {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .toggle-btn.inactive {
            background-color: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
        }

        .balance-positive {
            color: var(--success-color);
            font-weight: 600;
        }

        .balance-negative {
            color: var(--danger-color);
            font-weight: 600;
        }


        /* Defaults Panel (Inside Profile) */
.defaults-container {
    background-color: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.defaults-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
}

.defaults-toggles {
    display: flex;
    gap: 8px;
}

.def-btn {
    padding: 4px 10px;
    font-size: 11px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    cursor: pointer;
    background: var(--card-bg);
    transition: all 0.2s;
}

.def-btn.active {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}



        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-modal {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        /* List Items */
        .list-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item-info {
            flex: 1;
        }

        .list-item-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .list-item-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .list-item-amount {
            font-size: 18px;
            font-weight: 700;
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 20px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            position: relative;
        }

        .calendar-day:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .calendar-day.has-meal {
            background-color: var(--success-color);
            color: white;
        }

        .calendar-day-number {
            font-weight: 600;
        }

        .calendar-day-meals {
            font-size: 10px;
            margin-top: 4px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Auth Page */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
            max-width: 400px;
            width: 100%;
        }

        .auth-title {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .bottom-nav {
                display: block;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .calendar-grid {
                grid-template-columns: repeat(7, 1fr);
                gap: 4px;
            }

            .calendar-day {
                font-size: 12px;
            }

            .table {
                font-size: 12px;
            }

            .table th, .table td {
                padding: 8px;
            }
        }
        

        /* --- NEW STYLES FOR UPGRADE --- */

/* 1. Scheduler (Profile Page) */
.scheduler-container {
    margin-top: 20px;
}

.scheduler-scroll {
    display: flex;
    overflow-x: auto;
    gap: 12px;
    padding: 10px 5px;
    scrollbar-width: thin; /* Firefox */
}

.scheduler-card {
    min-width: 110px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
}

.scheduler-card.is-today {
    border: 2px solid var(--primary-color);
    background-color: rgba(79, 70, 229, 0.05);
}

.scheduler-date {
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 4px;
    text-align: center;
}

/* Scheduler Buttons */
.sched-btn {
    width: 100%;
    padding: 6px;
    border-radius: 6px;
    border: 1px solid var(--border-color);
    background: var(--bg-color);
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    justify-content: space-between;
      margin-bottom: 4px; /* Add spacing between the two buttons */
    align-items: center;
}

.sched-btn.active {
    background-color: var(--success-color);
    color: white;
    border-color: var(--success-color);
}

.sched-btn.locked {
    opacity: 0.5;
    cursor: not-allowed;
    background-color: #e5e7eb; /* Grey out */
    color: #9ca3af;
}

/* 2. Master Tracker Matrix */
.matrix-wrapper {
    overflow: auto;
    max-height: 75vh;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    position: relative;
}

.matrix-table {
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
    font-size: 12px;
}

.matrix-table th, .matrix-table td {
    padding: 8px;
    border-bottom: 1px solid var(--border-color);
    border-right: 1px solid var(--border-color);
    text-align: center;
    min-width: 60px;
}

/* Sticky Header (Member Names) */
.matrix-table thead th {
    position: sticky;
    top: 0;
    background-color: var(--card-bg);
    z-index: 10;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* Sticky First Column (Dates) */
.matrix-table tbody td:first-child {
    position: sticky;
    left: 0;
    background-color: var(--bg-color);
    font-weight: 600;
    z-index: 5;
    border-right: 2px solid var(--border-color);
}

/* Top-Left Corner Fix */
.matrix-table thead th:first-child {
    left: 0;
    z-index: 20;
    background-color: var(--card-bg);
}


.dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background-color: #E5E7EB; /* Inactive Grey */
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
}

.dot.on {
    background-color: var(--success-color);
    color: white;
}




/* --- UPDATED CSS FOR NUMBER TRACKER --- */

/* The container for the split view */
.cell-split {
    display: flex;
     flex-direction: row; /* Standard row */
    align-items: stretch;
    justify-content: center;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    overflow: hidden;
    font-size: 11px;
    font-weight: 700;
    height: 100%;
    min-height: 28px;
    background-color: var(--bg-color);
}

/* Individual Number Box */
.cell-val {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 22px;
    transition: all 0.2s;
}

/* Day Side (Left) */
.cell-val.day-col {
    border-right: 1px solid var(--border-color);
}

/* Active State (Has Meal) */
.cell-val.active {
    background-color: rgba(16, 185, 129, 0.15); /* Light Green BG */
    color: var(--success-color); /* Green Text */
}

/* Specific colors for specific times */
.cell-val.night-col {
    border-right: 1px solid var(--border-color);
    background-color: rgba(79, 70, 229, 0.05); /* Slight Blue tint for Night */
}
.cell-val.day-col {
    background-color: rgba(245, 158, 11, 0.05); /* Slight Orange tint for Day */
}

/* Active Colors */
.cell-val.night-col.active { background-color: rgba(79, 70, 229, 0.2); color: var(--primary-color); font-weight: 800; }
.cell-val.day-col.active { background-color: rgba(245, 158, 11, 0.2); color: #d97706; font-weight: 800; }



.cell-val.zero {
    color: var(--text-secondary);
    opacity: 0.4;
    font-weight: 400;
}

/* Hover Effect for Clickable Cells */
td[onclick]:hover .cell-split {
    border-color: var(--primary-color);
    cursor: pointer;
}


/* Status Badge in Header */
.entry-status-badge {
    font-size: 10px;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 10px;
    margin-top: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s;
}

/* Pending State (Before Auto-Entry) */
.status-pending {
    background-color: #FFF7ED; /* Light Orange */
    color: #C2410C; /* Dark Orange */
    border: 1px solid #FED7AA;
}

/* Done State (After Auto-Entry) */
.status-done {
    background-color: #ECFDF5; /* Light Green */
    color: #047857; /* Dark Green */
    border: 1px solid #6EE7B7;
}


/* System Status Visualization */
.status-box {
    padding: 15px;
    border-radius: 8px;
    display: flex;
    align-items: flex-start;
    gap: 15px;
}

.status-box.pending {
    background-color: #FFF7ED;
    border: 1px solid #FED7AA;
    color: #9A3412;
}

.status-box.success {
    background-color: #ECFDF5;
    border: 1px solid #6EE7B7;
    color: #065F46;
}

.status-icon {
    font-size: 24px;
}

.status-title {
    font-weight: 700;
    font-size: 15px;
    margin-bottom: 4px;
}

.status-desc {
    font-size: 13px;
    opacity: 0.9;
}

.status-meta {
    font-size: 11px;
    margin-top: 8px;
    font-family: monospace;
    background: rgba(0,0,0,0.05);
    padding: 4px 8px;
    border-radius: 4px;
    display: inline-block;
}



/* Status Toggle Buttons */
.status-btn {
    padding: 6px 12px;
    border-radius: 20px;
    border: 1px solid var(--border-color);
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.2s;
    width: 80px;
    text-align: center;
}

/* ON State */
.status-btn.on {
    background-color: var(--success-color);
    color: white;
    border-color: var(--success-color);
    box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
}

/* OFF State */
.status-btn.off {
    background-color: var(--bg-color);
    color: var(--text-secondary);
    border-color: var(--border-color);
}

.status-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Hover effects for admins */
.status-btn:not(:disabled):hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
/* Mobile Visibility (Optional: If you want it visible on mobile, remove this) */
/* Currently keeping it inside .header-clock which is hidden on mobile in your code */
    </style>
</head>
<body>
   <!-- Auth Page (Updated for Supabase Auth) -->
<div id="authPage" class="auth-container">
    <div class="auth-card">
        <h1 class="auth-title">MealCal 2.0</h1>
        
        <!-- Login Mode -->
       <form id="authForm">
    <div id="authError" style="color: red; font-size: 12px; margin-bottom: 10px; text-align: center; display: none;"></div>
    
    <!-- Username Field (Hidden by default, shown for Sign Up) -->
    <div class="form-group hidden" id="usernameField">
        <label class="form-label">Username (Unique)</label>
        <input type="text" id="authUsername" class="form-input" placeholder="e.g. mess_hero_01">
    </div>

    <div class="form-group">
        <label class="form-label" id="emailLabel">Email or Username</label>
        <input type="text" id="authEmail" class="form-input" placeholder="Enter email or username" required>
    </div>
    
    <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" id="authPassword" class="form-input" placeholder="Enter password" required>
    </div>

    <button type="submit" class="btn btn-primary" style="width: 100%;" id="authBtn">Login</button>
    
    <div style="margin-top: 15px; text-align: center; font-size: 13px;">
        <span id="authToggleText">Don't have an account?</span>
        <a href="#" id="authToggleBtn" style="color: var(--primary-color); font-weight: 600;">Sign Up</a>
    </div>
</form>
    </div>
</div>
    <!-- Main App -->
    <div id="mainApp" class="app-container hidden">

           <!-- FIXED HEADER -->
    <header class="app-header">
        <div class="header-left">
            <div class="app-logo">MealCal 2.0</div>
            <div class="cycle-badge" id="headerCycleName">Loading...</div>
        </div>

   <div class="header-clock">
            <div class="clock-time" id="clockTime">00:00:00</div>
            <div class="clock-date" id="clockDate">Mon, 01 Jan</div>
            <!-- NEW INDICATOR -->
            <div id="entryStatusBadge" class="entry-status-badge status-pending">Loading...</div>
        </div>

        <div class="header-right">
            <div class="user-info">
                <div class="user-name" id="headerUserName">User</div>
                <div class="user-role" id="headerUserRole">Role</div>
            </div>
            <button class="notif-btn" id="notifBellBtn">
                üîî
                <span class="notif-badge hidden" id="notifBadge">0</span>
            </button>
        </div>
    </header>

    <!-- NOTIFICATION PANEL -->
    <div class="notif-panel" id="notifPanel">
        <div class="notif-header">
            <h3>Notifications</h3>
            <button class="close-modal" id="closeNotifPanel">√ó</button>
        </div>
        <div class="notif-filters">
            <button class="filter-chip active" data-filter="all">All</button>
            <button class="filter-chip" data-filter="deposit">Deposits üí∞</button>
            <button class="filter-chip" data-filter="expense">Expenses üõí</button>
            <button class="filter-chip" data-filter="meal">Meals üçΩÔ∏è</button>
            <button class="filter-chip" data-filter="other">System ‚öôÔ∏è</button>
        </div>
        <div class="notif-list" id="notifListContainer">
            <div class="loading">Loading...</div>
        </div>
    </div>


        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">

            <div class="cycle-selector">
                <select id="cycleSelect" class="form-select">
                    <option value="">Loading cycles...</option>
                </select>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-page="dashboard">
                        <span class="nav-icon">üìä</span>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="profile">
                        <span class="nav-icon">üë§</span>
                        Profile
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="tracker">
                        <span class="nav-icon">üìÖ</span>
                        Meal Tracker
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="summary">
                        <span class="nav-icon">üìà</span>
                        Summary
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="expenses">
                        <span class="nav-icon">üõí</span>
                        Expenses
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="deposits">
                        <span class="nav-icon">üí∞</span>
                        Deposits
                    </a>
                </li>
                <li class="nav-item" id="adminMenuItem" style="display: none;">
                    <a class="nav-link" data-page="admin">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        Admin Panel
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="logoutBtn">
                        <span class="nav-icon">üö™</span>
                        Logout
                    </a>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page-content">
                <h2 style="margin-bottom: 20px;">Dashboard</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Meal Rate</div>
                        <div class="stat-value" id="statMealRate">‡ß≥0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #10B981, #059669);">
                        <div class="stat-label">Total Meals</div>
                        <div class="stat-value" id="statTotalMeals">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #F59E0B, #D97706);">
                        <div class="stat-label">Total Deposit</div>
                        <div class="stat-value" id="statTotalDeposit">‡ß≥0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #EF4444, #DC2626);">
                        <div class="stat-label">Total Expense</div>
                        <div class="stat-value" id="statTotalExpense">‡ß≥0</div>
                    </div>
                </div>

                <!-- NEW: System Status Card -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Daily Automation Status</h3>
        <div id="statusDateDisplay" style="font-size:12px; color:var(--text-secondary);"></div>
    </div>
    <div id="systemStatusContent">
        <div class="loading">Checking system logs...</div>
    </div>
</div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Activity</h3>
                    </div>
                    <div id="recentActivity">
                        <div class="loading">Loading activity...</div>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profilePage" class="page-content hidden">
                <h2 style="margin-bottom: 20px;">My Profile</h2>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title" id="profileName">Loading...</h3>
                    </div>


                    
                    <div class="stats-grid">
                        <div class="stat-card" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED);">
                            <div class="stat-label">My Total Meals</div>
                            <div class="stat-value" id="profileTotalMeals">0</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #10B981, #059669);">
                            <div class="stat-label">My Deposits</div>
                            <div class="stat-value" id="profileTotalDeposit">‡ß≥0</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #F59E0B, #D97706);">
                            <div class="stat-label">My Balance</div>
                            <div class="stat-value" id="profileBalance">‡ß≥0</div>
                        </div>
                    </div>

                    <h4 style="margin: 20px 0 10px;">Today's Meal Status</h4>

                    
                   <!-- Inside Profile Page -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">My Meal Schedule</h3>
        <div style="font-size: 11px; color: var(--text-secondary);" id="lockTimeDisplay">
            Lock Time: Loading...
        </div>
    </div>
    

      <!-- NEW: Default/Permanent Settings -->
    <div class="defaults-container">
        <div class="defaults-label">
            Set Default State
            <div style="font-weight:400; font-size:10px; margin-top:2px;">
                New schedule cards will auto-set to this.
            </div>
        </div>
        <div class="defaults-toggles">
            <button id="defDayBtn" class="def-btn" onclick="toggleDefaultPreference('day')">Day Default</button>
            <button id="defNightBtn" class="def-btn" onclick="toggleDefaultPreference('night')">Night Default</button>
        </div>
    </div>


    <!-- 7 Day Scrolling Container -->
    <div class="scheduler-container">
        <div class="scheduler-scroll" id="schedulerList">
            <div class="loading">Loading schedule...</div>
        </div>
    </div>
    
    <div style="margin-top: 15px; font-size: 11px; color: var(--warning-color); text-align: center;">
        ‚ö†Ô∏è Note: Meals are locked daily after bazar time.
    </div>
</div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">My Deposit History</h3>
                    </div>
                    <div id="profileDepositHistory">
                        <div class="loading">Loading deposits...</div>
                    </div>
                </div>
            </div>

<!-- Tracker Page -->
<div id="trackerPage" class="page-content hidden">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>Master Meal Tracker</h2>
        <button class="btn btn-primary btn-sm" onclick="loadMasterTracker()">üîÑ Refresh</button>
    </div>

    <div class="card">
        <div class="matrix-wrapper">
            <table class="matrix-table" id="masterMatrixTable">
                <thead>
                    <!-- Headers injected by JS -->
                </thead>
                <tbody>
                    <!-- Rows injected by JS -->
                </tbody>
            </table>
        </div>
<div style="margin-top: 10px; font-size: 11px; color: var(--text-secondary); text-align: center;">
    Format: <strong>[ Night üåô | Next Day üåû ]</strong> <br>
    Row Date indicates the Night meal.
</div>
    </div>
</div>

            <!-- Summary Page -->
            <div id="summaryPage" class="page-content hidden">
                <h2 style="margin-bottom: 20px;">Summary Report</h2>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Member Summary</h3>
                        <button class="btn btn-primary btn-sm" id="exportSummaryBtn">Export</button>
                    </div>
                    <div class="table-container">
                        <table class="table" id="summaryTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Day Meals</th>
                                    <th>Night Meals</th>
                                    <th>Total Meals</th>
                                    <th>Total Cost</th>
                                    <th>Deposits</th>
                                    <th>Balance</th>
                                </tr>
                            </thead>
                            <tbody id="summaryTableBody">
                                <tr><td colspan="7" class="loading">Loading summary...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Expenses Page -->
            <div id="expensesPage" class="page-content hidden">
                <h2 style="margin-bottom: 20px;">Expenses</h2>
                
                <div class="card" id="addExpenseCard">
                    <div class="card-header">
                        <h3 class="card-title">Add Expense</h3>
                    </div>
                    <form id="expenseForm">
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" id="expenseDate" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Shopper</label>
                            <select id="expenseMember" class="form-select" required>
                                <option value="">Select shopper...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea id="expenseDescription" class="form-textarea" placeholder="e.g., Chicken, Rice, Oil"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount (‡ß≥)</label>
                            <input type="number" id="expenseAmount" class="form-input" step="0.01" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Expense</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Expense List</h3>
                    </div>
                    <div id="expenseList">
                        <div class="loading">Loading expenses...</div>
                    </div>
                </div>
            </div>
<!-- Deposits Page -->
<div id="depositsPage" class="page-content hidden">
    <h2 style="margin-bottom: 20px;">Deposits & Charges</h2>
    
    <!-- Split View: Form + Specific History -->
    <div class="split-view-container" id="depositSplitView">
        
        <!-- LEFT: Transaction Form -->
        <div class="card" id="addDepositCard" style="height: fit-content;">
            <div class="card-header">
                <h3 class="card-title">New Transaction</h3>
            </div>
            <form id="depositForm">
                <div class="form-group">
                    <label class="form-label">Member</label>
                    <!-- Added onchange event here -->
                    <select id="depositMember" class="form-select" onchange="loadSelectedMemberHistory(this.value)" required>
                        <option value="">Select member...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Transaction Type</label>
                    <!-- Added onchange event here -->
                    <select id="depositType" class="form-select" onchange="autoUpdateDepositLabel()">
                        <option value="deposit">üí∞ Add Deposit (Credit)</option>
                        <option value="charge">üîª Deduct Charge (Debit)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Label (Editable)</label>
                    <input type="text" id="depositLabel" class="form-input" value="Deposit" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Amount (‡ß≥)</label>
                    <input type="number" id="depositAmount" class="form-input" step="0.01" min="0" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes (Optional)</label>
                    <textarea id="depositNotes" class="form-textarea" style="min-height: 60px;"></textarea>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Submit Transaction</button>
            </form>
        </div>

        <!-- RIGHT: Selected Member History -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Member History</h3>
                <span id="historyMemberName" style="font-size: 12px; color: var(--primary-color);">No member selected</span>
            </div>
            <div id="selectedMemberHistoryList" class="history-box">
                <div class="history-empty">Select a member to view their specific log.</div>
            </div>
        </div>
    </div>

<!-- BOTTOM: Global Log with Filter -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Global Transaction Log</h3>
        
        <!-- NEW: Filter Dropdown -->
        <select id="depositLogFilter" class="form-select" style="width: 150px; font-size: 12px; padding: 6px;" onchange="loadDeposits()">
            <option value="">All Members</option>
            <!-- Options will be populated by JS -->
        </select>
    </div>
    <div id="depositList">
        <div class="loading">Loading deposits...</div>
    </div>
</div>
</div>

            <!-- Admin Page -->
            <div id="adminPage" class="page-content hidden">
                <h2 style="margin-bottom: 20px;">Admin Panel</h2>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Cycle Management</h3>
                    </div>
                    <form id="createCycleForm">
                        <div class="form-group">
                            <label class="form-label">Cycle Name</label>
                            <input type="text" id="cycleName" class="form-input" placeholder="e.g., April 2025" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" id="cycleStartDate" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" id="cycleEndDate" class="form-input" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Create Cycle</button>
                        <button type="button" class="btn btn-danger" id="closeMonthBtn">Close Current Month</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Member Management</h3>
                        <div style="font-size:12px; color:var(--text-secondary);">Adding a member automatically creates a user with password "123"</div>
                    </div>
                    <form id="addMemberForm">
                        <div class="form-group">
                            <label class="form-label">Member Name</label>
                            <input type="text" id="memberName" class="form-input" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Member</button>
                    </form>
                    <div id="membersList" style="margin-top: 20px;">
                        <div class="loading">Loading members...</div>
                    </div>
                </div>


                <!-- Inside Admin Page, add this card -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">System Settings</h3>
    </div>
  <form id="adminSettingsForm">
        <div class="form-group">
            <label class="form-label">Restricted Bazar Range (Lock Time)</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div style="flex:1">
                    <label style="font-size: 11px;">Start Time</label>
                    <input type="time" id="settingLockTime" class="form-input" required>
                </div>
                <div style="font-weight:bold;">-</div>
                <div style="flex:1">
                    <label style="font-size: 11px;">End Time</label>
                    <input type="time" id="settingLockTimeEnd" class="form-input" required>
                </div>
            </div>
            <small style="color: var(--text-secondary); display:block; margin-top:5px;">
                Users cannot change meal status between these times on the day of the bazar.
            </small>
        </div>
        <button type="submit" class="btn btn-primary">Save Settings</button>
    </form>

    <!-- Inside adminSettingsForm -->
       <!-- Inside adminSettingsForm -->
<div class="form-group" style="margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 15px;">
    <label class="form-label">Auto-Entry / Finalize Time</label>
    <div style="display:flex; gap:10px; align-items:flex-end;">
        <input type="time" id="settingAutoTime" class="form-input" style="flex:1;" required>
        
        <!-- NEW BUTTON -->
        <button type="button" class="btn btn-danger" onclick="triggerManualAutoEntry()" style="font-size:12px; white-space:nowrap;">
            ‚ö° Force Run Now
        </button>
    </div>
    <small style="color: var(--primary-color);">
        System will snapshot meals at this time. Use "Force Run" to apply plans to tracker immediately.
    </small>
</div>

</div>

            </div>
        </main>

        <!-- Bottom Navigation (Mobile) -->
        <nav class="bottom-nav">
            <ul class="bottom-nav-list">
                <li class="bottom-nav-item">
                    <a class="bottom-nav-link active" data-page="dashboard">
                        <span style="font-size: 24px;">üìä</span>
                        <span>Home</span>
                    </a>
                </li>
                <li class="bottom-nav-item">
                    <a class="bottom-nav-link" data-page="tracker">
                        <span style="font-size: 24px;">üìÖ</span>
                        <span>Tracker</span>
                    </a>
                </li>
                <li class="bottom-nav-item">
                    <a class="bottom-nav-link" data-page="deposits">
                        <span style="font-size: 24px;">üí∞</span>
                        <span>Wallet</span>
                 </a>
                </li>
                <li class="bottom-nav-item">
                    <a class="bottom-nav-link" data-page="profile">
                        <span style="font-size: 24px;">üë§</span>
                        <span>Profile</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Modals -->
<!-- Edit Meal Modal (Session Edition) -->
<div id="mealModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="mealModalTitle">Edit Session</h3>
            <span class="close-modal" onclick="closeMealModal()">√ó</span>
        </div>
        <form id="mealForm">
            <!-- Hidden Fields store the TWO dates we are editing -->
            <input type="hidden" id="mealMemberId">
            <input type="hidden" id="mealDateSession"> <!-- For Night -->
            <input type="hidden" id="mealDateNext">    <!-- For Day -->

<div class="form-group">
                <label class="form-label" id="mealNightLabel">Night Meal</label>
                <!-- Added min="0", step="1" and oninput logic -->
                <input type="number" id="mealNightCount" class="form-input" step="1" min="0" 
                       oninput="this.value = !!this.value && Math.abs(this.value) >= 0 ? Math.abs(Math.round(this.value)) : null">
            </div>

            <div class="form-group">
                <label class="form-label" id="mealDayLabel">Day Meal</label>
                <!-- Added min="0", step="1" and oninput logic -->
                <input type="number" id="mealDayCount" class="form-input" step="1" min="0" 
                       oninput="this.value = !!this.value && Math.abs(this.value) >= 0 ? Math.abs(Math.round(this.value)) : null">
            </div>
            
            <div style="font-size:11px; color:var(--text-secondary); margin-bottom:15px; background:var(--bg-color); padding:8px; border-radius:6px;">
                ‚ÑπÔ∏è This updates the <strong>Night</strong> meal of the Bazar Date and the <strong>Day</strong> meal of the following morning.
            </div>

            <button type="submit" class="btn btn-primary" style="width:100%;">Save Session</button>
        </form>
    </div>
</div>

<!-- Edit Member Modal -->
<div id="editMemberModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit Member</h3>
            <span class="close-modal" onclick="document.getElementById('editMemberModal').classList.remove('active')">√ó</span>
        </div>
        <form id="editMemberForm">
            <input type="hidden" id="editMemberId">
            <input type="hidden" id="editUserId">
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" id="editMemberName" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">New Password (leave blank to keep current)</label>
                <input type="password" id="editMemberPassword" class="form-input" placeholder="New password...">
            </div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
    // ============================================
    // SUPABASE CONFIGURATION
    // ============================================
    const SUPABASE_URL = 'https://bcardtccxcnktkkeszpp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjYXJkdGNjeGNua3Rra2VzenBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NzU1NDIsImV4cCI6MjA4MDE1MTU0Mn0.xGxk81ThPGtyQgRCNoOxpvxsnXBUAzgmclrS0ru7g2Q';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================
    // STATE MANAGEMENT
    // ============================================

    let currentCycleId = null;
    let allMembers = [];
    let allCycles = [];


    // ============================================
// NEW SUPABASE AUTHENTICATION LOGIC
// ============================================

let isLoginMode = true; // Toggle between Login and Signup

// 1. Initialize Auth State Listener (Runs automatically on load)
async function initAuth() {
    // Check if user is already logged in
    const { data: { session } } = await supabase.auth.getSession();
    
    if (session) {
        await handleUserSession(session.user);
    } else {
        document.getElementById('authPage').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
    }

    // Listen for changes (Login, Logout, Auto-refresh)
    supabase.auth.onAuthStateChange(async (_event, session) => {
        if (session) {
            await handleUserSession(session.user);
        } else {
            currentUser = null;
            document.getElementById('authPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }
    });
}

// 2. Fetch Member Profile based on Login ID
async function handleUserSession(user) {
    try {
        // Fetch the profile linked to this Login ID
        let { data: member, error } = await supabase
            .from('members')
            .select('*')
            .eq('user_id', user.id)
            .single();

        if (member) {
            // Success: User is linked to a Member
            currentUser = { 
                ...user, 
                member_id: member.id,
                name: member.name, 
                role: member.role || 'user' // Read role from DB!
            };
        } else {
            // Unlinked User (Just signed up, not connected yet)
            console.log("User not linked to member profile");
            currentUser = { 
                ...user, 
                role: 'guest',
                name: user.email 
            };
        }

        // Redirect logic
        showApp();
        
        // Show/Hide Admin Tab based on REAL role
        if (currentUser.role === 'admin' || currentUser.role === 'manager') {
            document.getElementById('adminMenuItem').style.display = 'block';
        } else {
            document.getElementById('adminMenuItem').style.display = 'none';
        }

    } catch (err) {
        console.error("Session handling error:", err);
    }
}

// 3. Handle Form Submit (Login / Signup)
// --- NEW AUTH LOGIC (Supports Username) ---

// 1. Toggle Login / Sign Up UI
document.getElementById('authToggleBtn').addEventListener('click', (e) => {
    e.preventDefault();
    isLoginMode = !isLoginMode;
    
    const title = isLoginMode ? 'Login' : 'Sign Up';
    const linkText = isLoginMode ? 'Sign Up' : 'Login';
    const infoText = isLoginMode ? "Don't have an account?" : "Already have an account?";
    const emailLabel = isLoginMode ? "Email or Username" : "Email";

    // Show/Hide Username field
    if (isLoginMode) {
        document.getElementById('usernameField').classList.add('hidden');
        document.getElementById('authUsername').removeAttribute('required');
    } else {
        document.getElementById('usernameField').classList.remove('hidden');
        document.getElementById('authUsername').setAttribute('required', 'true');
    }
    
    document.getElementById('emailLabel').textContent = emailLabel;
    document.getElementById('authBtn').textContent = title;
    document.getElementById('authToggleBtn').textContent = linkText;
    document.getElementById('authToggleText').textContent = infoText;
});

// 2. Handle Submission
// 2. Handle Submission (Improved with better debugging)
document.getElementById('authForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const emailOrUser = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    const username = document.getElementById('authUsername').value.trim();
    
    const errorDiv = document.getElementById('authError');
    const btn = document.getElementById('authBtn');
    
    errorDiv.style.display = 'none';
    btn.textContent = 'Processing...';
    btn.disabled = true;

    try {
        if (isLoginMode) {
            // ================= LOGIN FLOW =================
            let finalEmail = emailOrUser;

            // 1. Resolve Username to Email
            if (!emailOrUser.includes('@')) {
                const { data, error } = await supabase
                    .from('members')
                    .select('email')
                    .eq('name', emailOrUser)
                    .single();

                if (error || !data || !data.email) {
                    throw new Error("Username not found. Please sign up or check spelling.");
                }
                finalEmail = data.email;
            }

            // 2. Log In
            const { data, error } = await supabase.auth.signInWithPassword({
                email: finalEmail,
                password: password
            });

            if (error) throw error;

            // 3. Force App Load (Don't wait for listener)
            btn.textContent = 'Success!';
            await handleUserSession(data.user); // <--- Manually trigger session handler

        } else {
            // ================= SIGN UP FLOW =================
            if (username.length < 3) throw new Error("Username must be at least 3 chars.");

            // 1. Sign Up
            const { data, error } = await supabase.auth.signUp({
                email: emailOrUser,
                password: password,
                options: {
                    data: { username: username } // Pass username to Trigger
                }
            });

            if (error) throw error;
            
            alert("Account created successfully! You can now log in.");
            
            // Switch to Login View
            document.getElementById('authToggleBtn').click();
            document.getElementById('authEmail').value = username; // Pre-fill username
        }

    } catch (err) {
        console.error("Auth Error:", err);
        errorDiv.textContent = err.message;
        errorDiv.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = isLoginMode ? 'Login' : 'Sign Up';
    }
});

// 5. Update Logout
document.getElementById('logoutBtn').addEventListener('click', async () => {
    await supabase.auth.signOut();
    // onAuthStateChange will handle the UI update
});

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    
    // Simple hash function (for password hashing - in production use bcrypt)
    async function hashPassword(password) {
        const msgBuffer = new TextEncoder().encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function formatCurrency(amount) {
        return `‡ß≥${parseFloat(amount).toFixed(2)}`;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB');
    }

    function showNotification(message, type = 'info') {
        alert(message); // In production, use a proper notification library
    }

    // ============================================
    // AUTHENTICATION
    // ============================================
    


    document.getElementById('logoutBtn').addEventListener('click', () => {
        currentUser = null;
        localStorage.removeItem('mealcal_user');
        hideApp();
    });

    function showApp() {
        document.getElementById('authPage').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        
        // Show admin menu if user is admin
        if (currentUser.role === 'admin' || currentUser.role === 'manager') {
            document.getElementById('adminMenuItem').style.display = 'block';
        } else {
            document.getElementById('adminMenuItem').style.display = 'none';
        }
        
        initializeApp();
    }

    function hideApp() {
        document.getElementById('authPage').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('loginForm').reset();
        initLoginPage(); // Reload dropdown
    }

    // Check for saved session
window.addEventListener('DOMContentLoaded', () => {
    // Start the new Auth System
    initAuth();
});

// ==========================================
// EXPENSE APPROVAL HANDLER (GLOBAL)
// ==========================================

// Explicitly attach to 'window' to ensure HTML buttons can find it
window.handleExpenseApproval = async function(expenseId, newStatus) {
    console.log("Click triggered:", expenseId, newStatus); // Debugging check

    // Visual feedback on the button immediately
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = "...";
    btn.disabled = true;

    try {
        // 1. Update Database
        const { error } = await supabase
            .from('expenses')
            .update({ status: newStatus })
            .eq('id', expenseId);

        if (error) throw error;

        // 2. Fetch details for Logging (Optional, but good for history)
        const { data: expense } = await supabase
            .from('expenses')
            .select('description, amount, members(name)')
            .eq('id', expenseId)
            .single();

        // 3. Log Activity
        const actor = currentUser.members ? currentUser.members.name : "Admin";
        const actionLabel = newStatus === 'approved' ? 'APPROVED' : 'REJECTED';
        
        await logActivity(
            `Expense ${actionLabel}: ${expense.description} (${formatCurrency(expense.amount)}) - Action by ${actor}`, 
            'expense'
        );

        // 4. Refresh List
        await loadExpenses();
        showNotification(`Expense ${newStatus} successfully`, 'success');

    } catch (err) {
        console.error('Approval Error:', err);
        showNotification(`Failed to ${newStatus} expense: ${err.message}`, 'error');
        
        // Revert button state on error
        btn.textContent = originalText;
        btn.disabled = false;
    }
};

    // ============================================
    // APP INITIALIZATION
    // ============================================
    
async function initializeApp() {
    await loadCycles();
    await loadAppConfig();
    await loadMembers();
    initHeader();
    initNotifications();
    
    // NEW: Check status
    updateEntryStatusIndicator();
    // Set Interval to check every 60 seconds
    setInterval(updateEntryStatusIndicator, 60000); 

    navigateToPage('dashboard');
}

    function loadPageData(pageName) {
        switch(pageName) {
            case 'dashboard':
                loadDashboard();
                break;
            case 'profile':
                loadProfile();
                loadScheduler(); // <--- NEW CALL
                break;
            case 'tracker':
                loadTracker();
                  loadMasterTracker(); // <--- NEW CALL
                break;
            case 'summary':
                loadSummary();
                break;
            case 'expenses':
                loadExpenses();
                break;
            case 'deposits':
                loadDeposits();
                break;
            case 'admin':
                loadAdmin();
                break;
        }
    }

    // Add Handler for Admin Settings Form
document.getElementById('adminSettingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const newTime = document.getElementById('settingLockTime').value;
    
    // Upsert Config
    const { error } = await supabase
        .from('app_config')
        .upsert({ key_name: 'lock_time_start', value_text: newTime }, { onConflict: 'key_name' });

    if (!error) {
        appConfig.lock_time_start = newTime;
        showNotification("Settings updated!", "success");
    } else {
        showNotification("Failed to save settings", "error");
    }
});



// Centralized Logic for "Active Session Date"
// Ensures consistency across Profile, Summary, and Dashboard
async function getActiveSessionDate() {
    // 1. Get Local Date (Browser Time)
    const today = new Date();
    const todayStr = today.toLocaleDateString('en-CA'); // "YYYY-MM-DD"

    try {
        // 2. Check System Log for TODAY
        const { data: log } = await supabase
            .from('system_logs')
            .select('id')
            .eq('log_date', todayStr)
            .maybeSingle();

        let sessionDate = new Date(today);

        // 3. Apply Shift Logic
        // If today's auto-entry is DONE, we target TOMORROW.
        // If today's auto-entry is PENDING, we target TODAY.
        // NOTE: At midnight, "today" becomes the next day, and "log" becomes null,
        // so the result stabilizes on the same date.
        if (log) {
            sessionDate.setDate(today.getDate() + 1);
        }

        return sessionDate;
    } catch (err) {
        console.error("Date Logic Error", err);
        return new Date(); // Fallback to today
    }
}


// Global Config
let appConfig = {
    lock_time_start: '17:00',
    lock_time_end: '19:00',
    auto_entry_time: '18:30' // Default
};

async function loadAppConfig() {
    try {
        const { data, error } = await supabase.from('app_config').select('*');
        if (data) {
            data.forEach(item => {
                appConfig[item.key_name] = item.value_text;
            });
        }
        
        // Update Admin UI inputs
        const startInput = document.getElementById('settingLockTime');
        const endInput = document.getElementById('settingLockTimeEnd');
        if(startInput) startInput.value = appConfig.lock_time_start;
        if(endInput) endInput.value = appConfig.lock_time_end;


        const autoInput = document.getElementById('settingAutoTime');
    if(autoInput) autoInput.value = appConfig.auto_entry_time;

        
        // Update Profile Display
        const lockDisplay = document.getElementById('lockTimeDisplay');
        if(lockDisplay) {
            lockDisplay.textContent = `Restricted: ${convertTo12Hour(appConfig.lock_time_start)} - ${convertTo12Hour(appConfig.lock_time_end)}`;
        }
        
    } catch (err) {
        console.error("Config Load Error", err);
    }
}

// Admin Form Saver
// Admin Form Saver
document.getElementById('adminSettingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // 1. Get Values
    const start = document.getElementById('settingLockTime').value;
    const end = document.getElementById('settingLockTimeEnd').value;
    const autoTime = document.getElementById('settingAutoTime').value; // <--- Make sure this ID exists in HTML
    
    const btn = e.target.querySelector('button[type="submit"]');
    btn.textContent = "Saving...";
    btn.disabled = true;

    try {
        // 2. Upsert All 3 Settings
        const { error } = await supabase.from('app_config').upsert([
            { key_name: 'lock_time_start', value_text: start },
            { key_name: 'lock_time_end', value_text: end },
            { key_name: 'auto_entry_time', value_text: autoTime } // <--- CRITICAL FIX
        ], { onConflict: 'key_name' });

        if (error) throw error;

        // 3. Update Local Config State
        appConfig.lock_time_start = start;
        appConfig.lock_time_end = end;
        appConfig.auto_entry_time = autoTime;
        
        // 4. Update UI
        const lockDisplay = document.getElementById('lockTimeDisplay');
        if(lockDisplay) lockDisplay.textContent = `Restricted: ${convertTo12Hour(start)} - ${convertTo12Hour(end)}`;
        
        showNotification("Settings saved successfully!", "success");
        loadScheduler(); // Refresh UI locks

    } catch (err) {
        console.error("Save Error", err);
        showNotification("Failed to save settings", "error");
    } finally {
        btn.textContent = "Save Settings";
        btn.disabled = false;
    }
});
// Helper: Convert 17:00 to 5:00 PM
function convertTo12Hour(timeStr) {
    if(!timeStr) return "";
    const [hour, min] = timeStr.split(':');
    const h = parseInt(hour);
    const ampm = h >= 12 ? 'PM' : 'AM';
    const h12 = h % 12 || 12;
    return `${h12}:${min} ${ampm}`;
}


/**
 * Checks if a specific meal slot is locked based on Bazar Time.
 * Logic: A "Bazar Session" locks Today's Night and Tomorrow's Day.
 */
function isMealLocked(dateString, mealType) {
    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];

    // 1. Determine "Session Date" (The date the Bazar happens)
    // Night Meal (e.g. 8th Night) -> Bazar is 8th.
    // Day Meal (e.g. 9th Day) -> Bazar is 8th (Previous Day).
    
    let sessionDateStr = dateString;
    if (mealType === 'day') {
        const d = new Date(dateString);
        d.setDate(d.getDate() - 1); // Subtract 1 day
        sessionDateStr = d.toISOString().split('T')[0];
    }

    // 2. Past Session Logic
    // If the bazar day is in the past, it's definitely locked (History).
    if (sessionDateStr < todayStr) return true;

    // 3. Future Session Logic
    // If bazar is tomorrow or later, it's Open.
    if (sessionDateStr > todayStr) return false;

    // 4. TODAY'S Session Logic (sessionDateStr === todayStr)
    // We are on the day of the Bazar. Check the Time Range.
    
    // Parse Config Times
    const [sH, sM] = appConfig.lock_time_start.split(':').map(Number);
    const [eH, eM] = appConfig.lock_time_end.split(':').map(Number);
    
    const startTime = new Date();
    startTime.setHours(sH, sM, 0, 0);
    
    const endTime = new Date();
    endTime.setHours(eH, eM, 0, 0); // e.g., 19:00:00

    // Range Logic: Locked ONLY if Start <= Now <= End
    if (now >= startTime && now <= endTime) {
        return true; // Locked inside range
    }

    return false; // Open before 5pm, Open after 7pm
}


async function loadScheduler() {
    if (!currentUser.member_id || !currentCycleId) return;
    
    const container = document.getElementById('schedulerList');
    container.innerHTML = '<div class="loading">Loading plans...</div>';

    try {
        // 1. Fetch Member Defaults
        const { data: memberData } = await supabase
            .from('members')
            .select('*')
            .eq('id', currentUser.member_id)
            .single();

        if (memberData) updateDefaultButtons(memberData);
        
        const defDay = memberData?.default_day_on || false;
        const defNight = memberData?.default_night_on || false;

        // 2. Calculate Dates (8 Days range)
        const startDate = await getActiveSessionDate();
        const dates = [];
        for(let i=0; i<=8; i++) { 
            const d = new Date(startDate);
            d.setDate(startDate.getDate() + i); 
            dates.push(d.toLocaleDateString('en-CA'));
        }

        // 3. Fetch Existing Plans
        const { data: plans } = await supabase
            .from('meal_plans')
            .select('*')
            .eq('member_id', currentUser.member_id)
            .in('plan_date', dates);

        const planMap = {};
        plans?.forEach(p => planMap[p.plan_date] = p);

        // 4. AUTO-MATERIALIZE MISSING PLANS
        // If a date has no plan, we create one NOW using current defaults.
        // This "locks in" the current view so changing defaults later won't affect these specific days.
        const newPlansToInsert = [];

        dates.forEach(dateStr => {
            if (!planMap[dateStr]) {
                // Create the object
                const newPlan = {
                    member_id: currentUser.member_id,
                    plan_date: dateStr,
                    day_count: defDay ? 1 : 0,
                    night_count: defNight ? 1 : 0
                };
                
                // Add to bulk insert list
                newPlansToInsert.push(newPlan);
                
                // Add to local map so we can render immediately without re-fetching
                planMap[dateStr] = newPlan;
            }
        });

        // Save to DB silently (Fire and forget)
        if (newPlansToInsert.length > 0) {
            supabase
                .from('meal_plans')
                .upsert(newPlansToInsert, { onConflict: 'member_id, plan_date' })
                .then(({ error }) => {
                    if (error) console.error("Auto-save plans error", error);
                });
        }

        // 5. Render Cards
        container.innerHTML = '';
        const fmt = (dStr) => {
            const d = new Date(dStr);
            return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        };

        for (let i = 0; i < 7; i++) {
            const dateSession = dates[i];
            const dateNextDay = dates[i+1];
            
            const sessionLabel = fmt(dateSession);
            const nextDayLabel = fmt(dateNextDay);
            
            const isFirstCard = (i === 0);
            
            // We are guaranteed to have data now because of Step 4
            const planSession = planMap[dateSession]; 
            const planNext = planMap[dateNextDay];

            const card = document.createElement('div');
            card.className = `scheduler-card ${isFirstCard ? 'is-today' : ''}`;
            card.style.minWidth = "160px";
            
            const nightActive = planSession.night_count > 0;
            const dayActive = planNext.day_count > 0;

 card.innerHTML = `
                <div class="scheduler-date" style="font-size:10px; color:var(--text-secondary); text-transform:uppercase;">
                    ${isFirstCard ? 'Active Session' : 'Upcoming'} <br>
                    <span style="color:var(--primary-color); font-weight:700; font-size:14px;">
                        ${sessionLabel} <span style="background:var(--primary-color); color:white; padding:1px 4px; border-radius:4px; font-size:9px; vertical-align:middle;">BAZAR</span>
                    </span>
                </div>
                
                <div style="display:flex; flex-direction:column; gap:8px; width:100%;">
                    
                    <!-- Night Plan Button -->
                    <button class="sched-btn ${nightActive ? 'active' : ''}" 
                        onclick="toggleSchedulerPlan('${dateSession}', 'night', this)">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <span style="font-size:14px;">üåô</span> 
                            <div style="text-align:right;">
                                <div style="font-weight:700;">Night</div>
                                <div style="font-size:9px; opacity:0.8;">${sessionLabel} (Bazar)</div>
                            </div>
                        </div>
                    </button>
                    
                    <!-- Day Plan Button -->
                    <button class="sched-btn ${dayActive ? 'active' : ''}" 
                        onclick="toggleSchedulerPlan('${dateNextDay}', 'day', this)">
                         <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <span style="font-size:14px;">üåû</span> 
                            <div style="text-align:right;">
                                <div style="font-weight:700;">Day</div>
                                <div style="font-size:9px; opacity:0.8; color:${dayActive ? '#fff' : '#d97706'}">${nextDayLabel} (Next)</div>
                            </div>
                        </div>
                    </button>
                </div>
            `;
            container.appendChild(card);
        }


    } catch (err) {
        console.error("Scheduler Error:", err);
        container.innerHTML = '<div class="loading" style="color:red">Error loading schedule</div>';
    }
}
// Function triggered by clicking scheduler buttons
async function toggleSchedulerPlan(date, type, btnElement) {
    // Visual toggle immediately for responsiveness
    const wasActive = btnElement.classList.contains('active');
    if (wasActive) btnElement.classList.remove('active');
    else btnElement.classList.add('active');

    const newCount = wasActive ? 0 : 1;

    try {
        // 1. Fetch current plan to preserve the *other* meal type (Day/Night)
        const { data: existing } = await supabase
            .from('meal_plans')
            .select('*')
            .eq('member_id', currentUser.member_id)
            .eq('plan_date', date)
            .single();

        let updateData = {
            member_id: currentUser.member_id,
            plan_date: date,
            day_count: existing ? existing.day_count : 0,
            night_count: existing ? existing.night_count : 0
        };

        if (type === 'day') updateData.day_count = newCount;
        else updateData.night_count = newCount;

        // 2. Save to PLAN table
        const { error } = await supabase
            .from('meal_plans')
            .upsert(updateData, { onConflict: 'member_id, plan_date' });

        if (error) throw error;
        // console.log("Plan updated");

    } catch (err) {
        console.error("Plan update failed", err);
        showNotification("Failed to save plan", "error");
        // Revert UI
        if (wasActive) btnElement.classList.add('active');
        else btnElement.classList.remove('active');
    }
}

 async function loadMasterTracker() {
    if (!currentCycleId) return;
    
    const tableHead = document.querySelector('#masterMatrixTable thead');
    const tableBody = document.querySelector('#masterMatrixTable tbody');
    if (!tableHead || !tableBody) return;

    tableBody.innerHTML = '<tr><td colspan="100" class="loading">Loading session matrix...</td></tr>';

    try {
        const cycle = allCycles.find(c => c.id === currentCycleId);
        if (!cycle) return;

        // 1. Fetch ALL meals 
        const { data: meals } = await supabase
            .from('meals')
            .select('*')
            .eq('cycle_id', currentCycleId);

        const matrixData = {};
        if (meals) {
            meals.forEach(m => {
                if (!matrixData[m.meal_date]) matrixData[m.meal_date] = {};
                matrixData[m.meal_date][m.member_id] = { d: m.day_count, n: m.night_count };
            });
        }

        // 2. Build Header
        let headerHTML = '<tr><th style="min-width: 90px; z-index:20;">Session<br>Date</th>';
        allMembers.forEach(m => {
            headerHTML += `<th>${m.name.split(' ')[0]}</th>`; 
        });
        headerHTML += '</tr>';
        tableHead.innerHTML = headerHTML;

        // 3. Build Body Rows
        let bodyHTML = '';
        const start = new Date(cycle.start_date);
        const end = new Date(cycle.end_date);
        const todayStr = new Date().toISOString().split('T')[0];

        // Loop dates
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const dateSessionStr = d.toISOString().split('T')[0];
            
            // Calculate Next Date for the Day Meal side
            const dNext = new Date(d);
            dNext.setDate(d.getDate() + 1);
            const dateNextStr = dNext.toISOString().split('T')[0];

            const dateLabel = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
            
            const isToday = (dateSessionStr === todayStr);
            const rowStyle = isToday ? 'style="background: rgba(79, 70, 229, 0.08); border-left: 3px solid var(--primary-color);"' : '';

            bodyHTML += `<tr ${rowStyle}>
                <td style="font-weight:600; font-size:11px;">
                    ${dateLabel}<br><span style="color:var(--text-secondary); font-weight:400; font-size:9px;">Night + Next Day</span>
                </td>`;

    allMembers.forEach(m => {
                // Get Night Data (From Session Date)
                const sessionData = (matrixData[dateSessionStr] && matrixData[dateSessionStr][m.id]) 
                                    ? matrixData[dateSessionStr][m.id] : { d:0, n: 0 };
                
                // Get Day Data (From Next Date)
                const nextData = (matrixData[dateNextStr] && matrixData[dateNextStr][m.id]) 
                                    ? matrixData[dateNextStr][m.id] : { d: 0, n:0 };

                const nVal = parseFloat(sessionData.n); 
                const dVal = parseFloat(nextData.d);   

                const nTxt = nVal > 0 ? nVal : '-';
                const dTxt = dVal > 0 ? dVal : '-';
                const nClass = nVal > 0 ? 'active' : 'zero';
                const dClass = dVal > 0 ? 'active' : 'zero';

                const isAdmin = (currentUser.role === 'admin' || currentUser.role === 'manager');
                
                // --- KEY UPDATE: Unified Click Action ---
                // Both clicks now send: (MemberID, SessionDate, NightValue, NextDayValue)
                // Note: We pass 'nextData.d' as the Day Value
                const clickAction = isAdmin 
                    ? `onclick="openMealModal('${m.id}', '${dateSessionStr}', ${nVal}, ${dVal})"`
                    : '';

                const cursorStyle = isAdmin ? 'pointer' : 'default';

                bodyHTML += `
                    <td>
                        <div class="cell-split">
                            <div class="cell-val night-col ${nClass}" title="Night (${dateLabel})" 
                                 ${clickAction} style="cursor:${cursorStyle}">
                                ${nTxt}
                            </div>
                            <div class="cell-val day-col ${dClass}" title="Day (Next Morning)" 
                                 ${clickAction} style="cursor:${cursorStyle}">
                                ${dTxt}
                            </div>
                        </div>
                    </td>
                `;
            });

            bodyHTML += '</tr>';
        }
        tableBody.innerHTML = bodyHTML;

    } catch (err) {
        console.error("Matrix Error", err);
        tableBody.innerHTML = '<tr><td colspan="100">Error loading data.</td></tr>';
    }
}

    function initHeader() {
    // 1. Set User Info
    if (currentUser) {
        // Use member name if available, else username
        const displayName = currentUser.members ? currentUser.members.name : currentUser.username;
        document.getElementById('headerUserName').textContent = displayName;
        document.getElementById('headerUserRole').textContent = currentUser.role;
    }

    // 2. Start Clock
    updateClock();
    setInterval(updateClock, 1000);

    // 3. Listen for Cycle Changes to update header badge
    const cycleSelect = document.getElementById('cycleSelect');
    if (cycleSelect.options[cycleSelect.selectedIndex]) {
        document.getElementById('headerCycleName').textContent = cycleSelect.options[cycleSelect.selectedIndex].text;
    }
    
    // Add listener to update badge when selector changes
    cycleSelect.addEventListener('change', (e) => {
        document.getElementById('headerCycleName').textContent = e.target.options[e.target.selectedIndex].text;
    });
}

function updateClock() {
    const now = new Date();
    
    // Time
    const timeString = now.toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' });
    document.getElementById('clockTime').textContent = timeString;

    // Date
    const dateString = now.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
    document.getElementById('clockDate').textContent = dateString;
}


// ============================================
// NOTIFICATION LOGIC (FIXED)
// ============================================

let allNotifications = [];
let currentNotifFilter = 'all';

function initNotifications() {
    // 1. Attach Bell Click Listener
    const bellBtn = document.getElementById('notifBellBtn');
    const panel = document.getElementById('notifPanel');
    const closeBtn = document.getElementById('closeNotifPanel');

    // Remove old listeners to prevent duplicates (cloning trick)
    const newBell = bellBtn.cloneNode(true);
    bellBtn.parentNode.replaceChild(newBell, bellBtn);
    
    const newClose = closeBtn.cloneNode(true);
    closeBtn.parentNode.replaceChild(newClose, closeBtn);

    // Re-attach listeners
    document.getElementById('notifBellBtn').addEventListener('click', (e) => {
        e.stopPropagation(); // Stop click from closing the panel immediately
        document.getElementById('notifPanel').classList.toggle('active');
        document.getElementById('notifBadge').classList.add('hidden');
    });

    document.getElementById('closeNotifPanel').addEventListener('click', () => {
        document.getElementById('notifPanel').classList.remove('active');
    });

    // 2. Filter Clicks
    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', (e) => {
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            e.target.classList.add('active');
            currentNotifFilter = e.target.getAttribute('data-filter');
            renderNotifications();
        });
    });

    // 3. Close panel when clicking outside
    document.addEventListener('click', (e) => {
        const p = document.getElementById('notifPanel');
        const b = document.getElementById('notifBellBtn');
        if (p.classList.contains('active') && !p.contains(e.target) && !b.contains(e.target)) {
            p.classList.remove('active');
        }
    });

    // 4. Start Loading
    loadNotifications();
    setupRealtimeNotifications();
}

async function loadNotifications() {
    if (!currentCycleId) return;

    try {
        // CHANGED: Added 'role' to the select query
        const { data, error } = await supabase
            .from('notifications')
            .select('*, members(name, role)') 
            .eq('cycle_id', currentCycleId)
            .order('created_at', { ascending: false })
            .limit(50);

        if (error) throw error;

        allNotifications = data || [];
        renderNotifications();
        updateDashboardActivity(data);

    } catch (err) {
        console.error('Error loading notifications:', err);
    }
}

function renderNotifications() {
    const container = document.getElementById('notifListContainer');
    if (!container) return;

    const filtered = allNotifications.filter(n => {
        if (currentNotifFilter === 'all') return true;
        if (currentNotifFilter === 'meal') return n.type.includes('meal');
        return n.type === currentNotifFilter;
    });

    if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">No notifications found</div>';
        return;
    }

    container.innerHTML = filtered.map(notif => {
        let typeClass = 'type-other';
        let icon = '‚öôÔ∏è';
        if (notif.type === 'deposit') { typeClass = 'type-deposit'; icon = 'üí∞'; }
        if (notif.type === 'expense') { typeClass = 'type-expense'; icon = 'üõí'; }
        if (notif.type.includes('meal')) { typeClass = 'type-meal'; icon = 'üçΩÔ∏è'; }

        const dateObj = new Date(notif.created_at);
        const displayTime = dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) + 
                          ', ' + dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

        // --- NEW LOGIC START ---
        let author = 'System';
        if (notif.members) {
            // Check if the actor is an Admin
            if (notif.members.role === 'admin') {
                author = '<span style="color:var(--primary-color); font-weight:800;">Admin</span>';
            } else {
                author = notif.members.name;
            }
        }
        // --- NEW LOGIC END ---

        return `
        <div class="notif-item ${typeClass}" onclick="handleNotifClick('${notif.type}')">
            <div class="notif-content">
                <strong>${icon}</strong> ${notif.message}
            </div>
            <div class="notif-meta" style="display: flex; justify-content: space-between; margin-top: 5px;">
                <span style="opacity: 0.8;">${displayTime}</span>
                <span style="font-weight: 600;">By: ${author}</span>
            </div>
        </div>
        `;
    }).join('');
}


function setupRealtimeNotifications() {
    supabase
        .channel('public:notifications')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications' }, async payload => {
            const newNotifRaw = payload.new;
            
            if (newNotifRaw.cycle_id === currentCycleId) {
                // CHANGED: Added 'role' here too
                const { data: fullNotif } = await supabase
                    .from('notifications')
                    .select('*, members(name, role)') 
                    .eq('id', newNotifRaw.id)
                    .single();

                if (fullNotif) {
                    allNotifications.unshift(fullNotif);
                    renderNotifications();
                    updateDashboardActivity(allNotifications);
                    
                    const badge = document.getElementById('notifBadge');
                    const currentCount = parseInt(badge.textContent || '0');
                    badge.textContent = currentCount + 1;
                    badge.classList.remove('hidden');
                }
            }
        })
        .subscribe();
}

// Updated Log Activity (Uses member_id)
async function logActivity(message, type = 'info') {
    if (!currentCycleId) return;
    try {
        await supabase
            .from('notifications')
            .insert({
                cycle_id: currentCycleId,
                message: message,
                type: type,
                member_id: currentUser?.member_id // FIXED: Use member_id
            });
    } catch (err) {
        console.error('Error logging activity:', err);
    }
}



// --- Deep Linking Action ---
function handleNotifClick(type) {
    document.getElementById('notifPanel').classList.remove('active');

    if (type === 'deposit') {
        navigateToPage('deposits');
    } else if (type === 'expense') {
        navigateToPage('expenses');
    } else if (type.includes('meal')) {
        navigateToPage('tracker');
    } else {
        navigateToPage('dashboard');
    }
}



// Helper to keep Dashboard synced
function updateDashboardActivity(data) {
    const container = document.getElementById('recentActivity');
    if (!container) return;
    
    const slice = data.slice(0, 10);
    if (slice.length === 0) {
        container.innerHTML = '<div class="loading">No recent activity</div>';
        return;
    }
    
    container.innerHTML = slice.map(notif => `
        <div class="list-item">
            <div class="list-item-info">
                <div class="list-item-title">${notif.message}</div>
                <div class="list-item-subtitle">${formatDate(notif.created_at)}</div>
            </div>
        </div>
    `).join('');
}




    async function loadCycles() {
        try {
            const { data, error } = await supabase
                .from('cycles')
                .select('*')
                .order('start_date', { ascending: false });

            if (error) throw error;

            allCycles = data || [];
            const cycleSelect = document.getElementById('cycleSelect');
            cycleSelect.innerHTML = '';

            if (allCycles.length === 0) {
                cycleSelect.innerHTML = '<option value="">No cycles available</option>';
                return;
            }

            allCycles.forEach(cycle => {
                const option = document.createElement('option');
                option.value = cycle.id;
                option.textContent = cycle.name;
                if (cycle.is_active) {
                    option.selected = true;
                    currentCycleId = cycle.id;
                }
                cycleSelect.appendChild(option);
            });

            if (!currentCycleId && allCycles.length > 0) {
                currentCycleId = allCycles[0].id;
            }

            cycleSelect.addEventListener('change', (e) => {
                currentCycleId = parseInt(e.target.value);
                refreshCurrentPage();
            });

        } catch (err) {
            console.error('Error loading cycles:', err);
        }
    }

    async function loadMembers() {
        try {
            const { data, error } = await supabase
                .from('members')
                .select('*')
                .order('name');

            if (error) throw error;

            allMembers = data || [];
            populateMemberSelects();
        } catch (err) {
            console.error('Error loading members:', err);
        }
    }

 function populateMemberSelects() {
    const selects = ['trackerMemberSelect', 'expenseMember', 'depositMember', 'depositLogFilter'];

    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        const firstOption = select.options[0];
        const currentValue = select.value; // Preserve value if reloading
        
        select.innerHTML = '';
        select.appendChild(firstOption);
        
        allMembers.forEach(member => {
            const option = document.createElement('option');
            option.value = member.id;
            option.textContent = member.name;
            select.appendChild(option);
        });

        // --- NEW LOGIC FOR USER CONVENIENCE ---
        // If this is the Expense form and I am a regular user, auto-select ME
        if (selectId === 'expenseMember' && currentUser.role === 'user' && currentUser.member_id) {
             select.value = currentUser.member_id;
             // Optional: Disable it so they can't change it
             // select.disabled = true; 
        } else if (currentValue) {
            select.value = currentValue;
        }
    });
}
    // ============================================
    // NAVIGATION
    // ============================================
    
    function navigateToPage(pageName) {
        // Hide all pages
        document.querySelectorAll('.page-content').forEach(page => {
            page.classList.add('hidden');
        });

        // Show selected page
        const targetPage = document.getElementById(pageName + 'Page');
        if (targetPage) {
            targetPage.classList.remove('hidden');
        }

        // Update active states
        document.querySelectorAll('.nav-link, .bottom-nav-link').forEach(link => {
            link.classList.remove('active');
        });

        document.querySelectorAll(`[data-page="${pageName}"]`).forEach(link => {
            link.classList.add('active');
        });

        // Load page data
        loadPageData(pageName);
    }


    function refreshCurrentPage() {
        const activePage = document.querySelector('.page-content:not(.hidden)');
        if (activePage) {
            const pageName = activePage.id.replace('Page', '');
            loadPageData(pageName);
        }
    }

    // Setup navigation
    document.querySelectorAll('.nav-link, .bottom-nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const pageName = link.getAttribute('data-page');
            if (pageName) {
                navigateToPage(pageName);
            }
        });
    });

    // ============================================
    // DASHBOARD PAGE
    // ============================================
    
    async function loadDashboard() {
        if (!currentCycleId) return;

        try {
            // Calculate meal rate
            const { data: expenses } = await supabase
                .from('expenses')
                .select('amount')
                .eq('cycle_id', currentCycleId);

            const { data: meals } = await supabase
                .from('meals')
                .select('day_count, night_count')
                .eq('cycle_id', currentCycleId);


                const { data: log } = await supabase
    .from('system_logs')
    .select('*')
    .eq('log_date', new Date().toISOString().split('T')[0])
    .single();

if (log) {
    // Optional: Show a small badge somewhere
    console.log("‚úÖ Daily Automation Ran at: " + new Date(log.executed_at).toLocaleTimeString());
} else {
    console.log("‚è≥ Waiting for Auto-Entry Time...");
}



            const totalExpense = expenses?.reduce((sum, e) => sum + parseFloat(e.amount), 0) || 0;
            const totalMeals = meals?.reduce((sum, m) => sum + parseFloat(m.day_count) + parseFloat(m.night_count), 0) || 0;
            const mealRate = totalMeals > 0 ? totalExpense / totalMeals : 0;

            document.getElementById('statMealRate').textContent = formatCurrency(mealRate);
            document.getElementById('statTotalMeals').textContent = totalMeals.toFixed(1);
            document.getElementById('statTotalExpense').textContent = formatCurrency(totalExpense);

            // Get deposits
            const { data: deposits } = await supabase
                .from('deposits')
                .select('amount')
                .eq('cycle_id', currentCycleId);

            const totalDeposit = deposits?.reduce((sum, d) => sum + parseFloat(d.amount), 0) || 0;
            document.getElementById('statTotalDeposit').textContent = formatCurrency(totalDeposit);

             loadSystemStatus(); 

            // Load recent activity
            await loadRecentActivity();

        } catch (err) {
            console.error('Error loading dashboard:', err);
        }
    }

    async function loadRecentActivity() {
        try {
            const { data, error } = await supabase
                .from('notifications')
                .select('*')
                .eq('cycle_id', currentCycleId)
                .order('created_at', { ascending: false })
                .limit(10);

            if (error) throw error;

            const container = document.getElementById('recentActivity');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="loading">No recent activity</div>';
                return;
            }

            container.innerHTML = data.map(notif => `
                <div class="list-item">
                    <div class="list-item-info">
                        <div class="list-item-title">${notif.message}</div>
                        <div class="list-item-subtitle">${formatDate(notif.created_at)}</div>
                    </div>
                </div>
            `).join('');

        } catch (err) {
            console.error('Error loading activity:', err);
        }
    }

    // ============================================
    // PROFILE PAGE
    // ============================================
    
    async function loadProfile() {
        if (!currentUser) return;
        
        // If admin (no member_id), show limited view
        if (!currentUser.member_id) {
            document.getElementById('profileName').textContent = "Administrator";
            document.getElementById('profileTotalMeals').textContent = "-";
            document.getElementById('profileTotalDeposit').textContent = "-";
            document.getElementById('profileBalance').textContent = "-";
            document.getElementById('profileDepositHistory').innerHTML = "<div class='loading'>Admins do not have meal records.</div>";
            return;
        }

        if (!currentCycleId) return;

        try {
            // Load member info
            const member = allMembers.find(m => m.id === currentUser.member_id);
            if (member) {
                document.getElementById('profileName').textContent = member.name;
            }

            // Calculate stats
            const { data: meals } = await supabase
                .from('meals')
                .select('day_count, night_count')
                .eq('cycle_id', currentCycleId)
                .eq('member_id', currentUser.member_id);

            const totalMeals = meals?.reduce((sum, m) => sum + parseFloat(m.day_count) + parseFloat(m.night_count), 0) || 0;
            document.getElementById('profileTotalMeals').textContent = totalMeals.toFixed(1);

            const { data: deposits } = await supabase
                .from('deposits')
                .select('amount')
                .eq('cycle_id', currentCycleId)
                .eq('member_id', currentUser.member_id);

            const totalDeposit = deposits?.reduce((sum, d) => sum + parseFloat(d.amount), 0) || 0;
            document.getElementById('profileTotalDeposit').textContent = formatCurrency(totalDeposit);

            // Calculate balance
            const { data: allExpenses } = await supabase
                .from('expenses')
                .select('amount')
                .eq('cycle_id', currentCycleId);

            const { data: allMeals } = await supabase
                .from('meals')
                .select('day_count, night_count')
                .eq('cycle_id', currentCycleId);

            const totalExpense = allExpenses?.reduce((sum, e) => sum + parseFloat(e.amount), 0) || 0;
            const allTotalMeals = allMeals?.reduce((sum, m) => sum + parseFloat(m.day_count) + parseFloat(m.night_count), 0) || 0;
            const mealRate = allTotalMeals > 0 ? totalExpense / allTotalMeals : 0;
            const balance = totalDeposit - (totalMeals * mealRate);
            
            const balanceEl = document.getElementById('profileBalance');
            balanceEl.textContent = formatCurrency(balance);
            balanceEl.className = balance >= 0 ? 'stat-value balance-positive' : 'stat-value balance-negative';

            // Load today's meal status
            await loadTodayMealStatus();

            // Load deposit history
            await loadProfileDepositHistory();

        } catch (err) {
            console.error('Error loading profile:', err);
        }
    }

    async function loadTodayMealStatus() {
        if (!currentUser.member_id) return;
        const today = new Date().toISOString().split('T')[0];

        try {
            const { data } = await supabase
                .from('meals')
                .select('*')
                .eq('member_id', currentUser.member_id)
                .eq('meal_date', today)
                .single();

            const dayCount = data?.day_count || 0;
            const nightCount = data?.night_count || 0;

            const dayToggle = document.getElementById('dayMealToggle');
            const nightToggle = document.getElementById('nightMealToggle');

            if (dayCount > 0) {
                dayToggle.classList.add('active');
                dayToggle.classList.remove('inactive');
                document.getElementById('dayMealStatus').textContent = 'ON';
            } else {
                dayToggle.classList.add('inactive');
                dayToggle.classList.remove('active');
                document.getElementById('dayMealStatus').textContent = 'OFF';
            }

            if (nightCount > 0) {
                nightToggle.classList.add('active');
                nightToggle.classList.remove('inactive');
                document.getElementById('nightMealStatus').textContent = 'ON';
            } else {
                nightToggle.classList.add('inactive');
                nightToggle.classList.remove('active');
                document.getElementById('nightMealStatus').textContent = 'OFF';
            }

        } catch (err) {
            console.error('Error loading meal status:', err);
        }
    }

    async function loadProfileDepositHistory() {
        if (!currentUser.member_id) return;
        try {
            const { data, error } = await supabase
                .from('deposits')
                .select('*')
                .eq('member_id', currentUser.member_id)
                .eq('cycle_id', currentCycleId)
                .order('created_at', { ascending: false });

            if (error) throw error;

            const container = document.getElementById('profileDepositHistory');

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="loading">No deposits yet</div>';
                return;
            }

            container.innerHTML = data.map(deposit => `
                <div class="list-item">
                    <div class="list-item-info">
                        <div class="list-item-title">${deposit.label || 'Deposit'}</div>
                        <div class="list-item-subtitle">${formatDate(deposit.created_at)}</div>
                    </div>
                    <div class="list-item-amount balance-positive">${formatCurrency(deposit.amount)}</div>
                </div>
            `).join('');

        } catch (err) {
            console.error('Error loading deposit history:', err);
        }
    }

    // Toggle meal status
    // document.getElementById('dayMealToggle').addEventListener('click', async () => {
    //     if (currentUser.member_id) await toggleMeal('day');
    // });

    // document.getElementById('nightMealToggle').addEventListener('click', async () => {
    //     if (currentUser.member_id) await toggleMeal('night');
    // });




    async function toggleDefaultPreference(type) {
    if (!currentUser.member_id) return;

    // 1. Get current member data from local list to check current state
    const member = allMembers.find(m => m.id === currentUser.member_id);
    if (!member) return;

    // 2. Determine new state (Toggle)
    let updates = {};
    if (type === 'day') {
        const newState = !member.default_day_on;
        updates = { default_day_on: newState };
        // Optimistic Update (Visual)
        member.default_day_on = newState; 
        updateDefaultButtons(member);
    } else {
        const newState = !member.default_night_on;
        updates = { default_night_on: newState };
        // Optimistic Update (Visual)
        member.default_night_on = newState; 
        updateDefaultButtons(member);
    }

    try {
        // 3. Save to DB
        const { error } = await supabase
            .from('members')
            .update(updates)
            .eq('id', currentUser.member_id);

        if (error) throw error;
        // console.log("Default updated");
        
        // 4. Reload Scheduler to apply new default to any *future missing* cards immediately?
        // Actually, we usually only apply defaults when a card is CREATED. 
        // Existing cards shouldn't change. So we don't reload scheduler here.

    } catch (err) {
        console.error("Failed to update defaults", err);
        showNotification("Failed to save default setting", "error");
    }
}

// Helper to update button colors
function updateDefaultButtons(member) {
    const dayBtn = document.getElementById('defDayBtn');
    const nightBtn = document.getElementById('defNightBtn');
    
    if (dayBtn) {
        dayBtn.className = `def-btn ${member.default_day_on ? 'active' : ''}`;
        dayBtn.textContent = `Default Day: ${member.default_day_on ? 'ON' : 'OFF'}`;
    }
    
    if (nightBtn) {
        nightBtn.className = `def-btn ${member.default_night_on ? 'active' : ''}`;
        nightBtn.textContent = `Default Night: ${member.default_night_on ? 'ON' : 'OFF'}`;
    }
}





   async function toggleMeal(mealType) {
    const today = new Date().toISOString().split('T')[0];

    try {
        const { data: existing } = await supabase
            .from('meals')
            .select('*')
            .eq('member_id', currentUser.member_id)
            .eq('meal_date', today)
            .single();

        let dayCount = existing?.day_count || 0;
        let nightCount = existing?.night_count || 0;

        if (mealType === 'day') {
            dayCount = dayCount > 0 ? 0 : 1;
        } else {
            nightCount = nightCount > 0 ? 0 : 1;
        }

        if (existing) {
            await supabase
                .from('meals')
                .update({
                    day_count: dayCount,
                    night_count: nightCount,
                    updated_at: new Date().toISOString()
                })
                .eq('id', existing.id);
        } else {
            await supabase
                .from('meals')
                .insert({
                    cycle_id: currentCycleId,
                    member_id: currentUser.member_id,
                    meal_date: today,
                    day_count: dayCount,
                    night_count: nightCount
                });
        }

        // --- CRUCIAL UPDATE HERE ---
        // We get the name of the person performing the action
        const actorName = currentUser.members ? currentUser.members.name : currentUser.username;
        const actionType = mealType === 'day' ? (dayCount > 0 ? 'ON' : 'OFF') : (nightCount > 0 ? 'ON' : 'OFF');
        
        await logActivity(
            `${actorName} turned ${mealType.toUpperCase()} meal ${actionType} for today`, 
            'meal' 
        );
        // ---------------------------

        await loadTodayMealStatus();
        showNotification('Meal status updated', 'success');

    } catch (err) {
        console.error('Error toggling meal:', err);
        showNotification('Failed to update meal status', 'error');
    }
}

    // ============================================
    // TRACKER PAGE
    // ============================================
    
       function loadTracker() {
        // The old dropdown logic is gone. 
        // We simply load the master matrix now.
        loadMasterTracker();
    }


    async function loadMemberCalendar(memberId) {
        if (!currentCycleId) return;

        try {
            const cycle = allCycles.find(c => c.id === currentCycleId);
            if (!cycle) return;

            const startDate = new Date(cycle.start_date);
            const endDate = new Date(cycle.end_date);
            
            // Fetch meals for this member and cycle
            const { data: meals } = await supabase
                .from('meals')
                .select('*')
                .eq('cycle_id', currentCycleId)
                .eq('member_id', memberId);

            const mealMap = {};
            meals?.forEach(meal => {
                mealMap[meal.meal_date] = meal;
            });

            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';

            // Generate calendar days
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const meal = mealMap[dateStr];
                const totalMeals = meal ? parseFloat(meal.day_count) + parseFloat(meal.night_count) : 0;

                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day' + (totalMeals > 0 ? ' has-meal' : '');
                dayDiv.innerHTML = `
                    <div class="calendar-day-number">${d.getDate()}</div>
                    <div class="calendar-day-meals">${totalMeals > 0 ? totalMeals.toFixed(1) : '-'}</div>
                `;

                // Only managers and admins can edit
                if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                    dayDiv.addEventListener('click', () => {
                        openMealModal(memberId, dateStr, meal);
                    });
                }

                calendarGrid.appendChild(dayDiv);
            }

        } catch (err) {
            console.error('Error loading calendar:', err);
        }
    }

function openMealModal(memberId, sessionDate, currentNightVal, nextDayVal) {
    // 1. Calculate Dates
    const dSession = new Date(sessionDate);
    const dNext = new Date(dSession);
    dNext.setDate(dSession.getDate() + 1);
    
    const nextDateStr = dNext.toISOString().split('T')[0];
    
    // 2. Format Labels
    const fmt = (d) => d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }); // "8 Dec"
    const fmtFull = (d) => d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }); // "8 Dec 2025"

    // 3. GET MEMBER NAME
    const member = allMembers.find(m => m.id == memberId);
    const memberName = member ? member.name : 'Member';

    // 4. Update Header (Name + Date)
    document.getElementById('mealModalTitle').innerHTML = `
        <div style="color:var(--primary-color); font-size:18px;">${memberName}</div>
        <div style="font-size:13px; color:var(--text-primary); font-weight:400; margin-top:2px;">
            Bazar Session of <strong>${fmtFull(dSession)}</strong>
        </div>
    `;
    
    // 5. Update Input Labels
    document.getElementById('mealNightLabel').innerHTML = `Night <span style="font-weight:400; color:var(--primary-color)">(${fmt(dSession)})</span>`;
    document.getElementById('mealDayLabel').innerHTML = `Day <span style="font-weight:400; color:#d97706">(${fmt(dNext)})</span>`;

    // 6. Set Inputs and Hidden IDs
    document.getElementById('mealMemberId').value = memberId;
    document.getElementById('mealDateSession').value = sessionDate;
    document.getElementById('mealDateNext').value = nextDateStr;

    // Round values before showing
    document.getElementById('mealNightCount').value = Math.round(parseFloat(currentNightVal || 0));
    document.getElementById('mealDayCount').value = Math.round(parseFloat(nextDayVal || 0));
    
    document.getElementById('mealModal').classList.add('active');
}
    function closeMealModal() {
        document.getElementById('mealModal').classList.remove('active');
    }

   // ==========================================
// UPDATED MEAL FORM HANDLER
// ==========================================
// ==========================================
// UPDATED MEAL FORM HANDLER (FIXED NOTIFICATION)
// ==========================================
document.getElementById('mealForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    btn.textContent = "Saving...";
    btn.disabled = true;

    // Get Inputs
    const memberId = parseInt(document.getElementById('mealMemberId').value);
    const sessionDate = document.getElementById('mealDateSession').value; // e.g. Dec 8
    const nextDate = document.getElementById('mealDateNext').value;       // e.g. Dec 9
    
    const nightVal = parseFloat(document.getElementById('mealNightCount').value) || 0;
    const dayVal = parseFloat(document.getElementById('mealDayCount').value) || 0;

    try {
        // Fetch current state to preserve non-edited slots
        const { data: existingRows } = await supabase
            .from('meals')
            .select('*')
            .eq('member_id', memberId)
            .in('meal_date', [sessionDate, nextDate]);

        // Helper to find existing row
        const findRow = (d) => existingRows?.find(r => r.meal_date === d);
        const rowSession = findRow(sessionDate);
        const rowNext = findRow(nextDate);

        // Prepare Upsert for Session Date (Update NIGHT, Keep Day)
        const upsertSession = {
            cycle_id: currentCycleId,
            member_id: memberId,
            meal_date: sessionDate,
            night_count: nightVal,
            day_count: rowSession ? rowSession.day_count : 0, 
            updated_at: new Date().toISOString()
        };

        // Prepare Upsert for Next Date (Update DAY, Keep Night)
        const upsertNext = {
            cycle_id: currentCycleId,
            member_id: memberId,
            meal_date: nextDate,
            day_count: dayVal,
            night_count: rowNext ? rowNext.night_count : 0, 
            updated_at: new Date().toISOString()
        };

        // Execute Upsert
        const { error } = await supabase
            .from('meals')
            .upsert([upsertSession, upsertNext], { onConflict: 'member_id, meal_date' });

        if (error) throw error;

        // --- FIXED NOTIFICATION LOGIC ---
        
        // 1. Get the Actor (Who did the edit?)
        const actor = currentUser.members ? currentUser.members.name : "Admin";
        
        // 2. Get the Target (Whose meal was edited?)
        const targetMember = allMembers.find(m => m.id === memberId);
        const targetName = targetMember ? targetMember.name : "Unknown Member";

        // 3. Log with Target Name
        await logActivity(
            `Tracker Edit for ${targetName} (Session ${sessionDate}): Night=${nightVal}, Day=${dayVal}`, 
            'meal'
        );
        // --------------------------------

        closeMealModal();
        await loadMasterTracker();
        showNotification("Session updated successfully", "success");

    } catch (err) {
        console.error("Save Error", err);
        showNotification("Failed to save: " + err.message, "error");
    } finally {
        btn.textContent = "Save Session";
        btn.disabled = false;
    }
});

    // ============================================
    // SUMMARY PAGE
    // ============================================
    
async function loadSummary() {
    if (!currentCycleId) return;

    try {
        // 1. USE CENTRALIZED DATE LOGIC
        const sessionDate = await getActiveSessionDate();
        
        // Define Columns based on Active Session
        const nightDateStr = sessionDate.toLocaleDateString('en-CA');
        
        const nextDay = new Date(sessionDate);
        nextDay.setDate(sessionDate.getDate() + 1);
        const dayDateStr = nextDay.toLocaleDateString('en-CA');

        const fmt = (d) => d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });

        // 2. Fetch Data Separately
        // A. Billed Meals (History/Tracker) -> ONLY for calculating Total Cost/Meals
        const { data: meals } = await supabase
            .from('meals')
            .select('*')
            .eq('cycle_id', currentCycleId);
        
        // B. Plans (Future/Intent) -> ONLY for the Buttons
        const { data: plans } = await supabase
            .from('meal_plans')
            .select('*')
            .in('plan_date', [nightDateStr, dayDateStr]);
        
        const { data: deposits } = await supabase.from('deposits').select('*').eq('cycle_id', currentCycleId);
        const { data: expenses } = await supabase.from('expenses').select('*').eq('cycle_id', currentCycleId);

        // 3. Fast Lookups
        const planMap = {};
        plans?.forEach(p => { planMap[`${p.member_id}_${p.plan_date}`] = p; });

        // 4. Financial Rates
        const totalExpense = expenses?.reduce((sum, e) => sum + parseFloat(e.amount), 0) || 0;
        const allTotalMeals = meals?.reduce((sum, m) => sum + parseFloat(m.day_count) + parseFloat(m.night_count), 0) || 0;
        const mealRate = allTotalMeals > 0 ? totalExpense / allTotalMeals : 0;

        // 5. Build Member Stats
        const memberStats = {};

        // Helper: Get Plan Status (Plan -> Default) 
        // STRICTLY IGNORES TRACKER ('meals' table)
        const getPlanStatus = (member, dateStr, type) => {
            const plan = planMap[`${member.id}_${dateStr}`];
            
            if (plan) {
                return type === 'night' ? plan.night_count : plan.day_count;
            }
            
            // Fallback to Default
            return type === 'night' ? (member.default_night_on ? 1 : 0) : (member.default_day_on ? 1 : 0);
        };

        allMembers.forEach(member => {
            // A. Calculate Historical Totals (From Tracker)
            let totalMeals = 0;
            meals?.filter(m => m.member_id === member.id).forEach(m => {
                totalMeals += (parseFloat(m.day_count) + parseFloat(m.night_count));
            });

            const memDeposits = deposits?.filter(d => d.member_id === member.id).reduce((sum, d) => sum + parseFloat(d.amount), 0) || 0;
            const totalCost = totalMeals * mealRate;

            memberStats[member.id] = {
                id: member.id,
                name: member.name,
                // B. Calculate Button Status (From Plan Only)
                // This ensures it matches the Profile Card exactly
                nightStatus: parseFloat(getPlanStatus(member, nightDateStr, 'night')),
                dayStatus: parseFloat(getPlanStatus(member, dayDateStr, 'day')),
                totalMeals: totalMeals,
                totalCost: totalCost,
                totalDeposit: memDeposits,
                balance: memDeposits - totalCost
            };
        });

        // 6. Header
        const realTodayStr = new Date().toLocaleDateString('en-CA');
        const isTargetingTomorrow = (nightDateStr !== realTodayStr);
        const dateLabelPrefix = isTargetingTomorrow ? "Target: " : "Active: ";

        const tableHead = document.querySelector('#summaryTable thead tr');
        tableHead.innerHTML = `
            <th>Name</th>
            <th style="text-align:center;">Night <br><span style="font-size:9px; color:var(--primary-color)">${dateLabelPrefix}${fmt(sessionDate)}</span></th>
            <th style="text-align:center;">Day <br><span style="font-size:9px; color:#d97706">${fmt(nextDay)}</span></th>
            <th>Total<br>Meals</th>
            <th>Total<br>Cost</th>
            <th>Deposits</th>
            <th>Balance</th>
        `;

        // 7. Render Body
        const isAdmin = (currentUser.role === 'admin' || currentUser.role === 'manager');
        const tbody = document.getElementById('summaryTableBody');
        
        tbody.innerHTML = Object.values(memberStats).map(stat => {
            const nightIsOn = stat.nightStatus > 0;
            const nightBtnClass = nightIsOn ? 'status-btn on' : 'status-btn off';
            const nightAction = isAdmin ? `onclick="quickToggleSummaryMeal(${stat.id}, '${nightDateStr}', 'night', ${stat.nightStatus})"` : 'disabled';
            
            const dayIsOn = stat.dayStatus > 0;
            const dayBtnClass = dayIsOn ? 'status-btn on' : 'status-btn off';
            const dayAction = isAdmin ? `onclick="quickToggleSummaryMeal(${stat.id}, '${dayDateStr}', 'day', ${stat.dayStatus})"` : 'disabled';

            return `
            <tr>
                <td style="vertical-align: middle;"><strong>${stat.name}</strong></td>
                <td style="text-align:center;"><button class="${nightBtnClass}" ${nightAction}>${nightIsOn ? 'ON' : 'OFF'}</button></td>
                <td style="text-align:center;"><button class="${dayBtnClass}" ${dayAction}>${dayIsOn ? 'ON' : 'OFF'}</button></td>
                <td style="vertical-align: middle;"><strong>${stat.totalMeals.toFixed(1)}</strong></td>
                <td style="vertical-align: middle;">${formatCurrency(stat.totalCost)}</td>
                <td style="vertical-align: middle;">${formatCurrency(stat.totalDeposit)}</td>
                <td style="vertical-align: middle;" class="${stat.balance >= 0 ? 'balance-positive' : 'balance-negative'}">
                    <strong>${formatCurrency(stat.balance)}</strong>
                </td>
            </tr>`;
        }).join('');

    } catch (err) {
        console.error('Error loading summary:', err);
    }
}
// Function to instantly toggle meal from Summary Page
// Function to toggle meal from Summary Page (STRICTLY PLANS)
async function quickToggleSummaryMeal(memberId, dateStr, type, currentVal) {
    const btn = event.target; // Optimistic UI
    const originalText = btn.textContent;
    btn.textContent = "...";
    btn.disabled = true;

    // 1. Calculate New Value
    const newVal = currentVal > 0 ? 0 : 1;

    try {
        // 2. Fetch existing PLAN to preserve the 'other' side (Day/Night)
        // We do NOT check the 'meals' (Tracker) table.
        const { data: existingPlan } = await supabase
            .from('meal_plans')
            .select('*')
            .eq('member_id', memberId)
            .eq('plan_date', dateStr)
            .maybeSingle();

        // 3. Prepare Upsert Data
        const upsertPlan = {
            member_id: memberId,
            plan_date: dateStr,
            // If plan exists, keep existing values, otherwise default to 0
            day_count: existingPlan ? existingPlan.day_count : 0,
            night_count: existingPlan ? existingPlan.night_count : 0
        };

        // 4. Update the specific field we clicked
        if (type === 'night') {
            upsertPlan.night_count = newVal;
        } else {
            upsertPlan.day_count = newVal;
        }

        // 5. Send to Database (meal_plans only)
        const { error } = await supabase
            .from('meal_plans')
            .upsert(upsertPlan, { onConflict: 'member_id, plan_date' });

        if (error) throw error;

        // 6. Log and Refresh
        const actor = currentUser.members ? currentUser.members.name : "Admin";
        // We don't need to fetch member name again, logic is fast enough
        await logActivity(`Plan Updated: ${type} for ${dateStr} set to ${newVal ? 'ON' : 'OFF'} by ${actor}`, 'meal');

        await loadSummary();
        showNotification("Schedule updated successfully", "success");

    } catch (err) {
        console.error("Quick Toggle Error", err);
        showNotification("Update failed", "error");
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

    document.getElementById('exportSummaryBtn').addEventListener('click', () => {
        const table = document.getElementById('summaryTable');
        const wb = XLSX.utils.table_to_book(table);
        XLSX.writeFile(wb, `MealCal_Summary_${new Date().toISOString().split('T')[0]}.xlsx`);
    });

    // ============================================
    // EXPENSES PAGE
    // ============================================
    
  async function loadExpenses() {
    // 1. UI: ALWAYS SHOW the Add Expense Card (Changed from previous logic)
    document.getElementById('addExpenseCard').style.display = 'block';
    
    // Check role for button logic later
    const isUser = currentUser.role === 'user';

    if (!currentCycleId) return;

    try {
        // 2. Fetch Data
        const { data, error } = await supabase
            .from('expenses')
            .select('*, members(name)')
            .eq('cycle_id', currentCycleId)
            .order('expense_date', { ascending: false });

        if (error) throw error;

        const expenseListContainer = document.getElementById('expenseList');

        if (!data || data.length === 0) {
            expenseListContainer.innerHTML = '<div class="loading">No expenses yet</div>';
            return;
        }

        // 3. Separate Data
        const pendingItems = data.filter(e => e.status === 'pending');
        const historyItems = data.filter(e => e.status !== 'pending'); // Approved or Rejected

        // 4. Helper to Render Row
        const renderRow = (expense, showButtons) => {
            let statusBadge = '';
            if (expense.status === 'pending') statusBadge = '<span class="entry-status-badge status-pending" style="margin-left: 5px;">PENDING</span>';
            if (expense.status === 'approved') statusBadge = '<span class="entry-status-badge status-done" style="margin-left: 5px;">APPROVED</span>';
            if (expense.status === 'rejected') statusBadge = '<span class="entry-status-badge status-pending" style="background:#FEE2E2; color:#B91C1C; border:1px solid #FECACA; margin-left: 5px;">REJECTED</span>';

            let buttonsHTML = '';
            if (showButtons) {
                buttonsHTML = `
                <div style="display:flex; gap:5px; margin-top:5px; justify-content:flex-end;">
                    <button class="btn btn-success btn-sm" onclick="handleExpenseApproval('${expense.id}', 'approved')">‚úì</button>
                    <button class="btn btn-danger btn-sm" onclick="handleExpenseApproval('${expense.id}', 'rejected')">‚úï</button>
                </div>`;
            }

            return `
            <div class="list-item" style="${expense.status === 'pending' ? 'background-color:#fff7ed;' : ''}"> 
                <div class="list-item-info">
                    <div class="list-item-title">${expense.description || 'Expense'}</div>
                    <div class="list-item-subtitle">
                        ${formatDate(expense.expense_date)} ‚Ä¢ ${expense.members?.name || 'Unknown'}
                        ${statusBadge}
                    </div>
                </div>
                <div style="display:flex; flex-direction:column; align-items:flex-end;">
                    <div class="list-item-amount">${formatCurrency(expense.amount)}</div>
                    ${buttonsHTML}
                </div>
            </div>`;
        };

        // 5. Build HTML
        let finalHTML = '';

        // Pending Section (Visible to ALL, Buttons for Admin Only)
        if (pendingItems.length > 0) {
            finalHTML += `<div style="font-size:12px; font-weight:700; color:var(--warning-color); margin-bottom:10px; text-transform:uppercase; letter-spacing:1px;">‚ö†Ô∏è Pending Approval</div>`;
            pendingItems.forEach(item => {
                finalHTML += renderRow(item, !isUser); 
            });
            finalHTML += `<div style="border-bottom: 2px dashed var(--border-color); margin: 15px 0;"></div>`;
        }

        // History Section
        if (historyItems.length > 0) {
            finalHTML += `<div style="font-size:12px; font-weight:700; color:var(--text-secondary); margin-bottom:10px; text-transform:uppercase; letter-spacing:1px;">History</div>`;
            historyItems.forEach(item => {
                finalHTML += renderRow(item, false); 
            });
        }

        expenseListContainer.innerHTML = finalHTML;

    } catch (err) {
        console.error('Error loading expenses:', err);
    }
}


 document.getElementById('expenseForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const date = document.getElementById('expenseDate').value;
    const memberId = parseInt(document.getElementById('expenseMember').value);
    const description = document.getElementById('expenseDescription').value;
    const amount = parseFloat(document.getElementById('expenseAmount').value);

    // LOGIC: If Admin/Manager -> 'approved', If User -> 'pending'
    const isAdmin = (currentUser.role === 'admin' || currentUser.role === 'manager');
    const initialStatus = isAdmin ? 'approved' : 'pending';
    
    // Notification Message Customization
    const msg = isAdmin ? 'Expense added and approved' : 'Expense submitted for approval';

    try {
        const { error } = await supabase
            .from('expenses')
            .insert({
                cycle_id: currentCycleId,
                member_id: memberId,
                expense_date: date,
                description: description,
                amount: amount,
                status: initialStatus
            });

        if (error) throw error;

        // Log Activity
        const member = allMembers.find(m => m.id === memberId);
        await logActivity(
            `${msg}: ${formatCurrency(amount)} by ${member?.name}`, 
            'expense'
        );

        // Reset and Reload
        document.getElementById('expenseForm').reset();
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        
        await loadExpenses();
        showNotification(msg, 'success');

    } catch (err) {
        console.error('Error adding expense:', err);
        showNotification('Failed to add expense', 'error');
    }
});
    // ============================================
    // DEPOSITS PAGE
    // ============================================
  async function loadDeposits() {
    // 1. UI Logic (Show/Hide Split View based on role)
    const isUser = currentUser.role === 'user';
    if (isUser) {
        document.getElementById('depositSplitView').style.display = 'none';
    } else {
        document.getElementById('depositSplitView').style.display = 'grid';
    }

    if (!currentCycleId) return;

    // 2. Get Filter Value
    const filterId = document.getElementById('depositLogFilter').value;

    try {
        // 3. Build Query
        let query = supabase
            .from('deposits')
            .select('*, members(name)')
            .eq('cycle_id', currentCycleId)
            .order('created_at', { ascending: false });

        // 4. Apply Filter if selected
        if (filterId) {
            query = query.eq('member_id', filterId);
        }

        const { data, error } = await query;

        if (error) throw error;

        const container = document.getElementById('depositList');

        if (!data || data.length === 0) {
            container.innerHTML = '<div class="loading">No transactions found</div>';
            return;
        }

        // 5. Render List
        container.innerHTML = data.map(deposit => {
            const isNegative = deposit.amount < 0;
            const colorClass = isNegative ? 'balance-negative' : 'balance-positive';
            
            return `
            <div class="list-item">
                <div class="list-item-info">
                    <div class="list-item-title">${deposit.label || (isNegative ? 'Charge' : 'Deposit')}</div>
                    <div class="list-item-subtitle">
                        ${formatDate(deposit.created_at)} ‚Ä¢ ${deposit.members?.name || 'Unknown'}
                        ${deposit.notes ? `<br>${deposit.notes}` : ''}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div class="list-item-amount ${colorClass}">${formatCurrency(deposit.amount)}</div>
                </div>
            </div>
            `;
        }).join('');

    } catch (err) {
        console.error('Error loading deposits:', err);
    }
}


function autoUpdateDepositLabel() {
    const type = document.getElementById('depositType').value;
    const labelInput = document.getElementById('depositLabel');
    
    // Only update if the user hasn't typed something custom yet (optional logic, 
    // strictly replacing is usually safer for UX in this context)
    if (type === 'charge') {
        labelInput.value = 'Reduction';
    } else {
        labelInput.value = 'Deposit';
    }
}

async function loadSelectedMemberHistory(memberId) {
    const container = document.getElementById('selectedMemberHistoryList');
    const nameLabel = document.getElementById('historyMemberName');
    
    if (!memberId) {
        container.innerHTML = '<div class="history-empty">Select a member to view their specific log.</div>';
        nameLabel.textContent = "No member selected";
        return;
    }

    // Update Name Label
    const member = allMembers.find(m => m.id == memberId);
    nameLabel.textContent = member ? member.name : 'Unknown';

    container.innerHTML = '<div class="loading" style="padding:10px;">Loading history...</div>';

    try {
        const { data, error } = await supabase
            .from('deposits')
            .select('*')
            .eq('cycle_id', currentCycleId)
            .eq('member_id', memberId)
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!data || data.length === 0) {
            container.innerHTML = '<div class="history-empty">No transactions found for this cycle.</div>';
            return;
        }

        container.innerHTML = data.map(t => {
            const isNegative = t.amount < 0;
            const colorClass = isNegative ? 'balance-negative' : 'balance-positive';
            const dateStr = new Date(t.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            
            return `
            <div style="padding: 10px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 600; font-size: 13px;">${t.label || (isNegative ? 'Charge' : 'Deposit')}</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">${dateStr}</div>
                </div>
                <div class="${colorClass}" style="font-weight: 700; font-size: 14px;">
                    ${formatCurrency(t.amount)}
                </div>
            </div>
            `;
        }).join('');

    } catch (err) {
        console.error("Error loading member history:", err);
        container.innerHTML = '<div class="history-empty" style="color:red">Error loading data.</div>';
    }
}

document.getElementById('depositForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const memberId = parseInt(document.getElementById('depositMember').value);
    const type = document.getElementById('depositType').value;
    const rawAmount = parseFloat(document.getElementById('depositAmount').value);
    const label = document.getElementById('depositLabel').value;
    const notes = document.getElementById('depositNotes').value;
    
    // Logic: Charge is negative, Deposit is positive
    const finalAmount = type === 'charge' ? -Math.abs(rawAmount) : Math.abs(rawAmount);

    try {
        await supabase
            .from('deposits')
            .insert({
                cycle_id: currentCycleId,
                member_id: memberId,
                amount: finalAmount,
                label: label,
                notes: notes
            });

        const member = allMembers.find(m => m.id === memberId);
        const editorName = currentUser.members ? currentUser.members.name : currentUser.username;
        
        // Custom Log Message
        let logMessage = '';
        if (type === 'charge') {
            logMessage = `Charge Deduction: ${formatCurrency(finalAmount)} applied to ${member?.name} (${label}) by ${editorName}`;
        } else {
            logMessage = `Deposit Added: ${formatCurrency(finalAmount)} for ${member?.name}`;
        }

        await logActivity(logMessage, 'deposit');

        // Form Cleanup
        document.getElementById('depositAmount').value = '';
        document.getElementById('depositNotes').value = '';
        // Note: We do NOT reset member ID so the admin can add multiple for same person easily
        // We do NOT reset type/label automatically to keep workflow smooth
        
        // Refresh Lists
        await loadDeposits(); // Global List
        await loadSelectedMemberHistory(memberId); // Right Side List
        
        showNotification('Transaction successful', 'success');

    } catch (err) {
        console.error('Error processing transaction:', err);
        showNotification('Failed to process transaction', 'error');
    }
});



    // ============================================
    // ADMIN PAGE
    // ============================================
    
    async function loadAdmin() {
        await loadMembersList();
    }

    document.getElementById('createCycleForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = document.getElementById('cycleName').value;
        const startDate = document.getElementById('cycleStartDate').value;
        const endDate = document.getElementById('cycleEndDate').value;

        try {
            // Deactivate all cycles first
            await supabase
                .from('cycles')
                .update({ is_active: false })
                .neq('id', 0);

            // Create new cycle
            await supabase
                .from('cycles')
                .insert({
                    name: name,
                    start_date: startDate,
                    end_date: endDate,
                    is_active: true
                });

            await logActivity(`New cycle created: ${name}`, 'other');

            document.getElementById('createCycleForm').reset();
            await loadCycles();
            showNotification('Cycle created successfully', 'success');

        } catch (err) {
            console.error('Error creating cycle:', err);
            showNotification('Failed to create cycle', 'error');
        }
    });

    document.getElementById('closeMonthBtn').addEventListener('click', async () => {
        if (!confirm('Are you sure you want to close this month? This will calculate final balances.')) {
            return;
        }

        // Implementation for closing month and carrying forward balances
        showNotification('Month closing feature coming soon', 'info');
    });

    document.getElementById('addMemberForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = document.getElementById('memberName').value;

        try {
            // 1. Insert Member
            const { data: memberData, error: memberError } = await supabase
                .from('members')
                .insert({ name: name })
                .select()
                .single();
            
            if (memberError) throw memberError;

            // 2. Automatically create User
            const defaultPass = await hashPassword("123");
            
            await supabase.from('users').insert({
                username: name,
                password: defaultPass,
                role: 'user',
                member_id: memberData.id
            });

            await logActivity(`New member added & user created: ${name}`, 'other');

            document.getElementById('addMemberForm').reset();
            await loadMembers();
            await loadMembersList();
            showNotification('Member added successfully. Default password is "123"', 'success');

        } catch (err) {
            console.error('Error adding member:', err);
            showNotification('Failed to add member', 'error');
        }
    });

  async function loadMembersList() {
    const container = document.getElementById('membersList');
    container.innerHTML = '<div class="loading">Loading members...</div>';

    try {
        // FIXED: Only fetch members. All info (role, user_id) is now in this table.
        const { data: members, error } = await supabase
            .from('members')
            .select('*')
            .order('name');
        
        if (error) throw error;

        if (!members || members.length === 0) {
            container.innerHTML = '<div class="loading">No members yet</div>';
            return;
        }

        container.innerHTML = members.map(member => {
            const isManager = member.role === 'manager';
            const isAdmin = member.role === 'admin';
            const hasLogin = member.user_id !== null;

            return `
            <div class="list-item" style="flex-wrap: wrap; gap: 10px;">
                <div class="list-item-info" style="min-width: 200px;">
                    <div class="list-item-title">
                        ${member.name} 
                        ${isAdmin ? '<span style="font-size:10px; background:#4F46E5; color:white; padding:2px 6px; border-radius:4px;">ADMIN</span>' : ''}
                        ${isManager ? '<span style="font-size:10px; background:#10B981; color:white; padding:2px 6px; border-radius:4px;">MANAGER</span>' : ''}
                    </div>
                    <div class="list-item-subtitle">
                        Status: ${hasLogin ? '<span style="color:var(--success-color)">Active User</span>' : '<span style="color:var(--warning-color)">No Login Linked</span>'}
                        <br>${member.email || ''}
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px;">
                    ${!isAdmin ? `
                    <button class="btn btn-sm ${isManager ? 'btn-secondary' : 'btn-success'}" 
                            onclick="toggleManagerRole('${member.id}', '${member.role}')">
                        ${isManager ? 'Demote' : 'Make Manager'}
                    </button>
                    ` : ''}
                    
                    <button class="btn btn-sm btn-primary" 
                            onclick="openEditMemberModal('${member.id}', '${member.name}', '')">
                        Edit
                    </button>
                </div>
            </div>
            `;
        }).join('');

    } catch (err) {
        console.error('Error loading members list:', err);
        container.innerHTML = '<div class="loading" style="color:red">Error loading list</div>';
    }
}


// --- Action 1: Toggle Manager Role ---
async function toggleManagerRole(memberId, currentRole) {
    const isManager = currentRole === 'manager';
    const newRole = isManager ? 'user' : 'manager';
    
    if (!confirm(`Change role to ${newRole}?`)) return;

    try {
        const { error } = await supabase
            .from('members')
            .update({ role: newRole })
            .eq('id', memberId);

        if (error) throw error;

        showNotification('Role updated successfully', 'success');
        await loadMembersList();

    } catch (err) {
        console.error('Role update error:', err);
        showNotification('Failed to update role', 'error');
    }
}

// --- Action 2: Delete Member ---
async function deleteMember(memberId, userId) {
    if (!confirm('WARNING: Deleting a member will remove their user account. If they have existing meal/deposit records, this might fail or cause data issues. Continue?')) return;

    try {
        // 1. Delete User Account first (if exists)
        if (userId) {
            const { error: uError } = await supabase.from('users').delete().eq('id', userId);
            if (uError) throw uError;
        }

        // 2. Delete Member
        const { error: mError } = await supabase.from('members').delete().eq('id', memberId);
        if (mError) {
            // If foreign key constraint fails (has meals/deposits)
            throw new Error("Cannot delete member: They likely have associated meals or deposits.");
        }

        showNotification('Member deleted successfully', 'success');
        await loadMembersList();
        await loadMembers(); // Refresh global list

    } catch (err) {
        console.error('Delete error:', err);
        showNotification(err.message, 'error');
    }
}

// --- Action 3: Edit Member (Modal & Save) ---
function openEditMemberModal(memberId, currentName, userId) {
    document.getElementById('editMemberId').value = memberId;
    document.getElementById('editUserId').value = userId;
    document.getElementById('editMemberName').value = currentName;
    document.getElementById('editMemberPassword').value = ''; // Reset password field
    document.getElementById('editMemberModal').classList.add('active');
}

document.getElementById('editMemberForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const memberId = document.getElementById('editMemberId').value;
    const userId = document.getElementById('editUserId').value;
    const newName = document.getElementById('editMemberName').value;
    const newPassword = document.getElementById('editMemberPassword').value;

    try {
        // 1. Update Member Name
        const { error: mError } = await supabase
            .from('members')
            .update({ name: newName })
            .eq('id', memberId);
        
        if (mError) throw mError;

        // 2. Update User (Username and optionally Password)
        if (userId) {
            const userUpdates = { username: newName }; // Sync username with member name
            
            if (newPassword && newPassword.trim() !== "") {
                userUpdates.password = await hashPassword(newPassword);
            }

            const { error: uError } = await supabase
                .from('users')
                .update(userUpdates)
                .eq('id', userId);

            if (uError) throw uError;
        }

        document.getElementById('editMemberModal').classList.remove('active');
        showNotification('Member updated successfully', 'success');
        await loadMembersList();
        await loadMembers(); // Refresh global list

    } catch (err) {
        console.error('Edit error:', err);
        showNotification('Failed to update member: ' + err.message, 'error');
    }
});


    // ============================================
    // UTILITY: LOG ACTIVITY
    // ============================================
    
async function logActivity(message, type = 'info') {
    try {
        await supabase
            .from('notifications')
            .insert({
                cycle_id: currentCycleId,
                message: message,
                type: type,
                member_id: currentUser?.member_id // Use member_id, not UUID
            });
    } catch (err) {
        console.error('Error logging activity:', err);
    }
}


async function triggerManualAutoEntry() {
    if (!confirm("‚ö†Ô∏è Are you sure? \n\nThis will FORCE the system to copy all 'Meal Plans' into the 'Tracker' for Today's Night and Tomorrow's Day.\n\nThis overwrites the tracker with the plans immediately.")) {
        return;
    }

    const btn = document.querySelector('button[onclick="triggerManualAutoEntry()"]');
    const originalText = btn.textContent;
    btn.textContent = "Running...";
    btn.disabled = true;

    try {
        // Call the RPC function with force_run = true
        const { error } = await supabase.rpc('handle_auto_meal_entry', { force_run: true });

        if (error) throw error;

        showNotification("‚úÖ Auto-entry forced successfully!", "success");
        await updateEntryStatusIndicator(); // <--- REFRESH BADGE IMMEDIATELY
        await loadDashboard(); // Reload logs
        await loadMasterTracker(); // Update tracker view if looking at it

    } catch (err) {
        console.error("Force Run Error", err);
        showNotification("Failed to run automation: " + err.message, "error");
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}


// ==========================================
// ENTRY STATUS INDICATOR LOGIC
// ==========================================

async function updateEntryStatusIndicator() {
    // 1. Get Today's Date (in BD Time ideally, or Local)
    // Since JS runs on client, we construct the local date string
    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];
    
    // Calculate Tomorrow's Date for display
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    
    // Formatting Helpers
    const format = (d) => d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });

    try {
        // 2. Check Database for Today's Log
        const { data, error } = await supabase
            .from('system_logs')
            .select('id')
            .eq('log_date', todayStr)
            .maybeSingle(); // Use maybeSingle to avoid 406 error if 0 rows

        const badge = document.getElementById('entryStatusBadge');
        
        if (data) {
            // CASE: Log Found -> Auto Entry is DONE
            // Show Tomorrow's Date (Targeting next)
          badge.innerHTML =
  '<span style="color:#555;font-weight:600">Target:</span> ' +
  '<span style="color:#e63946;font-weight:bold">' + format(tomorrow) + '</span>' +
  '<span style="color:#1d3557"> Bazar</span>';

            badge.className = 'entry-status-badge status-done';
            badge.title = "Today's entry is finalized. System is targeting tomorrow.";
        } else {
            // CASE: No Log -> Auto Entry is PENDING
            // Show Today's Date (Active)
            badge.textContent = `Active: ${format(now)}`;
            badge.className = 'entry-status-badge status-pending';
            badge.title = "Waiting for Auto-Entry time.";
        }

    } catch (err) {
        console.error("Status Check Error", err);
    }
}


async function loadSystemStatus() {
    const container = document.getElementById('systemStatusContent');
    const dateDisplay = document.getElementById('statusDateDisplay');
    
    // 1. Get Today's Date (Local/BD)
    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];
    const niceDate = now.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' });
    
    if(dateDisplay) dateDisplay.textContent = niceDate;

    try {
        // 2. Fetch Log for Today
        const { data: log, error } = await supabase
            .from('system_logs')
            .select('*')
            .eq('log_date', todayStr)
            .maybeSingle();

        // 3. Render State
        if (log) {
            // === STATE: SUCCESS ===
            const runTime = new Date(log.executed_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            container.innerHTML = `
                <div class="status-box success">
                    <div class="status-icon">‚úÖ</div>
                    <div>
                        <div class="status-title">System Auto-Entry Completed</div>
                        <div class="status-desc">
                            The system successfully snapshotted meal plans and finalized the tracker.
                        </div>
                        <div class="status-meta">
                            LOG ID: #${log.id} ‚Ä¢ RUN TIME: ${runTime}
                        </div>
                        <div style="margin-top:5px; font-size:11px; font-style:italic;">
                            "${log.details}"
                        </div>
                    </div>
                </div>
            `;
        } else {
            // === STATE: PENDING ===
            // Get target time from our config variable
            const targetTime24 = appConfig.auto_entry_time || '18:30';
            const [h, m] = targetTime24.split(':');
            const targetTime12 = new Date(0, 0, 0, h, m).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

            container.innerHTML = `
                <div class="status-box pending">
                    <div class="status-icon">‚è≥</div>
                    <div>
                        <div class="status-title">Waiting for Auto-Entry</div>
                        <div class="status-desc">
                            System is monitoring for the scheduled time. Meal plans are still editable.
                        </div>
                        <div class="status-meta">
                            SCHEDULED TIME: ${targetTime12}
                        </div>
                    </div>
                </div>
            `;
        }

    } catch (err) {
        console.error("Status Load Error", err);
        container.innerHTML = '<div style="color:red; font-size:12px;">Failed to load status.</div>';
    }
}

</script>
</body>
</html>
