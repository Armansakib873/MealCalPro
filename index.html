<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MealCal Pro</title>
   <style>

@import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;700&display=swap');

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Noto+Sans+Bengali:wght@400;500;600;700;800&family=Poppins:wght@500;600;700;800&display=swap');
body {
    font-family: 'Hind Siliguri', -apple-system, sans-serif;
}

/* Ensure numeric values use the font */
/* .stat-value, .pulse-val, .log-amount, .balance-tag {
    font-family: 'Hind Siliguri', sans-serif !important;
    font-weight: 700;
} */


        /* =========================================
           1. THEME VARIABLES
           ========================================= */
        :root {

            
               /* --- BRAND COLORS --- */
    --primary-color: #059669;       /* Emerald 600 - The main brand color */
     --secondary-color: #10B981;
    --primary-dark: #047857;        /* Emerald 700 - Hover states/Text */
    --primary-soft: #ecfdf5;        /* Emerald 50 - Background tints */


         
              /* --- NEUTRALS (The Pro Look) --- */
    --bg-color: #f8fafc;            /* Slate 50 - Very subtle cool grey background */
    --card-bg: #ffffff;             /* Pure White - Critical for "clean" look */
    --text-primary: #0f172a;        /* Slate 900 - Almost black, softer than #000 */
    --text-secondary: #64748b;      /* Slate 500 - Perfect for subtitles */
    --border-color: #e2e8f0;        /* Slate 200 - Subtle borders */


              /* --- SEMANTIC COLORS --- */
    --success-color: #10b981;       /* Green for positive money */
    --danger-color: #f43f5e;        /* Rose 500 - Softer, modern red for expense/debt */
    --warning-color: #f59e0b;       /* Amber - For alerts */
            
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);


    --premium-indigo: #33a5be;
    --premium-slate: #f8fafc;
    --soft-emerald: #ecfdf5;
    --soft-rose: #fff1f2;
    --text-muted: #64748b;
    --glass: rgba(255, 255, 255, 0.8);

     /* --- TYPOGRAPHY VARIABLES --- */
    --font-primary: 'Inter', 'Noto Sans Bengali', -apple-system, sans-serif;
    --font-heading: 'Poppins', 'Noto Sans Bengali', sans-serif;
    --font-mono: 'Inter', monospace; /* Using Inter with tabular-nums feature */

      /* --- SPECIFIC UI ELEMENTS --- */
    --nav-bg: #ffffff;              /* White bottom nav for clean look */
    --nav-active-bg: #f0fdf4;       /* Soft green pill for active nav items */
    --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.05);

            
            /* Dimensions */
            --header-height: 60px;
            --bottom-nav-height: 70px;
        }

        [data-theme="dark"] {
            --bg-color: #111827;
            --card-bg: #1F2937;
            --text-primary: #F9FAFB;
            --text-secondary: #9CA3AF;
            --border-color: #374151;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            /* font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; */
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            /* Padding top to ensure content isn't hidden behind fixed header */
            padding-top: var(--header-height); 
        }

        body {
    font-family: var(--font-primary);
    /* Improves font rendering on modern screens */
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}



/* 2. Hide for Chrome, Safari, and all Webkit browsers */
*::-webkit-scrollbar {
    display: none !important;
    width: 0 !important;
    height: 0 !important;
}



/* 1. Brand and Headings get the premium "Poppins" look */
.app-logo, .auth-app-name, h1, h2, h3, .card-title, .modal-title {
    font-family: var(--font-heading);
    letter-spacing: -0.02em; /* Tighter tracking for modern look */
}

/* 2. Numeric values need to be clear and distinct */
/* We force English font for numbers for alignment, but keep Bengali if text is mixed */
.stat-value, 
.pulse-val, 
.log-amount, 
.balance-tag, 
.clock-time,
.amt-whole,
.amt-decimal {
    font-family: var(--font-mono) !important;
    font-feature-settings: "tnum"; /* Tabular numbers (prevents jumping when numbers change) */
    letter-spacing: -0.03em;
}

/* 3. Bengali Specific Elements (Menu items, dates) */
.pulse-header-title,
.slot-date,
.slot-label,
.slot-menu,
.dash-welcome-row p {
    font-family: 'Noto Sans Bengali', var(--font-primary);
}

/* 3. Fix the Login Wrapper to prevent the bottom/side bars */
.auth-page-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    margin: 0 !important;
    padding: 0 !important;
    overflow: hidden !important;
    z-index: 99999;
    background-color: #21122e;
}

        /* =========================================
           2. LAYOUT CONTAINERS
           ========================================= */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Fixed Header */
        .app-header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: var(--header-height);
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 900; 
            box-shadow: var(--shadow);
        }

        /* --- Header Logo Styling --- */
.header-logo-icon {
    height: 35px; /* Adjust based on your logo shape */
    width: auto;
    margin-right: 5px;
    object-fit: contain;
}

/* --- Splash Screen (First Loader) --- */
.splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.7); /* Transparent white */
    backdrop-filter: blur(15px); /* This creates the "blurred app vision" */
    -webkit-backdrop-filter: blur(15px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999; /* Top of everything */
    transition: opacity 0.5s ease, visibility 0.5s;
}

/* Prevent anything from showing behind the loader during auth check */
#authPage.hidden, #mainApp.hidden {
    display: none !important;
}

/* Ensure Splash is the absolute top layer */
.splash-screen {
    z-index: 10000; /* Higher than auth wrapper (9999) */
    background: #21122e; /* Match your app background to prevent white flashes */
}

.splash-content {
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.splash-logo-large {
    width: 120px; /* Adjust size */
    height: auto;
    margin-bottom: 20px;
    animation: pulse-logo 2s infinite ease-in-out;
}

.splash-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #e2e8f0;
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}

.splash-text {
    font-size: 14px;
    font-weight: 700;
    color: var(--primary-color);
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Update the splash-hidden class to use visibility instead of removal */
.splash-hidden {
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: none;
    transition: opacity 0.8s ease, visibility 0.8s;
}

/* Animations */
@keyframes pulse-logo {
    0% { transform: scale(1); filter: drop-shadow(0 0 0px rgba(35, 120, 4, 0)); }
    50% { transform: scale(1.05); filter: drop-shadow(0 0 15px rgba(35, 120, 4, 0.2)); }
    100% { transform: scale(1); filter: drop-shadow(0 0 0px rgba(35, 120, 4, 0)); }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}


/* --- Splash Video Styling --- */
.splash-video-asset {
    width: 320px; /* Size of your animation */
    height: auto;
    border-radius: 24px; /* Optional: adds rounded corners to video */
    margin-bottom: 20px;
    /* Keeps the blurred vision look consistent */
    /* filter: drop-shadow(0 10px 20px rgba(0,0,0,0.1));  */
}

/* --- Clean Progress Bar --- */
.loader-progress-container {
    width: 150px;
    height: 3px;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 10px;
    overflow: hidden;
    margin-top: 15px;
}

.loader-progress-bar {
    width: 0%;
    height: 100%;
    background: var(--primary-color);
    transition: width 0.4s ease;
}

/* Ensure splash text looks premium under the video */
.splash-text {
    font-family: 'Segoe UI', Roboto, sans-serif;
    font-size: 11px;
    font-weight: 800;
    color: var(--text-secondary);
    letter-spacing: 2px;
    margin-top: 10px;
}



/* Ensure splash is visible by default when the page loads */
.splash-screen {
    position: fixed;
    top: 0; left: 0; 
    width: 100%; height: 100%;
   /* Radial gradient */
    background: #FEFEFE ;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    display: flex; justify-content: center; align-items: center;
    z-index: 9999;
    opacity: 1;
    visibility: visible;
}



     /* --- 1. Position Badge top-right of Logo --- */
.header-left {
    position: relative;
    display: flex;
    align-items: center;
}

.app-logo {
    font-weight: 800;
    font-size: 20px;
    color: var(--primary-color);
    padding-right: 10px; /* Space for the badge overlap if needed */
}

.cycle-badge {
    position: absolute;
        top: 2px;
    right: -60px;
    font-size: 9px;
    padding: 1px 4px;
    border-radius: 8px;
    background-color: rgb(229 237 252 / 94%);
    color: #464646;
    border: 1px solid white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    white-space: nowrap;
    z-index: 10;
}



.header-right{
    display: flex;
    align-items: center;
    gap: 15px;
}

/* --- 2. Manage User Info in Mobile View --- */
@media (max-width: 768px) {

    .cycle-badge {
        font-size: 8px;
            top: 25px;
    right: 20px;
    }


    /* REMOVE the display:none and manage it instead */
    .user-info { 
        display: flex !important; /* Force display */
        flex-direction: column;
        align-items: flex-end;
        margin-right: 5px;
    }

    .user-name { 
        font-size: 8px; /* Smaller for mobile */
        max-width: 80px; /* Prevent long names from breaking header */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .user-role { 
        display: block !important; /* Ensure role is visible */
        font-size: 8px; 
        opacity: 0.8;
    }

    /* Adjust logo/badge for mobile if too crowded */
    .app-logo { font-size: 15px; }
    
    .header-right {
        gap: 5px; /* Tighter gap */
    }

    /* Fix clock container to make room for user info */
    .header-clock {
        margin: 0 auto; /* Center it */
        transform: scale(0.9); /* Slightly smaller to save space */
    }
}

        .user-info { text-align: right; line-height: 1.2; }
        .user-name { font-weight: 600; font-size: 10px; }
        .user-role { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }

        .header-clock {
            display: flex; flex-direction: column; align-items: center;
            font-variant-numeric: tabular-nums;
        }
        .clock-time { font-size: 16px; font-weight: 700; color: var(--text-primary); }
        .clock-date { font-size: 10px; color: var(--text-secondary); }

        /* =========================================
           3. SIDEBAR & NAVIGATION
           ========================================= */
        .sidebar {
            width: 260px;
            background-color: var(--card-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            position: fixed;
            top: var(--header-height);
            bottom: 0;
            z-index: 800;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .main-content {
            flex: 1;
            margin-left: 260px; /* Offset for sidebar */
            padding: 20px;
            width: 100%;
        }

        .nav-menu { list-style: none; }
        .nav-item { margin-bottom: 5px; }
        
        .nav-link {
            display: flex; align-items: center;
            padding: 10px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
            font-weight: 500;
        }
        .nav-link:hover, .nav-link.active { background-color: var(--primary-color); color: white; }
        .nav-icon { margin-right: 12px; font-size: 18px; }

        /* Mobile Bottom Nav */
     /* --- High-Density Bottom Nav (7 Items) --- */
.bottom-nav {
    display: none; /* Hidden on Desktop */
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background-color: #4e8297;
    border-top: 1px solid var(--border-color);
    height: 65px; /* Slightly shorter to feel tighter */
    z-index: 1000;
    padding-bottom: env(safe-area-inset-bottom);
    box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
}

.bottom-nav-list {
    display: flex;
    justify-content: space-around;
    align-items: center;
    list-style: none;
    height: 100%;
    margin: 0;
    padding: 0;
}

.bottom-nav-item {
    flex: 1; /* Each item takes exactly 1/7th of width */
    height: 100%;
}

.bottom-nav-link {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-decoration: none;
    color: #ffffff;
    transition: all 0.2s ease;
}

.bottom-nav-link span:first-child {
    font-size: 18px; /* Reduced icon size to fit more items */
    margin-bottom: 2px;
    display: block;
}

.bottom-nav-link label {
    font-size: 8px; /* Ultra-compact labels */
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0px;
    cursor: pointer;
}

/* Active State: Premium Indigo Lift */
.bottom-nav-link.active {
    color: var(--premium-indigo);
}

.bottom-nav-link.active span:first-child {
    transform: translateY(-3px);
}

/* --- Mobile Visibility Override --- */
@media (max-width: 768px) {
    .bottom-nav { display: block; }
    
    /* Ensure content padding-bottom is adjusted for fixed nav */
    .main-content {
        padding-bottom: 80px; 
    }
}

        /* Sidebar Overlay Styling */
.sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2400; /* Just below the sidebar (2500) */
    backdrop-filter: blur(2px);
}

.sidebar-overlay.active {
    display: block;
}

/* Ensure Bottom Nav active icons stand out */
.bottom-nav-link.active span:first-child {
    transform: translateY(-5px);
    display: inline-block;
    transition: transform 0.2s ease;
}

.bottom-nav-link.active {
    color: var(--primary-color) !important;
    font-weight: 800;
    background-color: rgba(254, 255, 237, 0.808);
    border: 1px solid #1E40AF;
    border-radius: 12px;
}


.defaults-toggles{
    display: flex; gap: 10px;
    border-radius: 15px;;
}
        /* =========================================
           4. CARDS & GRID
           ========================================= */
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px;
        }
        .card-title { font-size: 16px; font-weight: 600; color: var(--text-primary); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            display: flex; flex-direction: column; justify-content: space-between;
        }
        
        
        .stat-label {     font-size: 18px;
    opacity: 0.9;
    margin-bottom: 5px;
    color: #fff;
    font-weight: 700;
}
        .stat-value { font-size: 24px; font-weight: 700; }

        /* =========================================
           5. FORMS & BUTTONS
           ========================================= */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-size: 14px;
            /* Fix for iOS zooming on input focus */
            appearance: none; 
        }
        .form-textarea { min-height: 80px; resize: vertical; }

        .btn {
            padding: 10px 16px;
            border: none; border-radius: 8px;
            font-size: 14px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
            display: inline-flex; align-items: center; justify-content: center;
            gap: 5px;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-secondary { background-color: #e5e7eb; color: var(--text-primary); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        /* =========================================
           6. NOTIFICATIONS & MODALS
           ========================================= */
        .notif-btn { background: none; border: none; font-size: 22px; position: relative; padding: 5px; cursor: pointer; }
        .notif-badge {
            position: absolute; top: 0; right: 0;
            background-color: var(--danger-color); color: white;
            font-size: 9px; width: 14px; height: 14px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }

        .notif-panel {
            position: fixed;
            top: var(--header-height);
            right: -400px; /* Hidden */
            width: 350px;
            height: calc(100vh - var(--header-height));
            background-color: var(--card-bg);
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            z-index: 1100; /* Above bottom nav */
            transition: right 0.3s ease;
            display: flex; flex-direction: column;
        }
        .notif-panel.active { right: 0; }
        
        .notif-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .notif-list { flex: 1; overflow-y: auto; padding: 10px; }
        .notif-item {
            padding: 10px; border-radius: 8px; background-color: var(--bg-color);
            margin-bottom: 8px; border-left: 4px solid transparent; cursor: pointer;
        }
        .notif-item.type-deposit { border-left-color: var(--success-color); }
        .notif-item.type-expense { border-left-color: var(--danger-color); }
        .notif-item.type-meal { border-left-color: var(--warning-color); }

        .notif-filters { display: flex; gap: 5px; padding: 10px; overflow-x: auto; border-bottom: 1px solid var(--border-color); }
        .filter-chip {
            padding: 4px 10px; border-radius: 15px; font-size: 11px;
            border: 1px solid var(--border-color); background: var(--card-bg); white-space: nowrap;
        }
        .filter-chip.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center; justify-content: center;
            padding: 20px;
        }
        .modal.active { display: flex; }
        
        .modal-content {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            width: 100%; max-width: 450px;
            max-height: 90vh; overflow-y: auto;
            position: relative;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-modal { font-size: 24px; padding: 5px; cursor: pointer; color: var(--text-secondary); }

        /* =========================================
           7. TABLES, LISTS & SPECIAL COMPONENTS
           ========================================= */
        .list-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .list-item:last-child { border-bottom: none; }
        .list-item-title { font-weight: 600; font-size: 14px; }
        .list-item-subtitle { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        .list-item-amount { font-weight: 700; font-size: 14px; }

        .balance-positive { color: var(--success-color); }
        .balance-negative { color: var(--danger-color); }

        /* Scheduler Horizontal Scroll */
        .scheduler-container { margin-top: 15px; }
        .scheduler-scroll {
            display: flex; overflow-x: auto; gap: 10px; padding: 5px 2px;
            -webkit-overflow-scrolling: touch; /* Smooth iOS scroll */
            scrollbar-width: none;
        }

#profilePage .scheduler-scroll {
    display: flex !important;           /* Force cards into a row */
    flex-direction: row !important;     /* Ensure horizontal direction */
    overflow-x: auto !important;        /* Enable side scrolling */
    flex-wrap: nowrap !important;       /* Prevent stacking onto new lines */
    gap: 12px;                          /* Space between cards */
    padding: 5px 2px 15px 2px;          /* Padding (extra bottom for scrollbar) */
    width: 100%;                        /* Full width of container */
    -webkit-overflow-scrolling: touch;  /* Smooth scroll on iPhone */
    scrollbar-width: none;              /* Hide scrollbar on Firefox */
}

/* Hide scrollbar on Chrome/Safari/Edge */
#profilePage .scheduler-scroll::-webkit-scrollbar {
    display: none;
}

/* Ensure the cards have a fixed width so they don't squash */
#profilePage .scheduler-card {
    flex: 0 0 auto;        /* Don't grow, don't shrink, stay fixed */
    width: 150px;          /* Fixed card width */
    min-width: 150px;      /* Force minimum width */
    margin-right: 0;       /* Gap handles spacing */
}

/* Optional: Keep Desktop as Grid (If you want PC to be a grid, keep this) */
@media (min-width: 769px) {
    #profilePage .scheduler-scroll {
        display: grid !important;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)) !important;
        overflow-x: visible !important;
        flex-wrap: wrap !important;
    }
    
    #profilePage .scheduler-card {
        width: auto; /* Let grid control width on PC */
    }
}
        /* Matrix Table */
        .matrix-wrapper {
            overflow: auto; max-height: 70vh;
            border: 1px solid var(--border-color); border-radius: 8px;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }
        .matrix-table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 12px; }
        .matrix-table th, .matrix-table td {
            padding: 0;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            min-width: 70px; height: 36px;
            text-align: center;
        }
        /* Sticky Headers */
        .matrix-table thead th { position: sticky; top: 0; background-color: var(--card-bg); z-index: 10; padding: 8px; }
        .matrix-table tbody td:first-child {
            position: sticky; left: 0; background-color: var(--bg-color);
            z-index: 5; border-right: 2px solid var(--border-color); padding: 4px;
        }
        .matrix-table thead th:first-child { left: 0; z-index: 20; background-color: var(--card-bg); }

        /* Matrix Cell Split */
        .cell-split { display: flex; width: 100%; height: 100%; }
        .cell-val {
            flex: 1; display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 700;
        }
        .cell-val.day-col { border-right: 1px solid var(--border-color); }
        .cell-val.active { background-color: rgba(16, 185, 129, 0.15); color: var(--success-color); }
        .cell-val.zero { color: #d1d5db; font-weight: 400; }

        /* Split View (Deposits) */
        .split-view-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .history-box { max-height: 400px; overflow-y: auto; background: var(--bg-color); padding: 10px; border-radius: 8px; }

        /* Toast */
        #toast-container {
            position: fixed; top: 10px; right: 20px; z-index: 3000;
            display: flex; flex-direction: column; gap: 10px; pointer-events: none;
        }
        .toast {
            pointer-events: auto; background: var(--card-bg); padding: 12px 16px;
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid var(--primary-color); display: flex; align-items: center; gap: 10px;
            min-width: 280px; animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* Status Badges & Box */
        .entry-status-badge { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 10px; text-transform: uppercase; }
        .status-pending { background: #FFF7ED; color: #C2410C; border: 1px solid #FED7AA; }
        .status-done { background: #ECFDF5; color: #047857; border: 1px solid #6EE7B7; }

        #entryStatusBadge {
    display: inline-block;
    min-width: 140px; /* Constant width prevents layout jumping */
    text-align: center;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    /* This makes the movement smooth */
    transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), 
                transform 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                background 0.3s ease;
    will-change: transform, opacity;
}

/* Red / Rose indicator for Current Debt */
.status-debt { 
    background: #FFF1F2 !important; 
    color: #E11D48 !important; 
    border: 1px solid #FECACA !important; 
}

/* Orange / Amber indicator for Previous Dues */
.status-due { 
    background: #FFFBEB !important; 
    color: #D97706 !important; 
    border: 1px solid #FDE68A !important; 
}

/* Blue indicator for Target Date */
.status-pending { 
    background: #F0F9FF !important; 
    color: #0369A1 !important; 
    border: 1px solid #BAE6FD !important; 
}

        .status-box { 
            padding: 8px;
             border-radius: 12px;
             display: flex; gap: 8px;
             font-size: 12px;
             margin: 0;
         }
        .status-box.success { background: #ECFDF5; border: 1px solid #b4d1c6c8; color: #065F46; }
        .status-box.pending { background: #fff7edb1; border: 1px solid #FED7AA; color: #9A3412; }
        
        /* Status Toggle Buttons (Summary Page) */
        .status-btn { padding: 4px 10px; border-radius: 15px; border:1px solid #ccc; cursor:pointer; font-size:10px; width:50px; }
        .status-btn.on { background: var(--success-color); color:white; border-color: var(--success-color); }
        .status-btn.off { background: var(--bg-color); color: var(--text-secondary); }


        /* Utils */
        .hidden { display: none !important; }
        .loading { text-align: center; padding: 20px; color: var(--text-secondary); font-size: 12px; }
        
        /* Profile Defaults */
        .defaults-container { background: var(--bg-color); padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;}
        .def-btn { padding: 4px 8px; font-size: 10px; border: 1px solid var(--border-color); background: var(--card-bg); border-radius: 4px; cursor: pointer; }
        .def-btn.active { background: var(--primary-color); color: white; }



        /* Styling for the main amount */
.amt-whole {
    font-weight: 800;
    font-size: 1.1em;
}

/* Styling for the decimals (.০০) */
.amt-decimal {
    font-weight: 400;
    color: #94a3b8; /* Faded Grey */
    font-size: 0.85em;
    opacity: 0.7;
}

/* If the amount is negative, we can style it red automatically */
.balance-negative .amt-whole {
    color: #ef4444; /* Red */
}


        /* =========================================
   PREMIUM AUTH PAGE CSS
   ========================================= */

.auth-page-wrapper {
    position: fixed; /* Changed from flex or relative to fixed */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #21122e; /* Your purple color */
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999; /* Ensure it's above everything */
    overflow-y: auto;
}
/* Background Aurora Glows */
.auth-bg-glow {
    position: absolute;
    width: 400px;
    height: 400px;
    border-radius: 50%;
    filter: blur(100px);
    opacity: 0.15;
    z-index: 0;
}
.glow-1 { top: -100px; right: -100px; background: var(--primary-color); }
.glow-2 { bottom: -100px; left: -100px; background: #3b82f6; }

.auth-container-premium {
    width: 100%;
    max-width: 420px;
    position: relative;
    z-index: 10;
    animation: authFadeIn 0.8s ease-out;
}

@keyframes authFadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Branding */
.auth-brand {
    text-align: center;
    margin-bottom: 30px;
}
.auth-logo-img {
    width: 64px;
    height: auto;
    margin-bottom: 15px;
    filter: drop-shadow(0 4px 12px rgba(35, 120, 4, 0.3));
}
.auth-app-name {
    color: white;
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -1px;
}
.auth-app-name span { color: var(--primary-color); }
.auth-subtitle {
    color: #94a3b8;
    font-size: 14px;
    margin-top: 5px;
}

/* Glass Card */
.auth-card-premium {
    background: rgba(30, 41, 59, 0.7);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 24px;
    padding: 35px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
}

/* Input Styling */
.auth-input-group { margin-bottom: 20px; }
.auth-label {
    display: block;
    color: #cbd5e1;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
    margin-left: 4px;
}

.auth-input-wrapper {
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 14px;
    display: flex;
    align-items: center;
    padding: 0 15px;
    transition: all 0.3s;
}
.auth-input-wrapper:focus-within {
    border-color: var(--primary-color);
    background: rgba(15, 23, 42, 0.9);
    box-shadow: 0 0 0 4px rgba(35, 120, 4, 0.1);
}

.auth-input-icon { margin-right: 12px; font-size: 16px; opacity: 0.7; }

.auth-input-wrapper input {
    background: transparent;
    border: none;
    color: white;
    height: 50px;
    width: 100%;
    font-size: 15px;
    outline: none;
}
.auth-input-wrapper input::placeholder { color: #64748b; }

/* Combined Select & Input */
.auth-input-combined { display: flex; gap: 10px; }
.flex-main { flex: 1; }

.auth-select-mini {
    background: rgba(30, 41, 59, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 14px;
    color: white;
    padding: 0 10px;
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    outline: none;
}

/* Submit Button */
.auth-submit-btn {
    width: 100%;
    height: 55px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 14px;
    font-size: 16px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    cursor: pointer;
    transition: all 0.3s;
    margin-top: 10px;
}
.auth-submit-btn:hover {
    filter: brightness(1.1);
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(35, 120, 4, 0.2);
}
.auth-submit-btn:active { transform: translateY(0); }

/* Footer */
.auth-footer {
    margin-top: 25px;
    text-align: center;
    font-size: 14px;
    color: #94a3b8;
}
#authToggleBtn {
    background: none;
    border: none;
    color: var(--primary-color);
    font-weight: 700;
    cursor: pointer;
    margin-left: 5px;
    text-decoration: underline;
}

.auth-error-message {
    background: rgba(239, 68, 68, 0.1);
    border-left: 4px solid #ef4444;
    color: #f87171;
    padding: 12px;
    border-radius: 8px;
    font-size: 13px;
    margin-bottom: 20px;
    display: none;
}

.auth-legal {
    text-align: center;
    margin-top: 30px;
    font-size: 11px;
    color: #475569;
    letter-spacing: 1px;
    text-transform: uppercase;
}

/* PC Specific View Adjustments */
@media (min-width: 1024px) {
    .auth-container-premium { max-width: 450px; }
    .auth-card-premium { padding: 45px; }
}

/* Mobile Specific Tweaks */
@media (max-width: 480px) {
    .auth-card-premium { padding: 25px; border-radius: 30px; }
    .auth-app-name { font-size: 24px; }
}


/* --- Professional Profile Enhancements --- */
.profile-header-banner {
    height: 100px;
    background: radial-gradient(circle at top right, #069095, #021f2e);
    border-radius: 12px 12px 0 0;
    margin-bottom: -50px;
    padding: 15px;
}

.profile-info-section {
    text-align: center;
}

.profile-avatar-circle {
    position: relative;
    overflow: hidden; /* Ensures image doesn't leak out of circle */
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* This class will be added by JS if a photo exists */
.profile-avatar-circle.has-image {
    color: transparent !important; /* Hide initials */
}

.profile-avatar-circle img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
}

.profile-status-online {
    position: absolute;
    bottom: 5px;
    right: 5px;
    width: 18px;
    height: 18px;
    background: var(--success-color);
    border: 3px solid white;
    border-radius: 50%;
}

.profile-main-name {
    font-size: 22px;
    font-weight: 800;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.profile-main-meta {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 600;
}

/* Financial Card Stylings */
.balance-card-modern {
    background: #e2e4ae85;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.balance-card-modern.warning { border-left-color: var(--danger-color); }

/* 1. Positive State (Green) */
/* #profileBalanceCard.status-pos {
    background: linear-gradient(135deg, #064e3b 0%, #022c22 100%) !important;
    border: 1px solid #059669 !important;
}
#profileBalanceCard.status-pos .stat-value {
    color: #34d399 !important;
}

/* 2. Negative State (Reddish) */
#profileBalanceCard.status-neg {
    background: linear-gradient(135deg, #7f1d1d 0%, #450a0a 100%) !important;
    border: 1px solid #ef4444 !important;
    box-shadow: 0 10px 25px rgba(239, 68, 68, 0.2);
}

/* Make the text inside the red card readable (Light Red/White) */
#profileBalanceCard.status-neg .stat-value {
    color: #fca5a5 !important; /* Light Red Text */
}
#profileBalanceCard.status-neg .stat-label, 
#profileBalanceCard.status-neg .cycle-info-text {
    color: #fecaca !important; /* Very Light Red */
}
#profileBalanceCard.status-neg .btn-primary {
    background: #fca5a5 !important;
    color: #7f1d1d !important;
} */

/* Timeline Scheduler */
.scheduler-scroll {
    padding: 5px 5px;
    gap: 12px;
}

/* --- Premium Profile UI --- */
.profile-card-top {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.03);
    margin-bottom: 15px;
}

.avatar-premium {
    width: 54px;
    height: 54px;
    background: linear-gradient(135deg, #818cf8, #6366f1);
    color: white;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 20px;
    box-shadow: 0 4px 10px rgba(99, 102, 241, 0.2);
}

.profile-meta-mini h2 { font-size: 18px; margin: 0; }
.profile-meta-mini p { font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 700; }

/* Compact Balance Row */
.finance-row-compact {
    display: grid;
    grid-template-columns: 1.2fr 1fr 1fr;
    gap: 10px;
    margin-bottom: 15px;
}

.fin-box {
    background: white;
    padding: 10px;
    border-radius: 12px;
    border: 1px solid #f1f5f9;
}

.fin-box .label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; font-weight: 700; margin-bottom: 4px; }
.fin-box .val { font-size: 14px; font-weight: 800; font-family: 'Courier New', monospace; }

/* --- Compact Preferences (The Switches) --- */
.prefs-mini-card {
    background: #f1f5f9;
    padding: 10px 15px;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.pref-label { font-size: 12px; font-weight: 700; color: #334155; }
.pref-toggles-row { display: flex; gap: 8px; }

.toggle-pill {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 800;
    border: 1px solid #e2e8f0;
    background: white;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
}

.toggle-pill.active {
    background: var(--premium-indigo);
    color: white;
    border-color: var(--premium-indigo);
    box-shadow: 0 4px 8px rgba(99, 102, 241, 0.2);
}

/* --- Premium Scheduler --- */
/* --- Smart Scheduler Cards --- */
.scheduler-card {
    min-width: 155px;
    padding: 16px;
    background: #ffffff;
    border-radius: 28px;
    border: 1px solid #edf2f7;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.02);
    transition: transform 0.3s ease;
}

.scheduler-card.is-today {
    border: 2px solid #10b981;
    background: linear-gradient(to bottom, #f0fdf4, #ffffff);
}

.sched-date-main { font-size: 16px; font-weight: 800; color: #1a202c; margin-bottom: 2px;}
.sched-sub-label { font-size: 8px; font-weight: 700; color: #a0aec0; letter-spacing: 1.2px; margin-bottom: 15px; text-transform: uppercase; }

/* The "Smart" Buttons */
.sched-btn {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 14px;
    height: 46px;
    border-radius: 16px;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1.5px solid transparent;
    cursor: pointer;
}

/* Night Button: Midnight Glass Style (No more solid black) */
.night-btn { 
    background: #f8fafc; 
    color: #64748b; 
    border-color: #e2e8f0; 
}

.night-btn.active { 
    background: #0f172a; /* Deep Midnight */
    color: #10b981; 
    border-color: #0f172a;
    box-shadow: 0 8px 20px -6px rgba(15, 23, 42, 0.4);
}

/* Day Button: Soft Emerald Style */
.day-btn { 
    background: #f8fafc; 
    color: #64748b; 
    border-color: #e2e8f0; 
}

.day-btn.active { 
    background: #ffffff; 
    color: #059669; 
    border-color: #10b981;
    box-shadow: 0 8px 20px -6px rgba(16, 185, 129, 0.2);
}

/* The Status "Pill" */
.status-text {
    font-size: 9px;
    font-weight: 900;
    width: 34px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    background: #e2e8f0;
    color: #64748b;
    transition: all 0.2s ease;
}

/* Active Pill Colors */
.night-btn.active .status-text { 
    background: #10b981; 
    color: #ffffff; 
}

.day-btn.active .status-text { 
    background: #d1fae5; 
    color: #059669; 
}

.btn-label { font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 6px; }

/* Restricted Warning Logic Redesign */
.lock-badge {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

.lock-badge.is-restricted {
    background: #fff1f2 !important;
    border-color: #fecaca !important;
    color: #e11d48 !important;
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-2px); }
    75% { transform: translateX(2px); }
}

/* ============================================================
   DESKTOP PROFILE VIEW REFINEMENT (FIX)
   ============================================================ */
@media (min-width: 769px) {
    /* 1. Reset Header and Banner */
    #profilePage .profile-header-banner {
        height: 180px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        padding: 0 40px 0 200px; /* Space for the large avatar */
        justify-content: flex-start;
        border-radius: 16px;
    }

    #profilePage .profile-text-container {
        padding: 0;
        text-align: left;
    }


    /* 2. Reposition Avatar for Desktop */
    #profilePage .profile-info-section {
        position: absolute;
        top: 100px; /* Adjust based on your header height */
        left: 60px;
        margin: 0;
        z-index: 100;
    }

    #profilePage .profile-avatar-circle {
        width: 130px !important;
        height: 130px !important;
        font-size: 48px !important;
        box-shadow: var(--shadow-lg) !important;
    }

            .stat-label {     font-size: 18px;
    opacity: 0.9;
    margin-bottom: 5px;
    color: #fff;
    font-weight: 700;
}

        #profileCycleName{
            color: #bdbdbd;
        }

        .cycle-info-text{
            color: #d4d4d4;
            font-size: 14px;
        }


    }

    /* 3. Stats & Balance Row Layout */
    /* We will use a wrapper-like behavior via margins */
    #profilePage .profile-stats-mini {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 0px 0 20px 0;
        padding: 0;
    }

    #profilePage .profile-stat-item {
            margin: 10px;
    padding: 5px 15px !important;
    text-align: left;
    display: flex;
    flex-direction: column;
    background: #dfdfdf;
    border-radius: 18px;
    
    }

    .stat-mini-label{
            font-size: 0.8rem ;

    }
    .stat-mini-value{
        font-size: 1.4rem ;
        font-weight: 800 ;
        color: #000000;
    }

    /* 4. Balance Card Desktop Optimization */
    #profilePage #profileBalanceCard {
        margin: 0 0 30px 0 !important;
        padding: 30px !important;
        min-height: 140px !important;
    }

    #profilePage #profileBalanceCard .stat-value {
        font-size: 42px !important;
    }

    #profilePage .balance-card-right {
        gap: 15px;
    }

    /* 5. Scheduler Grid (Desktop) */
    #profilePage .scheduler-scroll {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        overflow-x: visible;
        gap: 20px;
    }

    #profilePage .scheduler-card {
        min-width: 0 !important; /* Allow grid to control width */
    }
}

/* --- 1. Wallet Balance Card States (Mobile & PC) --- */
#profileBalanceCard.status-pos {
    background: linear-gradient(135deg, #0f172a 0%, #020617 100%) !important;
}
#profileBalanceCard.status-pos .stat-value {
    color: #10b981 !important;
}

#profileBalanceCard.status-neg {
    background: linear-gradient(135deg, #450a0a 0%, #020617 100%) !important;
    border: 1px solid rgba(239, 68, 68, 0.3) !important;
}
#profileBalanceCard.status-neg .stat-value {
    color: #f87171 !important; /* Soft Red for contrast on black */
}

/* --- 2. Desktop View Profile Fix --- */
@media (min-width: 769px) {
    #profilePage .profile-header-banner {
        height: 200px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        padding: 0 60px 0 240px; 
        justify-content: space-between;
        border-radius: 16px;
        position: relative; /* Essential parent for absolute avatar */
    }

    #profilePage .profile-info-section {
        position: absolute;
        top: 100px; 
        left: 300px;
        margin: 0;
        z-index: 100;
        display: block !important; /* Ensure it stays visible */
    }

    #profilePage .profile-avatar-circle {
        width: 140px !important;
        height: 140px !important;
        font-size: 48px !important;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2) !important;
    }

    #profilePage .profile-avatar-circle img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }

    .profile-stat-item{
        box-shadow: inset 0 0 30px rgb(0 0 0 / 45%);
    }

    /* Fixed the overlapping banner text */
    #profilePage .profile-text-container {
        padding: 0;
        text-align: left;
        display: block !important;
    }

    #profilePage .profile-main-name {
        font-size: 32px !important;
        color: white !important;
        margin-top: 50px !important;
    }

    .profile-stats-mini{
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin: 40px 0 20px 0;
        padding: 0;
    }
}



/* Mobile Adjustments */
@media (max-width: 768px) {
    .finance-row-compact { grid-template-columns: 1fr 1fr; }
    .finance-row-compact .fin-box:first-child { grid-column: span 2; display: flex; justify-content: space-between; align-items: center; }
}

/* Mobile Specific Profile Fixes */
@media (max-width: 768px) {
    .profile-header-banner { height: 80px; margin-bottom: -35px; }
    .profile-avatar-circle { width: 70px; height: 70px; font-size: 24px; }
    
    .profile-stats-mini {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    
    .profile-stat-item {
        background: var(--bg-color);
        padding: 12px;
        border-radius: 8px;
        text-align: center;
    }

}



/* 1. Critical State (Low Funds) */
.balance-glass-card.state-critical {
    background: linear-gradient(135deg, #450a0a 0%, #1a0505 100%) !important; /* Deep Red BG */
    border: 1px solid #ef4444 !important; /* Bright Red Border */
    box-shadow: 0 10px 30px -5px rgba(239, 68, 68, 0.3); /* Red Glow */
}
.balance-glass-card.state-critical .glass-value {
    color: #c70000 !important; /* Light Red Text */
}

/* 2. Healthy State (Good Funds) */
.balance-glass-card.state-healthy {
    background: linear-gradient(135deg, #064e3b 0%, #022c22 100%) !important; /* Deep Green BG */
    border: 1px solid #10b981 !important; /* Emerald Border */
    box-shadow: 0 10px 30px -5px rgba(16, 185, 129, 0.3); /* Green Glow */
}
.balance-glass-card.state-healthy .glass-value {
   color: #00620c !important;
}

/* 3. Bar Transitions */
.safety-bar-fill {
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s ease;
}


/* =========================================
   PREMIUM MOBILE PROFILE REDESIGN
   ========================================= */
@media (max-width: 768px) {
    /* 1. Sophisticated Background & Banner */
    .profile-header-banner {
        height: 130px;
        background: radial-gradient(circle at top right, #237804, #0b2e02);
        border-radius: 0 0 40px 40px;
        margin-bottom: -60px;
        position: relative;
        overflow: hidden;
    }

    /* Abstract decorative element for uniqueness */
    .profile-header-banner::after {
        content: '';
        position: absolute;
        top: -20px;
        right: -20px;
        width: 150px;
        height: 150px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }

    /* 2. Asymmetrical Profile Section */
    .profile-info-section {
        display: flex;
        align-items: flex-end;
        padding: 0 20px;
        text-align: left;
        gap: 15px;
        margin-bottom: 15px;
    }

    .profile-avatar-circle {
        width: 85px !important;
        height: 85px !important;
        margin: 0 !important; /* Remove centering */
        border: 4px solid var(--bg-color);
        background: white;
        font-size: 32px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        z-index: 2;
    }

    .profile-main-name {
        font-size: 24px;
        color: white;
        margin-bottom: 12px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .profile-main-meta {
        backdrop-filter: blur(5px);
        color: white;
        padding: 3px 12px;
        border-radius: 20px;
        font-size: 10px;
        display: inline-block;
    }

    /* Make avatar look interactive */
.profile-avatar-circle {
    cursor: pointer;
    transition: transform 0.2s ease, filter 0.2s ease;
    position: relative;
}

.profile-avatar-circle:hover {
    transform: scale(1.05);
    filter: brightness(0.9);
}

/* Subtle "Edit" label that appears on hover */
.profile-avatar-circle::after {
    content: 'EDIT';
    position: absolute;
    bottom: 5px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.6);
    color: white;
    font-size: 8px;
    padding: 2px 6px;
    border-radius: 10px;
    opacity: 0;
    transition: opacity 0.2s;
}

.profile-avatar-circle:hover::after {
    opacity: 1;
}

.profile-avatar-circle {
    cursor: pointer; /* Indicates it can be clicked */
    transition: transform 0.2s ease;
}
.profile-avatar-circle:active {
    transform: scale(0.95); /* Slight "press" effect */
}

    /* 3. Metric Capsules (Replacing the simple grid) */
    .profile-stats-mini {
   display: flex;
        justify-content: space-evenly;
        background: #1d1c1af2;
        margin: 0 20px 20px 20px;
        padding: 15px;
        border-radius: 24px;
        box-shadow: 0 4px 15px rgb(51 47 47 / 5%);
        border: 1px solid var(--border-color);
    }

    .stat-mini-value{
        font-size: 16px !important;
        font-weight: 800 !important;
        color: #ced090 !important;
    }

    .profile-stat-item {
        background: transparent !important;
        border-right: 1px solid var(--border-color);
        padding: 0 !important;
        flex: 1;
    }

    .profile-stat-item:last-child { border-right: none; }

    .profile-stat-item div:first-child {
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 800;
        font-size: 8px !important;
        color: var(--text-secondary);
    }
   /* background: #725b00 !important;  */
    /* 4. The "Neo-Wallet" Hero Card */
   #profileBalanceCard {
        background: linear-gradient(135deg, #a3a041 0%, #020617 100%) !important;
        border-radius: 28px !important;
        padding: 25px !important;
        display: flex !important; /* Switch to side-by-side */
        justify-content: space-between !important;
        align-items: center !important;
        border: 1px solid rgba(255,255,255,0.1) !important;
        position: relative !important;
        color: white !important;
        box-shadow: 0 15px 35px rgba(0,0,0,0.2) !important;
        min-height: 120px !important;
    }

    /* Floating card label */
    #profileBalanceCard::before {
        content: 'PREMIUM MEALCARD';
        position: absolute;
        top: 15px;
        right: 25px;
        font-size: 7px;
        font-weight: 700;
        letter-spacing: 2px;
        color: #848f9d;
        opacity: 0.8;
    }

    /* Left Side: Labels and Amount */
    .balance-card-left {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    #profileBalanceCard .stat-label {
        color: #ffffff !important;
        font-size: 10px !important;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin: 0 !important;
    }

    #profileBalanceCard .stat-value {
        color: #10b981 !important; /* Emerald Green */
        font-size: 30px !important;
        font-weight: 800 !important;
        font-family: 'Segoe UI', Roboto, sans-serif !important;
        margin: 0 !important;
    }

    /* Right Side: Button and Cycle */
    .balance-card-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 12px;
    }

    /* Premium Add Cash Button */
    #profileBalanceCard .btn-primary {
        background: white !important;
        color: #0f172a !important;
        font-weight: 800 !important;
        font-size: 12px !important;
        padding: 8px 16px !important;
        border-radius: 12px !important;
        border: none !important;
        box-shadow: 0 4px 12px rgba(255,255,255,0.15) !important;
        text-transform: none !important;
    }

    .cycle-info-text {
        font-size: 9px !important;
        color: #64748b !important;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
}

.bg-tint-neg {
    background: rgba(239, 68, 68, 0.08) !important;
    border: 1px solid rgba(239, 68, 68, 0.3) !important;
    /* Subtle pulse to grab manager's attention */
    animation: border-pulse 2s infinite;
}

@keyframes border-pulse {
    0% { border-color: rgba(239, 68, 68, 0.3); }
    50% { border-color: rgba(239, 68, 68, 0.6); }
    100% { border-color: rgba(239, 68, 68, 0.3); }
}


/* ============================================================
   CLEANED PREMIUM PROFILE COMPONENTS (MOBILE)
   ============================================================ */

@media (max-width: 768px) {

    /* --- 1. Restricted Time Indicator --- */
    .lock-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 800;
        background: #f8fafc;
        color: #64748b;
        border: 1px solid #e2e8f0;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Active restricted state (Flashes Red) */
    .lock-badge.is-restricted {
        background: #fff1f2 !important;
        color: #e11d48 !important;
        border-color: #fecaca !important;
        box-shadow: 0 0 15px rgba(225, 29, 72, 0.1);
    }

    .lock-badge .dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: #cbd5e1;
    }

    .lock-badge.is-restricted .dot {
        background: #e11d48;
        animation: pulse-red-ring 1.5s infinite;
    }

    @keyframes pulse-red-ring {
        0% { transform: scale(1); opacity: 1; }
        100% { transform: scale(2.8); opacity: 0; }
    }

    /* --- 2. Default Meal Hub --- */
    .defaults-container {
        background: #f1f5f9;
        padding: 15px 20px;
        border-radius: 24px;
        margin: 5px 0;
        display: flex;
        gap: 12px;
        border: 1px solid rgba(0,0,0,0.02);
    }

    .def-btn {
        border-radius: 14px;
        font-size: 11px;
        font-weight: 800;
        border: 1px solid #cbd5e1;
        background: white;
        color: #475569;
        transition: all 0.2s ease;
    }

    .def-btn.active {
        background: #006620;
        color: white;
        border-color: #3b3b3bd1;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2);
    }

    /* --- 3. Smart Scheduler Cards --- */
    .scheduler-card {
        min-width: 155px;
        padding: 18px;
        background: white;
        border-radius: 28px;
        border: 1px solid #c6cacd;
        box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.03);
        text-align: center;
    }

    .scheduler-card.is-today {
        border: 2px solid #10b981;
        background: linear-gradient(to bottom, #f0fdf4, #ffffff);
        box-shadow: 0 10px 25px -5px rgba(16, 185, 129, 0.1);
    }

    .sched-date-main { font-size: 17px; font-weight: 900; color: #1e293b; margin-bottom: 2px; }
    .sched-sub-label { font-size: 8px; font-weight: 800; color: #94a3b8; letter-spacing: 1.2px; margin-bottom: 15px; text-transform: uppercase; }

    .sched-actions { display: flex; flex-direction: column; gap: 10px; }

    /* The Master Button Style */
    .sched-btn {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 12px;
        height: 48px;
        border-radius: 16px;
        border: 1.5px solid transparent;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    /* Night Button (Midnight Navy Style) */
    .night-btn { background: #f8fafc; color: #64748b; border-color: #e2e8f0; }
    .night-btn.active { 
        background: #1a2439 !important; 
        color: #10b981 !important; 
        border-color: #0f172a !important;
        box-shadow: 0 8px 20px -6px rgba(15, 23, 42, 0.4);
    }

    /* Day Button (Emerald Soft Style) */
    .day-btn { background: #f8fafc; color: #64748b; border-color: #e2e8f0; }
    .day-btn.active { 
        background: #f6f9d4 !important; 
        color: #059669 !important; 
        border-color: #10b981 !important;
        box-shadow: 0 8px 20px -6px rgba(16, 185, 129, 0.15);
    }

    /* The Status Pill (Fixed immediate toggle indicator) */
    .status-text {
        font-size: 9px;
        font-weight: 900;
        width: 36px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        background: #e2e8f0;
        color: #64748b;
        transition: all 0.2s ease;
    }

    .night-btn.active .status-text { 
        background: #10b981; 
        color: white; 
    }

    .day-btn.active .status-text { 
        background: #d1fae5; 
        color: #059669; 
    }

    .btn-label { font-size: 11px; font-weight: 700; display: flex; align-items: center; gap: 6px; }

}



/* --- Professional expense Enhancements --- */

/* --- Modern Compact Expense Form --- */
.expense-form-container {
    background: #bcd4d1b5;
    padding: 16px;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.03);
    border: 1px solid #f1f5f9;
}

.exp-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; /* Two columns */
    gap: 12px;
}

.exp-full { grid-column: span 2; } /* For description to take full width */

.exp-input-group { display: flex; flex-direction: column; gap: 4px; }
.exp-input-group label { font-size: 10px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-left: 2px; }

/* Premium Input Styling */
.exp-field {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 8px 12px;
    font-size: 14px;
    color: #1e293b;
    width: 100%;
    transition: all 0.2s;
}




.exp-field:focus { border-color: var(--premium-indigo); outline: none; background: white; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }

/* Compact Row 3 (Amount + Button) */
.amount-btn-row {
    display: flex;
    align-items: flex-end;
    gap: 10px;
}

.btn-add-exp {
    height: 38px; /* Match input height */
    padding: 0 20px;
    border-radius: 10px;
    background: #207385;
    color: white;
    font-weight: 700;
    font-size: 13px;
    border: none;
    cursor: pointer;
    white-space: nowrap;
    transition: transform 0.2s;
}

.btn-add-exp:active { transform: scale(0.95); }

/* --- Enhanced Expense List --- */
.expense-card-modern {
    background: white;
    padding: 12px;
    border-radius: 14px;
    margin-bottom: 10px;
    border: 1px solid #f1f5f9;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.exp-info-left { display: flex; gap: 12px; align-items: center; }
.exp-icon-box {
    width: 40px; height: 40px;
    border-radius: 10px;
    background: var(--soft-emerald);
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
}

.exp-details .title { font-size: 14px; font-weight: 700; color: #334155; }
.exp-details .meta { font-size: 10px; color: var(--text-muted); }

.exp-amount-right { text-align: right; }
.exp-amount-right .val { font-size: 15px; font-weight: 800; color: #1e293b; font-family: 'Courier New', monospace; }

/* Status Capsules */
.status-pill {
    font-size: 8px; font-weight: 800; padding: 2px 8px; border-radius: 20px; text-transform: uppercase;
}
.status-pill.pending { background: #fef3c7; color: #92400e; }
.status-pill.approved { background: #d1fae5; color: #065f46; }

@media (max-width: 480px) {
    .amount-btn-row { flex-direction: row; }
    .btn-add-exp { padding: 0 12px; font-size: 12px; }
}


/* =========================================
   PENDING EXPENSE CARD (MOBILE FRIENDLY)
   ========================================= */

/* The Main Orange Container */
.pending-box-premium {
    background-color: #fff7ed; /* Amber 50 */
    border: 1px solid #ffedd5; /* Amber 100 */
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px -1px rgba(251, 146, 60, 0.1); /* Soft Orange Shadow */
    animation: slideDown 0.3s ease-out;
}

.pending-header-title {
    font-size: 11px;
    font-weight: 800;
    color: #9a3412; /* Amber 900 */
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* Individual Pending Item Card */
.pending-card-inner {
    background: #ffffff;
    border: 1px solid #fed7aa; /* Amber 200 */
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 10px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

/* Top Row: Icon + Name + Amount */
.pending-main-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.pending-left-group {
    display: flex;
    gap: 12px;
    align-items: center;
}

.pending-icon-circle {
    width: 36px;
    height: 36px;
    background: #fff7ed;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    border: 1px solid #ffedd5;
}

.pending-shopper-name {
    font-weight: 700;
    font-size: 14px;
    color: #1e293b;
    line-height: 1.2;
}

.pending-desc {
    font-size: 11px;
    color: #ea580c; /* Amber 600 */
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 140px; /* Prevents text breaking layout on small phones */
}

.pending-right-group {
    text-align: right;
}

.pending-amt {
    font-weight: 800;
    font-size: 15px;
    color: #c2410c; /* Amber 700 */
    font-family: 'Courier New', monospace;
}

.pending-date {
    font-size: 10px;
    color: #9ca3af;
    font-weight: 600;
}

/* Admin Action Buttons Area */
.pending-actions {
    display: flex;
    gap: 10px;
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px dashed #fed7aa;
}

/* Big Touchable Buttons for Mobile */
.btn-mobile-action {
    flex: 1; /* Each button takes 50% width */
    padding: 8px 0;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 700;
    border: none;
    cursor: pointer;
    text-transform: uppercase;
    transition: transform 0.1s;
}

.btn-mobile-action:active {
    transform: scale(0.96);
}

.btn-approve {
    background: #22c55e;
    color: white;
    box-shadow: 0 2px 5px rgba(34, 197, 94, 0.2);
}

.btn-reject {
    background: #ef4444;
    color: white;
    box-shadow: 0 2px 5px rgba(239, 68, 68, 0.2);
}

/* Non-Admin Status Label */
.pending-status-label {
    margin-top: 8px;
    background: #fff7ed;
    color: #ea580c;
    font-size: 9px;
    font-weight: 800;
    text-align: center;
    padding: 4px;
    border-radius: 6px;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}


/* --- Premium Wallet UI --- */
.wallet-form-container {
    background: #bcd4d1b5;
    padding: 16px;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.03);
    border: 1px solid #f1f5f9;
}   

.wallet-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

/* Row 3 Special handling for Notes + Button */
.notes-btn-row {
    display: flex;
    align-items: flex-end;
    gap: 10px;
    grid-column: span 2;
}

.btn-wallet-submit {
    height: 38px;
    padding: 0 15px;
    border-radius: 10px;
    background: #207385;
    color: white;
    font-weight: 800;
    font-size: 11px;
    border: none;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.2s;
    white-space: nowrap;
}

.btn-wallet-submit:active { transform: scale(0.96); }

/* Pending Requests Section */
.pending-box-premium {
    background: var(--soft-rose);
    border: 1px solid #fecaca;
    border-radius: 14px;
    padding: 12px;
    margin-bottom: 20px;
}

/* History Cards */
.history-item-premium {
    background: white;
    padding: 12px;
    border-radius: 14px;
    border: 1px solid #f1f5f9;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.hist-left { display: flex; gap: 10px; align-items: center; }
.hist-icon {
    width: 36px; height: 36px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
}

.hist-icon.plus { background: var(--soft-emerald); color: #059669; }
.hist-icon.minus { background: var(--soft-rose); color: #e11d48; }
.hist-icon.settle { background: #f1f5f9; color: #64748b; }

.hist-details .name { font-size: 13px; font-weight: 700; color: #1e293b; }
.hist-details .meta { font-size: 10px; color: var(--text-muted); }

.hist-amount { text-align: right; }
.hist-amount .val { font-size: 14px; font-weight: 800; font-family: 'Courier New', monospace; }
.hist-amount .label { font-size: 9px; font-weight: 700; text-transform: uppercase; }

@media (max-width: 480px) {
    .wallet-grid { gap: 8px; }
    .btn-wallet-submit { padding: 0 10px; font-size: 10px; }
}


/* Edited Tag Badge */
.edited-badge {
    font-size: 8px;
    background: #f1f5f9;
    color: #64748b;
    border: 1px solid #cbd5e1;
    padding: 1px 4px;
    border-radius: 4px;
    margin-left: 6px;
    text-transform: uppercase;
    font-weight: 700;
    vertical-align: middle;
}

/* Mobile Friendly Edit Button */
.btn-icon-edit {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: 1px solid #e2e8f0;
    background: white;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    cursor: pointer;
    margin-left: 10px;
    transition: all 0.2s;
}
.btn-icon-edit:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}


        /* Summary Table Styles */
.summary-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    background: var(--card-bg);
}

.summary-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    min-width: 700px; /* Ensures table has room to breathe */
}

.summary-table th, .summary-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.summary-table th {
    background-color: var(--bg-color);
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.5px;
    white-space: nowrap;
}

/* Status Button Modern Look */
.status-btn {
    padding: 6px 0;
    width: 55px;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 800;
    border: 1px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
}

.status-btn.on {
    background-color: #ECFDF5;
    color: #059669;
    border-color: #A7F3D0;
}

.status-btn.off {
    background-color: #F3F4F6;
    color: #6B7280;
    border-color: #E5E7EB;
}

/* Mobile Responsiveness for Summary */
@media (max-width: 768px) {
    .summary-table {
        font-size: 12px;
    }

    /* Sticky first column (Name) for mobile */
    .summary-table th:first-child, 
    .summary-table td:first-child {
        position: sticky;
        left: 0;
        z-index: 10;
        background-color: var(--card-bg);
        border-right: 2px solid var(--border-color);
        min-width: 100px;
    }

    .summary-table th:first-child {
        background-color: var(--bg-color);
    }
    
    .summary-table td {
        padding: 10px 8px;
    }
}

.balance-cell {
    font-family: 'Courier New', monospace;
    font-weight: 800;
}


        /* Due Settlement Styles */
.due-item {
    padding: 12px;
    background: var(--bg-color);
    border-radius: 8px;
    margin-bottom: 10px;
    border-left: 4px solid transparent;
}

.due-item.debtor {
    background-color:rgb(255 230 230 / 44%);
}

.due-item.creditor {
    background-color: rgba(199, 255, 199, 0.271);
}
.due-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.due-item-name {
    font-weight: 700;
    font-size: 14px;
}

.due-item-amount {
    font-weight: 700;
    font-size: 16px;
}

.due-progress-bar {
    width: 100%;
    height: 6px;
    background: var(--border-color);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 8px;
}

.due-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success-color), var(--primary-color));
    transition: width 0.3s ease;
}

.due-status-badge {
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 8px;
    text-transform: uppercase;
    font-weight: 700;
}

.due-status-pending {
    background: #FEE2E2;
    color: #B91C1C;
}

.due-status-settling {
    background: #FEF3C7;
    color: #92400E;
}

.due-status-settled {
    background: #D1FAE5;
    color: #065F46;
}

 /*tracker Styles */

/* --- Tracker Sticky Scroll Fixes --- */
/* --- Tracker Sticky Scroll Fixes --- */

/* 1. The Scroll Container */
.matrix-premium-wrapper {
    background: white;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    overflow: auto; /* Required for sticky children */
    max-height: 70vh; /* Limits height to trigger vertical scroll */
    position: relative;
    -webkit-overflow-scrolling: touch;
}

.matrix-table-premium {
    width: 100%;
    border-collapse: separate; /* Essential for sticky to work correctly with borders */
    border-spacing: 0;
}

/* 2. Sticky Header (Top Row - Names) */
.matrix-table-premium thead th {
    position: sticky;
    top: 0;
    z-index: 100;
    background: #f7fffbb5;
    border-bottom: 2px solid #cbd5e1;
    padding: 12px 8px;
    font-size: 0.7rem;
    font-weight: 500;
    border: 1px solid #53535333;
}

/* 3. Sticky Column (First Column - Dates) */
.matrix-table-premium tbody td:first-child {
    position: sticky;
    left: 0;
    z-index: 50; /* Higher than other body cells, lower than top header */
    background: #ffffff;
    border-right: 2px solid #cbd5e1;
    font-size: 0.7rem;
    font-weight: 500;
    text-align: center;
    border: 1px solid #53535333;
}

/* 4. The Intersection (Top-Left BAZAR cell) */
.matrix-table-premium thead th:first-child {
    position: sticky;
    top: 0;
    left: 0;
    z-index: 150; /* Highest priority: stays fixed regardless of scroll direction */
    background: #f1f5f9;
    border-right: 2px solid #cbd5e1;
    border-bottom: 2px solid #cbd5e1;
}

/* 5. Body Styling */
.matrix-table-premium td {
    border-bottom: 1px solid #f1f5f9;
    border-right: 1px solid #f1f5f9;
    min-width: 80px;
    height: 45px;
}

.matrix-table-premium tbody tr:hover td {
    background-color: #f8fafc;
}

/* Interactive Split Cells */
.cell-split-premium {
    display: flex;
    height: 100%;
    width: 100%;
    cursor: pointer;
    border: 1px solid #60606040;
}

.cell-val-half {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-family: 'Courier New', monospace;
    transition: background 0.2s;
}

.cell-val-half.night {
    background: #c0c0c02b;
}

.cell-split-premium{
    border: 1px solid #dfcece;
}


.cell-val-half.active {
        background: rgb(99 227 241 / 10%);
    color: #4f46e5;
    border: 1px dashed #d7d7d7;
}
.cell-val-half.zero { color: #cbd5e1; font-weight: 400; }

/* Weekly Menu Editor Premium */
.menu-editor-card {
    background: white;
    border-radius: 20px;
    padding: 15px;
    margin-top: 25px;
    border: 1px solid #f1f5f9;
}

.menu-table-compact {
    width: 100%;
    border-collapse: collapse;
}

.menu-table-compact td { padding: 8px 0; border-bottom: 1px solid #f8fafc; }
.menu-day-label { font-size: 11px; font-weight: 800; color: #1e293b; width: 80px; }

.menu-input-pill {
    width: 100%;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 6px 10px;
    font-size: 11px;
    color: #475569;
    transition: all 0.2s;
}

.menu-input-pill:focus { border-color: var(--premium-indigo); background: white; outline: none; }

/* Dashboard Grid Layout */
.dashboard-header-grid {
    display: grid;
    grid-template-columns: 320px 1fr; /* Desktop: Plan card fixed, stats take rest */
    gap: 15px;
    margin-bottom: 20px;
    align-items: stretch;
}

.stats-subgrid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 2x2 on Desktop */
    gap: 15px;
}


/* --- Premium Dashboard UI --- */
.dash-welcome-row {
    padding: 0 5px;
    margin-bottom: 20px;
}

.dash-welcome-row h2 { font-size: 22px; font-weight: 800; margin: 0; }
.dash-welcome-row p { font-size: 11px; color: var(--text-muted); font-weight: 700; text-transform: uppercase; }

/* Main Action Card: Meal Plan */
.meal-pulse-card {
    background: white;
    border-radius: 20px;
    padding: 15px;
    box-shadow: 0 4px 25px rgba(0,0,0,0.03);
    margin-bottom: 15px;
    border: 1px solid #f1f5f9;
}

.pulse-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 15px; padding-bottom: 10px;
    border-bottom: 1px solid #f8fafc;
}

.pulse-header h3 { font-size: 13px; font-weight: 800; color: #1e293b; margin: 0; }
.pulse-badge { font-size: 9px; background: var(--soft-emerald); color: #059669; padding: 3px 8px; border-radius: 10px; font-weight: 800;margin-left: 5px; }

.pulse-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

.pulse-item {
    background: #d2f9efad;
    padding: 12px;
    border-radius: 14px;
    text-align: center;
    border: 1px solid #979a9e62;
}

.pulse-icon { font-size: 18px; margin-bottom: 4px; display: block; }
.pulse-label { font-size: 12px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; }
.pulse-val { font-size: 18px; font-weight: 900; color: #1e293b; margin: 2px 0; }
.pulse-menu { font-size: 10px; color: var(--premium-indigo); font-weight: 600; font-style: normal; }

/* 2x2 Stats Grid */
.dash-stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
}

/* Update this class */
.stat-pill-card {
    background: var(--card-bg) !important; /* Force White */
    border: 1px solid var(--border-color);
    border-left: 4px solid var(--border-color); /* Default gray stripe */
    padding: 15px;
    border-radius: 12px;
    box-shadow: var(--shadow-soft);
    display: flex;
    flex-direction: column;
    justify-content: center;
    transition: transform 0.2s ease;
}

/* =========================================
   PREMIUM NOTIFICATION BADGES
   ========================================= */

/* Ensure parent cards can hold absolute badges */
.stat-pill-card {
    position: relative !important; 
    overflow: visible !important; /* Allow badge to sit on the edge */
}

.premium-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    min-width: 20px;
    height: 20px;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); /* Amber Gradient */
    color: white;
    font-size: 10px;
    font-family: 'Inter', sans-serif;
    font-weight: 800;
    border-radius: 50%; /* Circle for single digits, pill for double */
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #ffffff; /* White ring to separate from card */
    box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.4);
    z-index: 10;
    
    /* Animation Basics */
    transform: scale(0);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    padding: 0 5px; /* Adjust for double digits */
}

/* Active State */
.premium-badge.active {
    transform: scale(1);
    opacity: 1;
    animation: badge-pulse 3s infinite;
}

/* Specific styling for counts > 99 */
.premium-badge.wide {
    border-radius: 12px;
    padding: 0 6px;
}

/* The Subtle "Live" Pulse */
@keyframes badge-pulse {
    0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
    70% { box-shadow: 0 0 0 6px rgba(245, 158, 11, 0); }
    100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
}

/* Mobile Tweaks */
@media (max-width: 768px) {
    .premium-badge {
        top: -8px;
        right: -4px;
        font-size: 9px;
        height: 18px;
        min-width: 18px;
    }
}


/* =========================================
   PREMIUM PENDING BADGES (DASHBOARD)
   ========================================= */

/* Ensure the parent card can position the badge */
.stat-pill-card {
    position: relative !important;
    overflow: visible !important; /* Allow badge to pop out slightly */
    transition: transform 0.2s ease;
}

/* The Badge Itself */
.premium-count-badge {
    position: absolute;
    top: -8px;    /* Floats slightly above the top edge */
    right: -8px;  /* Floats slightly off the right edge */
    
    min-width: 24px;
    height: 24px;
    
    /* Premium Amber Gradient */
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    
    color: white;
    font-family: 'Inter', sans-serif;
    font-size: 11px;
    font-weight: 800;
    
    border-radius: 50%; /* Circle */
    border: 2px solid #ffffff; /* White border to separate from card */
    
    display: flex;
    align-items: center;
    justify-content: center;
    
    /* Glow Shadow */
    box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
    
    z-index: 20;
    
    /* Animation defaults */
    transform: scale(0);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      cursor: pointer;
    pointer-events: auto; /* Ensures it catches clicks even if parent doesn't */
}

/* Active State (Visible) */
.premium-count-badge.active {
    transform: scale(1);
    opacity: 1;
    /* Live Pulse Animation */
    animation: badge-pulse-ring 2s infinite;
}

/* Wide style for numbers > 9 */
.premium-count-badge.wide {
    border-radius: 12px;
    padding: 0 6px;
    width: auto;
}

@keyframes badge-pulse-ring {
    0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); }
    70% { box-shadow: 0 0 0 6px rgba(245, 158, 11, 0); }
    100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
}

/* Mobile Tweaks: Adjust position slightly */
@media (max-width: 768px) {
    .premium-count-badge {
        top: -6px;
        right: -6px;
        min-width: 20px;
        height: 20px;
        font-size: 10px;
    }
}

/* =========================================
   ENHANCED LIQUID BALANCE CARD
   ========================================= */
/* =========================================
   MODERN VERTICAL METER CARD (CSS-FRIENDLY)
   ========================================= */
.liquid-card-container {
    grid-column: span 1;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 20px;
    padding: 0;
    position: relative;
    overflow: hidden;
    height: 240px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1), 0 3px 10px rgba(0,0,0,0.06);
    border: 1px solid rgba(226, 232, 240, 0.8);
    display: flex;
    flex-direction: column;
}

/* Decorative background circles */
.liquid-card-bg {
    position: absolute;
    top: -30px;
    right: -30px;
    width: 150px;
    height: 150px;
    background: radial-gradient(circle, rgba(99, 102, 241, 0.05) 0%, transparent 70%);
    border-radius: 50%;
    z-index: 0;
}

.liquid-card-bg::before {
    content: '';
    position: absolute;
    bottom: -80px;
    left: -80px;
    width: 120px;
    height: 120px;
    background: radial-gradient(circle, rgba(16, 185, 129, 0.05) 0%, transparent 70%);
    border-radius: 50%;
}

/* Vertical Meter Container */
.liquid-box {
    position: absolute;
    left: 20px;
    bottom: 20px;
    width: 50px;
    height: calc(100% - 100px);
    background: linear-gradient(180deg, #f1f5f9 0%, #e2e8f0 100%);
    border-radius: 25px;
    overflow: hidden;
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.08);
    z-index: 1;
}

/* The Fill Bar */
.liquid-fill-body {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: var(--fill-percent, 50%);
    background: linear-gradient(180deg, 
        var(--liquid-color-light, #34d399) 0%, 
        var(--liquid-color-main, #10b981) 50%,
        var(--liquid-color-dark, #059669) 100%);
    border-radius: 10px;
    transition: height 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
}

/* Animated shine effect on meter */
.liquid-fill-body::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(180deg, 
        rgba(255,255,255,0.4) 0%, 
        transparent 30%,
        transparent 70%,
        rgba(0,0,0,0.1) 100%);
    border-radius: 25px;
}

/* Pulsing glow effect */
.liquid-fill-body::after {
    content: '';
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    height: 20px;
    background: var(--liquid-color-light, #34d399);
    border-radius: 50%;
    filter: blur(8px);
    opacity: 0.6;
    animation: pulse-glow 2s ease-in-out infinite;
}

@keyframes pulse-glow {
    0%, 100% { opacity: 0.6; transform: translateX(-50%) scale(1); }
    50% { opacity: 0.3; transform: translateX(-50%) scale(1.1); }
}

/* Meter scale marks */
.meter-marks {
    position: absolute;
    left: 76px;
    bottom: 20px;
    height: calc(100% - 100px);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    z-index: 2;
}

.meter-mark {
    display: flex;
    align-items: center;
    gap: 6px;
}

.meter-mark-line {
    width: 8px;
    height: 1.5px;
    background: #cbd5e1;
    border-radius: 2px;
}

.meter-mark-label {
    font-size: 9px;
    font-weight: 600;
    color: #94a3b8;
    font-family: 'Courier New', monospace;
}

/* Floating particles/dots */
.bubble {
    position: absolute;
    left: 25px;
    width: 4px;
    height: 4px;
    background: rgba(255,255,255,0.8);
    border-radius: 50%;
    bottom: 0;
    animation: float-up 3s ease-in infinite;
    box-shadow: 0 0 6px rgba(255,255,255,0.6);
    z-index: 3;
}

.bubble:nth-child(1) { animation-duration: 3.5s; animation-delay: 0s; }
.bubble:nth-child(2) { animation-duration: 4s; animation-delay: 1s; }
.bubble:nth-child(3) { animation-duration: 3.2s; animation-delay: 2s; }
.bubble:nth-child(4) { animation-duration: 3.8s; animation-delay: 0.5s; }

@keyframes float-up {
    0% { bottom: 0; opacity: 0; }
    20% { opacity: 1; }
    80% { opacity: 1; }
    100% { bottom: 100%; opacity: 0; }
}

/* Content Area */
.liquid-content {
    position: relative;
    z-index: 10;
    padding: 20px 20px 20px 90px;
    display: flex;
    flex-direction: column;
    height: 100%;
    justify-content: space-between;
    box-shadow: inset 0 0 30px rgb(0 0 0 / 45%);
}

.liquid-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.liquid-title {
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: #64748b;
    background: rgba(255,255,255,0.7);
    padding: 5px 12px;
    border-radius: 16px;
    backdrop-filter: blur(8px);
    border: 1px solid rgba(226, 232, 240, 0.8);
}

.liquid-capacity-pill {
    font-size: 9px;
    font-weight: 700;
    color: #6366f1;
    background: rgba(238, 242, 255, 0.8);
    padding: 4px 9px;
    border-radius: 10px;
    border: 1px solid rgba(199, 210, 254, 0.5);
}

.liquid-value-wrapper {
    margin-top: auto;
    margin-bottom: 12px;
    text-align: left;
}

.liquid-currency {
    font-size: 20px;
    font-weight: 700;
    color: #64748b;
    vertical-align: top;
    margin-right: 2px;
}

.liquid-amount {
    font-size: 38px;
    font-weight: 900;
    letter-spacing: -1.5px;
    font-family: 'Courier New', monospace;
    background: linear-gradient(135deg, var(--text-gradient-1, #047857) 0%, var(--text-gradient-2, #059669) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.liquid-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
}

.liquid-status-badge {
    font-size: 9px;
    font-weight: 800;
    text-transform: uppercase;
    padding: 6px 14px;
    border-radius: 16px;
    letter-spacing: 0.5px;
    transition: all 0.3s;
}

.liquid-percentage {
    font-size: 11px;
    font-weight: 700;
    font-family: 'Courier New', monospace;
    color: #64748b;
    background: rgba(241, 245, 249, 0.8);
    padding: 5px 10px;
    border-radius: 12px;
}

/* Color States */
.state-healthy-liquid {
    --liquid-color-light: #6ee7b7;
    --liquid-color-main: #10b981;
    --liquid-color-dark: #059669;
    --text-gradient-1: #047857;
    --text-gradient-2: #059669;
}

.state-critical-liquid {
    --liquid-color-light: #fca5a5;
    --liquid-color-main: #ef4444;
    --liquid-color-dark: #dc2626;
    --text-gradient-1: #b91c1c;
    --text-gradient-2: #dc2626;
}

.state-empty-liquid {
    --liquid-color-light: #cbd5e1;
    --liquid-color-main: #94a3b8;
    --liquid-color-dark: #64748b;
    --text-gradient-1: #475569;
    --text-gradient-2: #64748b;
}

/* Tablet and Desktop */
@media (min-width: 640px) {
    .liquid-card-container {
        grid-column: span 2;
        height: 260px;
    }
    
    .liquid-box {
        width: 60px;
        left: 24px;
    }
    
    .meter-marks {
        left: 90px;
    }
    
    .liquid-content {
        padding: 24px 24px 24px 110px;
    }
    
    .liquid-amount {
        font-size: 48px;
    }
    
    .liquid-currency {
        font-size: 24px;
    }
}

@media (min-width: 1024px) {
    .liquid-card-container {
        height: 280px;
    }
    
    .liquid-amount {
        font-size: 52px;
    }
}

@keyframes foam-move {
    0%, 100% { transform: translateX(0) scaleX(1); }
    50% { transform: translateX(2px) scaleX(1.02); }
}

/* Enhanced bubbles with varying sizes */
.bubble {
    position: absolute;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), rgba(255,255,255,0.2));
    border-radius: 50%;
    bottom: 0;
    z-index: 4;
    animation: rise linear infinite;
    box-shadow: inset 0 0 10px rgba(255,255,255,0.5);
}

.bubble:nth-child(1) { left: 15%; width: 8px; height: 8px; animation-duration: 4s; animation-delay: 0s; }
.bubble:nth-child(2) { left: 35%; width: 12px; height: 12px; animation-duration: 5.5s; animation-delay: 1.2s; }
.bubble:nth-child(3) { left: 55%; width: 6px; height: 6px; animation-duration: 3.8s; animation-delay: 2.1s; }
.bubble:nth-child(4) { left: 75%; width: 10px; height: 10px; animation-duration: 6s; animation-delay: 0.8s; }
.bubble:nth-child(5) { left: 25%; width: 7px; height: 7px; animation-duration: 4.5s; animation-delay: 3s; }
.bubble:nth-child(6) { left: 65%; width: 9px; height: 9px; animation-duration: 5s; animation-delay: 1.8s; }
.bubble:nth-child(7) { left: 85%; width: 11px; height: 11px; animation-duration: 5.8s; animation-delay: 2.5s; }
.bubble:nth-child(8) { left: 45%; width: 8px; height: 8px; animation-duration: 4.2s; animation-delay: 0.5s; }

/* Content overlay */
.liquid-content {
    position: relative;
    z-index: 10;
    text-align: center;
    width: 100%;
    padding: 24px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    height: 100%;
    justify-content: space-between;
}

.liquid-header {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.liquid-title {
    font-size: 12px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: #475569;
    background: rgba(255,255,255,0.9);
    padding: 6px 14px;
    border-radius: 20px;
    backdrop-filter: blur(10px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.liquid-capacity-pill {
    font-size: 10px;
    font-weight: 700;
    color: #64748b;
    background: rgba(255,255,255,0.7);
    padding: 4px 10px;
    border-radius: 12px;
    backdrop-filter: blur(10px);
}

.liquid-value-wrapper {
    margin-bottom: 12px;
    transition: all 0.5s ease;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
}

.liquid-currency {
    font-size: 28px;
    font-weight: 700;
    vertical-align: top;
    margin-right: 4px;
}

.liquid-amount {
    font-size: 56px;
    font-weight: 900;
    letter-spacing: -2px;
    font-family: 'Courier New', monospace;
}

.liquid-status-badge {
    font-size: 11px;
    font-weight: 800;
    text-transform: uppercase;
    padding: 8px 18px;
    border-radius: 20px;
    background: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    letter-spacing: 0.8px;
    transition: all 0.3s;
    backdrop-filter: blur(10px);
}

/* Color States */
.state-healthy-liquid {
    --liquid-color-light: #6ee7b7;
    --liquid-color-main: #34d399;
    --liquid-color-dark: #10b981;
}

.state-critical-liquid {
    --liquid-color-light: #fca5a5;
    --liquid-color-main: #f87171;
    --liquid-color-dark: #ef4444;
}

.state-empty-liquid {
    --liquid-color-light: #e2e8f0;
    --liquid-color-main: #cbd5e1;
    --liquid-color-dark: #94a3b8;
}

/* Enhanced Wave Animations */
@keyframes wave-rotate-1 {
    0% { transform: translate(-5%, 0) rotate(0deg); }
    50% { transform: translate(-5%, 3%) rotate(180deg); }
    100% { transform: translate(-5%, 0) rotate(360deg); }
}

@keyframes wave-rotate-2 {
    0% { transform: translate(0, 0) rotate(0deg); }
    50% { transform: translate(0, -2%) rotate(180deg); }
    100% { transform: translate(0, 0) rotate(360deg); }
}

@keyframes wave-rotate-3 {
    0% { transform: translate(-2%, 0) rotate(0deg); }
    50% { transform: translate(-2%, 2%) rotate(180deg); }
    100% { transform: translate(-2%, 0) rotate(360deg); }
}

@keyframes wave-rotate-4 {
    0% { transform: translate(3%, 0) rotate(0deg); }
    50% { transform: translate(3%, -1%) rotate(180deg); }
    100% { transform: translate(3%, 0) rotate(360deg); }
}

@keyframes rise {
    0% {
        bottom: -20px;
        transform: translateX(0) scale(0.8);
        opacity: 0;
    }
    10% {
        opacity: 0.8;
    }
    50% {
        transform: translateX(10px) scale(1);
        opacity: 0.9;
    }
    100% {
        bottom: 110%;
        transform: translateX(-15px) scale(0.6);
        opacity: 0;
    }
}

/* Responsive */
@media (max-width: 768px) {
    .liquid-card-container {
        grid-column: span 1;
        height: 220px;
    }
    .liquid-amount {
        font-size: 42px;
    }
    .liquid-currency {
        font-size: 22px;
    }
}






/* Add specific styling based on content if possible, 
   or let the IDs handle the colors below */

.stat-pill-card .label { font-size: 9px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
.stat-pill-card .val { font-size: 16px; font-weight: 800; font-family: 'Courier New', monospace; color: #1e293b; }


 .stat-pill-card{
     border-left: 3px solid var(--premium-indigo);
     border: 1px solid #00366b32;
 }
/* System Status Pulse */
.system-status-pulse {
    background: var(--soft-slate);
    border-radius: 16px;
    margin-bottom: 10px;
}

.status-row { display: flex; align-items: center; gap: 12px; }
.status-indicator { width: 10px; height: 10px; border-radius: 50%; position: relative; }
.status-indicator::after {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    border-radius: 50%; background: inherit; animation: pulse-status 2s infinite;
}

@keyframes pulse-status { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(2.5); opacity: 0; } }

/* Feed */
.activity-feed-premium {
    background: white;
    border-radius: 20px;
    padding: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.02);
}

.feed-item {
    padding: 10px 0;
    border-bottom: 1px solid #f8fafc;
    display: flex; gap: 12px; align-items: flex-start;
}

.feed-icon { font-size: 14px; padding-top: 2px; }
.feed-content .msg { font-size: 12px; font-weight: 600; color: #334155; line-height: 1.4; }
.feed-content .time { font-size: 9px; color: var(--text-muted); margin-top: 2px; }



/* =========================
   Design Tokens (Professional Palette)
========================= */
:root {
    --brand-primary: #1fa97a;
    --bg-card: #ffffff;
    --border-soft: #e5e7eb;
    --text-dark: #1f2937;
    --text-muted: #6b7280;

    --night-bg-start: #0f172a;
    --night-bg-end: #1e293b;

    --day-bg-start: #f8fafc;
    --day-bg-end: #e0f2fe;
}

/* --- Modern Meal Plan Card --- */
.meal-pulse-card {
    background: var(--bg-card);
    border-radius: 22px;
    padding: 0;
    box-shadow: 0 10px 28px rgba(15, 23, 42, 0.06);
    margin-bottom: 20px;
    border: 1px solid var(--border-soft);
    overflow: hidden;
    box-shadow: inset 0 0 30px rgb(0 0 0 / 45%);
}

/* Header */
.pulse-header-modern {
    padding: 14px 20px;
    background: #ffff;
    box-shadow: inset 0 0 30px rgb(164 165 122 / 64%);
    border: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-soft);
    display: flex;
    justify-content: center;
    align-items: center;
}

.pulse-header-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--text-dark);
    font-family: 'Hind Siliguri', sans-serif;
    letter-spacing: 0.2px;
}

/* Grid */
.pulse-grid-modern {
    display: grid;
    grid-template-columns: 1fr 1fr;
}

/* Slots */
.plan-slot {
    padding: 22px 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
}

/* =========================
   NIGHT SLOT (Calm Dark)
========================= */
.slot-night {
    /*background-image: url(img2.jpg);*/
    background-size: cover;
    border-right: 1px solid rgba(255, 255, 255, 0.08);
}

.slot-night .slot-label {
    background: rgb(16 16 16 / 79%);
    color: #e6f1ff;
    border: 1px solid rgba(255, 255, 255, 0.15);
}

.slot-night .slot-date {
    color: .slot-night .slot-label#3954aaf0;
}

.slot-night .slot-count {
    color: #0e608a;
    text-shadow: 0 4px 18px rgb(0 0 0 / 26%);
}

/* =========================
   DAY SLOT (Clean Light)
========================= */
.slot-day {
    /* background-image: url(img1.jpg); */
    background-size: cover;
    color: #0f172a;
}

.slot-day .slot-label {
    background: #e0f2fe;
    color: #0369a1;
    border: 1px solid #bae6fd;
}

.slot-day .slot-date {
    color: #075985;
}

.slot-day .slot-count {
    color: #0284c7;
    text-shadow: 0 4px 18px rgb(0 0 0 / 26%);
}


/* =========================
   Typography
========================= */
.slot-date {
    font-family: 'Hind Siliguri', sans-serif;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 8px;
    line-height: 1.4;
}

.slot-label {
    font-family: 'Hind Siliguri', sans-serif;
    font-size: 11px;
    font-weight: 700;
    padding: 4px 12px;
    border-radius: 999px;
    margin-bottom: 12px;
    letter-spacing: 0.3px;
}

.slot-count {
    font-family: 'Hind Siliguri', sans-serif;
    font-size: 34px;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 6px;
}

.slot-menu {
    font-family: 'Hind Siliguri', sans-serif;
    font-size: 11px;
    color: #ffffff;
    background: #807d82c2;
    padding: 2px 5px;
    border-radius: 8px;
    opacity: 0.85;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}

/* =========================
   Stat Cards Cleanup
========================= */
.stat-card {
    margin-bottom: 0 !important;
    padding: 22px;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

/* =========================
   Weekly Menu Input (Premium)
========================= */
.weekly-menu-input {
    border: 1px solid transparent !important;
    background: transparent !important;
    transition: all 0.2s ease;
}

.weekly-menu-input:hover,
.weekly-menu-input:focus {
    border: 1px solid var(--border-soft) !important;
    background: #f8fafc !important;
}

.weekly-menu-input:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(31, 169, 122, 0.15);
}


/* --- Modern Table Styling --- */
.summary-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.table-wrapper {
    overflow-x: auto;
    background: var(--card-bg);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    -webkit-overflow-scrolling: touch;
}

.managed-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    white-space: nowrap;
}

.managed-table th {
    background: var(--bg-color);
    padding: 12px 15px;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 10px;
    letter-spacing: 0.5px;
    color: var(--text-secondary);
    border-bottom: 2px solid var(--border-color);
    text-align: center;
}

.managed-table td {
    padding: 10px 15px;
    border-bottom: 1px solid var(--border-color);
    vertical-align: middle;
    text-align: center;
}

/* Sticky First Column (Name) */
.managed-table th:first-child, 
.managed-table td:first-child {
    position: sticky;
    left: 0;
    background-color: var(--card-bg);
    z-index: 10;
    text-align: left;
    border-right: 2px solid var(--border-color);
    min-width: 120px;
}

.managed-table th:first-child {
    background: var(--bg-color);
}

.managed-table tr:hover td {
    background-color: rgba(79, 70, 229, 0.02);
}

/* --- Premium Summary Table & Page --- */
.summary-stats-header {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
}

.summary-card-mini {
    background: white;
    padding: 12px;
    border-radius: 14px;
    border: 1px solid #f1f5f9;
    text-align: center;
}

.summary-card-mini .label { font-size: 9px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
.summary-card-mini .val { font-size: 14px; font-weight: 800; color: var(--premium-indigo); }

/* Sticky Table Logic */
.summary-table-wrapper {
    overflow-x: auto;
    background: white;
    border-radius: 16px;
    border: 1px solid #f1f5f9;
    box-shadow: 0 4px 20px rgba(0,0,0,0.02);
}

.summary-table-premium {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    white-space: nowrap;
}

.summary-table-premium th {
    background: #f8fafc;
    padding: 12px 15px;
    font-weight: 800;
    color: var(--text-muted);
    text-transform: uppercase;
    font-size: 9px;
    border-bottom: 1px solid #f1f5f9;
    text-align: center;
}

.summary-table-premium td {
    padding: 10px 10px;
    border-bottom: 1px solid #f1f5f9;
    text-align: center;
    vertical-align: middle;
}

/* STICKY NAME COLUMN */
.summary-table-premium th:first-child, 
.summary-table-premium td:first-child {
    position: sticky;
    left: 0;
    background: white;
    z-index: 10;
    text-align: left;
    border-right: 2px solid #f1f5f9;
    min-width: 50px;
}

.summary-table-premium th:first-child { background: #f8fafc; }

/* Status Toggles in Summary */
.summary-status-btn {
    width: 42px;
    height: 22px;
    border-radius: 20px;
    border: 1px solid #e2e8f0;
    font-size: 9px;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.2s;
}

.summary-status-btn.on { background: #10b981; color: white; border-color: #10b981; }
.summary-status-btn.off { background: #f1f5f9; color: var(--text-muted); }

/* Due Settlement Refined */
.due-grid-mobile {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 20px;
}

.due-section-box {
    background: white;
    border-radius: 16px;
    padding: 15px;
    border: 1px solid #f1f5f9;
}

.due-item-premium {
    padding: 10px;
    border-radius: 12px;
    background: #f8fafc;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.due-item-premium .name { font-weight: 700; font-size: 13px; color: #1e293b; }
.due-item-premium .amt { font-weight: 800; font-family: 'Courier New', monospace; font-size: 14px; }


/* Balance Badges */
.balance-tag {
    font-family: 'Courier New', monospace;
    font-weight: 800;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 13px;
}

.balance-tag.pos { background: #ECFDF5; color: #047857; }
.balance-tag.neg { background: #FEF2F2; color: #B91C1C; }

/* --- Premium Mess Balance Card (Dashboard) --- */
.balance-glass-card {
    background: #1e293b; /* Deep Slate Base */
    border-radius: 24px;
    padding: 20px;
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
}

/* Aurora Glow behind glass */
.balance-glass-card::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: #fafff6;
    z-index: 0;
}

.glass-card-inner { position: relative; z-index: 1; }

.glass-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.glass-label { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }

/* Status Pill */
.status-pill-fintech {
    font-size: 8px;
    font-weight: 900;
    padding: 3px 8px;
    border-radius: 20px;
    text-transform: uppercase;
}

.status-pill-fintech.pos { background: #064e3b; color: #34d399; border: 1px solid #065f46; }
.status-pill-fintech.neg { background: #450a0a; color: #f87171; border: 1px solid #7f1d1d; animation: pulse-red-border 2s infinite; }

.glass-body { display: flex; align-items: baseline; gap: 5px; margin-bottom: 15px; }
.glass-currency { font-size: 20px; font-weight: 400; color: #94a3b8; }
.glass-value { font-size: 34px; font-weight: 900; color: white; font-family: 'Inter', sans-serif; letter-spacing: -1px; }

/* Safety Bar (Visual Buffer) */
.safety-bar-container {
    height: 4px;
    background: rgb(41 92 24);
    border-radius: 10px;
    margin-bottom: 6px;
    overflow: hidden;
}
.safety-bar-fill { height: 100%; width: 0%; transition: width 1s ease, background 0.5s; }
.safety-text { font-size: 9px; color: #64748b; font-weight: 700; }



.balance-glass-card {
    /* Dark Theme Gradient for Contrast */
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%) !important;
    color: white !important;
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.glass-label {
    color: #94a3b8 !important; /* Light Slate text */
    letter-spacing: 1.5px;
}

.glass-currency {
    color: #64748b !important;
}

.glass-value {
    color: #ffffff !important; /* Pure white text pops on dark background */
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Update the status pill inside this card */
.status-pill-fintech.pos {
    background: rgba(16, 185, 129, 0.2);
    color: #34d399;
    border: 1px solid rgba(16, 185, 129, 0.3);
}



.bottom-nav {
    background-color: #ffffff !important; /* Clean White */
    border-top: 1px solid #e2e8f0;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
}

.bottom-nav-link {
    color: #64748b; /* Inactive Icon Color (Slate 500) */
}

/* Active State */
.bottom-nav-link.active {
    color: var(--primary-color) !important;
    background-color: transparent; /* Remove the heavy box background */
}

.bottom-nav-link.active span:first-child {
    transform: translateY(-5px);
    color: var(--primary-color);
    filter: drop-shadow(0 4px 6px rgba(5, 150, 105, 0.2)); /* Green glow on icon */
}



@keyframes pulse-red-border {
    0% { border-color: #7f1d1d; }
    50% { border-color: #ef4444; }
    100% { border-color: #7f1d1d; }
}

/* Responsive adjustment for Dashboard Grid */
@media (max-width: 768px) {
    .dash-stats-grid {
        grid-template-columns: 1fr; /* Make balance card full width on mobile for impact */
    }
    .balance-glass-card { grid-column: span 1; }
}
/* Total Meals Card Styling (Blue) */
#statTotalMealsDisplay {
    color: #2563eb !important; /* Royal Blue */
}




/* Dashboard Balance Indicator Colors */
#statMessBalance.pos {
    color: #10b981 !important; /* Emerald Green */
}

#statMessBalance.neg {
    color: #ef4444 !important; /* Rose Red */
}

/* --- Mobile View Adjustments (Dashboard) --- */
@media (max-width: 768px) {

    /* 1. Force the grid to have 2 columns on mobile */
    .dash-stats-grid {
        grid-template-columns: 1fr 1fr !important; 
        gap: 10px;
    }

    /* 2. Make the Big Balance Card span across both columns (Full Width) */
    .balance-glass-card, 
    #messBalanceContainer {
        grid-column: span 2 !important;
    }

    /* 3. Optional: Compact styling for the small cards so they fit nicely */
    .stat-pill-card {
        padding: 10px !important;
        min-height: 80px; /* Ensure consistent height */
    }
    
    .stat-pill-card .label {
        font-size: 8px !important;
        white-space: nowrap; /* Prevent text wrapping */
    }
    
    .stat-pill-card .val {
        font-size: 15px !important; /* Adjust number size */
    }
}

/* Subtle background tints for the balance card */
.bg-tint-pos {
    background: #e3e4933b !important;
    border: 1px solid rgba(16, 185, 129, 0.2) !important;
}

.bg-tint-neg {
    background: rgba(239, 68, 68, 0.08) !important;
    border: 1px solid rgba(239, 68, 68, 0.2) !important;
}


/* Mobile View Adjustments */
@media (max-width: 768px) {
    .managed-table {
        font-size: 12px;
    }
    
    .managed-table td, .managed-table th {
        padding: 8px 10px;
    }

    .summary-status-btn {
        width: 40px;
        height: 22px;
    }
}



/* MOBILE VIEW RESPONSIVENESS */
@media (max-width: 768px) {
    .dashboard-header-grid {
        grid-template-columns: 1fr; /* Stack: Plan on top, stats below */
    }
    
    .stats-subgrid {
        grid-template-columns: 1fr 1fr; /* Stats share width: 2 per row */
        gap: 10px;
    }

    .stat-card {
        padding: 15px;
        min-height: 100px;
    }
    
    .stat-value {
        font-size: 18px;
    }

    .segment-count {
        width: 60px;
        font-size: 20px;
        padding: 8px;
    }
}
/* Mobile Tweak */
@media (max-width: 480px) {
    .meal-plan-count-box {
        font-size: 20px;
        padding: 4px 15px;
    }
}
.log-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    margin-bottom: 8px;
    border: 1px dashed rgba(149, 149, 149, 0.593);
    border-radius: 8px;
}
.log-main {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.log-amount {
    font-weight: bold;
    white-space: nowrap;
}

/* Floating Real-time Status Indicator */
.realtime-status {
    position: fixed;
    bottom: 20px; /* Distance from bottom on Desktop */
    right: 20px;
    background: var(--card-bg);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 2000; /* Above most elements */
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 6px;
    pointer-events: none; /* Allows clicking things behind it if necessary */
    transition: all 0.3s ease;
}

/* Status Colors */
.realtime-status.connected {
    color: #10B981;
    border-color: #10B981;
}

.realtime-status.disconnected {
    color: #EF4444;
    border-color: #EF4444;
}

/* Mobile Adjustment: Move it above the Bottom Nav */
@media (max-width: 768px) {
    .realtime-status {
        bottom: calc(var(--bottom-nav-height) + 15px); /* Position it 15px above bottom nav */
        right: 15px;
        padding: 4px 10px;
        font-size: 9px;
        background: rgba(255, 255, 255, 0.9); /* Slight transparency on mobile */
        backdrop-filter: blur(4px);
    }
}

/* Header Warning State */
.app-header.balance-warning {
    background-color: #fffcf6 !important; /* Very light red */
    border-bottom: 2px solid var(--danger-color);
    transition: all 0.5s ease;
}

.app-header.balance-warning .app-logo {
    color: var(--danger-color);
}

/* Optional: Add a pulsing animation to the logo when in debt */
.app-header.balance-warning .app-logo {
    animation: pulse-red 2s infinite;
}

@keyframes pulse-red {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

/* Mobile tweak for the warning */
@media (max-width: 768px) {
    .app-header.balance-warning {
        border-bottom-width: 3px;
    }
}


/* Mobile responsive for due cards */
@media (max-width: 768px) {
    #dueSettlementCard > div[style*="grid"] {
        grid-template-columns: 1fr !important;
    }
}

/* Dynamic Badge Animations */
#entryStatusBadge {
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-block;
    min-width: 120px;
    text-align: center;
}

/* Transition classes */
.badge-fade-out {
    opacity: 0;
    transform: translateY(-10px);
}

.badge-fade-in {
    opacity: 1;
    transform: translateY(0);
}

/* Specific colors for warnings */
.status-debt { background: #FEE2E2; color: #B91C1C; border: 1px solid #FECACA; }
.status-due { background: #FEF3C7; color: #92400E; border: 1px solid #FDE68A; }
   

/* =========================================
           7. MOBILE RESPONSIVENESS (CRITICAL)
           ========================================= */
        @media (max-width: 768px) {
            /* 1. LAYOUT & SIDEBAR AS DRAWER */
            .main-content { margin-left: 0; padding: 15px; padding-bottom: 90px; }
            .bottom-nav { display: block; }
            
            .sidebar {
                transform: translateX(-100%);
                width: 280px; height: 100vh; top: 0; left: 0;
                z-index: 2500; box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            }
            .sidebar.mobile-active { transform: translateX(0); }

            /* 2. HEADER TWEAKS */
            .user-info { display: none; } /* Hide Name */
            .user-role { display: none; }
            .header-clock { 
                display: flex !important; /* Show clock container */
                align-items: flex-end; 
            }
            .clock-time, .clock-date { display: none; } /* Hide time text */
            
            #entryStatusBadge { margin: 0; font-size: 9px; padding: 3px 6px; } /* Only show Badge */

}

            /* 3. TOAST NOTIFICATION FIX */
            #toast-container {
                top: 70px; /* Below Header */
                left: 50%; transform: translateX(-50%); /* Center */
                width: 90%; max-width: 350px;
                right: auto;
            }
            .toast {
                width: 100%; min-width: auto;
                font-size: 12px; padding: 8px 12px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            }

            /* 4. CONTENT ADJUSTMENTS */
            .stats-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            .stat-value { font-size: 18px; }
            .split-view-container { grid-template-columns: 1fr; } /* Stack deposits */
            .notif-panel { width: 100%; right: -100%; }

            /* 5. INPUT FIX */
            .form-input, .form-select { font-size: 16px; } /* Prevents zoom */
        }


        /* Enhanced Transaction Log Styles */
.log-item {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.2s;
}

.log-item:hover { background-color: rgba(0,0,0,0.02); }

.log-main { display: flex; align-items: center; gap: 15px; }

.log-icon {
    width: 40px; height: 40px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
}

.log-icon.deposit { background: #EEF2FF; color: #4F46E5; }
.log-icon.settlement { background: #F3F4F6; color: #6B7280; }
.log-icon.charge { background: #FEF2F2; color: #EF4444; }

.log-details { display: flex; flex-direction: column; }

.log-member { 
    font-weight: 800; 
    font-size: 15px; 
    color: var(--text-primary); 
    display: flex; 
    align-items: center; 
    gap: 8px;
}

.log-type-tag {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.tag-deposit { background: #DBEAFE; color: #1E40AF; }
.tag-settle { background: #F3F4F6; color: #374151; }

.log-meta { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }

.log-amount-area { text-align: right; }

.log-amount { font-family: 'Courier New', monospace; font-weight: 900; font-size: 16px; }

/* Arrow indicator for settlements */
.transfer-info {
    font-size: 11px;
    color: var(--primary-color);
    background: #F5F3FF;
    padding: 2px 8px;
    border-radius: 12px;
    margin-top: 4px;
    display: inline-block;
}
    </style>

      <script>
        window.supabaseLoadError = false;
        function handleSupabaseLoadError() {
            console.error('Failed to load Supabase script');
            const notification = document.getElementById('login-notification');
            if (notification) {
                notification.innerHTML = '<p class="error">Failed to load Supabase. Please check your internet connection and try again later.</p>';
            }
            const loader = document.getElementById('loader');
            if (loader) loader.classList.add('hidden');
        }
        </script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js" onerror="window.supabaseLoadError = true; handleSupabaseLoadError();"></script>
        <script>
        if (window.supabaseLoadError) {
            document.write('<script src="lib/supabase.min.js"><\/script>');
            console.warn('Loaded local Supabase script as fallback');
        }
        </script>
</head>
<body>

  <!-- The Splash Screen Loader with Video -->
<div id="initial-loader" class="splash-screen">
    <div class="splash-content">
        <!-- Replace the logo/spinner with this video tag -->
        <video id="splash-video" playsinline autoplay muted loop class="splash-video-asset">
            <source src="video3.mp4" type="video/mp4">
            <!-- Fallback image if video fails to load -->
            <img src="Mealcal_logo.png" alt="MealCal Logo">
        </video>
        
        <p class="splash-text">Preparing your kitchen...</p>
        
        <!-- Optional: A slim progress bar instead of a spinning circle -->
        <div class="loader-progress-container">
            <div class="loader-progress-bar" id="load-progress"></div>
        </div>
    </div>
</div>

<!-- Enhanced Auth Page -->
<div id="authPage" class="auth-page-wrapper hidden">    
    <!-- Animated Background Glows -->
    <div class="auth-bg-glow glow-1"></div>
    <div class="auth-bg-glow glow-2"></div>

    <div class="auth-container-premium">
        <!-- Logo & Branding Section -->
        <div class="auth-brand">
            <img src="Mealcal_logo.png" alt="Logo" class="auth-logo-img">
            <h1 class="auth-app-name">MealCal <span>Pro</span></h1>
            <p class="auth-subtitle" id="authSubtitle">Your kitchen, professionally managed.</p>
        </div>

        <!-- The Glass Card -->
        <div class="auth-card-premium">
            <div id="authError" class="auth-error-message"></div>

            <form id="authForm">
                <!-- Username Field (Signup Only) -->
                <div class="auth-input-group hidden" id="usernameField">
                    <label class="auth-label">Full Name</label>
                    <div class="auth-input-wrapper">
                        <span class="auth-input-icon">👤</span>
                        <input type="text" id="authUsername" placeholder="e.g. Ayan Rahman">
                    </div>
                </div>

                <!-- Email/User Field -->
                <div class="auth-input-group">
                    <label class="auth-label" id="emailLabel">Email or Username</label>
                    <div class="auth-input-combined">
                        <div class="auth-input-wrapper flex-main">
                            <span class="auth-input-icon">📧</span>
                            <input type="text" id="authEmail" placeholder="Enter credentials" required>
                        </div>
                        <select id="authUserDropdown" class="auth-select-mini">
                            <option value="">Select ▼</option>
                        </select>
                    </div>
                </div>

                <!-- Password Field -->
                <div class="auth-input-group">
                    <label class="auth-label">Security Password</label>
                    <div class="auth-input-wrapper">
                        <span class="auth-input-icon">🔒</span>
                        <input type="password" id="authPassword" placeholder="••••••••" required>
                    </div>
                </div>

                <button type="submit" class="auth-submit-btn" id="authBtn">
                    <span>Login to Kitchen</span>
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </button>
            </form>

            <div class="auth-footer">
                <span id="authToggleText">New to the mess?</span>
                <button id="authToggleBtn">Create Account</button>
            </div>
        </div>
        
        <p class="auth-legal">© 2026 MealCal Pro. Secure Cloud Sync.</p>
    </div>
</div>
    <!-- Main App -->
    <div id="mainApp" class="app-container hidden">

           <!-- FIXED HEADER -->
<header class="app-header">
    <div class="header-left">
        <!-- New logo image before the name -->
        <img src="Mealcal_logo.png" alt="Logo" class="header-logo-icon">
        <div class="app-logo">MealCal Pro</div>
        <div class="cycle-badge" id="headerCycleName">Loading...</div>
          
        </div>

   <div class="header-clock">
            <div class="clock-time" id="clockTime">00:00:00</div>
            <div class="clock-date" id="clockDate">Mon, 01 Jan</div>
            <!-- NEW INDICATOR -->
            <div id="entryStatusBadge" class="entry-status-badge status-pending">Loading...</div>
        </div>

        

        <div class="header-right">
            <div class="user-info">
                <div class="user-name" id="headerUserName">User</div>
                <div class="user-role" id="headerUserRole">Role</div>
            </div>
            <button class="notif-btn" id="notifBellBtn">
                🔔
                <span class="notif-badge hidden" id="notifBadge">0</span>
            </button>
        </div>
    </header>

    <!-- NOTIFICATION PANEL -->
    <div class="notif-panel" id="notifPanel">
        <div class="notif-header">
            <h3>Notifications</h3>
            <button class="close-modal" id="closeNotifPanel">×</button>
        </div>
        <div class="notif-filters">
            <button class="filter-chip active" data-filter="all">All</button>
            <button class="filter-chip" data-filter="deposit">Deposits 💰</button>
            <button class="filter-chip" data-filter="expense">Expenses 🛒</button>
            <button class="filter-chip" data-filter="meal">Meals 🍽️</button>
            <button class="filter-chip" data-filter="other">System ⚙️</button>
        </div>
        <div class="notif-list" id="notifListContainer">
            <div class="loading">Loading...</div>
        </div>
    </div>


        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">

            <div class="cycle-selector">
                <select id="cycleSelect" class="form-select">
                    <option value="">Loading cycles...</option>
                </select>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-page="dashboard">
                        <span class="nav-icon">📊</span>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="profile">
                        <span class="nav-icon">👤</span>
                        Profile
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="tracker">
                        <span class="nav-icon">📅</span>
                        Meal Tracker
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="summary">
                        <span class="nav-icon">📈</span>
                        Summary
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="expenses">
                        <span class="nav-icon">🛒</span>
                        Expenses
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="deposits">
                        <span class="nav-icon">💰</span>
                        Deposits
                    </a>
                </li>
                <li class="nav-item" id="adminMenuItem" style="display: none;">
                    <a class="nav-link" data-page="admin">
                        <span class="nav-icon">⚙️</span>
                        Admin Panel
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="logoutBtn">
                        <span class="nav-icon">🚪</span>
                        Logout
                    </a>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">


            <!-- Dashboard Page -->
<div id="dashboardPage" class="page-content">
    <!-- Welcome Header -->
    <div style="display: none;" class="dash-welcome-row">
        <p>Dashboard Overview</p>
        <h2 id="welcomeName">Hello!</h2>
    </div>

 <!-- Modern Meal Plan Card -->
<div class="meal-pulse-card">
    <div class="pulse-header-modern">
        <span class="pulse-header-title">📅 আজকের মিল শিডিউল</span>
        <span class="pulse-badge">LIVE</span>
    </div>
    
    <div class="pulse-grid-modern">
        <!-- Night Slot (Today) -->
        <div class="plan-slot slot-night">
            <div class="slot-date" id="planNightDate">-- জানুয়ারি --</div>
            <div class="slot-label">রাত</div>
            <div class="slot-count" id="planNightTotal">০</div>
            <div class="slot-menu" id="planNightMenu">менু নেই</div>
        </div>

        <!-- Day Slot (Tomorrow) -->
        <div class="plan-slot slot-day">
            <div class="slot-date" id="planDayDate">-- জানুয়ারি --</div>
            <div class="slot-label">দুপুর</div>
            <div class="slot-count" id="planDayTotal">০</div>
            <div class="slot-menu" id="planDayMenu">মেনু নেই</div>
        </div>
    </div>
</div>

    <!-- 2. Stats Grid (2x2) -->
    <div class="dash-stats-grid">


<!-- Modern Vertical Meter Card -->
<div class="liquid-card-container state-healthy-liquid" id="messBalanceContainer">
    <div class="liquid-card-bg"></div>
    
    <!-- Vertical Meter -->
    <div class="liquid-box">
        <div class="liquid-fill-body" id="liquidFillBar" style="--fill-percent: 50%;">
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
        </div>
    </div>
    
    <!-- Scale Marks -->
    <div class="meter-marks">
        <div class="meter-mark">
            <div class="meter-mark-line"></div>
            <div class="meter-mark-label">10k</div>
        </div>
        <div class="meter-mark">
            <div class="meter-mark-line"></div>
            <div class="meter-mark-label">7.5k</div>
        </div>
        <div class="meter-mark">
            <div class="meter-mark-line"></div>
            <div class="meter-mark-label">5k</div>
        </div>
        <div class="meter-mark">
            <div class="meter-mark-line"></div>
            <div class="meter-mark-label">2.5k</div>
        </div>
        <div class="meter-mark">
            <div class="meter-mark-line"></div>
            <div class="meter-mark-label">0</div>
        </div>
    </div>

    <!-- Content -->
    <div class="liquid-content">
        <div class="liquid-header">
            <div class="liquid-title">Mess Liquidity</div>
            <div class="liquid-capacity-pill">CAP: 10k</div>
        </div>

        <div class="liquid-value-wrapper">
            <span class="liquid-currency">৳</span>
            <span class="liquid-amount" id="statMessBalance">0</span>
        </div>

        <div class="liquid-meta">
            <div id="balanceStatusPill" class="liquid-status-badge">
                Calculating...
            </div>
            <div class="liquid-percentage" id="liquidPercent">
                0%
            </div>
        </div>
    </div>
</div>

        <div class="stat-pill-card">
            <div class="label">Meal Rate</div>
            <div class="val" id="statMealRate">৳0.00</div>
        </div>

        <!-- 2. NEW CARD: Total Meals -->
<div class="stat-pill-card">
    <div class="label">Total Meals</div>
    <div class="val" id="statTotalMealsDisplay">0</div>
</div>


<!-- 1. DEPOSITS CARD -->
<div class="stat-pill-card" id="cardDeposit"  onclick="navigateToPending('deposits', event)">
    <!-- Updated Badge with OnClick -->
    <div id="badgeDeposit" class="premium-count-badge hidden">0</div>
    
    <div class="label">Deposits</div>
    <div class="val" id="statTotalDeposit" style="color: #059669;">৳0</div>
</div>

<!-- 2. EXPENSES CARD -->
<div class="stat-pill-card" id="cardExpense"  onclick="navigateToPending('expenses', event)">
    <!-- Updated Badge with OnClick -->
    <div id="badgeExpense" class="premium-count-badge hidden">0</div>
    
    <div class="label">Expenses</div>
    <div class="val" id="statTotalExpense" style="color: #e11d48;">৳0</div>
</div>


    </div>

    <!-- 4. Recent Activity Feed -->
    <div class="activity-feed-premium">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="font-size: 13px; font-weight: 800; color: #1e293b; margin: 0;">Recent Activity</h3>
            <button class="btn btn-sm" onclick="loadRecentActivity()" style="font-size: 9px; background: #f1f5f9; padding: 4px 10px;">Refresh</button>
        </div>
        <div id="recentActivity">
            <div class="loading">Fetching feed...</div>
        </div>
    </div>
</div>

            <!-- Profile Page -->
<!-- Profile Page -->
<div id="profilePage" class="page-content hidden">
    <!-- Premium Banner -->
    <div class="profile-header-banner">
        <!-- Text container moved here for asymmetrical look, IDs preserved -->
        <div style="display: flex;" class="profile-text-container">
            <h2 class="profile-main-name" id="profileName">Loading...</h2>
            <div class="profile-main-meta" id="profileRoleDisplay">Member</div>

                <!-- Quick Stats Overview -->
    <div class="profile-stats-mini">
        <div class="profile-stat-item">
            <div class="stat-mini-label">Total Meals</div>
            <div class="stat-mini-value" id="profileTotalMeals">0</div>
        </div>
        <div class="profile-stat-item">
            <div class="stat-mini-label">Total Paid</div>
            <div class="stat-mini-value" id="profileTotalDeposit" style="color: var(--success-color);">৳0</div>
        </div>
    </div>


        </div>
    </div>
    
    <div class="profile-info-section">
        <div class="profile-avatar-circle" id="profileAvatar">
            U
            <div class="profile-status-online"></div>
        </div>
    </div>



    <!-- Balance Focus Card (Fintech Style) -->
<div class="card balance-card-modern" id="profileBalanceCard">
    <!-- Left Side -->
    <div class="balance-card-left">
        <div class="stat-label">Wallet Balance</div>
        <div class="stat-value" id="profileBalance">৳0</div>
    </div>

    <!-- Right Side -->
    <div class="balance-card-right">
        <button class="btn btn-sm btn-primary" onclick="navigateToPage('deposits')">Add Cash</button>
        <div class="cycle-info-text">Cycle: <span id="profileCycleName">...</span></div>
    </div>
</div>

    <!-- Attendance Section -->
    <div class="card premium-card-shadow">
        <div class="card-header">
            <h3 class="card-title">🗓️ Meal Attendance</h3>
            <div id="lockTimeDisplay" class="lock-badge">
                Restricted: 05:00 PM - 07:00 PM
            </div>
        </div>

        <!-- System Health Card (Injected by loadSystemStatus) -->
        <div class="system-status-pulse">
            <div id="systemStatusContent">
                <div class="status-row">
                    <div class="status-indicator" style="background: #fbbf24;"></div>
                    <div style="font-size: 12px; font-weight: 700; color: #92400e;">Checking system logs...</div>
                </div>
            </div>
        </div>
        
        <div class="defaults-container">
            <div class="defaults-label">
                <span style="font-size: 0.8rem; font-weight: 700;">Default Meal</span>
            </div>
            <div class="defaults-toggles">
                <button id="defDayBtn" class="def-btn" onclick="toggleDefaultPreference('day')">Day</button>
                <button id="defNightBtn" class="def-btn" onclick="toggleDefaultPreference('night')">Night</button>
            </div>
        </div>

        <div class="scheduler-container">
            <div class="scheduler-scroll" id="schedulerList">
                <div class="loading">Generating timeline...</div>
            </div>
        </div>
    </div>

    <!-- Financial History -->
    <div class="card premium-card-shadow">
        <div class="card-header">
            <h3 class="card-title">💳 Recent Transactions</h3>
            <span class="view-ledger-link" onclick="navigateToPage('deposits')">View Ledger</span>
        </div>
        <div id="profileDepositHistory">
            <div class="loading">Syncing history...</div>
        </div>
    </div>
</div>



<!-- Tracker Page -->
<div id="trackerPage" class="page-content hidden">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px;">
        <h2 style="font-size: 20px; font-weight: 800;">Meal Tracker</h2>
        <button class="btn btn-sm btn-secondary" onclick="loadMasterTracker()" style="font-size: 10px; border-radius: 20px;">🔄 Sync</button>
    </div>


    <!-- Main Matrix -->
    <div class="matrix-premium-wrapper">
        <div class="matrix-wrapper" style="border:none; border-radius:0;"> <!-- Reuse existing scroll logic -->
            <table class="matrix-table-premium" id="masterMatrixTable">
                <thead><!-- Injected by JS --></thead>
                <tbody><!-- Injected by JS --></tbody>
            </table>
        </div>
    </div>

    <!-- Weekly Menu Section -->
    <div class="menu-editor-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="font-size: 13px; font-weight: 800; color: #1e293b; margin: 0;">Standard Weekly Menu</h3>
            <span style="font-size: 9px; color: var(--text-muted); font-weight: 700;">ADMIN ONLY EDIT</span>
        </div>
        
        <table class="menu-table-compact">
            <tbody id="weeklyMenuBody">
                <!-- Injected by JS -->
            </tbody>
        </table>
    </div>
</div>


   <!-- Summary Page -->
<div id="summaryPage" class="page-content hidden">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px;">
        <h2 style="font-size: 20px; font-weight: 800;">Summary</h2>
        <div style="display: flex; gap: 10px;">
        <!-- New Full Export Button -->
        <button class="btn btn-sm" id="exportFullCycleBtn" style="background-color: #4f46e5; color: white; border-radius: 20px; font-size: 10px;">
            📥 Full Data Export
        </button>
        <!-- Existing Simple Export Button -->
        <button class="btn btn-sm btn-secondary" id="exportSummaryBtn" style="font-size: 10px; border-radius: 20px;">
            Table Only
        </button>
        </div>
    </div>

    <!-- Cycle Stats Overview -->
    <div class="summary-stats-header">
        <div class="summary-card-mini">
            <div class="label">Meal Rate</div>
            <div class="val" id="summaryMealRate">৳0.00</div>
        </div>
        <div class="summary-card-mini">
            <div class="label">Total Cost</div>
            <div class="val" id="summaryTotalCost">৳0</div>
        </div>
        <div class="summary-card-mini">
            <div class="label">Meals</div>
            <div class="val" id="summaryTotalMeals">0</div>
        </div>
    </div>

    <!-- Main Member Table -->
    <div class="summary-table-wrapper">
        <table class="summary-table-premium" id="summaryTable">
            <thead>
                <tr>
                    <th>Member</th>
                    <th>🌙 Night</th>
                    <th>🌞 Day</th>
                    <th>Bazar</th>
                    <th>Meals</th>
                    <th>Balance</th>
                </tr>
            </thead>
            <tbody id="summaryTableBody">
                <tr><td colspan="6" class="loading">Generating report...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Due Settlement Tracker (Updated Section) -->
    <div id="dueSettlementCard" style="display: none;">
        <h3 style="font-size: 13px; font-weight: 800; margin: 25px 0 12px 5px; color: #64748b;">DUE SETTLEMENTS</h3>
        
        <div class="due-grid-mobile">
            <!-- Debtors Box -->
            <div class="due-section-box" style="border: 1px solid #932437;">
                <div style="font-size: 10px; font-weight: 800; color: #f43f5e; margin-bottom: 10px; text-transform: uppercase;">📉 Outstanding Debts</div>
                <div id="debtorsList"></div>
            </div>

            <!-- Creditors Box -->
            <div class="due-section-box" style="border: 1px solid #0f5f2d;">
                <div style="font-size: 10px; font-weight: 800; color: #10b981; margin-bottom: 10px; text-transform: uppercase;">📈 Awaiting Settlement</div>
                <div id="creditorsList"></div>
            </div>
        </div>
    </div>
</div>

<!-- 5. EXPENSES PAGE -->
<div id="expensesPage" class="page-content hidden">
    <div class="card" id="addExpenseCard">
        <!-- Header changes dynamically via JS -->
        <h3 class="card-title" id="expenseFormTitle">Add Expense</h3>
        
        <form id="expenseForm">
            <!-- Hidden ID to track editing -->
            <input type="hidden" id="editExpenseId" value="">

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <div>
                    <label class="form-label">Date</label>
                    <input type="date" id="expenseDate" class="exp-field" required>
                </div>
                <div>
                    <label class="form-label">Shopper</label>
                    <select id="expenseMember" class="exp-field" required><option value="">Select...</option></select>
                </div>
            </div>
       <div class="form-group">
    <label class="form-label">Items</label>
    <input type="text" id="expenseDescription" class="exp-field" placeholder="e.g. Chicken, Oil (Optional)">
</div>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div style="flex: 1;">
                    <label class="form-label">Amount (৳)</label>
                    <input type="number" id="expenseAmount" class="exp-field" required>
                </div>
                
                <!-- Buttons Container -->
                <div style="display: flex; gap: 8px;">
                    <button type="button" id="expenseCancelBtn" class="btn btn-secondary hidden" onclick="resetExpenseForm()">Cancel</button>
                    <button type="submit" id="expenseSubmitBtn" class="btn btn-primary">ADD +</button>
                </div>
            </div>
        </form>
    </div>
    
  <!-- 1. Pending Approvals Container -->
<div id="pendingExpensesCard" class="pending-box-premium" style="display: none; background: #fff7ed; border-color: #fdba74;">
    <h3 style="font-size: 11px; font-weight: 800; color: #9a3412; margin-bottom: 10px; text-transform: uppercase;">⏳ Pending Bazar Requests</h3>
    <div id="pendingExpensesList"></div>
</div>

<!-- 2. History List -->
<div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px 0;">
    <h3 style="font-size: 13px; font-weight: 800; color: var(--text-secondary);">HISTORY</h3>
    <span style="font-size: 10px; color: var(--text-muted); font-weight: 700;">APPROVED ONLY</span>
</div>
<div id="expenseList"><div class="loading">Loading...</div></div>

</div> <!-- <<< THIS CLOSING DIV WAS LIKELY MISSING -->


<!-- Deposits Page (Should be separate, NOT inside expensesPage) -->
<div id="depositsPage" class="page-content hidden">
    <div style="display: none; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px;">
        <h2 style="font-size: 20px; font-weight: 800;">Wallet</h2>
        <div style="font-size: 10px; color: var(--text-muted); font-weight: 700;">FINANCE CENTER</div>
    </div>

    <!-- 1. Pending Approvals -->
    <div id="pendingDepositsCard" class="pending-box-premium" style="display: none;">
        <h3 style="font-size: 11px; font-weight: 800; color: #b91c1c; margin-bottom: 10px; text-transform: uppercase;">⏳ Pending Requests</h3>
        <div id="pendingDepositList"></div>
    </div>

    <!-- 2. Transaction Form -->
    <div class="wallet-form-container">
        <form id="depositForm" class="wallet-grid">
            <div class="exp-input-group">
                <label>Member</label>
                <select id="depositMember" class="exp-field" onchange="loadSelectedMemberHistory(this.value)" required>
                    <option value="">Select...</option>
                </select>
            </div>
            <div class="exp-input-group">
                <label>Type</label>
                <select id="depositType" class="exp-field" onchange="autoUpdateDepositLabel()">
                    <option value="deposit">💰 Add Cash</option>
                    <option value="charge">🔻 Deduction</option>
                </select>
            </div>
            <div class="exp-input-group">
                <label>Amount (৳)</label>
                <input type="number" style="border: 2px solid rgb(176, 0, 0);" id="depositAmount" class="exp-field" placeholder="0" required oninput="this.value = Math.round(this.value)">
            </div>
            <div class="exp-input-group">
                <label>Label</label>
                <input type="text" id="depositLabel" class="exp-field" value="Deposit">
            </div>
            <div class="notes-btn-row">
                <div style="flex: 1;">
                    <label style="font-size: 10px; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Notes</label>
                    <input type="text" id="depositNotes" class="exp-field" placeholder="Optional notes..." style="height: 38px;">
                </div>
                <button type="submit" class="btn-wallet-submit">SUBMIT</button>
            </div>
        </form>
    </div>

    <!-- 3. SELECTED MEMBER HISTORY (The Part I skipped) -->
    <div class="card" style="margin-top: 20px; padding: 15px; border: 1px solid var(--premium-indigo); background: #e2b7b7b5;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="font-size: 13px; font-weight: 800; color: rgb(33, 33, 33);">Individual Ledger</h3>
            <span id="historyMemberName" style="font-size: 11px; font-weight: 700; color: var(--premium-indigo); background: #000000b5; padding: 2px 8px; border-radius: 10px;">No member selected</span>
        </div>
        <div id="selectedMemberHistoryList" style="max-height: 250px; overflow-y: auto;">
            <div class="loading" style="font-size: 11px;">Select a member to view their specific log.</div>
        </div>
    </div>

    <!-- 4. Global Feed -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin: 25px 0 12px 5px;">
        <h3 style="font-size: 13px; font-weight: 800; color: #64748b;">GLOBAL LOG</h3>
        <select id="depositLogFilter" class="exp-field" style="width: auto; height: 28px; font-size: 10px; padding: 0 8px;" onchange="loadDeposits()">
            <option value="">All Members</option>
        </select>
    </div>

    <div id="depositList">
        <div class="loading">Syncing global ledger...</div>
    </div>
</div>

            <!-- Admin Page -->
            <div id="adminPage" class="page-content hidden">
                <h2 style="margin-bottom: 20px;">Admin Panel</h2>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Cycle Management</h3>
                    </div>


                    <form id="createCycleForm">
                        <div class="form-group">
                            <label class="form-label">Cycle Name</label>
                            <input type="text" id="cycleName" class="form-input" placeholder="e.g., April 2025" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" id="cycleStartDate" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" id="cycleEndDate" class="form-input" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Create Cycle</button>
                    </form>

                    <!-- Inside Admin Page, replace closeMonthBtn div -->
<div class="form-group" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border-color);">
    <label class="form-label" style="color: var(--danger-color); font-size: 16px;">
        ⚠️ Danger Zone: Close Current Cycle
    </label>
    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">
        This will finalize the current cycle, calculate balances, and create a new cycle with automatic due forwarding.
    </p>
    <button type="button" class="btn btn-danger" id="closeMonthBtn" style="width: 100%;">
        🔒 Close Current Cycle & Create New
    </button>
</div>



                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Member Management</h3>
                        <div style="font-size:12px; color:var(--text-secondary);">Adding a member automatically creates a user with password "123"</div>
                    </div>
                    <form id="addMemberForm">
                        <div class="form-group">
                            <label class="form-label">Member Name</label>
                            <input type="text" id="memberName" class="form-input" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Member</button>
                    </form>
                    <div id="membersList" style="margin-top: 20px;">
                        <div class="loading">Loading members...</div>
                    </div>
                </div>


                <!-- Inside Admin Page, add this card -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">System Settings</h3>
    </div>
  <form id="adminSettingsForm">
        <div class="form-group">
            <label class="form-label">Restricted Bazar Range (Lock Time)</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div style="flex:1">
                    <label for="settingLockTime" style="font-size: 11px;">Start Time</label>
                    <input type="time" id="settingLockTime" class="form-input" required>
                </div>
                <div style="font-weight:bold;">-</div>
                <div style="flex:1">
                    <label style="font-size: 11px;">End Time</label>
                    <input type="time" id="settingLockTimeEnd" class="form-input" required>
                </div>
            </div>
            <small style="color: var(--text-secondary); display:block; margin-top:5px;">
                Users cannot change meal status between these times on the day of the bazar.
            </small>
        </div>
        <button type="submit" class="btn btn-primary">Save Settings</button>
    </form>

    <!-- Inside adminSettingsForm -->
       <!-- Inside adminSettingsForm -->
<div class="form-group" style="margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 15px;">
    <label class="form-label">Auto-Entry / Finalize Time</label>
    <div style="display:flex; gap:10px; align-items:flex-end;">
        <input type="time" id="settingAutoTime" class="form-input" style="flex:1;" required>
        
        <!-- NEW BUTTON -->
        <button type="button" class="btn btn-danger" onclick="triggerManualAutoEntry()" style="font-size:12px; white-space:nowrap;">
            ⚡ Force Run Now
        </button>
    </div>
    <small style="color: var(--primary-color);">
        System will snapshot meals at this time. Use "Force Run" to apply plans to tracker immediately.
    </small>
</div>

</div>

            </div>
        </main>

    <!-- HIGH-DENSITY PREMIUM BOTTOM NAV (7 ITEMS) -->
<nav class="bottom-nav">
    <ul class="bottom-nav-list">
        <li class="bottom-nav-item">
            <a class="bottom-nav-link active" data-page="dashboard">
                <span>🏠</span><label>Home</label>
            </a>
        </li>
        <li class="bottom-nav-item">
            <a class="bottom-nav-link" data-page="profile">
                <span>👤</span><label>User</label>
            </a>
        </li>
        <li class="bottom-nav-item">
            <a class="bottom-nav-link" data-page="tracker">
                <span>📅</span><label>Track</label>
            </a>
        </li>
        <li class="bottom-nav-item">
            <a class="bottom-nav-link" data-page="summary">
                <span>📊</span><label>Sum</label>
            </a>
        </li>
        <li class="bottom-nav-item">
            <a class="bottom-nav-link" data-page="expenses">
                <span>🛒</span><label>Exp</label>
            </a>
        </li>
        <li class="bottom-nav-item">
            <a class="bottom-nav-link" data-page="deposits">
                <span>💰</span><label>Wallet</label>
            </a>
        </li>
        <li class="bottom-nav-item">
            <a class="bottom-nav-link" id="mobileMenuBtn">
                <span>☰</span><label>Menu</label>
            </a>
        </li>
    </ul>
</nav>


    <!-- Modals -->
<!-- Edit Meal Modal (Session Edition) -->
<div id="mealModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="mealModalTitle">Edit Session</h3>
            <span class="close-modal" onclick="closeMealModal()">×</span>
        </div>
        <form id="mealForm">
            <!-- Hidden Fields store the TWO dates we are editing -->
            <input type="hidden" id="mealMemberId">
            <input type="hidden" id="mealDateSession"> <!-- For Night -->
            <input type="hidden" id="mealDateNext">    <!-- For Day -->

<div class="form-group">
                <label class="form-label" id="mealNightLabel">Night Meal</label>
                <!-- Added min="0", step="1" and oninput logic -->
                <input type="number" id="mealNightCount" class="form-input" step="1" min="0" 
                       oninput="this.value = !!this.value && Math.abs(this.value) >= 0 ? Math.abs(Math.round(this.value)) : null">
            </div>

            <div class="form-group">
                <label class="form-label" id="mealDayLabel">Day Meal</label>
                <!-- Added min="0", step="1" and oninput logic -->
                <input type="number" id="mealDayCount" class="form-input" step="1" min="0" 
                       oninput="this.value = !!this.value && Math.abs(this.value) >= 0 ? Math.abs(Math.round(this.value)) : null">
            </div>
            
            <div style="font-size:11px; color:var(--text-secondary); margin-bottom:15px; background:var(--bg-color); padding:8px; border-radius:6px;">
                ℹ️ This updates the <strong>Night</strong> meal of the Bazar Date and the <strong>Day</strong> meal of the following morning.
            </div>

            <button type="submit" class="btn btn-primary" style="width:100%;">Save Session</button>
        </form>
    </div>
</div>

<!-- Edit Member Modal -->
<div id="editMemberModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit Member</h3>
            <span class="close-modal" onclick="document.getElementById('editMemberModal').classList.remove('active')">×</span>
        </div>
        <form id="editMemberForm">
            <input type="hidden" id="editMemberId">
            <input type="hidden" id="editUserId">
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" id="editMemberName" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">New Password (leave blank to keep current)</label>
                <input type="password" id="editMemberPassword" class="form-input" placeholder="New password...">
            </div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
    </div>
</div>

<!-- Cycle Close/Creation Modal -->
<div id="cycleCloseModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title">Close & Create Cycle</h3>
            <span class="close-modal" onclick="document.getElementById('cycleCloseModal').classList.remove('active')">×</span>
        </div>
        <form id="cycleCloseForm">
            <div class="form-group">
                <label class="form-label">Select Target Month</label>
                <div style="display: flex; gap: 10px;">
                    <select id="newCycleMonth" class="form-select" style="flex: 2;"></select>
                    <input type="number" id="newCycleYear" class="form-input" style="flex: 1;">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Cycle Name</label>
                <input type="text" id="newCycleName" class="form-input" placeholder="e.g. January 2026">
            </div>

            <div class="form-group">
                <label class="form-label">Start Date</label>
                <input type="date" id="newCycleStart" class="form-input" required>
            </div>

            <div class="form-group">
                <label class="form-label">End Date</label>
                <input type="date" id="newCycleEnd" class="form-input" required>
            </div>

            <div style="background: #fff1f2; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 11px; color: #991b1b;">
                ⚠️ This will deactivate the current cycle and forward all member balances to the new one.
            </div>

            <button type="submit" class="btn btn-danger" style="width: 100%;">Confirm & Finalize</button>
        </form>
    </div>
</div>


<!-- Toast Notification Container -->
<div id="toast-container"></div>


<!-- Sidebar Overlay (Must be added right after body tag or before sidebar) -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div id="realtimeStatus" class="realtime-status">⚫ Connecting...</div>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>


    const SUPABASE_URL = 'https://bcardtccxcnktkkeszpp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjYXJkdGNjeGNua3Rra2VzenBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NzU1NDIsImV4cCI6MjA4MDE1MTU0Mn0.xGxk81ThPGtyQgRCNoOxpvxsnXBUAzgmclrS0ru7g2Q';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================
    // STATE MANAGEMENT
    // ============================================

    let currentCycleId = null;
    let allMembers = [];
    let allCycles = [];


    // Master Local Mirror of the Database
let appState = {
    members: [],
    meals: [],
    meal_plans: [],
    expenses: [],
    deposits: [],
    notifications: [],
    lastSync: null
};

// Track if a page has been loaded at least once
const pageLoaded = {
    dashboard: false,
    profile: false,
    tracker: false,
    summary: false,
    expenses: false,
    deposits: false,
    admin: false
};

async function syncFullState() {
    console.log("🔄 Syncing local state with database...");
    
    // Fetch everything in parallel for speed
    const [
        { data: members },
        { data: meals },
        { data: plans },
        { data: expenses },
        { data: deposits }
    ] = await Promise.all([
        supabase.from('members').select('*').order('name'),
        supabase.from('meals').select('*').eq('cycle_id', currentCycleId),
        supabase.from('meal_plans').select('*'),
        supabase.from('expenses').select('*').eq('cycle_id', currentCycleId).eq('status', 'approved'),
        supabase.from('deposits').select('*').eq('cycle_id', currentCycleId).neq('status', 'pending')
    ]);

    // Update the mirror
    appState.members = members || [];
    appState.meals = meals || [];
    appState.meal_plans = plans || [];
    appState.expenses = expenses || [];
    appState.deposits = deposits || [];
    appState.lastSync = Date.now();

    console.log("✅ Local state is now current.");
}

// Helper to convert English numbers to Bengali digits
function toBn(num) {
    if (num === null || num === undefined) return "০";
    const bnDigits = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
    return num.toString().replace(/\d/g, d => bnDigits[d]);
}

// Helper to get YYYY-MM-DD in LOCAL time (prevents Dec 31st bug)
function toLocalISO(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`; // Returns YYYY-MM-DD
}

function parseLocalDate(dateStr) {
    const [y, m, d] = dateStr.split('-').map(Number);
    return new Date(y, m - 1, d);
}



    // ============================================
// NEW SUPABASE AUTHENTICATION LOGIC
// ============================================

let isLoginMode = true; // Toggle between Login and Signup

// 1. Initialize Auth State Listener (Runs automatically on load)
async function initAuth() {
    // 1. Check for current session
    const { data: { session } } = await supabase.auth.getSession();
    
    if (session) {
        // User is logged in: Keep splash visible and load the app
        await handleUserSession(session.user);
    } else {
        // User is logged out:
        // Hide the loader and show the login page simultaneously for a smooth swap
        const authPage = document.getElementById('authPage');
        const mainApp = document.getElementById('mainApp');
        
        mainApp.classList.add('hidden');
        authPage.classList.remove('hidden');
        
        // Short delay to let the UI render behind the splash before fading it out
        setTimeout(() => {
            hideSplash(600); 
            console.log("Unauthenticated: Transitioning to Login.");
        }, 500);
    }

    // Listen for Auth changes (Login/Logout)
    supabase.auth.onAuthStateChange(async (_event, session) => {
        if (session) {
            // Transition handled by handleUserSession -> initializeApp
            await handleUserSession(session.user);
        } else {
            // If logged out, reset visibility
            document.getElementById('authPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            hideSplash(400);
        }
    });
}

// 2. Fetch Member Profile based on Login ID
async function handleUserSession(user) {
    try {
        // 1. Try to fetch the profile from the 'members' table
        let { data: member, error } = await supabase
            .from('members')
            .select('*')
            .eq('user_id', user.id)
            .maybeSingle();

        if (member) {
            // Success: User is a recognized member
            currentUser = { 
                ...user, 
                member_id: member.id,
                name: member.name, 
                role: member.role || 'user'
            };
        } else {
            // New Signup Fallback: Use metadata from the Auth system
            // This ensures the header shows the name immediately after account creation
            currentUser = { 
                ...user, 
                name: user.user_metadata?.display_name || user.email.split('@')[0], 
                role: 'user' 
            };
        }

        // Redirect logic
        showApp();
        
        // Admin Tab Logic
        if (currentUser.role === 'admin' || currentUser.role === 'manager') {
            document.getElementById('adminMenuItem').style.display = 'block';
        } else {
            document.getElementById('adminMenuItem').style.display = 'none';
        }

    } catch (err) {
        console.error("Session handling error:", err);
    }
}
// 3. Handle Form Submit (Login / Signup)
// --- NEW AUTH LOGIC (Supports Username) ---

// 1. Toggle Login / Sign Up UI
// Add/Update this in your existing toggle listener
// Locate this in your script
document.getElementById('authToggleBtn').addEventListener('click', (e) => {
    e.preventDefault();
    isLoginMode = !isLoginMode;
    
    const title = isLoginMode ? 'Login to Kitchen' : 'Create Account';
    const subtitle = isLoginMode ? 'Your kitchen, professionally managed.' : 'Join the mess and track your meals.';
    const emailLabel = isLoginMode ? 'Email or Username' : 'Email Address';
    const btnText = isLoginMode ? 'Login to Kitchen' : 'Sign Up Now';
    const toggleText = isLoginMode ? 'New to the mess?' : 'Already have an account?';
    const linkText = isLoginMode ? 'Create Account' : 'Login';

    document.getElementById('authSubtitle').textContent = subtitle;
    document.getElementById('emailLabel').textContent = emailLabel;
    document.getElementById('authBtn').querySelector('span').textContent = btnText;
    document.getElementById('authToggleText').textContent = toggleText;
    document.getElementById('authToggleBtn').textContent = linkText;

    // Show/Hide Full Name field for Signup
    const userField = document.getElementById('usernameField');
    if (isLoginMode) {
        userField.classList.add('hidden');
        document.getElementById('authUsername').removeAttribute('required');
    } else {
        userField.classList.remove('hidden');
        document.getElementById('authUsername').setAttribute('required', 'true');
    }
});

// 2. Handle Submission (Improved with better debugging)
document.getElementById('authForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // 1. Collect inputs
    const emailOrUser = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    const fullName = document.getElementById('authUsername').value.trim(); // Only for Signup
    const errorDiv = document.getElementById('authError');
    
    errorDiv.style.display = 'none';
    
    // Show the splash loader
    showSplash(isLoginMode ? "Securing Kitchen..." : "Setting up your Account...");

    try {
        if (isLoginMode) {
            // ==========================================
            // LOG IN LOGIC
            // ==========================================
            let finalEmail = emailOrUser;

            // Handle Username Login (if no @ is present)
            if (!emailOrUser.includes('@')) {
                const { data: member, error: findError } = await supabase
                    .from('members')
                    .select('email')
                    .eq('name', emailOrUser)
                    .maybeSingle();

                if (findError || !member || !member.email) {
                    throw new Error("Username not found. Please use your email.");
                }
                finalEmail = member.email;
            }

            const { error: loginError } = await supabase.auth.signInWithPassword({ 
                email: finalEmail, 
                password: password 
            });

            if (loginError) throw loginError;
            // Success: supabase.auth.onAuthStateChange will automatically trigger initializeApp()

        } else {
            // ==========================================
            // SIGN UP LOGIC
            // ==========================================
            
            // Validation
            if (!emailOrUser.includes('@')) throw new Error("A valid email is required for registration.");
            if (fullName.length < 2) throw new Error("Please enter your full name.");
            if (password.length < 6) throw new Error("Password must be at least 6 characters.");

            // 1. Create the Auth User
            // ... inside authForm listener, in the 'else' (Signup) block:
const { data: authData, error: signupError } = await supabase.auth.signUp({
    email: emailOrUser,
    password: password,
    options: {
        // This 'display_name' is what currentUser.user_metadata looks for
        data: { display_name: fullName } 
    }
});

            if (signupError) throw signupError;

            // 2. Check if Email Confirmation is required
            // (If session is null, it means the user must click the link in their email)
            if (authData.user && !authData.session) {
                hideSplash(100);
                alert("Signup successful! Please check your email inbox to confirm your account before logging in.");
                // Switch back to login mode automatically
                document.getElementById('authToggleBtn').click(); 
                return;
            }

            // 3. Link Auth User to 'members' table
            // This is the most important part for your app to show the user's name
            if (authData.user) {
                const { error: memberError } = await supabase.from('members').insert({
                    user_id: authData.user.id,
                    name: fullName,
                    email: emailOrUser,
                    role: 'user' // Default role for new signups
                });

                if (memberError) {
                    console.error("Member Link Error:", memberError);
                    throw new Error("Account created but profile sync failed. Please contact Admin.");
                }

                showNotification("Welcome to MealCal Pro!", "success");
            }
        }

    } catch (err) {
        // Hide splash and show error
        hideSplash(100); 
        errorDiv.textContent = err.message;
        errorDiv.style.display = 'block';
        console.error("Auth Failure:", err);
    }
});




// 5. Update Logout
document.getElementById('logoutBtn').addEventListener('click', async () => {
    await supabase.auth.signOut();
    // onAuthStateChange will handle the UI update
});



// Function to populate the login dropdown
async function loadLoginUserDropdown() {
    const dropdown = document.getElementById('authUserDropdown');
    
    // We fetch from 'members' because it's usually public/readable even before login
    // assuming member names match usernames as per your logic
    try {
        const { data, error } = await supabase
            .from('members')
            .select('name')
            .order('name');

        if (error) throw error;

        // Clear and repopulate
        dropdown.innerHTML = '<option value="">Select User ▼</option>';
        
        data.forEach(member => {
            const option = document.createElement('option');
            option.value = member.name;
            option.textContent = member.name;
            dropdown.appendChild(option);
        });

        // Add listener to auto-fill the input
        dropdown.addEventListener('change', (e) => {
            if (e.target.value) {
                document.getElementById('authEmail').value = e.target.value;
            }
        });

    } catch (err) {
        console.error("Error loading user dropdown:", err);
        // If error (e.g., RLS policy prevents reading), just hide the dropdown
        dropdown.style.display = 'none';
    }
}

// --- CORRECTED loadPageData (Async) ---
async function loadPageData(pageName, forceRefresh = false) {
    // 1. If page is already loaded and no force refresh, exit immediately.
    // This makes switching to the page 0-second lag.
    if (pageLoaded[pageName] && !forceRefresh) {
        return; 
    }

    try {
        switch(pageName) {
            case 'expenses':
                await loadExpenses();
                break;
            case 'profile':
                await Promise.all([loadProfile(), loadScheduler()]);
                break;
            case 'dashboard':
                await loadDashboard();
                break;
            case 'tracker':
                await Promise.all([loadMasterTracker(), loadWeeklyMenuEditor()]);
                break;
            case 'summary':
                await loadSummary();
                break;
            case 'deposits':
                await loadDeposits();
                break;
            case 'admin':
                await loadAdmin();
                break;
        }
        
        // Mark as loaded
        pageLoaded[pageName] = true;
        
    } catch (err) {
        console.error(`❌ Failed to load ${pageName}:`, err);
    }
}

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    
    // Simple hash function (for password hashing - in production use bcrypt)
    async function hashPassword(password) {
        const msgBuffer = new TextEncoder().encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }


function formatCurrency(amount) {
    const isNegative = amount < 0;
    // We get absolute value for the numbers, but keep track of sign
    const val = Math.abs(parseFloat(amount || 0)).toFixed(2);
    const [integerPart, decimalPart] = val.split('.');
    
    // Add the negative sign if needed
    const signPrefix = isNegative ? '-' : '';
    
    return `${signPrefix}৳ <span class="amt-whole">${toBn(integerPart)}</span><span class="amt-decimal">.${toBn(decimalPart)}</span>`;
}

// This function handles both the name 'formatDate' and adds the Time
function formatDate(dateString) {
    if (!dateString) return "-";
    const date = new Date(dateString);
    
    // Formats to: 02 Jan • 10:30 AM
    return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }) + 
           ' • ' + 
           date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
}



// Utility: Prevents a function from running too many times in a short period
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}



// ============================================
// REAL-TIME SYNCHRONIZATION SYSTEM (Free Tier)
// ============================================

let realtimeChannels = [];

// Initialize real-time listeners
function initRealtimeSync() {
    // Clean up existing channels first
    cleanupRealtimeChannels();
    
    if (!currentCycleId) {
        console.warn("No cycle ID, skipping real-time setup");
        return;
    }

    console.log("🔄 Setting up real-time sync for cycle:", currentCycleId);

    // Create a SINGLE channel for all tables (free tier has channel limits)
    const mainChannel = supabase
        .channel('db_changes')
        
        // 1. MEAL PLANS - Watch for schedule changes
        .on('postgres_changes', 
            { event: '*', schema: 'public', table: 'meal_plans' },
            (payload) => {
                console.log("📅 Meal Plan Changed:", payload.eventType);
                handleRealtimeUpdate('meal_plans', payload);
            }
        )
        
        // 2. MEALS (Tracker)
        .on('postgres_changes',
            { event: '*', schema: 'public', table: 'meals' },
            (payload) => {
                console.log("🍽️ Meal Record Changed:", payload.eventType);
                handleRealtimeUpdate('meals', payload);
            }
        )
        
        // 3. DEPOSITS
        .on('postgres_changes',
            { event: '*', schema: 'public', table: 'deposits' },
            (payload) => {
                console.log("💰 Deposit Changed:", payload.eventType);
                handleRealtimeUpdate('deposits', payload);
            }
        )
        
        // 4. EXPENSES
        .on('postgres_changes',
            { event: '*', schema: 'public', table: 'expenses' },
            (payload) => {
                console.log("🛒 Expense Changed:", payload.eventType);
                handleRealtimeUpdate('expenses', payload);
            }
        )
        
        // 5. NOTIFICATIONS
        .on('postgres_changes',
            { event: 'INSERT', schema: 'public', table: 'notifications' },
            (payload) => {
                console.log("🔔 New Notification");
                handleRealtimeUpdate('notifications', payload);
            }
        )
        
        // 6. MEMBERS
        .on('postgres_changes',
            { event: '*', schema: 'public', table: 'members' },
            (payload) => {
                console.log("👤 Member Changed:", payload.eventType);
                handleRealtimeUpdate('members', payload);
            }
        )
        
        // 7. CYCLE DUES
        .on('postgres_changes',
            { event: '*', schema: 'public', table: 'cycle_dues' },
            (payload) => {
                console.log("💳 Due Changed:", payload.eventType);
                handleRealtimeUpdate('cycle_dues', payload);
            }
        )
        
        .subscribe((status) => {
            console.log("Realtime status:", status);
            updateConnectionStatus(status);
        });

    realtimeChannels.push(mainChannel);
    console.log("✅ Real-time sync initialized");
}

// Cleanup function
function cleanupRealtimeChannels() {
    realtimeChannels.forEach(channel => {
        supabase.removeChannel(channel);
    });
    realtimeChannels = [];
}

// ============================================
// UNIFIED REAL-TIME HANDLER
// ============================================

// Debounce timers for each page/component
const refreshTimers = {};

function handleRealtimeUpdate(table, payload) {
    const activePage = getActivePage();
    const eventType = payload.eventType; // INSERT, UPDATE, DELETE
    const newData = payload.new;
    const oldData = payload.old;
    
    // Filter out updates not related to current cycle (optimization)
    if (newData?.cycle_id && newData.cycle_id != currentCycleId) return;
    if (oldData?.cycle_id && oldData.cycle_id != currentCycleId) return;
    
    // Route to appropriate handler based on table
    switch(table) {
        case 'meal_plans':
            handleMealPlanUpdate(activePage, payload);
            break;
        case 'meals':
            handleMealUpdate(activePage, payload);
            break;
        case 'deposits':
            handleDepositUpdate(activePage, payload, newData, oldData);
            break;
        case 'expenses':
            handleExpenseUpdate(activePage, payload, newData);
            break;
        case 'notifications':
            handleNotificationUpdate(payload, newData);
            break;
        case 'members':
            handleMemberUpdate(activePage);
            break;
        case 'cycle_dues':
            handleDueUpdate(activePage, newData, oldData);
            break;
    }
}

// ============================================
// INDIVIDUAL TABLE HANDLERS
// ============================================

function handleMealPlanUpdate(activePage, payload) {
    console.log("🔄 Real-time Update Received:", payload.eventType);
    
    // Update Dashboard immediately regardless of current page
    updateDashboardMealPlan();

    // Specific UI updates based on where the user is looking
    const isMe = payload.new?.member_id === currentUser?.member_id || 
                 payload.old?.member_id === currentUser?.member_id;

    if (activePage === 'profile' && isMe) {
        loadScheduler(); // Refresh the dots/buttons on profile
    }
    
    if (activePage === 'summary') {
        loadSummary(); // Refresh the table
    }

    updateEntryStatusIndicator();
}


function handleMealUpdate(activePage, payload) {
    const isMe = payload.new?.member_id === currentUser?.member_id || 
                 payload.old?.member_id === currentUser?.member_id;

    // Tracker and Summary need updates for everyone
    if (activePage === 'tracker') {
        debounceRefresh(() => loadMasterTracker(), 'tracker', 800);
    }
    if (activePage === 'summary') {
        debounceRefresh(() => loadSummary(), 'summary', 1000);
    }
    
    // ONLY refresh profile stats if the update belongs to the current user
    if (activePage === 'profile' && isMe) {
        debounceRefresh(() => loadProfile(), 'profile', 800);
        // Also refresh scheduler if actual meal records change
        debounceRefresh(() => loadScheduler(), 'scheduler', 800);
    }
}



function handleDepositUpdate(activePage, payload, newData, oldData) {
    const isCurrentUser = newData?.member_id === currentUser?.member_id || 
                          oldData?.member_id === currentUser?.member_id;
    
    // Update Deposits page
    if (activePage === 'deposits') {
        debounceRefresh(() => loadDeposits(), 'deposits', 500);
    }
    
    // Update Summary
    if (activePage === 'summary') {
        debounceRefresh(() => loadSummary(), 'summary', 1000);
    }
    
    // Update Dashboard
    if (activePage === 'dashboard') {
        debounceRefresh(() => loadDashboard(), 'dashboard', 1000);
    }
    
    // Update Profile if current user
    if (activePage === 'profile' && isCurrentUser) {
        debounceRefresh(() => loadProfile(), 'profile', 800);
    }
    
    // Update balance warning
    if (isCurrentUser) {
        debounceRefresh(() => {
            checkGlobalBalanceWarning();
            updateEntryStatusIndicator();
        }, 'balance-check', 1000);
    }
      updateDashboardBadges(); 
       updatePendingCounts();
    
    // Show toast notification for new deposits (not from current user)
    if (payload.eventType === 'INSERT' && newData && !isCurrentUser) {
        const memberName = allMembers.find(m => m.id === newData.member_id)?.name || 'Someone';
        const amount = Math.abs(newData.amount);
        const type = newData.amount > 0 ? '💰 Deposit' : '📉 Charge';
        showNotification(`${type}: ${memberName} - ৳${amount}`, 'info');
    }
}

function handleExpenseUpdate(activePage, payload, newData) {
    // 1. If we are currently looking at the expenses page, update the list.
    if (activePage === 'expenses') {
        // We set forceRefresh to true here because data actually changed in the DB
        debounceRefresh(() => loadExpenses(), 'expenses-ui', 500);
    }
    
    // 2. Summary needs update because meal rate depends on expenses
    if (activePage === 'summary') {
        debounceRefresh(() => loadSummary(), 'summary-ui', 1000);
    }
    
    // 3. Dashboard stats
    if (activePage === 'dashboard') {
        debounceRefresh(() => loadDashboard(), 'dash-ui', 1000);
    }
      updateDashboardBadges(); 
       updatePendingCounts();
    
    // 4. Show a toast notification for everyone
    if (payload.eventType === 'INSERT' && newData) {
        const memberName = allMembers.find(m => m.id === newData.member_id)?.name || 'Someone';
        showNotification(`🛒 New Bazar: ${newData.description} (৳${newData.amount}) by ${memberName}`, 'info');
    }
}

function handleNotificationUpdate(payload, newData) {
    // Only process if it's for current cycle
    if (newData?.cycle_id != currentCycleId) return;
    
    // Update notification panel if open
    if (document.getElementById('notifPanel').classList.contains('active')) {
        debounceRefresh(() => loadNotifications(), 'notifications', 500);
    }
    
    // Update badge count
    const badge = document.getElementById('notifBadge');
    const currentCount = parseInt(badge.textContent) || 0;
    badge.textContent = currentCount + 1;
    badge.classList.remove('hidden');
    
    // Update recent activity on dashboard
    if (getActivePage() === 'dashboard') {
        debounceRefresh(() => loadRecentActivity(), 'activity', 800);
    }
}

function handleMemberUpdate(activePage) {
    // Reload global members list
    debounceRefresh(() => loadMembers(), 'members-global', 1000);
    
    // Update Admin page
    if (activePage === 'admin') {
        debounceRefresh(() => loadMembersList(), 'members-list', 800);
    }
    
    // Update Summary (member names might have changed)
    if (activePage === 'summary') {
        debounceRefresh(() => loadSummary(), 'summary', 1000);
    }
}

function handleDueUpdate(activePage, newData, oldData) {
    // Only update if it's for current cycle
    if (newData?.to_cycle_id != currentCycleId && oldData?.to_cycle_id != currentCycleId) return;
    
    // Update Summary page dues section
    if (activePage === 'summary') {
        debounceRefresh(() => loadDueSettlement(), 'dues', 800);
    }
    
    // Update balance indicator if it affects current user
    if (newData?.member_id === currentUser?.member_id || oldData?.member_id === currentUser?.member_id) {
        debounceRefresh(() => updateEntryStatusIndicator(), 'status-indicator', 1000);
    }
}

// ============================================
// HELPER FUNCTIONS
// ============================================

function debounceRefresh(callback, key, delay = 500) {
    // Clear existing timer for this key
    if (refreshTimers[key]) {
        clearTimeout(refreshTimers[key]);
    }
    
    // Set new timer
    refreshTimers[key] = setTimeout(() => {
        try {
            callback();
        } catch (err) {
            console.error(`Error in debounced refresh for ${key}:`, err);
        }
        delete refreshTimers[key];
    }, delay);
}

function getActivePage() {
    const activePage = document.querySelector('.page-content:not(.hidden)');
    if (!activePage) return null;
    return activePage.id.replace('Page', '');
}

function updateConnectionStatus(status) {
    const statusEl = document.getElementById('realtimeStatus');
    if (!statusEl) return;
    
    if (status === 'SUBSCRIBED') {
        statusEl.textContent = '🟢 Live';
        statusEl.className = 'realtime-status connected';
    } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
        statusEl.textContent = '🔴 Offline';
        statusEl.className = 'realtime-status disconnected';
    } else if (status === 'CLOSED') {
        statusEl.textContent = '⚫ Disconnected';
        statusEl.className = 'realtime-status disconnected';
    }
}

// ============================================
// VISIBILITY & LIFECYCLE MANAGEMENT
// ============================================

// Pause/Resume real-time when tab visibility changes
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        console.log("⏸️ Tab hidden - keeping realtime active but pausing UI updates");
        // Keep realtime channels active but pause status indicator
        if (statusCycleInterval) {
            clearInterval(statusCycleInterval);
            statusCycleInterval = null;
        }
    } else {
        console.log("▶️ Tab visible - resuming UI updates");
        updateEntryStatusIndicator();
        checkGlobalBalanceWarning();
        
        // Refresh current page to catch up on any missed updates
        const activePage = getActivePage();
        if (activePage) {
            console.log("🔄 Refreshing", activePage, "after tab became visible");
            debounceRefresh(() => loadPageData(activePage), 'visibility-refresh', 500);
        }
    }
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    console.log("🧹 Cleaning up realtime connections");
    cleanupRealtimeChannels();
    if (statusCycleInterval) {
        clearInterval(statusCycleInterval);
    }
});

// Reconnect if connection is lost
window.addEventListener('online', () => {
    console.log("🌐 Network reconnected - reinitializing realtime");
    showNotification("Connection restored", "success");
    initRealtimeSync();
});

window.addEventListener('offline', () => {
    console.log("📡 Network lost");
    showNotification("Connection lost - changes won't sync", "warning");
});



// Optional: Keep this as an alias in case you already changed some calls
const formatDateTime = formatDate;


  function showNotification(message, type = 'info') {
    const container = document.getElementById('toast-container');
    
    // Create Toast Element
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    // Determine Icon
    let icon = 'ℹ️';
    if (type === 'success') icon = '✅';
    if (type === 'error') icon = '❌';
    if (type === 'warning') icon = '⚠️';

    // Set Content
    toast.innerHTML = `
        <div class="toast-icon">${icon}</div>
        <div class="toast-msg">${message}</div>
    `;

    // Add to DOM
    container.appendChild(toast);

    // Click to dismiss immediately
    toast.addEventListener('click', () => {
        removeToast(toast);
    });

    // Auto dismiss after 3 seconds
    setTimeout(() => {
        removeToast(toast);
    }, 2000);
}
function removeToast(toastElement) {
    toastElement.classList.add('hide');
    // Force removal after CSS transition time (300ms)
    setTimeout(() => {
        if (toastElement.parentNode) toastElement.remove();
    }, 300);
}

    // ============================================
    // AUTHENTICATION
    // ============================================
    


    document.getElementById('logoutBtn').addEventListener('click', () => {
        currentUser = null;
        localStorage.removeItem('mealcal_user');
        hideApp();
    });

 function showApp() {
    document.getElementById('authPage').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    
    document.body.style.overflow = "auto";
    document.documentElement.style.overflow = "auto";
    
    // --- UI SECURITY: HIDE/SHOW MENU ITEM ---
    const adminBtn = document.getElementById('adminMenuItem');
    if (adminBtn) {
        if (currentUser.role === 'admin' || currentUser.role === 'manager') {
            adminBtn.style.display = 'block'; // Show for Admin/Manager
        } else {
            adminBtn.style.display = 'none';  // Hide for everyone else
        }
    }
    
    initializeApp();
}

    function hideApp() {
        document.getElementById('authPage').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('loginForm').reset();
        initLoginPage(); // Reload dropdown
    }

    // Check for saved session
// Check for saved session & Load Dropdown
window.addEventListener('DOMContentLoaded', () => {
    // Start the new Auth System
    initAuth();
    
    // NEW: Load the users into the login dropdown
    loadLoginUserDropdown(); 
});
// ==========================================
// EXPENSE APPROVAL HANDLER (GLOBAL)
// ==========================================

// Explicitly attach to 'window' to ensure HTML buttons can find it
// Attach to window so HTML onClick works
window.handleExpenseApproval = async function(expenseId, newStatus) {
    const userRole = currentUser?.role;
    if (userRole !== 'admin' && userRole !== 'manager') {
        showNotification("Permission Denied", "error");
        return; 
    }

    // Change button text to indicate processing
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = "...";
    btn.disabled = true;

    try {
        // 1. Update Database
        if (newStatus === 'rejected') {
            // Option A: Delete it entirely
            const { error } = await supabase.from('expenses').delete().eq('id', expenseId);
            if (error) throw error;
        } else {
            // Option B: Approve it
            const { error } = await supabase
                .from('expenses')
                .update({ status: 'approved' })
                .eq('id', expenseId);
            if (error) throw error;
        }

        // 2. Fetch details for logging (Optional but good for UX)
        // We can skip fetching if we just want speed, but logging is nice.
        const actorName = currentUser.name || "Admin";
        const actionLabel = newStatus === 'approved' ? 'APPROVED' : 'REJECTED';
        
        await logActivity(
            `Expense Request ${actionLabel} by ${actorName}`, 
            'expense'
        );

        showNotification(`Expense ${newStatus} successfully`, 'success');

        // 3. Refresh Data
        await loadExpenses(); 
        await loadDashboard(); // Update totals

    } catch (err) {
        console.error('Approval Error:', err);
        showNotification(`Failed: ${err.message}`, 'error');
        btn.textContent = originalText;
        btn.disabled = false;
    }
};




window.handleDepositApproval = async function(depositId) {
    if (!confirm("Approve this deposit? This will apply the balance and trigger due settlements.")) return;
    
    const btn = event.target;
    btn.disabled = true;

    try {
        // 1. Get the pending deposit details
        const { data: dep, error: fetchErr } = await supabase
            .from('deposits')
            .select('*')
            .eq('id', depositId)
            .single();
        
        if (fetchErr) throw fetchErr;

        // 2. Delete the pending record (to avoid duplicates, or update status)
        // We update status to 'approved' and THEN run settlement logic
        const { error: updateErr } = await supabase
            .from('deposits')
            .update({ status: 'approved' })
            .eq('id', depositId);
        
        if (updateErr) throw updateErr;

        // 3. Run the Settlement Logic (Crucial!)
        // Since it's already in the DB as 'approved' now, we just need to 
        // trigger the settlement portion of your existing logic.
        // We reuse your client-side settlement function but modify it slightly 
        // OR just call it. For simplicity, we manually run the settlement part:
        
        await logActivity(`Deposit Approved: ${formatCurrency(dep.amount)} for member ID ${dep.member_id}`, 'deposit');
        
        // Refresh page - the settlement logic should ideally be a separate function 
        // but for now, we will re-run the "Approved" flow
        showNotification("Deposit Approved!", "success");
        refreshCurrentPage();

    } catch (err) {
        console.error(err);
        showNotification("Approval failed", "error");
    }
};

window.handleDepositRejection = async function(depositId) {
    if (!confirm("Reject and delete this request?")) return;

    try {
        const { error } = await supabase.from('deposits').delete().eq('id', depositId);
        if (error) throw error;
        showNotification("Request Rejected", "warning");
        refreshCurrentPage();
    } catch (err) {
        showNotification("Error", "error");
    }
};


window.handleDepositAction = async function(depositId, action) {
    // --- SECURITY CHECK ---
    if (currentUser?.role !== 'admin' && currentUser?.role !== 'manager') {
        showNotification("Permission Denied", "error");
        return;
    }
    console.log(`Action: ${action} triggered for ID: ${depositId}`);
    
    // Disable the button to prevent double-clicks
    const btn = event.target;
    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = "...";

    try {
        if (action === 'approve') {
            // 1. Fetch the data of the pending request
            const { data: dep, error: fError } = await supabase
                .from('deposits')
                .select('*')
                .eq('id', depositId)
                .single();

            if (fError || !dep) {
                console.error("Fetch Error:", fError);
                throw new Error("Could not find the pending request.");
            }

            console.log("Pending data found. Attempting to delete request row...");

            // 2. DELETE the pending record FIRST. 
            // If this fails, we stop (prevents duplicates).
            const { error: delError } = await supabase
                .from('deposits')
                .delete()
                .eq('id', depositId);
            
            if (delError) {
                console.error("Delete Error:", delError);
                throw new Error("Permission denied or database error during deletion.");
            }

            console.log("Pending request deleted. Now processing official settlement...");

            // 3. Process the NEW official deposit
            // We pass status: 'approved' explicitly to ensure it hits the history filter
            await processDepositWithClientSideSettlement(
                dep.member_id, 
                dep.cycle_id, 
                dep.amount, 
                dep.label || 'Deposit', 
                dep.notes
            );


            
            const actorName = currentUser.name || "Unknown";
    const actorRole = currentUser.role === 'manager' ? 'Manager' : 'Admin';

    // LOG THE APPROVAL ACT
    await logActivity(
        `Deposit Approved: ${dep.members.name}'s request for ${formatCurrency(dep.amount)} was approved by ${actorRole} (${actorName})`, 
        'deposit'
    );
    showNotification("Request Approved", "success");



        } else if (action === 'reject') {
            const { error: delError } = await supabase
                .from('deposits')
                .delete()
                .eq('id', depositId);
            
            if (delError) throw delError;
            showNotification("Request Rejected", "warning");
        }
        
        // 4. Force UI update
        console.log("Refreshing UI...");
        await loadDeposits(); 
        if (typeof loadDashboard === 'function') loadDashboard();

    } catch (err) {
        console.error("CRITICAL ERROR in handleDepositAction:", err.message);
        showNotification(err.message, "error");
        btn.disabled = false;
        btn.textContent = originalText;
    }
};

async function initializeApp() {
    const progress = document.getElementById('load-progress');
    const setProgress = (p) => { if(progress) progress.style.width = p + '%'; };
function updateRestrictedUI() {
    const badge = document.getElementById('lockTimeDisplay');
    if (!badge || !appConfig.lock_time_start) return;

    const now = new Date();
    const [sH, sM] = appConfig.lock_time_start.split(':').map(Number);
    const [eH, eM] = appConfig.lock_time_end.split(':').map(Number);
    
    const start = new Date(); start.setHours(sH, sM, 0);
    const end = new Date(); end.setHours(eH, eM, 0);

    const isLocked = now >= start && now <= end;

    if (isLocked) {
        badge.classList.add('is-restricted');
        badge.innerHTML = `<span class="dot"></span> RESTRICTED NOW: ${convertTo12Hour(appConfig.lock_time_start)} - ${convertTo12Hour(appConfig.lock_time_end)}`;
    } else {
        badge.classList.remove('is-restricted');
        badge.innerHTML = `<span class="dot"></span> Restricted: ${convertTo12Hour(appConfig.lock_time_start)} - ${convertTo12Hour(appConfig.lock_time_end)}`;
    }
}

// Call it once and set interval
updateRestrictedUI();
setInterval(updateRestrictedUI, 30000); // Check every 30 seconds




    try {
        // Step 1: Initialize DB connection
        setProgress(20);
        await loadCycles();
        
        // Step 2: Load Config and Members
        setProgress(40);
        await loadAppConfig();
        await loadMembers();

        initHeader();
        initNotifications();

        // Step 3: Priority Data Load (Dashboard)
        setProgress(70);
        await loadPageData('dashboard');
        
        // Finalize internal settings
        updateEntryStatusIndicator();
        initRealtimeSync();
        setProgress(100);

             // Final Progress
        const progress = document.getElementById('load-progress');
        if(progress) progress.style.width = '100%';

        // --- HIDE SPLASH ---
        setTimeout(() => {
            hideSplash();
        }, 1000); // Small delay to let the animation be seen

        // --- COORDINATED FADE OUT ---
        // We wait for the animation to feel "complete" (approx 1.5 - 2 seconds total)
        setTimeout(() => {
            const loader = document.getElementById('initial-loader');
            if (loader) {
                loader.classList.add('splash-hidden');
                
                // Remove from DOM to keep it light
                setTimeout(() => loader.remove(), 800);
            }
        }, 1200); // Adjust this delay based on your video length

        // Background loading begins after the app is visible
        setTimeout(() => preLoadAllPages(), 2000);
        
    } catch (err) {
        console.error("Critical Init Error:", err);
        const splashText = document.querySelector('.splash-text');
        if(splashText) splashText.textContent = "Connection Error. Please check internet.";
        if(progress) progress.style.background = "var(--danger-color)";
    }
}

async function preLoadAllPages() {
    // Standard pages for everyone
    const pages = ['profile', 'tracker', 'summary', 'expenses', 'deposits'];

    // Only preload Admin for Admins/Managers
    if (currentUser.role === 'admin' || currentUser.role === 'manager') {
        pages.push('admin');
    }

    for (const page of pages) {
        await loadPageData(page);
    }
    console.log("✅ Pages pre-loaded.");
}

function loadPageData(pageName) {
    // If it's already loaded, we only refresh if the user is actually LOOKING at the page
    // This allows background loading to happen once, but manual refreshes still work.
    const isVisible = !document.getElementById(pageName + 'Page').classList.contains('hidden');
    
    if (pageLoaded[pageName] && !isVisible) {
        return; 
    }

    switch(pageName) {
        case 'dashboard':
            // Returning the promise so initializeApp can await it
            return loadDashboard();
        case 'profile':
            // Combined profile and scheduler into one flow
            return Promise.all([loadProfile(), loadScheduler()]);
        case 'tracker':
            return Promise.all([loadMasterTracker(), loadWeeklyMenuEditor()]);
        case 'summary':
            return loadSummary();
        case 'expenses':
            return loadExpenses();
        case 'deposits':
            return loadDeposits();
        case 'admin':
            return loadAdmin();
    }

    pageLoaded[pageName] = true;
}

// --- SPLASH CONTROL HELPERS ---

function hideSplash(delay = 800) {
    const loader = document.getElementById('initial-loader');
    if (loader) {
        setTimeout(() => {
            loader.classList.add('splash-hidden');
        }, delay);
    }
}

function showSplash(text = "Preparing your kitchen...") {
    const loader = document.getElementById('initial-loader');
    const splashText = document.querySelector('.splash-text');
    const progress = document.getElementById('load-progress');
    
    if (loader) {
        if(splashText) splashText.textContent = text;
        if(progress) progress.style.width = '0%';
        loader.classList.remove('splash-hidden');
    }
}
    // Add Handler for Admin Settings Form
document.getElementById('adminSettingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const start = document.getElementById('settingLockTime').value;
    const end = document.getElementById('settingLockTimeEnd').value;
    const autoTime = document.getElementById('settingAutoTime').value;
    
    const btn = e.target.querySelector('button[type="submit"]');
    btn.textContent = "Saving...";
    btn.disabled = true;

    try {
        const { error } = await supabase.from('app_config').upsert([
            { key_name: 'lock_time_start', value_text: start },
            { key_name: 'lock_time_end', value_text: end },
            { key_name: 'auto_entry_time', value_text: autoTime }
        ], { onConflict: 'key_name' });

        if (error) throw error;

        appConfig.lock_time_start = start;
        appConfig.lock_time_end = end;
        appConfig.auto_entry_time = autoTime;
        
        const actor = currentUser.members ? currentUser.members.name : "Admin";
        // LOG SETTINGS CHANGE
        await logActivity(`System Config: Bazar lock times and auto-entry schedule were updated by ${actor}`, 'other');

        showNotification("Settings saved successfully!", "success");
        loadScheduler();
    } catch (err) {
        showNotification("Failed to save settings", "error");
    } finally {
        btn.textContent = "Save Settings";
        btn.disabled = false;
    }
});



// Centralized Logic for "Active Session Date"
// Ensures consistency across Profile, Summary, and Dashboard
// Centralized Logic for "Active Session Date" (Timezone Safe)
async function getActiveSessionDate() {
    const today = new Date();
    // Force local date string
    const todayStr = toLocalISO(today);

    try {
        // Check if bazar for today is already done
        const { data: log } = await supabase
            .from('system_logs')
            .select('id')
            .eq('log_date', todayStr)
            .maybeSingle();

        let sessionDate = new Date(today);
        if (log) {
            // If today's automation ran, the "Active" bazar is now tomorrow's
            sessionDate.setDate(today.getDate() + 1);
        }
        return sessionDate;
    } catch (err) {
        return new Date(); 
    }
}

// Global Config
let appConfig = {
    lock_time_start: '17:00',
    lock_time_end: '19:00',
    auto_entry_time: '18:30' // Default
};

async function loadAppConfig() {
    try {
        const { data, error } = await supabase.from('app_config').select('*');
        if (data) {
            data.forEach(item => {
                appConfig[item.key_name] = item.value_text;
            });
        }
        
        // Update Admin UI inputs
        const startInput = document.getElementById('settingLockTime');
        const endInput = document.getElementById('settingLockTimeEnd');
        if(startInput) startInput.value = appConfig.lock_time_start;
        if(endInput) endInput.value = appConfig.lock_time_end;


        const autoInput = document.getElementById('settingAutoTime');
    if(autoInput) autoInput.value = appConfig.auto_entry_time;

        
        // Update Profile Display
        const lockDisplay = document.getElementById('lockTimeDisplay');
        if(lockDisplay) {
            lockDisplay.textContent = `Restricted: ${convertTo12Hour(appConfig.lock_time_start)} - ${convertTo12Hour(appConfig.lock_time_end)}`;
        }
        
    } catch (err) {
        console.error("Config Load Error", err);
    }
}

// Admin Form Saver
// Admin Form Saver
document.getElementById('adminSettingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // 1. Get Values
    const start = document.getElementById('settingLockTime').value;
    const end = document.getElementById('settingLockTimeEnd').value;
    const autoTime = document.getElementById('settingAutoTime').value; // <--- Make sure this ID exists in HTML
    
    const btn = e.target.querySelector('button[type="submit"]');
    btn.textContent = "Saving...";
    btn.disabled = true;

    try {
        // 2. Upsert All 3 Settings
        const { error } = await supabase.from('app_config').upsert([
            { key_name: 'lock_time_start', value_text: start },
            { key_name: 'lock_time_end', value_text: end },
            { key_name: 'auto_entry_time', value_text: autoTime } // <--- CRITICAL FIX
        ], { onConflict: 'key_name' });

        if (error) throw error;

        // 3. Update Local Config State
        appConfig.lock_time_start = start;
        appConfig.lock_time_end = end;
        appConfig.auto_entry_time = autoTime;
        
        // 4. Update UI
        const lockDisplay = document.getElementById('lockTimeDisplay');
        if(lockDisplay) lockDisplay.textContent = `Restricted: ${convertTo12Hour(start)} - ${convertTo12Hour(end)}`;
        
        showNotification("Settings saved successfully!", "success");
        loadScheduler(); // Refresh UI locks

    } catch (err) {
        console.error("Save Error", err);
        showNotification("Failed to save settings", "error");
    } finally {
        btn.textContent = "Save Settings";
        btn.disabled = false;
    }
});
// Helper: Convert 17:00 to 5:00 PM
function convertTo12Hour(timeStr) {
    if(!timeStr) return "";
    const [hour, min] = timeStr.split(':');
    const h = parseInt(hour);
    const ampm = h >= 12 ? 'PM' : 'AM';
    const h12 = h % 12 || 12;
    return `${h12}:${min} ${ampm}`;
}


/**
 * Checks if a specific meal slot is locked based on Bazar Time.
 * Logic: A "Bazar Session" locks Today's Night and Tomorrow's Day.
 */
function isMealLocked(dateString, mealType) {
    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];

    // 1. Determine "Session Date" (The date the Bazar happens)
    // Night Meal (e.g. 8th Night) -> Bazar is 8th.
    // Day Meal (e.g. 9th Day) -> Bazar is 8th (Previous Day).
    
    let sessionDateStr = dateString;
    if (mealType === 'day') {
        const d = new Date(dateString);
        d.setDate(d.getDate() - 1); // Subtract 1 day
        sessionDateStr = d.toISOString().split('T')[0];
    }

    // 2. Past Session Logic
    // If the bazar day is in the past, it's definitely locked (History).
    if (sessionDateStr < todayStr) return true;

    // 3. Future Session Logic
    // If bazar is tomorrow or later, it's Open.
    if (sessionDateStr > todayStr) return false;

    // 4. TODAY'S Session Logic (sessionDateStr === todayStr)
    // We are on the day of the Bazar. Check the Time Range.
    
    // Parse Config Times
    const [sH, sM] = appConfig.lock_time_start.split(':').map(Number);
    const [eH, eM] = appConfig.lock_time_end.split(':').map(Number);
    
    const startTime = new Date();
    startTime.setHours(sH, sM, 0, 0);
    
    const endTime = new Date();
    endTime.setHours(eH, eM, 0, 0); // e.g., 19:00:00

    // Range Logic: Locked ONLY if Start <= Now <= End
    if (now >= startTime && now <= endTime) {
        return true; // Locked inside range
    }

    return false; // Open before 5pm, Open after 7pm
}


async function loadScheduler() {
    if (!currentUser.member_id || !currentCycleId) return;
    
    const container = document.getElementById('schedulerList');
    
    // 1. CACHE CHECK: If cards exist and we aren't forcing a reload, skip.
    // This prevents the scheduler from re-rendering when you switch tabs.
    if (container.querySelector('.scheduler-card') && pageLoaded.profile) {
        return; 
    }

    // 2. Only show loading text if the container is empty.
    if (!container.innerHTML || container.innerHTML.includes('loading')) {
        container.innerHTML = '<div class="loading">Syncing your schedule...</div>';
    }

    try {
        // Fetch Member Defaults
        const { data: memberData } = await supabase
            .from('members')
            .select('default_day_on, default_night_on')
            .eq('id', currentUser.member_id)
            .maybeSingle();

        if (memberData) updateDefaultButtons(memberData);
        
        const defDay = memberData?.default_day_on || false;
        const defNight = memberData?.default_night_on || false;

        // Calculate 8-day date range (Today + next 7 days)
        const startDate = await getActiveSessionDate();
        const dates = [];
        for(let i=0; i<=8; i++) { 
            const d = new Date(startDate);
            d.setDate(startDate.getDate() + i); 
            dates.push(toLocalISO(d));
        }

        // Fetch user's specific meal plans
        const { data: plans } = await supabase
            .from('meal_plans')
            .select('*')
            .eq('member_id', currentUser.member_id)
            .in('plan_date', dates);

        const planMap = {};
        plans?.forEach(p => planMap[p.plan_date] = p);

        // 3. BUILD HTML STRING (Avoids multiple DOM reflows/flickers)
        let newHTML = '';
        const fmt = (dStr) => {
            const d = parseLocalDate(dStr);
            return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        };

        for (let i = 0; i < 7; i++) {
            const dateSession = dates[i];
            const dateNextDay = dates[i+1];
            
            const sessionLabel = fmt(dateSession);
            const nextDayLabel = fmt(dateNextDay);
            const isFirstCard = (i === 0);
            
            const nightActive = planMap[dateSession] ? planMap[dateSession].night_count > 0 : defNight;
            const dayActive = planMap[dateNextDay] ? planMap[dateNextDay].day_count > 0 : defDay;

          newHTML += `
    <div class="scheduler-card ${isFirstCard ? 'is-today' : ''}">
        <div class="sched-date-main">${sessionLabel}</div>
        <div class="sched-sub-label">${isFirstCard ? 'ACTIVE SESSION' : 'UPCOMING'}</div>
        
        <div class="sched-actions">
            <button class="sched-btn night-btn ${nightActive ? 'active' : ''}" 
                onclick="toggleSchedulerPlan('${dateSession}', 'night', this)">
                <span class="status-text">${nightActive ? 'ON' : 'OFF'}</span>
                <span class="btn-label">🌙 Night</span>
            </button>
            
            <button class="sched-btn day-btn ${dayActive ? 'active' : ''}" 
                onclick="toggleSchedulerPlan('${dateNextDay}', 'day', this)">
                <span class="status-text">${dayActive ? 'ON' : 'OFF'}</span>
                <span class="btn-label">🌞 Day</span>
            </button>
        </div>
    </div>`;
        }
        
        // 4. Update the DOM only once
        container.innerHTML = newHTML;

    } catch (err) {
        console.error("Scheduler Error:", err);
        container.innerHTML = '<div class="loading" style="color:red">Error loading schedule</div>';
    }
}


// Function triggered by clicking scheduler buttons
// Function triggered by clicking scheduler buttons (Profile Page)
async function toggleSchedulerPlan(date, type, btnElement) {
    // 1. IMMEDIATE UI UPDATE (Optimistic)
    const statusLabel = btnElement.querySelector('.status-text');
    const wasActive = btnElement.classList.contains('active');
    
    // Flip classes and text immediately
    if (wasActive) {
        btnElement.classList.remove('active');
        if (statusLabel) statusLabel.textContent = 'OFF';
    } else {
        btnElement.classList.add('active');
        if (statusLabel) statusLabel.textContent = 'ON';
    }

    const newCount = wasActive ? 0 : 1;

    try {
        // 2. DATABASE SYNC
        const { data: existing } = await supabase
            .from('meal_plans')
            .select('*')
            .eq('member_id', currentUser.member_id)
            .eq('plan_date', date)
            .maybeSingle();

        let updateData = {
            member_id: currentUser.member_id,
            plan_date: date,
            day_count: existing ? existing.day_count : 0,
            night_count: existing ? existing.night_count : 0
        };

        if (type === 'day') updateData.day_count = newCount;
        else updateData.night_count = newCount;

        const { error } = await supabase.from('meal_plans').upsert(updateData, { onConflict: 'member_id, plan_date' });
        if (error) throw error;

        // 3. LOG ACTIVITY (New Addition)
        const actorName = currentUser.name || "User";
        const actionText = newCount > 0 ? "turned ON" : "turned OFF";
        const typeLabel = type.charAt(0).toUpperCase() + type.slice(1); // "Day" or "Night"
        
        // Format date to look nice (e.g., "12 Jan")
        const dateObj = new Date(date);
        const niceDate = dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });

        // Message: "Ayan turned ON his 12 Jan Night meal"
        const logMsg = `${actorName} ${actionText} their ${niceDate} ${typeLabel} meal`;
        
        await logActivity(logMsg, 'meal');

    } catch (err) {
        console.error("Plan update failed", err);
        showNotification("Failed to save plan", "error");
        
        // REVERT UI on error
        btnElement.classList.toggle('active', wasActive);
        if (statusLabel) statusLabel.textContent = wasActive ? 'ON' : 'OFF';
    }
}


// --- Update loadMasterTracker ---
async function loadMasterTracker() {
    if (!currentCycleId) return;
    
    const table = document.getElementById('masterMatrixTable');
    if (!table) return;

    try {
        const cycle = allCycles.find(c => c.id == currentCycleId);
        const { data: meals } = await supabase.from('meals').select('*').eq('cycle_id', currentCycleId);
        
        const matrixData = {};
        meals?.forEach(m => {
            if (!matrixData[m.meal_date]) matrixData[m.meal_date] = {};
            matrixData[m.meal_date][m.member_id] = { d: m.day_count, n: m.night_count };
        });

        let currentIter = parseLocalDate(cycle.start_date);
        let endIter = parseLocalDate(cycle.end_date);
        const todayStr = toLocalISO(new Date());

        // 1. Generate Header Row
        let headerHTML = `
            <thead>
                <tr>
                    <th>BAZAR</th>
                    ${allMembers.map(m => `<th>${m.name.split(' ')[0]}</th>`).join('')}
                </tr>
            </thead>`;


        // 2. Generate Body Rows
        let bodyHTML = '<tbody>';
        while (currentIter.getTime() <= endIter.getTime()) {
            const dateSessionStr = toLocalISO(currentIter);
            const dNext = new Date(currentIter);
            dNext.setDate(currentIter.getDate() + 1);
            const dateNextStr = toLocalISO(dNext);

            const displayDate = currentIter.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
            const isTodayRow = (dateSessionStr === todayStr);

            bodyHTML += `<tr ${isTodayRow ? 'style="background: #f0f9ff;"' : ''}>
                <td>${displayDate}</td>
                ${allMembers.map(m => {
                    const nVal = matrixData[dateSessionStr]?.[m.id]?.n || 0;
                    const dVal = matrixData[dateNextStr]?.[m.id]?.d || 0;
                    return `
                        <td>
                            <div class="cell-split-premium" onclick="openMealModal('${m.id}', '${dateSessionStr}', ${nVal}, ${dVal})">
                                <div class="cell-val-half night ${nVal > 0 ? 'active' : 'zero'}">${nVal > 0 ? nVal : '-'}</div>
                                <div class="cell-val-half ${dVal > 0 ? 'active' : 'zero'}">${dVal > 0 ? dVal : '-'}</div>
                            </div>
                        </td>`;
                }).join('')}
            </tr>`;
            
            currentIter.setDate(currentIter.getDate() + 1);
        }
        bodyHTML += '</tbody>';

        // 3. Update Table
        table.innerHTML = headerHTML + bodyHTML;
        pageLoaded.tracker = true;
    } catch (err) {
        console.error("Tracker Sync Error:", err);
    }
}


// --- Update loadWeeklyMenuEditor ---
async function loadWeeklyMenuEditor() {
    const tbody = document.getElementById('weeklyMenuBody');
    const isAdmin = (currentUser.role === 'admin' || currentUser.role === 'manager');
    
    try {
        const { data, error } = await supabase.from('weekly_menus').select('*').order('day_index', { ascending: true });
        if (error) throw error;

        const order = [6, 0, 1, 2, 3, 4, 5]; 
        const sortedData = order.map(idx => data.find(d => d.day_index === idx));

        tbody.innerHTML = sortedData.map(day => `
            <tr>
                <td class="menu-day-label">${day.day_name}</td>
                <td style="padding-right: 5px;">
                    <input type="text" id="night-${day.day_index}" class="menu-input-pill" 
                        value="${day.night_menu || ''}" ${!isAdmin ? 'disabled' : ''} 
                        onchange="saveDayMenu(${day.day_index})" placeholder="Night...">
                </td>
                <td>
                    <input type="text" id="day-${day.day_index}" class="menu-input-pill" 
                        value="${day.day_menu || ''}" ${!isAdmin ? 'disabled' : ''} 
                        onchange="saveDayMenu(${day.day_index})" placeholder="Day...">
                </td>
            </tr>
        `).join('');
    } catch (err) { console.error(err); }
}


function initHeader() {
    // 1. Set User Info
    if (currentUser) {
        // Use the 'name' property defined in handleUserSession
        const displayName = currentUser.name || "User";
        const role = currentUser.role || 'user';
        
        // Update header with format: Name (ROLE)
        document.getElementById('headerUserName').textContent = `${displayName} (${role.toUpperCase()})`;
        
        // Clear old secondary role field
        const subRole = document.getElementById('headerUserRole');
        if(subRole) subRole.textContent = "";
    }

    // 2. Start Clock
    updateClock();
    if (!window.clockInterval) {
        window.clockInterval = setInterval(updateClock, 1000);
    }

    // 3. Update Cycle Name Badge
    const cycleSelect = document.getElementById('cycleSelect');
    if (cycleSelect && cycleSelect.options[cycleSelect.selectedIndex]) {
        document.getElementById('headerCycleName').textContent = cycleSelect.options[cycleSelect.selectedIndex].text;
    }
}


function updateClock() {
    const now = new Date();
    
    // Time
    const timeString = now.toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' });
    document.getElementById('clockTime').textContent = timeString;

    // Date
    const dateString = now.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
    document.getElementById('clockDate').textContent = dateString;
}


// ============================================
// NOTIFICATION LOGIC (FIXED)
// ============================================

let allNotifications = [];
let currentNotifFilter = 'all';

function initNotifications() {
    // 1. Attach Bell Click Listener
    const bellBtn = document.getElementById('notifBellBtn');
    const panel = document.getElementById('notifPanel');
    const closeBtn = document.getElementById('closeNotifPanel');

    // Remove old listeners to prevent duplicates (cloning trick)
    const newBell = bellBtn.cloneNode(true);
    bellBtn.parentNode.replaceChild(newBell, bellBtn);
    
    const newClose = closeBtn.cloneNode(true);
    closeBtn.parentNode.replaceChild(newClose, closeBtn);

    // Re-attach listeners
// Inside initNotifications() ...

    document.getElementById('notifBellBtn').addEventListener('click', (e) => {
        e.stopPropagation(); // Stop click from bubbling

        // 1. LOG & FORCE REFRESH (Bypassing Cooldown)
        console.log("🔄 Refreshing view: NOTIFICATIONS");
        
        // Show loading state briefly in the list if you want, or just fetch
        const container = document.getElementById('notifListContainer');
        if(container.innerHTML.trim() === '') container.innerHTML = '<div class="loading">Syncing...</div>';
        
        loadNotifications().then(() => {
            console.log("✅ Notifications Synced");
        });

        // 2. TOGGLE UI
        document.getElementById('notifPanel').classList.toggle('active');
        
        // 3. CLEAR BADGE
        document.getElementById('notifBadge').classList.add('hidden');
        // Reset badge count logic if you track it in a variable
        document.getElementById('notifBadge').textContent = '0';
    });

    document.getElementById('closeNotifPanel').addEventListener('click', () => {
        document.getElementById('notifPanel').classList.remove('active');
    });

    // 2. Filter Clicks
    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', (e) => {
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            e.target.classList.add('active');
            currentNotifFilter = e.target.getAttribute('data-filter');
            renderNotifications();
        });
    });

    // 3. Close panel when clicking outside
    document.addEventListener('click', (e) => {
        const p = document.getElementById('notifPanel');
        const b = document.getElementById('notifBellBtn');
        if (p.classList.contains('active') && !p.contains(e.target) && !b.contains(e.target)) {
            p.classList.remove('active');
        }
    });

    // 4. Start Loading
    loadNotifications();
}

async function loadNotifications() {
    if (!currentCycleId) return;

    try {
        const targetCycleId = parseInt(currentCycleId);
        console.log("🔔 Fetching notifications for cycle:", targetCycleId);

        const { data, error } = await supabase
            .from('notifications')
            .select(`
                id, 
                message, 
                type, 
                created_at, 
                member_id,
                members (
                    name, 
                    role
                )
            `)
            .eq('cycle_id', targetCycleId)
            .order('created_at', { ascending: false })
            .limit(50);

        if (error) throw error;

        allNotifications = data || [];
        console.log("✅ Notifications loaded:", allNotifications.length);
        renderNotifications();
        
    } catch (err) {
        console.error('❌ Notification Fetch Error:', err);
        const container = document.getElementById('notifListContainer');
        if(container) container.innerHTML = `<div class="loading" style="color:red">Failed to load history.</div>`;
    }
}

function renderNotifications() {
    const container = document.getElementById('notifListContainer');
    if (!container) return;

    // Filter logic
    const filtered = allNotifications.filter(n => {
        if (currentNotifFilter === 'all') return true;
        if (currentNotifFilter === 'meal') return n.type && n.type.includes('meal');
        return n.type === currentNotifFilter;
    });

    if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:40px 20px; color:#aaa;">No history found for this cycle.</div>';
        return;
    }

    container.innerHTML = filtered.map(notif => {
        let typeClass = 'type-other';
        let icon = '⚙️';
        if (notif.type === 'deposit') { typeClass = 'type-deposit'; icon = '💰'; }
        if (notif.type === 'expense') { typeClass = 'type-expense'; icon = '🛒'; }
        if (notif.type && notif.type.includes('meal')) { typeClass = 'type-meal'; icon = '🍽️'; }

        const dateObj = new Date(notif.created_at);
        const displayTime = dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) + 
                          ' • ' + dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

// --- FIXED AUTHOR LOGIC IN renderNotifications ---
let authorMarkup = '<span style="color:var(--text-secondary)">System</span>';

if (notif.members) {
    const role = notif.members.role;
    const name = notif.members.name;

    if (role === 'admin') {
        authorMarkup = `<span style="color:var(--primary-color); font-weight:800;">Admin</span>`;
    } else if (role === 'manager') {
        // Show Manager + their name for clarity
        authorMarkup = `<span style="color:var(--secondary-color); font-weight:800;">Manager (${name.split(' ')[0]})</span>`;
    } else {
        authorMarkup = `<span style="font-weight:600;">${name}</span>`;
    }
}
        return `
        <div class="notif-item ${typeClass}" onclick="handleNotifClick('${notif.type}')">
            <div style="display:flex; gap:10px; align-items:flex-start;">
                <div style="font-size:18px;">${icon}</div>
                <div style="flex:1;">
                    <div style="font-size:13px; color:var(--text-primary); line-height:1.4;">${notif.message}</div>
                    <div style="display:flex; justify-content:space-between; margin-top:6px; font-size:10px; color:var(--text-secondary);">
                        <span>${displayTime}</span>
                        <span>By: ${authorMarkup}</span>
                    </div>
                </div>
            </div>
        </div>
        `;
    }).join('');
}




// Updated Log Activity (Uses member_id)
async function logActivity(message, type = 'info') {
    if (!currentCycleId) return;
    
    try {
        // Use the member_id from our currentUser object
        const actorMemberId = currentUser?.member_id;

        const { error } = await supabase
            .from('notifications')
            .insert({
                cycle_id: parseInt(currentCycleId),
                message: message,
                type: type,
                member_id: actorMemberId // This links the name/role to the log
            });

        if (error) throw error;
        
        // Refresh local view
        if (document.getElementById('notifPanel').classList.contains('active')) {
            loadNotifications();
        }
    } catch (err) {
        console.error('Logging Error:', err.message);
    }
}


// --- Deep Linking Action ---
function handleNotifClick(type) {
    document.getElementById('notifPanel').classList.remove('active');

    if (type === 'deposit') {
        navigateToPage('deposits');
    } else if (type === 'expense') {
        navigateToPage('expenses');
    } else if (type.includes('meal')) {
        navigateToPage('tracker');
    } else {
        navigateToPage('dashboard');
    }
}



// Helper to keep Dashboard synced
function updateDashboardActivity(data) {
    const container = document.getElementById('recentActivity');
    if (!container) return;
    
    const slice = data.slice(0, 10);
    if (slice.length === 0) {
        container.innerHTML = '<div class="loading">No recent activity</div>';
        return;
    }
    
    container.innerHTML = slice.map(notif => `
        <div class="list-item">
            <div class="list-item-info">
                <div class="list-item-title">${notif.message}</div>
                <div class="list-item-subtitle">${formatDateTime(notif.created_at)}</div>
            </div>
        </div>
    `).join('');
}




    async function loadCycles() {
    try {
        const { data, error } = await supabase
            .from('cycles')
            .select('*')
            .order('start_date', { ascending: false });

        if (error) throw error;

        allCycles = data || [];
        const cycleSelect = document.getElementById('cycleSelect');
        cycleSelect.innerHTML = '';

        if (allCycles.length === 0) {
            cycleSelect.innerHTML = '<option value="">No cycles available</option>';
            return;
        }

        // Locate this in your initialization or loadCycles
document.getElementById('cycleSelect').addEventListener('change', (e) => {
    currentCycleId = e.target.value;
    const selectedOption = e.target.options[e.target.selectedIndex];
    document.getElementById('headerCycleName').textContent = selectedOption.text;
    
    // ✅ Restart real-time for new cycle
    console.log("🔄 Cycle changed, restarting realtime for cycle:", currentCycleId);
    initRealtimeSync();
    
    refreshCurrentPage(); 
     updateEntryStatusIndicator();
    checkGlobalBalanceWarning();
});

        // FIND THE ACTIVE ONE OR FALLBACK TO THE NEWEST
        const activeCycle = allCycles.find(c => c.is_active === true) || allCycles[0];
        currentCycleId = activeCycle.id;

        allCycles.forEach(cycle => {
            const option = document.createElement('option');
            option.value = cycle.id;
            option.textContent = cycle.name;
            if (cycle.id === currentCycleId) {
                option.selected = true;
            }
            cycleSelect.appendChild(option);
        });

        // Update the header badge
        document.getElementById('headerCycleName').textContent = activeCycle.name;

    } catch (err) {
        console.error('Error loading cycles:', err);
    }
}
    async function loadMembers() {
        try {
            const { data, error } = await supabase
                .from('members')
                .select('*')
                .order('name');

            if (error) throw error;

            allMembers = data || [];
            populateMemberSelects();
        } catch (err) {
            console.error('Error loading members:', err);
        }
    }

 function populateMemberSelects() {
    const selects = ['trackerMemberSelect', 'expenseMember', 'depositMember', 'depositLogFilter'];

    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;

        // Save current selection if refreshing
        const currentValue = select.value; 
        
        // Clear and add placeholder
        select.innerHTML = '';
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = "Select...";
        select.appendChild(defaultOption);
        
        // Populate Members
        allMembers.forEach(member => {
            const option = document.createElement('option');
            option.value = member.id;
            option.textContent = member.name;
            select.appendChild(option);
        });

        // --- SPECIFIC DEFAULTS LOGIC ---

        // 1. Expenses: Always default to Current User initially
        if (selectId === 'expenseMember' && currentUser.member_id) {
             select.value = currentUser.member_id;
        } 
        // 2. Deposits: Always default to Current User
        else if (selectId === 'depositMember' && currentUser.member_id) {
             select.value = currentUser.member_id;
        }
        // 3. Others: Restore previous value if exists
        else if (currentValue) {
            select.value = currentValue;
        }
    });

    // Force date default on load as well
    resetExpenseForm(); 
}
    // ============================================
    // NAVIGATION
    // ============================================
    
async function navigateToPage(pageName) {
    if (!pageName) return;

    // --- SECURITY CHECK ---
    // If trying to access Admin, check role immediately
    if (pageName === 'admin') {
        if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'manager')) {
            showNotification("⛔ Access Denied: Admin privileges required.", "error");
            // If they are currently on a different page, stay there. 
            // If they are nowhere (fresh load), send to dashboard.
            if (document.querySelector('.page-content:not(.hidden)') === null) {
                navigateToPage('dashboard');
            }
            return;
        }
    }

    // --- STANDARD NAVIGATION ---
    // Hide all pages
    document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
    
    // Show target page
    const target = document.getElementById(pageName + 'Page');
    if (target) target.classList.remove('hidden');

    // Update Nav UI (Active State)
    document.querySelectorAll('.bottom-nav-link, .nav-link').forEach(link => {
        link.classList.toggle('active', link.getAttribute('data-page') === pageName);
    });

    // Load Data
    await loadPageData(pageName);

    // Auto-close sidebar on mobile
    if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        if(sidebar) sidebar.classList.remove('mobile-active');
        if(overlay) overlay.classList.remove('active');
    }
}

// Ensure the Menu button (sidebar trigger) works
document.getElementById('mobileMenuBtn').addEventListener('click', (e) => {
    e.preventDefault();
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    sidebar.classList.add('mobile-active');
    overlay.classList.add('active');
});

function refreshCurrentPage() {
    // Find which page is active (has no 'hidden' class)
    const activePage = document.querySelector('.page-content:not(.hidden)');
    
    if (activePage) {
        const pageId = activePage.id.replace('Page', '');
        console.log(`🔄 Refreshing view: ${pageId}`);
        loadPageData(pageId);
        
        // Always refresh dashboard stats if on dashboard
        // (Because dashboard has multiple sub-components)
        if (pageId === 'dashboard') {
            loadDashboard();
            loadSystemStatus();
        }
    }
}
    // Setup navigation
    document.querySelectorAll('.nav-link, .bottom-nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const pageName = link.getAttribute('data-page');
            if (pageName) {
                navigateToPage(pageName);
            }
        });
    });

    // ============================================
    // DASHBOARD PAGE
    // ============================================
    
// --- Update loadDashboard to set the welcome name ---
async function loadDashboard() {
        if (!currentCycleId) return;
        const [exp, meals, deps] = await Promise.all([
            supabase.from('expenses').select('amount').eq('cycle_id', currentCycleId).eq('status', 'approved'),
            supabase.from('meals').select('day_count, night_count').eq('cycle_id', currentCycleId),
            supabase.from('deposits').select('amount').eq('cycle_id', currentCycleId).neq('status', 'pending')
        ]);

        const totalExp = exp.data?.reduce((s, i) => s + i.amount, 0) || 0;
        const totalMeals = meals.data?.reduce((s, i) => s + (i.day_count + i.night_count), 0) || 0;
        const totalDep = deps.data?.reduce((s, i) => s + i.amount, 0) || 0;
        const rate = totalMeals ? totalExp / totalMeals : 0;
        const liquidity = totalDep - totalExp;

        // Update Text Stats
        document.getElementById('statMealRate').innerHTML = formatCurrency(rate);
        document.getElementById('statTotalExpense').innerHTML = formatCurrency(totalExp);
        document.getElementById('statTotalDeposit').innerHTML = formatCurrency(totalDep);

          // --- NEW: UPDATE TOTAL MEALS CARD ---
        // toBn() converts to Bengali digits. toFixed(1) keeps one decimal place (e.g., 50.5)
        const mealsEl = document.getElementById('statTotalMealsDisplay');
        if (mealsEl) {
            mealsEl.textContent = toBn(totalMeals.toFixed(1).replace(/\.0$/, '')); // Removes .0 if whole number
        }
        
        // ============================================
        // LIQUID CARD LOGIC (NEW)
        // ============================================
      // ============================================
// ENHANCED LIQUID CARD LOGIC
// ============================================
// ============================================
// VERTICAL METER CARD LOGIC - SIMPLE
// ============================================
const balEl = document.getElementById('statMessBalance');
const container = document.getElementById('messBalanceContainer');
const fillBar = document.getElementById('liquidFillBar');
const pill = document.getElementById('balanceStatusPill');
const percentEl = document.getElementById('liquidPercent');

// 1. Update Number
balEl.textContent = typeof toBn === 'function' 
    ? toBn(Math.round(liquidity).toLocaleString()) 
    : Math.round(liquidity).toLocaleString();

// 2. Calculate Percentage (0-10,000 range)
let percent = Math.max(0, Math.min(100, (liquidity / 10000) * 100));

// Minimum visibility for very low amounts
let visualPercent = liquidity <= 0 ? 3 : (percent < 5 ? 5 : percent);

// Update meter fill
fillBar.style.setProperty('--fill-percent', `${visualPercent}%`);

// Update percentage display
percentEl.textContent = `${Math.round(percent)}%`;

// 3. State styling
container.classList.remove('state-healthy-liquid', 'state-critical-liquid', 'state-empty-liquid');

if (liquidity >= 1000) {
    // Healthy
    container.classList.add('state-healthy-liquid');
    pill.textContent = 'HEALTHY';
    pill.style.color = '#047857';
    pill.style.background = '#d1fae5';
    pill.style.border = '1px solid #a7f3d0';
} else if (liquidity > 0) {
    // Low Funds
    container.classList.add('state-critical-liquid');
    pill.textContent = 'LOW FUNDS';
    pill.style.color = '#b91c1c';
    pill.style.background = '#fee2e2';
    pill.style.border = '1px solid #fecaca';
} else {
    // Deficit
    container.classList.add('state-critical-liquid');
    pill.textContent = 'DEFICIT';
    pill.style.color = '#7f1d1d';
    pill.style.background = '#fef2f2';
    pill.style.border = '1px solid #fecaca';
}

        updateDashboardMealPlan();
        loadSystemStatus();
        loadRecentActivity(); 
          updateDashboardBadges(); 
           updatePendingCounts();
    }


    // ==========================================
// BADGE MANAGER SYSTEM
// ==========================================

async function updateDashboardBadges() {
    // Only run if cycle is loaded
    if (!currentCycleId) return;

    try {
        // 1. Fetch Pending Counts in Parallel
        // We use { count: 'exact', head: true } for maximum performance (doesn't download data rows)
        const [pendingDep, pendingExp] = await Promise.all([
            supabase
                .from('deposits')
                .select('*', { count: 'exact', head: true })
                .eq('cycle_id', currentCycleId)
                .eq('status', 'pending'),
            
            supabase
                .from('expenses')
                .select('*', { count: 'exact', head: true })
                .eq('cycle_id', currentCycleId)
                .eq('status', 'pending')
        ]);

        // 2. Update UI
        toggleBadge('badgeDeposit', pendingDep.count);
        toggleBadge('badgeExpense', pendingExp.count);
        
        // 3. Optional: Update Bottom Nav Badges (If you want them there too)
        updateNavBadge('deposits', pendingDep.count);
        updateNavBadge('expenses', pendingExp.count);

    } catch (err) {
        console.error("Badge Sync Error:", err);
    }
}



// ==========================================
// PENDING BADGE SYSTEM
// ==========================================

async function updatePendingCounts() {
    if (!currentCycleId) return;

    try {
        // Run count queries in parallel for speed
        const [depReq, expReq] = await Promise.all([
            // Count Pending Deposits
            supabase
                .from('deposits')
                .select('*', { count: 'exact', head: true }) // head:true means don't fetch data, just count
                .eq('cycle_id', currentCycleId)
                .eq('status', 'pending'),

            // Count Pending Expenses
            supabase
                .from('expenses')
                .select('*', { count: 'exact', head: true })
                .eq('cycle_id', currentCycleId)
                .eq('status', 'pending')
        ]);

        // Update UI
        toggleBadgeUI('badgeDeposit', depReq.count);
        toggleBadgeUI('badgeExpense', expReq.count);

    } catch (err) {
        console.error("Badge Sync Error:", err);
    }
}

// ==========================================
// BADGE NAVIGATION HANDLER
// ==========================================

async function navigateToPending(page, event) {
    // Prevent bubbling if the card itself has a click listener (optional safety)
    if(event) event.stopPropagation();

    // 1. Navigate to the page
    await navigateToPage(page);

    // 2. Determine target container ID
    let targetId = '';
    if (page === 'expenses') targetId = 'pendingExpensesCard';
    if (page === 'deposits') targetId = 'pendingDepositsCard';

    // 3. Scroll and Highlight
    setTimeout(() => {
        const el = document.getElementById(targetId);
        
        if (el && el.style.display !== 'none') {
            // Smooth Scroll to the pending box
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Visual Pulse Effect to show user "Here it is!"
            const originalTransform = el.style.transform;
            const originalShadow = el.style.boxShadow;
            
            el.style.transition = 'all 0.3s ease';
            el.style.transform = 'scale(1.02)';
            el.style.boxShadow = '0 0 0 4px rgba(245, 158, 11, 0.4)'; // Amber glow ring
            
            // Remove effect after 600ms
            setTimeout(() => {
                el.style.transform = originalTransform;
                el.style.boxShadow = originalShadow;
            }, 600);
        } else {
            // Fallback if badge showed number but list is somehow empty (rare sync issue)
            showNotification("No pending items found visible.", "info");
        }
    }, 300); // Small delay to ensure page rendering is complete
}

function toggleBadgeUI(elementId, count) {
    const el = document.getElementById(elementId);
    if (!el) return;

    if (count && count > 0) {
        // Set text (99+ if too large)
        el.textContent = count > 99 ? '99+' : count;
        
        // Remove hidden class first
        el.classList.remove('hidden');
        
        // Use timeout to allow CSS transition to animate in
        setTimeout(() => {
            el.classList.add('active');
            // Make it pill-shaped if double digits
            if (count > 9) el.classList.add('wide');
            else el.classList.remove('wide');
        }, 10);
    } else {
        el.classList.remove('active');
        // Wait for fade out animation before hiding
        setTimeout(() => el.classList.add('hidden'), 400);
    }
}

// Helper to animate badge
function toggleBadge(elementId, count) {
    const el = document.getElementById(elementId);
    if (!el) return;

    if (count && count > 0) {
        el.textContent = count > 99 ? '99+' : count;
        el.classList.remove('hidden');
        // Small delay to allow 'display:block' to apply before adding 'active' for animation
        requestAnimationFrame(() => {
            el.classList.add('active');
            if(count > 9) el.classList.add('wide');
        });
    } else {
        el.classList.remove('active');
        // Wait for transition to finish before hiding
        setTimeout(() => el.classList.add('hidden'), 300);
    }
}

// Optional Helper: Add red dots to bottom nav icons
function updateNavBadge(pageName, count) {
    const navLink = document.querySelector(`.bottom-nav-link[data-page="${pageName}"]`);
    if(!navLink) return;
    
    // Check if dot exists, else create it
    let dot = navLink.querySelector('.nav-dot');
    if (!dot) {
        dot = document.createElement('div');
        dot.className = 'nav-dot';
        dot.style.cssText = 'position:absolute; top:8px; right:20px; width:8px; height:8px; background:#ef4444; border-radius:50%; border:1px solid white; display:none;';
        navLink.style.position = 'relative';
        navLink.appendChild(dot);
    }
    
    dot.style.display = count > 0 ? 'block' : 'none';
}


// --- Update loadRecentActivity for the new feed style ---
async function loadRecentActivity() {
    const container = document.getElementById('recentActivity');
    if (!container) return;

    try {
        const { data, error } = await supabase
            .from('notifications')
            .select('*')
            .eq('cycle_id', currentCycleId)
            .order('created_at', { ascending: false })
            .limit(8);

        if (error) throw error;

        if (!data || data.length === 0) {
            container.innerHTML = '<div style="font-size:11px; color:gray; text-align:center; padding:20px;">No recent activity found.</div>';
            return;
        }

        container.innerHTML = data.map(notif => {
            let icon = '🔔';
            if(notif.type === 'meal') icon = '🍽️';
            if(notif.type === 'deposit') icon = '💰';
            if(notif.type === 'expense') icon = '🛒';

            return `
            <div class="feed-item">
                <div class="feed-icon">${icon}</div>
                <div class="feed-content">
                    <div class="msg">${notif.message}</div>
                    <div class="time">${formatDate(notif.created_at)}</div>
                </div>
            </div>`;
        }).join('');

    } catch (err) {
        console.error('Activity Feed Error:', err);
    }
}

    // ============================================
    // PROFILE PAGE
    // ============================================
    
async function loadProfile() {
    if (!currentUser || !currentUser.member_id) return;
    if (!currentCycleId) return;

    try {
        const member = allMembers.find(m => m.id === currentUser.member_id);
        if (member) {
            const avatarCircle = document.getElementById('profileAvatar');
            avatarCircle.onclick = changeProfilePicture; 
            
            document.getElementById('profileName').textContent = member.name;
            document.getElementById('profileRoleDisplay').textContent = member.role || 'Member';
            
            if (member.avatar_url && member.avatar_url.trim() !== "") {
                avatarCircle.innerHTML = `
                    <img src="${member.avatar_url}" alt="Profile">
                    <div class="profile-status-online"></div>
                `;
                avatarCircle.classList.add('has-image');
            } else {
                const initials = member.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                avatarCircle.innerHTML = `${initials}<div class="profile-status-online"></div>`;
                avatarCircle.classList.remove('has-image');
            }
        }

        // Fetch calculation data
        const [userMeals, userDeps, allExp, allMeals] = await Promise.all([
            supabase.from('meals').select('day_count, night_count').eq('member_id', currentUser.member_id).eq('cycle_id', currentCycleId),
            supabase.from('deposits').select('amount').eq('member_id', currentUser.member_id).eq('cycle_id', currentCycleId).neq('status', 'pending'),
            supabase.from('expenses').select('amount').eq('cycle_id', currentCycleId).eq('status', 'approved'),
            supabase.from('meals').select('day_count, night_count').eq('cycle_id', currentCycleId)
        ]);

        // Calculations
        const totalUserMeals = userMeals.data?.reduce((s, m) => s + (parseFloat(m.day_count) + parseFloat(m.night_count)), 0) || 0;
        const totalUserPaid = userDeps.data?.reduce((s, d) => s + parseFloat(d.amount), 0) || 0;
        const totalGlobalExp = allExp.data?.reduce((s, e) => s + parseFloat(e.amount), 0) || 0;
        const totalGlobalMeals = allMeals.data?.reduce((s, m) => s + (parseFloat(m.day_count) + parseFloat(m.night_count)), 0) || 1;
        
        const rate = totalGlobalMeals > 0 ? totalGlobalExp / totalGlobalMeals : 0;
        const currentBalance = totalUserPaid - (totalUserMeals * rate);

        // --- UI UPDATES (FIXED) ---

        // 1. Fix Total Meals: Update the text content + Convert to Bengali
        const mealsEl = document.getElementById('profileTotalMeals');
        if (mealsEl) {
            // toBn converts "15" to "১৫"
            mealsEl.textContent = toBn(totalUserMeals); 
        }

        // 2. Fix Total Paid: Convert to Bengali
        const depositEl = document.getElementById('profileTotalDeposit');
        if (depositEl) {
            depositEl.textContent = `৳${toBn(Math.round(totalUserPaid))}`;
        }

        // 3. Fix Main Wallet Balance: Use formatCurrency() for styling + Bengali
        const heroBal = document.getElementById('profileBalance');
        if (heroBal) {
            // Using innerHTML because formatCurrency returns <span> tags for styling
            heroBal.innerHTML = formatCurrency(currentBalance); 
        }

        // 4. Update Color States (Positive/Negative)
        const heroCard = document.getElementById('profileBalanceCard'); 
        
        if (currentBalance < 0) {
            if(heroCard) { heroCard.classList.add('status-neg'); heroCard.classList.remove('status-pos'); }
        } else {
            if(heroCard) { heroCard.classList.add('status-pos'); heroCard.classList.remove('status-neg'); }
        }

        // Cycle Name
        const cycleObj = allCycles.find(c => c.id == currentCycleId);
        document.getElementById('profileCycleName').textContent = cycleObj ? cycleObj.name : 'Unknown';

        await loadProfileDepositHistory();
        pageLoaded.profile = true; 
    } catch (err) {
        console.error('Error loading profile:', err);
    }
}

// Function to update the Avatar Link
async function changeProfilePicture() {
    // 1. Ask the user for the URL
    const currentUrl = allMembers.find(m => m.id === currentUser.member_id)?.avatar_url || "";
    const newUrl = prompt("Enter the direct link to your new profile picture:", currentUrl);

    // 2. If user didn't cancel and entered something (or cleared it)
    if (newUrl !== null) {
        try {
            // Show a loading notification
            showNotification("Updating photo...", "info");

            // 3. Update Supabase
            const { error } = await supabase
                .from('members')
                .update({ avatar_url: newUrl.trim() })
                .eq('id', currentUser.member_id);

            if (error) throw error;

            // 4. Update local state so UI reflects change immediately
            const memberIndex = allMembers.findIndex(m => m.id === currentUser.member_id);
            if (memberIndex !== -1) allMembers[memberIndex].avatar_url = newUrl.trim();

            // 5. Refresh the Profile UI
            loadProfile();
            showNotification("Profile picture updated!", "success");

        } catch (err) {
            console.error("Update failed:", err);
            showNotification("Failed to update photo.", "error");
        }
    }
}




    async function loadTodayMealStatus() {
        if (!currentUser.member_id) return;
        const today = new Date().toISOString().split('T')[0];

        try {
            const { data } = await supabase
                .from('meals')
                .select('*')
                .eq('member_id', currentUser.member_id)
                .eq('meal_date', today)
                .maybeSingle();

            const dayCount = data?.day_count || 0;
            const nightCount = data?.night_count || 0;

            const dayToggle = document.getElementById('dayMealToggle');
            const nightToggle = document.getElementById('nightMealToggle');

            if (dayCount > 0) {
                dayToggle.classList.add('active');
                dayToggle.classList.remove('inactive');
                document.getElementById('dayMealStatus').textContent = 'ON';
            } else {
                dayToggle.classList.add('inactive');
                dayToggle.classList.remove('active');
                document.getElementById('dayMealStatus').textContent = 'OFF';
            }

            if (nightCount > 0) {
                nightToggle.classList.add('active');
                nightToggle.classList.remove('inactive');
                document.getElementById('nightMealStatus').textContent = 'ON';
            } else {
                nightToggle.classList.add('inactive');
                nightToggle.classList.remove('active');
                document.getElementById('nightMealStatus').textContent = 'OFF';
            }

        } catch (err) {
            console.error('Error loading meal status:', err);
        }
    }

    async function loadProfileDepositHistory() {
        if (!currentUser.member_id) return;
        try {
            const { data, error } = await supabase
                .from('deposits')
                .select('*')
                .eq('member_id', currentUser.member_id)
                .eq('cycle_id', currentCycleId)
                .order('created_at', { ascending: false });

            if (error) throw error;

            const container = document.getElementById('profileDepositHistory');

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="loading">No deposits yet</div>';
                return;
            }

            container.innerHTML = data.map(deposit => `
                <div class="list-item">
                    <div class="list-item-info">
                        <div class="list-item-title">${deposit.label || 'Deposit'}</div>
                       <div class="list-item-subtitle">${formatDateTime(deposit.created_at)}</div>
                    </div>
                    <div class="list-item-amount balance-positive">${formatCurrency(deposit.amount)}</div>
                </div>
            `).join('');

        } catch (err) {
            console.error('Error loading deposit history:', err);
        }
    }

    // Toggle meal status
    // document.getElementById('dayMealToggle').addEventListener('click', async () => {
    //     if (currentUser.member_id) await toggleMeal('day');
    // });

    // document.getElementById('nightMealToggle').addEventListener('click', async () => {
    //     if (currentUser.member_id) await toggleMeal('night');
    // });




    async function toggleDefaultPreference(type) {
    if (!currentUser.member_id) return;

    // 1. Get current member data from local list to check current state
    const member = allMembers.find(m => m.id === currentUser.member_id);
    if (!member) return;

    // 2. Determine new state (Toggle)
    let updates = {};
    if (type === 'day') {
        const newState = !member.default_day_on;
        updates = { default_day_on: newState };
        // Optimistic Update (Visual)
        member.default_day_on = newState; 
        updateDefaultButtons(member);
    } else {
        const newState = !member.default_night_on;
        updates = { default_night_on: newState };
        // Optimistic Update (Visual)
        member.default_night_on = newState; 
        updateDefaultButtons(member);
    }

    try {
        // 3. Save to DB
        const { error } = await supabase
            .from('members')
            .update(updates)
            .eq('id', currentUser.member_id);

        if (error) throw error;
        // console.log("Default updated");
        
        // 4. Reload Scheduler to apply new default to any *future missing* cards immediately?
        // Actually, we usually only apply defaults when a card is CREATED. 
        // Existing cards shouldn't change. So we don't reload scheduler here.

    } catch (err) {
        console.error("Failed to update defaults", err);
        showNotification("Failed to save default setting", "error");
    }
}

// Helper to update button colors
function updateDefaultButtons(member) {
    const dayBtn = document.getElementById('defDayBtn');
    const nightBtn = document.getElementById('defNightBtn');
    
    if (dayBtn) {
        dayBtn.className = `def-btn ${member.default_day_on ? 'active' : ''}`;
        dayBtn.textContent = `Default Day: ${member.default_day_on ? 'ON' : 'OFF'}`;
    }
    
    if (nightBtn) {
        nightBtn.className = `def-btn ${member.default_night_on ? 'active' : ''}`;
        nightBtn.textContent = `Default Night: ${member.default_night_on ? 'ON' : 'OFF'}`;
    }
}





   async function toggleMeal(mealType) {
    const today = new Date().toISOString().split('T')[0];

    try {
        const { data: existing } = await supabase
            .from('meals')
            .select('*')
            .eq('member_id', currentUser.member_id)
            .eq('meal_date', today)
            .maybeSingle();

        let dayCount = existing?.day_count || 0;
        let nightCount = existing?.night_count || 0;

        if (mealType === 'day') {
            dayCount = dayCount > 0 ? 0 : 1;
        } else {
            nightCount = nightCount > 0 ? 0 : 1;
        }

        if (existing) {
            await supabase
                .from('meals')
                .update({
                    day_count: dayCount,
                    night_count: nightCount,
                    updated_at: new Date().toISOString()
                })
                .eq('id', existing.id);
        } else {
            await supabase
                .from('meals')
                .insert({
                    cycle_id: currentCycleId,
                    member_id: currentUser.member_id,
                    meal_date: today,
                    day_count: dayCount,
                    night_count: nightCount
                });
        }

        // --- CRUCIAL UPDATE HERE ---
        // We get the name of the person performing the action
        const actorName = currentUser.members ? currentUser.members.name : currentUser.username;
        const actionType = mealType === 'day' ? (dayCount > 0 ? 'ON' : 'OFF') : (nightCount > 0 ? 'ON' : 'OFF');
        
        await logActivity(
            `${actorName} turned ${mealType.toUpperCase()} meal ${actionType} for today`, 
            'meal' 
        );
        // ---------------------------

        await loadTodayMealStatus();
        showNotification('Meal status updated', 'success');

    } catch (err) {
        console.error('Error toggling meal:', err);
        showNotification('Failed to update meal status', 'error');
    }
}

    // ============================================
    // TRACKER PAGE
    // ============================================
    
       function loadTracker() {
        // The old dropdown logic is gone. 
        // We simply load the master matrix now.
        loadMasterTracker();
    }


    async function loadMemberCalendar(memberId) {
        if (!currentCycleId) return;

        try {
            const cycle = allCycles.find(c => c.id === currentCycleId);
            if (!cycle) return;

            const startDate = new Date(cycle.start_date);
            const endDate = new Date(cycle.end_date);
            
            // Fetch meals for this member and cycle
            const { data: meals } = await supabase
                .from('meals')
                .select('*')
                .eq('cycle_id', currentCycleId)
                .eq('member_id', memberId);

            const mealMap = {};
            meals?.forEach(meal => {
                mealMap[meal.meal_date] = meal;
            });

            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';

            // Generate calendar days
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const meal = mealMap[dateStr];
                const totalMeals = meal ? parseFloat(meal.day_count) + parseFloat(meal.night_count) : 0;

                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day' + (totalMeals > 0 ? ' has-meal' : '');
                dayDiv.innerHTML = `
                    <div class="calendar-day-number">${d.getDate()}</div>
                    <div class="calendar-day-meals">${totalMeals > 0 ? totalMeals.toFixed(1) : '-'}</div>
                `;

                // Only managers and admins can edit
                if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                    dayDiv.addEventListener('click', () => {
                        openMealModal(memberId, dateStr, meal);
                    });
                }

                calendarGrid.appendChild(dayDiv);
            }

        } catch (err) {
            console.error('Error loading calendar:', err);
        }
    }

function openMealModal(memberId, sessionDate, currentNightVal, nextDayVal) {
    const dSession = new Date(sessionDate);
    const dNext = new Date(dSession);
    dNext.setDate(dSession.getDate() + 1);
    const nextDateStr = dNext.toISOString().split('T')[0];
    
    const fmt = (d) => d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
    const member = allMembers.find(m => m.id == memberId);

    // Set Hidden Fields
    document.getElementById('mealMemberId').value = memberId;
    document.getElementById('mealDateSession').value = sessionDate;
    document.getElementById('mealDateNext').value = nextDateStr;

    // Set Values
    document.getElementById('mealNightCount').value = currentNightVal;
    document.getElementById('mealDayCount').value = nextDayVal;

    // PERMISSION CHECK
    const isAdminOrManager = (currentUser.role === 'admin' || currentUser.role === 'manager');
    const saveBtn = document.querySelector('#mealForm button[type="submit"]');
    const nightInput = document.getElementById('mealNightCount');
    const dayInput = document.getElementById('mealDayCount');
    const modalTitle = document.getElementById('mealModalTitle');

    if (!isAdminOrManager) {
        // Mode: View Only
        saveBtn.classList.add('hidden'); // Ensure .hidden is in your CSS or use .style.display='none'
        saveBtn.style.display = 'none';
        nightInput.disabled = true;
        dayInput.disabled = true;
        modalTitle.innerHTML = `<div style="color:var(--text-secondary); font-size:14px;">View Session: ${member?.name}</div>
                               <div style="font-size:11px; color:var(--danger-color); font-weight:700;">READ ONLY MODE</div>`;
    } else {
        // Mode: Edit
        saveBtn.classList.remove('hidden');
        saveBtn.style.display = 'block';
        nightInput.disabled = false;
        dayInput.disabled = false;
        modalTitle.innerHTML = `<div style="color:var(--primary-color); font-size:16px;">Edit Session: ${member?.name}</div>
                               <div style="font-size:11px;">Bazar Date: ${fmt(dSession)}</div>`;
    }
    
    document.getElementById('mealNightLabel').innerHTML = `Night (${fmt(dSession)})`;
    document.getElementById('mealDayLabel').innerHTML = `Day (${fmt(dNext)})`;

    document.getElementById('mealModal').classList.add('active');
}

    function closeMealModal() {
        document.getElementById('mealModal').classList.remove('active');
    }

   // ==========================================
// UPDATED MEAL FORM HANDLER
// ==========================================
// ==========================================
// UPDATED MEAL FORM HANDLER (FIXED NOTIFICATION)
// ==========================================
document.getElementById('mealForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.textContent;
    
    const memberId = parseInt(document.getElementById('mealMemberId').value);
    const sessionDate = document.getElementById('mealDateSession').value;
    const nextDate = document.getElementById('mealDateNext').value;
    const nightVal = Math.round(parseFloat(document.getElementById('mealNightCount').value)) || 0;
    const dayVal = Math.round(parseFloat(document.getElementById('mealDayCount').value)) || 0;

    btn.textContent = "Saving...";
    btn.disabled = true;

    try {
        const { data: existingRows } = await supabase.from('meals').select('*').eq('member_id', memberId).in('meal_date', [sessionDate, nextDate]);
        const findRow = (d) => existingRows?.find(r => r.meal_date === d);
        const rowSession = findRow(sessionDate);
        const rowNext = findRow(nextDate);

        const upserts = [
            { cycle_id: currentCycleId, member_id: memberId, meal_date: sessionDate, night_count: nightVal, day_count: rowSession ? rowSession.day_count : 0 },
            { cycle_id: currentCycleId, member_id: memberId, meal_date: nextDate, day_count: dayVal, night_count: rowNext ? rowNext.night_count : 0 }
        ];

        const { error } = await supabase.from('meals').upsert(upserts, { onConflict: 'member_id, meal_date' });
        if (error) throw error;

        const actor = currentUser.members ? currentUser.members.name : "Admin";
        const targetMember = allMembers.find(m => m.id === memberId);
        await logActivity(`Tracker Override: ${targetMember?.name}'s session (${sessionDate}) set to N:${nightVal} D:${dayVal} by ${actor}`, 'meal');

        closeMealModal();
        await loadMasterTracker();
        showNotification("Session updated", "success");
    } catch (err) {
        showNotification(err.message, "error");
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
});

    // ============================================
    // SUMMARY PAGE
    // ============================================
    
async function loadSummary() {
    if (!currentCycleId) return;

    const tbody = document.getElementById('summaryTableBody');
    if (!tbody) return;

    try {
const sessionDate = await getActiveSessionDate(); // This helper uses local time
const nightDateStr = toLocalISO(sessionDate);

// Calculate next day properly
const nextDay = new Date(sessionDate);
nextDay.setDate(sessionDate.getDate() + 1);
const dayDateStr = toLocalISO(nextDay);

        const [mealsRes, plansRes, depositsRes, expensesRes] = await Promise.all([
            supabase.from('meals').select('*').eq('cycle_id', currentCycleId),
            supabase.from('meal_plans').select('*').in('plan_date', [nightDateStr, dayDateStr]),
            supabase.from('deposits').select('*').eq('cycle_id', currentCycleId).neq('status', 'pending'),
            supabase.from('expenses').select('*').eq('cycle_id', currentCycleId).eq('status', 'approved')
        ]);

        const meals = mealsRes.data || [];
        const plans = plansRes.data || [];
        const deposits = depositsRes.data || [];
        const expenses = expensesRes.data || [];

        // Update Top Stat Cards
        const totalExpense = expenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
        const allTotalMeals = meals.reduce((sum, m) => sum + (parseFloat(m.day_count || 0) + parseFloat(m.night_count || 0)), 0);
        const mealRate = allTotalMeals > 0 ? totalExpense / allTotalMeals : 0;

        document.getElementById('summaryMealRate').textContent = `৳${mealRate.toFixed(2)}`;
        document.getElementById('summaryTotalCost').textContent = `৳${Math.round(totalExpense)}`;
        document.getElementById('summaryTotalMeals').textContent = allTotalMeals.toFixed(0);

        // Build Table Rows
        const isAdmin = (currentUser.role === 'admin' || currentUser.role === 'manager');
        const bazarCountMap = {};
        expenses.forEach(exp => { bazarCountMap[exp.member_id] = (bazarCountMap[exp.member_id] || 0) + 1; });

        tbody.innerHTML = allMembers.map(member => {
            const memMeals = meals.filter(m => m.member_id === member.id).reduce((sum, m) => sum + (parseFloat(m.day_count || 0) + parseFloat(m.night_count || 0)), 0);
            const memPaid = deposits.filter(d => d.member_id === member.id).reduce((sum, d) => sum + parseFloat(d.amount || 0), 0);
            const memBal = memPaid - (memMeals * mealRate);
            
            const nPlan = plans.find(p => p.member_id === member.id && p.plan_date === nightDateStr);
            const dPlan = plans.find(p => p.member_id === member.id && p.plan_date === dayDateStr);
            
            const nVal = nPlan ? nPlan.night_count : (member.default_night_on ? 1 : 0);
            const dVal = dPlan ? dPlan.day_count : (member.default_day_on ? 1 : 0);

           return `
            <tr>
                <td><strong>${member.name.split(' ')[0]}</strong></td>
                <td><button class="summary-status-btn ${nVal > 0 ? 'on' : 'off'}" ${isAdmin ? `onclick="quickToggleSummaryMeal(${member.id}, '${nightDateStr}', 'night', ${nVal})"` : 'disabled'}>${nVal > 0 ? 'ON' : 'OFF'}</button></td>
                <td><button class="summary-status-btn ${dVal > 0 ? 'on' : 'off'}" ${isAdmin ? `onclick="quickToggleSummaryMeal(${member.id}, '${dayDateStr}', 'day', ${dVal})"` : 'disabled'}>${dVal > 0 ? 'ON' : 'OFF'}</button></td>
               <td style="font-weight:700; color:var(--premium-indigo);">${toBn(bazarCountMap[member.id] || 0)}</td>
    <td>${toBn(memMeals.toFixed(1))}</td>
    <td><span class="balance-tag ${memBal >= 0 ? 'pos' : 'neg'}">${toBn(Math.round(memBal))}</span></td>
</tr>`;
        }).join('');

        await loadDueSettlement();

    } catch (err) {
        console.error('Summary Error:', err);
        tbody.innerHTML = '<tr><td colspan="6" style="color:red">Error loading summary</td></tr>';
    }
}
// Function to instantly toggle meal from Summary Page
// Function to instantly toggle meal from Summary Page
async function quickToggleSummaryMeal(memberId, dateStr, type, currentVal) {
    const btn = event.target; // Optimistic UI
    const originalText = btn.textContent;
    btn.textContent = "...";
    btn.disabled = true;

    // 1. Calculate New Value
    const newVal = currentVal > 0 ? 0 : 1;

    try {
        // 2. Fetch existing PLAN to preserve the 'other' side (Day/Night)
        const { data: existingPlan } = await supabase
            .from('meal_plans')
            .select('*')
            .eq('member_id', memberId)
            .eq('plan_date', dateStr)
            .maybeSingle();

        // 3. Prepare Upsert Data
        const upsertPlan = {
            member_id: memberId,
            plan_date: dateStr,
            day_count: existingPlan ? existingPlan.day_count : 0,
            night_count: existingPlan ? existingPlan.night_count : 0
        };

        if (type === 'night') {
            upsertPlan.night_count = newVal;
        } else {
            upsertPlan.day_count = newVal;
        }

        // 4. Send to Database
        const { error } = await supabase
            .from('meal_plans')
            .upsert(upsertPlan, { onConflict: 'member_id, plan_date' });

        if (error) throw error;

        // 5. IMPROVED LOGGING LOGIC
        // Get the target member's name from the global list
        const targetMember = allMembers.find(m => m.id === memberId);
        const targetName = targetMember ? targetMember.name : "Member";
        
        // Get Actor's name
        const actorName = currentUser.members ? currentUser.members.name : currentUser.name;
        
        // Format details
        const actionText = newVal > 0 ? "enabled" : "disabled";
        const typeLabel = type.charAt(0).toUpperCase() + type.slice(1); // "Day" or "Night"
        const dateObj = new Date(dateStr);
        const niceDate = dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });

        // Message: "Day meal for 12 Jan enabled for John by Admin"
        const logMsg = `${typeLabel} meal for ${niceDate} ${actionText} for "${targetName}" by "${actorName}"`;

        await logActivity(logMsg, 'meal');

        await loadSummary();
        showNotification("Schedule updated successfully", "success");

    } catch (err) {
        console.error("Quick Toggle Error", err);
        showNotification("Update failed", "error");
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

    document.getElementById('exportSummaryBtn').addEventListener('click', () => {
        const table = document.getElementById('summaryTable');
        const wb = XLSX.utils.table_to_book(table);
        XLSX.writeFile(wb, `MealCal_Summary_${new Date().toISOString().split('T')[0]}.xlsx`);
    });





    // ============================================
// FULL CYCLE EXPORT SYSTEM
// ============================================

document.getElementById('exportFullCycleBtn').addEventListener('click', async () => {
    if (!currentCycleId) return;
    
    const btn = document.getElementById('exportFullCycleBtn');
    const originalText = btn.textContent;
    btn.textContent = "Generating...";
    btn.disabled = true;

    try {
        // 1. Fetch ALL Data for the Cycle in Parallel
        const [cycleRes, membersRes, mealsRes, depositsRes, expensesRes] = await Promise.all([
            supabase.from('cycles').select('name, start_date, end_date').eq('id', currentCycleId).single(),
            supabase.from('members').select('id, name').order('name'),
            supabase.from('meals').select('*').eq('cycle_id', currentCycleId),
            supabase.from('deposits').select('*, members(name)').eq('cycle_id', currentCycleId).neq('status', 'pending').order('created_at'),
            supabase.from('expenses').select('*, members(name)').eq('cycle_id', currentCycleId).eq('status', 'approved').order('expense_date')
        ]);

        const cycle = cycleRes.data;
        const members = membersRes.data;
        const meals = mealsRes.data;
        const deposits = depositsRes.data;
        const expenses = expensesRes.data;

        // 2. Perform Calculations
        const totalExpense = expenses.reduce((sum, e) => sum + parseFloat(e.amount), 0);
        const totalMeals = meals.reduce((sum, m) => sum + (parseFloat(m.day_count) + parseFloat(m.night_count)), 0);
        const totalDeposits = deposits.reduce((sum, d) => sum + parseFloat(d.amount), 0);
        
        // Avoid division by zero
        const mealRate = totalMeals > 0 ? (totalExpense / totalMeals) : 0;
        const currentBalance = totalDeposits - totalExpense; // Cash in Hand

        // 3. Construct Data Arrays (Rows for the Excel file)
        let dataRows = [];

        // --- SECTION A: METADATA ---
        dataRows.push(["MEALCAL PRO - FULL CYCLE REPORT"]);
        dataRows.push(["Export Date", new Date().toLocaleString()]);
        dataRows.push(["Cycle Name", cycle.name]);
        dataRows.push(["Duration", `${cycle.start_date} to ${cycle.end_date}`]);
        dataRows.push([]); // Spacer

        // --- SECTION B: OVERALL STATISTICS ---
        dataRows.push(["--- OVERALL STATISTICS ---"]);
        dataRows.push(["Total Meals", "Total Expenses", "Total Deposits", "Meal Rate", "Cash Balance"]);
        dataRows.push([
            totalMeals.toFixed(2), 
            totalExpense.toFixed(2), 
            totalDeposits.toFixed(2), 
            mealRate.toFixed(4), 
            currentBalance.toFixed(2)
        ]);
        dataRows.push([]); // Spacer

        // --- SECTION C: MEMBER SUMMARY TABLE ---
        dataRows.push(["--- MEMBER SUMMARY ---"]);
        dataRows.push(["Member Name", "Total Meals", "Total Deposit", "Actual Cost", "Balance (+Refund/-Due)"]);

        members.forEach(m => {
            const mMeals = meals.filter(x => x.member_id === m.id)
                .reduce((s, x) => s + (parseFloat(x.day_count) + parseFloat(x.night_count)), 0);
            
            const mDep = deposits.filter(x => x.member_id === m.id)
                .reduce((s, x) => s + parseFloat(x.amount), 0);
            
            const mCost = mMeals * mealRate;
            const mBal = mDep - mCost;

            dataRows.push([
                m.name,
                mMeals.toFixed(1),
                mDep.toFixed(2),
                mCost.toFixed(2),
                mBal.toFixed(2)
            ]);
        });
        dataRows.push([]); // Spacer

        // --- SECTION D: EXPENSE LOG (BAZAR LIST) ---
        dataRows.push(["--- EXPENSE / BAZAR LOG ---"]);
        dataRows.push(["Date", "Shopper", "Description", "Amount"]);
        
        expenses.forEach(e => {
            dataRows.push([
                e.expense_date,
                e.members?.name || 'Unknown',
                e.description,
                parseFloat(e.amount).toFixed(2)
            ]);
        });
        dataRows.push([]); // Spacer

        // --- SECTION E: DEPOSIT LOG (WALLET HISTORY) ---
        dataRows.push(["--- DEPOSIT & TRANSACTION LOG ---"]);
        dataRows.push(["Date", "Member", "Label/Type", "Notes", "Amount"]);

        deposits.forEach(d => {
            const dateStr = new Date(d.created_at).toLocaleDateString('en-GB');
            dataRows.push([
                dateStr,
                d.members?.name || 'Unknown',
                d.label,
                d.notes || '-',
                parseFloat(d.amount).toFixed(2)
            ]);
        });

        // 4. Generate File
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(dataRows);

        // Optional: Auto-width columns (Cosmetic)
        ws['!cols'] = [
            { wch: 20 }, { wch: 20 }, { wch: 25 }, { wch: 15 }, { wch: 15 }
        ];

        XLSX.utils.book_append_sheet(wb, ws, "Full Report");
        
        // Filename: MealCal_Report_CycleName_Date.csv
        const safeName = cycle.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        const fileName = `MealCal_FullReport_${safeName}.csv`;

        XLSX.writeFile(wb, fileName);

        showNotification("Full Cycle Data Exported!", "success");

    } catch (err) {
        console.error("Export Error:", err);
        showNotification("Failed to export data", "error");
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
});

    // ============================================
    // EXPENSES PAGE
    // ============================================
    
 window.handleDepositAction = async function(depositId, action) {
    console.log(`Action: ${action} triggered for ID: ${depositId}`);
    const btn = event.target;
    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = "...";

    try {
        const { data: dep, error: fError } = await supabase
            .from('deposits')
            .select('*, members(name)')
            .eq('id', depositId)
            .single();

        if (fError || !dep) throw new Error("Could not find the pending request.");

        const actor = currentUser.members ? currentUser.members.name : "Admin";

        if (action === 'approve') {
            const { error: delError } = await supabase.from('deposits').delete().eq('id', depositId);
            if (delError) throw delError;

            await processDepositWithClientSideSettlement(
                dep.member_id, 
                dep.cycle_id, 
                dep.amount, 
                dep.label || 'Deposit', 
                dep.notes
            );
            
            // LOG THE APPROVAL ACT
            await logActivity(`Deposit Approved: ${dep.members.name}'s request for ${formatCurrency(dep.amount)} was approved by ${actor}`, 'deposit');
            showNotification("Request Approved", "success");

        } else if (action === 'reject') {
            const { error: delError } = await supabase.from('deposits').delete().eq('id', depositId);
            if (delError) throw delError;


            // LOG THE REJECTION ACT
            await logActivity(`Deposit Rejected: ${dep.members.name}'s request for ${formatCurrency(dep.amount)} was rejected by ${actor}`, 'deposit');
            showNotification("Request Rejected", "warning");
        }
        
        await loadDeposits(); 
        if (typeof loadDashboard === 'function') loadDashboard();

    } catch (err) {
        console.error("CRITICAL ERROR:", err.message);
        showNotification(err.message, "error");
        btn.disabled = false;
        btn.textContent = originalText;
    }
};

document.getElementById('expenseForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Get form values
    const expenseId = document.getElementById('editExpenseId').value;
    const date = document.getElementById('expenseDate').value;
    const mid = document.getElementById('expenseMember').value;
    const desc = document.getElementById('expenseDescription').value;
    const amt = parseFloat(document.getElementById('expenseAmount').value);
    
    if (!currentCycleId) { alert("No active cycle"); return; }

    const submitBtn = document.getElementById('expenseSubmitBtn');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = "Processing...";
    submitBtn.disabled = true;

    // Get the name of the shopper for the log
    const shopperSelect = document.getElementById('expenseMember');
    const shopperName = shopperSelect.options[shopperSelect.selectedIndex].text;
    
    // Get the name of the person performing the edit (Admin/Manager)
    const actorName = currentUser.members ? currentUser.members.name : currentUser.name;

    try {
        if (expenseId) {
            // ===========================
            // 1. EDIT MODE
            // ===========================

            // A. Fetch OLD data first (to compare for notification)
            const { data: oldData, error: fetchError } = await supabase
                .from('expenses')
                .select('amount, description')
                .eq('id', expenseId)
                .single();
            
            if (fetchError) throw fetchError;

            // B. Update the Database
            const { error: updateError } = await supabase
                .from('expenses')
                .update({ 
                    expense_date: date, 
                    member_id: mid, 
                    description: desc, 
                    amount: amt,
                    is_edited: true // This will now work with the SQL fix
                })
                .eq('id', expenseId);

            if (updateError) throw updateError;

            // C. Log Detailed Notification
            // Example: "Expense edit request APPROVED: from 800 to 700..."
            const msg = `Expense Edited: from ৳${oldData.amount} to ৳${amt} for "${desc}" (Shopper: ${shopperName}) - by ${actorName}`;
            
            await supabase.from('notifications').insert({
                cycle_id: currentCycleId,
                type: 'expense',
                message: msg
            });

            showNotification('Expense updated successfully!', 'success');

        } else {
            // ===========================
            // 2. INSERT MODE (New Entry)
            // ===========================
            
            const isAdmin = (currentUser.role === 'admin' || currentUser.role === 'manager');
            const status = isAdmin ? 'approved' : 'pending';

            const { error: insertError } = await supabase
                .from('expenses')
                .insert({ 
                    cycle_id: currentCycleId, 
                    expense_date: date, 
                    member_id: mid, 
                    description: desc, 
                    amount: amt,
                    status: status
                });

            if (insertError) throw insertError;

            // Log New Entry Notification
            const msg = `New Expense: ৳${amt} for "${desc}" by ${shopperName}`;
            await supabase.from('notifications').insert({
                cycle_id: currentCycleId,
                type: 'expense',
                message: msg
            });

            showNotification(isAdmin ? 'Expense added successfully!' : 'Request sent to admin', 'success');
        }

        // Reset Form and Reload
        resetExpenseForm();
        await loadExpenses(); 
        await loadDashboard(); 

    } catch (err) {
        console.error(err);
        showNotification(err.message, 'error');
    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
});

    // ============================================
    // DEPOSITS PAGE
    // ============================================
async function loadDeposits() {
    const filterId = document.getElementById('depositLogFilter').value;
    if (!currentCycleId) return;

    try {
        const { data, error } = await supabase
            .from('deposits')
            .select('*, members(name)')
            .eq('cycle_id', currentCycleId)
            .order('created_at', { ascending: false });

        if (error) throw error;

        const pendingCard = document.getElementById('pendingDepositsCard');
        const pendingList = document.getElementById('pendingDepositList');
        const historyContainer = document.getElementById('depositList');

        // STRICT FILTERING
        // Pending: only those explicitly marked 'pending'
        const pendingItems = data.filter(d => d.status === 'pending');
        
        // History: only those marked 'approved' OR legacy records (null status)
        const historyItems = data.filter(d => d.status === 'approved' || !d.status);

        // Render Pending
        if (pendingItems.length > 0) {
            pendingCard.style.display = 'block';
            const isAdmin = (currentUser.role === 'admin' || currentUser.role === 'manager');
            pendingList.innerHTML = pendingItems.map(t => `
                <div class="list-item" style="background: rgba(245, 158, 11, 0.05); padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #fed7aa;">
                    <div class="log-main">
                        <div class="log-details">
                            <div class="log-member">${t.members?.name} <span class="due-status-badge due-status-pending">PENDING REQUEST</span></div>
                            <div class="log-meta" style="font-weight:700;">${formatCurrency(t.amount)} • ${t.label || 'Deposit'}</div>
                        </div>
                    </div>
                    ${isAdmin ? `
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-success btn-sm" onclick="handleDepositAction(${t.id}, 'approve')">Approve</button>
                        <button class="btn btn-danger btn-sm" onclick="handleDepositAction(${t.id}, 'reject')">✕</button>
                    </div>` : ''}
                </div>
            `).join('');
        } else {
            pendingCard.style.display = 'none';
        }

        // Render History
        let filteredHistory = historyItems;
        if (filterId) filteredHistory = historyItems.filter(h => h.member_id == filterId);

        if (filteredHistory.length === 0) {
            historyContainer.innerHTML = '<div class="loading">No transaction history found.</div>';
            return;
        }

        historyContainer.innerHTML = filteredHistory.map(t => {
            const isSettlement = t.label === 'Auto-Settlement' || t.label === 'Reduction';
            const isNegative = t.amount < 0;
            
            // Icon & Style Logic
            let icon = '💰';
            let iconClass = 'deposit';
            let tagClass = 'tag-deposit';
            let typeLabel = 'Deposit';

            if (t.label === 'Auto-Settlement') {
                icon = '🔄';
                iconClass = 'settlement';
                tagClass = 'tag-settle';
                typeLabel = 'Settlement';
            } else if (isNegative) {
                icon = '🔻';
                iconClass = 'charge';
                tagClass = 'tag-settle';
                typeLabel = 'Charge';
            }

         const dateStr = formatDateTime(t.created_at);

            return `
           <div class="log-item">
    <div class="log-content">
        <!-- Left side -->
        <div class="log-main">
            <div class="log-icon ${iconClass}">${icon}</div>

            <div class="log-details">
                <div class="log-member">
                    ${t.members?.name || 'Unknown'}
                    <span class="log-type-tag ${tagClass}">
                        ${typeLabel}
                    </span>
                </div>

                <div class="log-meta">
                    ${dateStr} ${t.notes ? `• ${t.notes}` : ''}
                </div>

                ${isSettlement && t.notes
                    ? `<div class="transfer-info">📌 ${t.notes}</div>`
                    : ''}
            </div>
        </div>

        <!-- Right side (balance) -->
        <div class="log-amount
            ${isNegative ? 'balance-negative' : 'balance-positive'}">
            ${isNegative ? '-' : '+'}${formatCurrency(Math.abs(t.amount))}
        </div>
    </div>
</div>

            `;
        }).join('');

    } catch (err) {
        console.error('Error loading deposits:', err);
        historyContainer.innerHTML = '<div class="loading" style="color:red;">Error loading transactions.</div>';
    }
}

async function loadExpenses() {
    const historyContainer = document.getElementById('expenseList');
    const pendingContainer = document.getElementById('pendingExpensesList');
    const pendingCard = document.getElementById('pendingExpensesCard');
    
    if (!currentCycleId) return;

    try {
        // Fetch ALL expenses for this cycle
        const { data: expenses, error } = await supabase
            .from('expenses')
            .select('*, members(name)')
            .eq('cycle_id', currentCycleId)
            .order('created_at', { ascending: false });

        if (error) throw error;

        // Reset Containers
        historyContainer.innerHTML = '';
        pendingContainer.innerHTML = '';
        pendingCard.style.display = 'none';

        if (!expenses || expenses.length === 0) {
            historyContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#cbd5e1;">No expenses yet.</div>';
            return;
        }

        const isAdmin = (currentUser.role === 'admin' || currentUser.role === 'manager');

        // --- FILTERING ---
        const pendingItems = expenses.filter(e => e.status === 'pending');
        // History shows Approved items OR items marked 'rejected' (optional)
        const historyItems = expenses.filter(e => e.status === 'approved');

        // 1. RENDER PENDING LIST (Mobile Optimized)
if (pendingItems.length > 0) {
    pendingCard.style.display = 'block';
    
    pendingContainer.innerHTML = pendingItems.map(exp => {
        const dateStr = new Date(exp.expense_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        const shopperName = exp.members?.name || 'Unknown';
        // Truncate description for mobile if too long
        const shortDesc = (exp.description || 'No details').substring(0, 25) + ((exp.description?.length > 25) ? '...' : '');
        
        // Admin Buttons vs User Label
        const footerContent = isAdmin ? `
            <div class="pending-actions">
                <button class="btn-mobile-action btn-approve" onclick="handleExpenseApproval('${exp.id}', 'approved')">
                    ✓ Approve
                </button>
                <button class="btn-mobile-action btn-reject" onclick="handleExpenseApproval('${exp.id}', 'rejected')">
                    ✕ Reject
                </button>
            </div>
        ` : `<div class="pending-status-label">WAITING FOR ADMIN APPROVAL</div>`;

        return `
        <div class="pending-card-inner">
            <!-- Top Row -->
            <div class="pending-main-row">
                <div class="pending-left-group">
                    <div class="pending-icon-circle">🛒</div>
                    <div>
                        <div class="pending-shopper-name">${shopperName}</div>
                        <div class="pending-desc">${shortDesc}</div>
                    </div>
                </div>
                <div class="pending-right-group">
                    <div class="pending-amt">৳${toBn(exp.amount)}</div>
                    <div class="pending-date">${dateStr}</div>
                </div>
            </div>
            
            <!-- Bottom Row (Buttons or Status) -->
            ${footerContent}
        </div>`;
    }).join('');
}
        // 2. RENDER HISTORY LIST (Approved Only)
        if (historyItems.length === 0) {
            historyContainer.innerHTML = '<div style="text-align:center; padding:10px; color:#cbd5e1; font-size:11px;">No approved expenses yet.</div>';
        } else {
            historyItems.forEach(exp => {
                const dateObj = new Date(exp.expense_date);
                const dateStr = dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                const itemsText = exp.description ? exp.description : 'General Expense';
                const shopperName = exp.members?.name || 'Unknown';
                const editedTag = exp.is_edited ? `<span class="edited-badge">EDITED</span>` : '';

                let actionBtn = '';
                if (isAdmin) {
                    actionBtn = `
                    <button class="btn-icon-edit" 
                        onclick="populateExpenseForm('${exp.id}', '${exp.expense_date}', '${exp.member_id}', '${exp.amount}', this.dataset.desc)"
                        data-desc="${(exp.description || '').replace(/"/g, '&quot;')}"
                    >✎</button>`;
                }

                const html = `
                <div class="expense-card-modern">
                    <div class="exp-info-left">
                        <div class="exp-icon-box">🛒</div>
                        <div class="exp-details">
                            <div class="title">${shopperName} • ${dateStr} ${editedTag}</div>
                            <div class="meta">${itemsText}</div>
                        </div>
                    </div>
                    <div class="exp-info-left" style="gap:0;">
                        <div class="exp-amount-right">
                            <div class="val">৳${toBn(exp.amount)}</div> 
                        </div>
                        ${actionBtn}
                    </div>
                </div>`;
                
                historyContainer.insertAdjacentHTML('beforeend', html);
            });
        }

    } catch (err) {
        console.error("Load Exp Error:", err);
        historyContainer.innerHTML = '<div style="color:red; text-align:center;">Failed to load.</div>';
    }
}


// Function to fill the form with existing data
function populateExpenseForm(id, date, memberId, amount, desc) {
    // 1. Fill Fields
    document.getElementById('editExpenseId').value = id;
    document.getElementById('expenseDate').value = date;
    document.getElementById('expenseMember').value = memberId;
    document.getElementById('expenseAmount').value = amount;
    document.getElementById('expenseDescription').value = desc;

    // 2. Change UI to "Edit Mode"
    document.getElementById('expenseFormTitle').textContent = "Edit Expense Log";
    document.getElementById('expenseFormTitle').style.color = "var(--primary-color)";
    
    const submitBtn = document.getElementById('expenseSubmitBtn');
    submitBtn.textContent = "Update ✓";
    submitBtn.classList.remove('btn-primary');
    submitBtn.classList.add('btn-success'); // You might need to define .btn-success or just leave styled via CSS
    submitBtn.style.backgroundColor = "#059669"; // Force green

    document.getElementById('expenseCancelBtn').classList.remove('hidden');

    // 3. Scroll to top so user sees the form
    document.getElementById('expensesPage').scrollIntoView({ behavior: 'smooth' });
}

// Function to cancel edit and reset form
function resetExpenseForm() {
    const form = document.getElementById('expenseForm');
    if (!form) return;

    // 1. Clear standard inputs
    form.reset();
    document.getElementById('editExpenseId').value = '';
    
    // 2. Reset UI Styling (Title & Buttons)
    const title = document.getElementById('expenseFormTitle');
    const submitBtn = document.getElementById('expenseSubmitBtn');
    const cancelBtn = document.getElementById('expenseCancelBtn');

    title.textContent = "Add Expense";
    title.style.color = "var(--text-primary)";
    
    submitBtn.textContent = "ADD +";
    submitBtn.className = "btn btn-primary"; // Reset classes
    submitBtn.style.backgroundColor = ""; // Reset inline styles

    if (cancelBtn) cancelBtn.classList.add('hidden');

    // 3. SET DEFAULT DATE: TODAY (Local Time)
    // We adjust for timezone offset to get the correct local "YYYY-MM-DD"
    const now = new Date();
    const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000))
                        .toISOString()
                        .split('T')[0];
    
    document.getElementById('expenseDate').value = localDate;
    
    // 4. SET DEFAULT SHOPPER: CURRENT USER
    // This applies to everyone (Admins included) for convenience
    if (currentUser && currentUser.member_id) {
        const memberSelect = document.getElementById('expenseMember');
        if (memberSelect) {
            memberSelect.value = currentUser.member_id;
        }
    }
}

document.getElementById('expenseForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Get form values
    const expenseId = document.getElementById('editExpenseId').value;
    const date = document.getElementById('expenseDate').value;
    const mid = document.getElementById('expenseMember').value;
    const desc = document.getElementById('expenseDescription').value;
    const amt = parseFloat(document.getElementById('expenseAmount').value);
    
    if (!currentCycleId) { alert("No active cycle"); return; }

    const submitBtn = document.getElementById('expenseSubmitBtn');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = "Processing...";
    submitBtn.disabled = true;

    // Get Shopper Name (The person who bought it)
    const shopperSelect = document.getElementById('expenseMember');
    const shopperName = shopperSelect.options[shopperSelect.selectedIndex].text;
    
    // Get Actor Name (The person currently logged in editing)
    const actorName = currentUser.members ? currentUser.members.name : currentUser.name;

    try {
        if (expenseId) {
            // ===========================
            // 1. EDIT MODE
            // ===========================

            // A. Fetch OLD data first
            const { data: oldData, error: fetchError } = await supabase
                .from('expenses')
                .select('amount, description')
                .eq('id', expenseId)
                .single();
            
            if (fetchError) throw fetchError;

            // B. Update Database
            const { error: updateError } = await supabase
                .from('expenses')
                .update({ 
                    expense_date: date, 
                    member_id: mid, 
                    description: desc, 
                    amount: amt,
                    is_edited: true 
                })
                .eq('id', expenseId);

            if (updateError) throw updateError;

            // C. Log Notification (Fixed Bengali Numbers & Linked Actor)
            // Use toBn() for converting numbers to Bengali
            const oldAmtBn = toBn(oldData.amount);
            const newAmtBn = toBn(amt);

            const msg = `Expense Edited: from ৳${oldAmtBn} to ৳${newAmtBn} for "${desc}" (Shopper: ${shopperName}) - by ${actorName}`;
            
            await supabase.from('notifications').insert({
                cycle_id: currentCycleId,
                type: 'expense',
                message: msg,
                member_id: currentUser.member_id // <--- THIS FIXES "By: System" to "By: Admin"
            });

            showNotification('Expense updated successfully!', 'success');

        } else {
            // ===========================
            // 2. INSERT MODE
            // ===========================
            
            const isAdmin = (currentUser.role === 'admin' || currentUser.role === 'manager');
            const status = isAdmin ? 'approved' : 'pending';

            const { error: insertError } = await supabase
                .from('expenses')
                .insert({ 
                    cycle_id: currentCycleId, 
                    expense_date: date, 
                    member_id: mid, 
                    description: desc, 
                    amount: amt,
                    status: status
                });

            if (insertError) throw insertError;

            // Log New Entry
            const amtBn = toBn(amt);
            const msg = `New Expense: ৳${amtBn} for "${desc}" by ${shopperName}`;
            
            await supabase.from('notifications').insert({
                cycle_id: currentCycleId,
                type: 'expense',
                message: msg,
                member_id: currentUser.member_id // Link actor here too
            });

            showNotification(isAdmin ? 'Expense added successfully!' : 'Request sent to admin', 'success');
        }

        resetExpenseForm();
        await loadExpenses(); 
        await loadDashboard(); 

    } catch (err) {
        console.error(err);
        showNotification(err.message, 'error');
    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
});

function autoUpdateDepositLabel() {
    const type = document.getElementById('depositType').value;
    const labelInput = document.getElementById('depositLabel');
    
    // Only update if the user hasn't typed something custom yet (optional logic, 
    // strictly replacing is usually safer for UX in this context)
    if (type === 'charge') {
        labelInput.value = 'Reduction';
    } else {
        labelInput.value = 'Deposit';
    }
}

async function loadSelectedMemberHistory(memberId) {
    const container = document.getElementById('selectedMemberHistoryList');
    const nameLabel = document.getElementById('historyMemberName');
    
    // Defensive check: If the page isn't loaded yet, stop here.
    if (!container || !nameLabel) return;

    if (!memberId) {
        container.innerHTML = '<div style="font-size:11px; color:gray; text-align:center; padding:10px;">Select a member to view their specific log.</div>';
        nameLabel.textContent = "No member selected";
        return;
    }

    const member = allMembers.find(m => m.id == memberId);
    nameLabel.textContent = member ? member.name.toUpperCase() : 'UNKNOWN';
    container.innerHTML = '<div class="loading" style="font-size:11px;">Loading history...</div>';

    try {
        const { data, error } = await supabase
            .from('deposits')
            .select('*, members(name)')
            .eq('cycle_id', currentCycleId)
            .eq('member_id', memberId)
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!data || data.length === 0) {
            container.innerHTML = '<div style="font-size:11px; color:gray; text-align:center; padding:10px;">No personal history found.</div>';
            return;
        }

        // Reuse the premium renderHistoryItem function for consistency
        container.innerHTML = data.map(t => renderHistoryItem(t)).join('');

    } catch (err) {
        console.error("Error loading member history:", err);
        container.innerHTML = '<div style="font-size:11px; color:red; text-align:center; padding:10px;">Error loading data.</div>';
    }
}


function renderHistoryItem(t) {
    const isNegative = t.amount < 0;
    const isSettle = t.label === 'Auto-Settlement';
    
    let icon = '💰';
    let iconClass = 'plus';
    if (isSettle) { icon = '🔄'; iconClass = 'settle'; }
    else if (isNegative) { icon = '📉'; iconClass = 'minus'; }

    const dateStr = new Date(t.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });

    // --- CHANGED LINE BELOW: toBn(Math.round(t.amount)) ---
    return `
    <div class="history-item-premium">
        <div class="hist-left">
            <div class="hist-icon ${iconClass}">${icon}</div>
            <div class="hist-details">
                <div class="name">${t.members?.name || 'User'}</div>
                <div class="meta">${dateStr} ${t.notes ? `• ${t.notes}` : ''}</div>
            </div>
        </div>
        <div class="hist-amount">
            <div class="val" style="color: ${isNegative ? '#e11d48' : '#059669'}">
                ${isNegative ? '' : '+'}${toBn(Math.round(t.amount))}
            </div>
            <div class="label" style="color: var(--text-muted)">${t.label || 'Entry'}</div>
        </div>
    </div>`;
}


// Add this NEW function BEFORE the depositForm handler
async function processDepositWithClientSideSettlement(memberId, cycleId, amount, label, notes) {
    try {
        const targetCycleId = parseInt(cycleId); 

        // 1. Insert the official REAL cash deposit (Approved)
        const { data: mainDeposit, error: depError } = await supabase
            .from('deposits')
            .insert({
                cycle_id: targetCycleId,
                member_id: memberId,
                amount: amount,
                label: label,
                notes: notes,
                status: 'approved'
            })
            .select().single();

        if (depError) throw depError;

        const memberObj = allMembers.find(m => m.id == memberId);
        
        // GLOBAL LOG
        await logActivity(`Cash Deposit: ${formatCurrency(amount)} added for ${memberObj?.name}`, 'deposit');
        
    

        if (amount <= 0) return { settled: false, deposit_id: mainDeposit.id };

        // 2. Find Debtor Due
        const { data: debtorDue } = await supabase
            .from('cycle_dues')
            .select('*')
            .eq('member_id', memberId)
            .eq('to_cycle_id', targetCycleId)
            .in('status', ['pending', 'settling'])
            .lt('due_amount', 0)
            .maybeSingle();

        if (!debtorDue) return { settled: false, deposit_id: mainDeposit.id };

        // 3. Find Creditors
        const { data: creditors } = await supabase
            .from('cycle_dues')
            .select('*, members(name)')
            .eq('to_cycle_id', targetCycleId)
            .in('status', ['pending', 'settling'])
            .gt('due_amount', 0)
            .order('created_at', { ascending: true });

        if (!creditors || creditors.length === 0) return { settled: false, deposit_id: mainDeposit.id };

        // INITIALIZE POOL (Fixed placement)
        let poolAvailable = Math.min(amount, Math.abs(debtorDue.due_amount) - Math.abs(debtorDue.settled_amount));
        let totalActuallySettled = 0;

        for (const creditor of creditors) {
            if (poolAvailable <= 0) break;

            const creditorOwed = creditor.due_amount - creditor.settled_amount;
            if (creditorOwed <= 0) continue;

            // CALCULATE SETTLEMENT (With Rounding Logic)
            const settleAmountRaw = Math.min(poolAvailable, creditorOwed);
            const settleAmount = Math.round(settleAmountRaw * 100) / 100; // Limits to 2 decimals

            if (settleAmount <= 0) continue;

            // 4. Create Transfer Logs (Auto-Settlements)
            await supabase.from('deposits').insert([
                { 
                    cycle_id: targetCycleId, 
                    member_id: memberId, 
                    amount: -settleAmount, 
                    label: 'Auto-Settlement', 
                    notes: `Paid to ${creditor.members.name}`,
                    status: 'approved'
                },
                { 
                    cycle_id: targetCycleId, 
                    member_id: creditor.member_id, 
                    amount: settleAmount, 
                    label: 'Auto-Settlement', 
                    notes: `Received from ${memberObj.name}`,
                    status: 'approved'
                }
            ]);

         

            // Update Creditor Progress
            const newCreditorSettled = creditor.settled_amount + settleAmount;
            await supabase.from('cycle_dues').update({
                settled_amount: newCreditorSettled,
                status: newCreditorSettled >= creditor.due_amount ? 'settled' : 'settling',
                settled_at: newCreditorSettled >= creditor.due_amount ? new Date().toISOString() : null
            }).eq('id', creditor.id);

            poolAvailable -= settleAmount;
            totalActuallySettled += settleAmount;
        }

        // 5. Update Debtor Progress Record
        if (totalActuallySettled > 0) {
            const newDebtorSettled = Math.abs(debtorDue.settled_amount) + totalActuallySettled;
            const isFullySettled = newDebtorSettled >= Math.abs(debtorDue.due_amount);
            
            await supabase.from('cycle_dues').update({
                settled_amount: -newDebtorSettled,
                status: isFullySettled ? 'settled' : 'settling',
                settled_at: isFullySettled ? new Date().toISOString() : null
            }).eq('id', debtorDue.id);
            
        }

        return {
            settled: totalActuallySettled > 0,
            settled_amount: totalActuallySettled,
            deposit_id: mainDeposit.id
        };

    } catch (err) {
        console.error("Settlement Logic Crash:", err);
        throw err;
    }
}

document.getElementById('depositForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.textContent;

    const memberId = parseInt(document.getElementById('depositMember').value);
    const type = document.getElementById('depositType').value;
    const rawAmount = parseFloat(document.getElementById('depositAmount').value);
    const roundedAmount = Math.round(rawAmount); 
    const label = document.getElementById('depositLabel').value;
    const notes = document.getElementById('depositNotes').value;
    
    const finalAmount = type === 'charge' ? -Math.abs(roundedAmount) : Math.abs(roundedAmount);
    const isAdmin = (currentUser.role === 'admin' || currentUser.role === 'manager');
    const actor = currentUser.members ? currentUser.members.name : "User";

    btn.textContent = "Processing...";
    btn.disabled = true;

    try {
        const targetMember = allMembers.find(m => m.id === memberId);

        if (isAdmin) {
            let result;
            try {
                const { data, error } = await supabase.rpc('process_deposit_with_settlement', {
                    p_member_id: memberId,
                    p_cycle_id: parseInt(currentCycleId),
                    p_amount: finalAmount,
                    p_label: label,
                    p_notes: notes
                });
                if (error) throw error;
                result = data;
            } catch (rpcError) {
                result = await processDepositWithClientSideSettlement(memberId, currentCycleId, finalAmount, label, notes);
            }
            
            await logActivity(`Deposit Approved: ${formatCurrency(finalAmount)} added for ${targetMember?.name} by ${actor}`, 'deposit');
            showNotification("Transaction completed", 'success');
        } else {
            const { error } = await supabase.from('deposits').insert({
                cycle_id: parseInt(currentCycleId),
                member_id: memberId,
                amount: finalAmount,
                label: label,
                notes: notes,
                status: 'pending'
            });
            if (error) throw error;

            await logActivity(`Deposit Request: ${targetMember?.name} requested ${formatCurrency(finalAmount)} approval via ${actor}`, 'deposit');
            showNotification("Request submitted", 'info');
        }

        document.getElementById('depositAmount').value = '';
        document.getElementById('depositNotes').value = '';
        await loadDeposits();
    } catch (err) {
        showNotification(err.message, 'error');
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
});

    // ============================================
    // ADMIN PAGE
    // ============================================
    
    async function loadAdmin() {
        await loadMembersList();
    }

   document.getElementById('createCycleForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.textContent;
    const name = document.getElementById('cycleName').value;
    const startDate = document.getElementById('cycleStartDate').value;
    const endDate = document.getElementById('cycleEndDate').value;

    btn.textContent = "Creating...";
    btn.disabled = true;

    try {
        await supabase.from('cycles').update({ is_active: false }).neq('id', 0);
        const { error } = await supabase.from('cycles').insert({ name, start_date: startDate, end_date: endDate, is_active: true });
        if (error) throw error;

        const actor = currentUser.members ? currentUser.members.name : "Admin";
        await logActivity(`System: New cycle "${name}" created and activated by ${actor}`, 'other');

        document.getElementById('createCycleForm').reset();
        await loadCycles();
        showNotification('Cycle created', 'success');
    } catch (err) {
        showNotification(err.message, 'error');
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
});



    document.getElementById('addMemberForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = document.getElementById('memberName').value;

        try {
            // 1. Insert Member
            const { data: memberData, error: memberError } = await supabase
                .from('members')
                .insert({ name: name })
                .select()
                .maybeSingle();
            
            if (memberError) throw memberError;

            // 2. Automatically create User
            const defaultPass = await hashPassword("123");
            
            await supabase.from('users').insert({
                username: name,
                password: defaultPass,
                role: 'user',
                member_id: memberData.id
            });

            await logActivity(`New member added & user created: ${name}`, 'other');

            document.getElementById('addMemberForm').reset();
            await loadMembers();
            await loadMembersList();
            showNotification('Member added successfully. Default password is "123"', 'success');

        } catch (err) {
            console.error('Error adding member:', err);
            showNotification('Failed to add member', 'error');
        }
    });

 async function loadMembersList() {
    const container = document.getElementById('membersList');
    if (!container) return;
    container.innerHTML = '<div class="loading">Loading members...</div>';

    try {
        const { data: members, error } = await supabase
            .from('members')
            .select('*')
            .order('name');
        
        if (error) throw error;

        if (!members || members.length === 0) {
            container.innerHTML = '<div class="loading">No members yet</div>';
            return;
        }

        container.innerHTML = members.map(member => {
            const isManager = member.role === 'manager';
            const isAdmin = member.role === 'admin';
            const hasLogin = member.user_id !== null;

            // --- FIXED AVATAR LOGIC (Inside the loop) ---
            const avatarHtml = (member.avatar_url && member.avatar_url.trim() !== "") 
                ? `<img src="${member.avatar_url}" style="width:45px; height:45px; border-radius:50%; object-fit:cover; border: 2px solid #e2e8f0;">`
                : `<div style="width:45px; height:45px; border-radius:50%; background:#f1f5f9; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:16px; color:#64748b; border: 2px solid #cbd5e1;">${member.name[0].toUpperCase()}</div>`;

            return `
            <div class="list-item" style="flex-wrap: wrap; gap: 12px; align-items: center; padding: 15px; background: white; border-radius: 16px; margin-bottom: 10px; border: 1px solid #f1f5f9;">
                
                <!-- Avatar column -->
                <div style="flex-shrink: 0;">
                    ${avatarHtml}
                </div>

                <!-- Info column -->
                <div class="list-item-info" style="flex: 1; min-width: 150px;">
                    <div class="list-item-title" style="font-size: 15px; font-weight: 800;">
                        ${member.name} 
                        ${isAdmin ? '<span style="font-size:9px; background:#0f172a; color:white; padding:2px 6px; border-radius:6px; margin-left:5px;">ADMIN</span>' : ''}
                        ${isManager ? '<span style="font-size:9px; background:#10b981; color:white; padding:2px 6px; border-radius:6px; margin-left:5px;">MANAGER</span>' : ''}
                    </div>
                    <div class="list-item-subtitle" style="font-size: 11px;">
                        ${hasLogin ? '<span style="color:#10b981">● Active User</span>' : '<span style="color:#f59e0b">○ No Login Linked</span>'}
                    </div>
                </div>
                
                <!-- Actions column -->
                <div style="display: flex; gap: 8px;">
                    ${!isAdmin ? `
                    <button class="btn btn-sm ${isManager ? 'btn-secondary' : 'btn-success'}" 
                            style="font-size: 10px; padding: 6px 10px;"
                            onclick="toggleManagerRole('${member.id}', '${member.role}')">
                        ${isManager ? 'Demote' : 'Promote'}
                    </button>
                    ` : ''}
                    
                    <button class="btn btn-sm btn-primary" 
                            style="font-size: 10px; padding: 6px 10px;"
                            onclick="openEditMemberModal('${member.id}', '${member.name}', '${member.user_id || ''}')">
                        Edit
                    </button>
                </div>
            </div>
            `;
        }).join('');

    } catch (err) {
        console.error('Error loading members list:', err);
        container.innerHTML = '<div class="loading" style="color:red">Error loading list</div>';
    }
}


// --- Action 1: Toggle Manager Role ---
async function toggleManagerRole(memberId, currentRole) {
    const isManager = currentRole === 'manager';
    const newRole = isManager ? 'user' : 'manager';
    if (!confirm(`Change role to ${newRole}?`)) return;

    try {
        const { error } = await supabase.from('members').update({ role: newRole }).eq('id', memberId);
        if (error) throw error;

        const targetMember = allMembers.find(m => m.id == memberId);
        const actor = currentUser.members ? currentUser.members.name : "Admin";
        
        // LOG ROLE CHANGE
        await logActivity(`Access Control: ${targetMember.name} was ${isManager ? 'demoted to User' : 'promoted to Manager'} by ${actor}`, 'other');

        showNotification('Role updated successfully', 'success');
        await loadMembersList();
    } catch (err) {
        showNotification('Failed to update role', 'error');
    }
}

// --- Action 2: Delete Member ---
async function deleteMember(memberId, userId) {
    if (!confirm('WARNING: Deleting a member will remove their user account. If they have existing meal/deposit records, this might fail or cause data issues. Continue?')) return;

    try {
        // 1. Delete User Account first (if exists)
        if (userId) {
            const { error: uError } = await supabase.from('users').delete().eq('id', userId);
            if (uError) throw uError;
        }

        // 2. Delete Member
        const { error: mError } = await supabase.from('members').delete().eq('id', memberId);
        if (mError) {
            // If foreign key constraint fails (has meals/deposits)
            throw new Error("Cannot delete member: They likely have associated meals or deposits.");
        }

        showNotification('Member deleted successfully', 'success');
        await loadMembersList();
        await loadMembers(); // Refresh global list

    } catch (err) {
        console.error('Delete error:', err);
        showNotification(err.message, 'error');
    }
}

// --- Action 3: Edit Member (Modal & Save) ---
function openEditMemberModal(memberId, currentName, userId) {
    document.getElementById('editMemberId').value = memberId;
    document.getElementById('editUserId').value = userId;
    document.getElementById('editMemberName').value = currentName;
    document.getElementById('editMemberPassword').value = ''; // Reset password field
    document.getElementById('editMemberModal').classList.add('active');
}

document.getElementById('editMemberForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const memberId = document.getElementById('editMemberId').value;
    const userId = document.getElementById('editUserId').value;
    const newName = document.getElementById('editMemberName').value;
    const newPassword = document.getElementById('editMemberPassword').value;

    try {
        // 1. Update Member Name
        const { error: mError } = await supabase
            .from('members')
            .update({ name: newName })
            .eq('id', memberId);


               const actor = currentUser.members ? currentUser.members.name : "Admin";
        // LOG MEMBER EDIT
        await logActivity(`Member Profile: Account for "${newName}" was modified by ${actor}`, 'other');

        document.getElementById('editMemberModal').classList.remove('active');
        showNotification('Member updated successfully', 'success');
        
        if (mError) throw mError;

        // 2. Update User (Username and optionally Password)
        if (userId) {
            const userUpdates = { username: newName }; // Sync username with member name
            
            if (newPassword && newPassword.trim() !== "") {
                userUpdates.password = await hashPassword(newPassword);
            }

            const { error: uError } = await supabase
                .from('users')
                .update(userUpdates)
                .eq('id', userId);

            if (uError) throw uError;
        }

        await loadMembersList();
        await loadMembers(); // Refresh global list

    } catch (err) {
        console.error('Edit error:', err);
        showNotification('Failed to update member: ' + err.message, 'error');
    }
});


    // ============================================
    // UTILITY: LOG ACTIVITY
    // ============================================

    // Helper for whole number currency display
function formatCurrencyRound(amount) {
    return `৳${Math.round(parseFloat(amount || 0))}`;
}
    
async function logActivity(message, type = 'info') {
    if (!currentCycleId) {
        console.error("Cannot log activity: currentCycleId is missing.");
        return;
    }
    
    try {
        const { error } = await supabase
            .from('notifications')
            .insert({
                cycle_id: parseInt(currentCycleId), // Ensure it's an Integer
                message: message,
                type: type,
                member_id: currentUser?.member_id || null // NULL for system logs
            });

        if (error) throw error;
        
        // Refresh local notifications if the panel is open
        if (document.getElementById('notifPanel').classList.contains('active')) {
            loadNotifications();
        }
    } catch (err) {
        console.error('Logging Error:', err.message);
    }
}


async function triggerManualAutoEntry() {
    if (!confirm("⚠️ Are you sure? \n\nThis will FORCE the system to copy all 'Meal Plans' into the 'Tracker' for Today's Night and Tomorrow's Day.\n\nThis overwrites the tracker with the plans immediately.")) {
        return;
    }

    const btn = document.querySelector('button[onclick="triggerManualAutoEntry()"]');
    const originalText = btn.textContent;
    btn.textContent = "Running...";
    btn.disabled = true;

    try {
        // Call the RPC function with force_run = true
        const { error } = await supabase.rpc('handle_auto_meal_entry', { force_run: true });

        if (error) throw error;

        showNotification("✅ Auto-entry forced successfully!", "success");
        await updateEntryStatusIndicator(); // <--- REFRESH BADGE IMMEDIATELY
        await loadDashboard(); // Reload logs
        await loadMasterTracker(); // Update tracker view if looking at it

    } catch (err) {
        console.error("Force Run Error", err);
        showNotification("Failed to run automation: " + err.message, "error");
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}


// ==========================================
// ENTRY STATUS INDICATOR LOGIC
// ==========================================

// Global rotation variable
// Global variables for Badge Rotation
let statusCycleInterval = null;
let statusQueue = [];
let currentStatusIndex = 0;

async function updateEntryStatusIndicator() {
    const badge = document.getElementById('entryStatusBadge');
    if (!badge || !currentCycleId || !currentUser?.member_id) return;

    try {
        const today = new Date();
        const sessionDate = await getActiveSessionDate();
        const dateLabel = sessionDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }).toUpperCase();
        
        // 1. FETCH DATA
        const [expRes, allMealsRes, myMealsRes, myDepsRes, duesRes] = await Promise.all([
            supabase.from('expenses').select('amount').eq('cycle_id', currentCycleId).eq('status', 'approved'),
            supabase.from('meals').select('day_count, night_count').eq('cycle_id', currentCycleId),
            supabase.from('meals').select('day_count, night_count').eq('member_id', currentUser.member_id).eq('cycle_id', currentCycleId),
            supabase.from('deposits').select('amount').eq('member_id', currentUser.member_id).eq('cycle_id', currentCycleId).neq('status', 'pending'),
            supabase.from('cycle_dues').select('due_amount, settled_amount').eq('member_id', currentUser.member_id).eq('to_cycle_id', currentCycleId).neq('status', 'settled')
        ]);

        // 2. CALCULATE CURRENT BALANCE
        const totalExp = expRes.data?.reduce((s, e) => s + parseFloat(e.amount), 0) || 0;
        const totalGlobalMeals = allMealsRes.data?.reduce((s, m) => s + (parseFloat(m.day_count) + parseFloat(m.night_count)), 0) || 1;
        const mealRate = totalExp / totalGlobalMeals;
        
        const myDeposit = myDepsRes.data?.reduce((s, d) => s + parseFloat(d.amount), 0) || 0;
        const myMealCost = (myMealsRes.data?.reduce((s, m) => s + (parseFloat(m.day_count) + parseFloat(m.night_count)), 0) || 0) * mealRate;
        
        // Use Math.ceil to avoid -0.01 issues
        const myBalance = Math.ceil(myDeposit - myMealCost);

        // 3. CALCULATE PREVIOUS DUE (Only negative amounts = Debt)
        const prevDebt = duesRes.data?.filter(d => d.due_amount < 0)
            .reduce((s, d) => s + (Math.abs(d.due_amount) - Math.abs(d.settled_amount)), 0) || 0;

        // 4. BUILD THE ROTATION QUEUE
        const newQueue = [];

      // CONDITION 1: Target
        const isToday = sessionDate.getDate() === today.getDate() && sessionDate.getMonth() === today.getMonth();
        newQueue.push({
            text: `TARGET: ${dateLabel} BAZAR`,
            class: isToday ? 'status-pending' : 'status-done'
        });

        // CONDITION 2 & 4: Add Current Debt Card if negative
        if (myBalance < -1) { 
             const debtAmount = toBn(Math.round(Math.abs(myBalance)));
              newQueue.push({
                text: `DEBT: -৳${debtAmount}`, // Added negative sign here
                class: 'status-debt'
            });
        }

        // CONDITION 3 & 4: Add Past Due Card if exists
         if (prevDebt > 1) {
            const pastDueAmount = toBn(Math.round(prevDebt));
            newQueue.push({
                text: `PAST DUE: -৳${pastDueAmount}`, // Added negative sign here
                class: 'status-due'
            });
        }

        // --- CRITICAL FIX: PREVENT ANIMATION RESET ---
        // We compare the new queue with the old one. If they are identical, 
        // we DO NOT reset the interval. This stops the "blink" issue.
        const currentQueueStr = JSON.stringify(statusQueue);
        const newQueueStr = JSON.stringify(newQueue);

        if (currentQueueStr === newQueueStr && statusCycleInterval) {
            return; // Nothing changed, let it keep rotating smoothly
        }

        // If data changed, update state and restart timer
        if (statusCycleInterval) clearInterval(statusCycleInterval);
        
        statusQueue = newQueue;
        currentStatusIndex = 0;

        // Apply first item immediately
        applyBadgeState(statusQueue[0]);

        // Start rotation only if we have 2+ items (Condition 2, 3, 4)
        if (statusQueue.length > 1) {
            statusCycleInterval = setInterval(rotateStatusBadge, 3000); // 3 Seconds
        }

    } catch (err) {
        console.error("Badge Sync Error:", err);
    }
}


function applyBadgeState(state) {
    const badge = document.getElementById('entryStatusBadge');
    badge.style.opacity = '1';
    badge.style.transform = 'translateY(0)';
    badge.textContent = state.text;
    badge.className = `entry-status-badge ${state.class}`;
}

function rotateStatusBadge() {
    const badge = document.getElementById('entryStatusBadge');
    if (!badge || statusQueue.length <= 1) return;

    // Transition Out
    badge.style.opacity = '0';
    badge.style.transform = 'translateY(-8px)';

    setTimeout(() => {
        currentStatusIndex = (currentStatusIndex + 1) % statusQueue.length;
        const state = statusQueue[currentStatusIndex];
        
        badge.textContent = state.text;
        badge.className = `entry-status-badge ${state.class}`;
        
        // Transition In
        badge.style.opacity = '1';
        badge.style.transform = 'translateY(0)';
    }, 600); // Duration of the "disappeared" state
}


async function loadSystemStatus() {
    const container = document.getElementById('systemStatusContent');
    const dateDisplay = document.getElementById('statusDateDisplay');
    
    // 1. Get Today's Date (Local/BD)
    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];
    const niceDate = now.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' });
    
    if(dateDisplay) dateDisplay.textContent = niceDate;

    try {
        // 2. Fetch Log for Today
        const { data: log, error } = await supabase
            .from('system_logs')
            .select('*')
            .eq('log_date', todayStr)
            .maybeSingle();

        // 3. Render State
        if (log) {
            // === STATE: SUCCESS ===
            const runTime = new Date(log.executed_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            container.innerHTML = `
                <div class="status-box success">
                    <div>
                        <div class="status-title">System Auto-Entry Completed, RUN TIME: ${runTime}</div>
                    </div>
                </div>
            `;
        } else {
            // === STATE: PENDING ===
            // Get target time from our config variable
            const targetTime24 = appConfig.auto_entry_time || '18:30';
            const [h, m] = targetTime24.split(':');
            const targetTime12 = new Date(0, 0, 0, h, m).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

            container.innerHTML = `
                <div class="status-box pending">
                    <div>
                        <div class="status-title">Waiting for Auto-Entry Meals are editable</div>
                        <div class="status-meta">
                            SCHEDULED TIME: ${targetTime12}
                        </div>
                    </div>
                </div>
            `;
        }

    } catch (err) {
        console.error("Status Load Error", err);
        container.innerHTML = '<div style="color:red; font-size:12px;">Failed to load status.</div>';
    }
}



// --- MOBILE MENU LOGIC ---
// --- UNIFIED MOBILE NAVIGATION & SIDEBAR LOGIC ---
// --- FIX: MOBILE SIDEBAR TRIGGER ---
const mobileMenuBtn = document.getElementById('mobileMenuBtn');
const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');

// Open Sidebar
if (mobileMenuBtn) {
    mobileMenuBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation(); // Stops click from bubbling up
        sidebar.classList.add('mobile-active');
        sidebarOverlay.classList.add('active');
    });
}

// Close Sidebar when clicking the overlay
if (sidebarOverlay) {
    sidebarOverlay.addEventListener('click', () => {
        sidebar.classList.remove('mobile-active');
        sidebarOverlay.classList.remove('active');
    });
}

// Update navigateToPage to handle the 7-item nav correctly
async function navigateToPage(pageName) {
    // 1. Safety check: If pageName is undefined (like when clicking the Menu button), stop.
    if (!pageName) return;

    // 2. Hide all pages
    document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
    
    // 3. Show target page
    const target = document.getElementById(pageName + 'Page');
    if (target) target.classList.remove('hidden');

    // 4. Update Active Classes on BOTH Navs
    document.querySelectorAll('.bottom-nav-link, .nav-link').forEach(link => {
        if (link.getAttribute('data-page') === pageName) {
            link.classList.add('active');
        } else {
            link.classList.remove('active');
        }
    });

    // 5. Load Data (Persistence Check)
    loadPageData(pageName);

    // 6. Auto-close sidebar on mobile after selecting a page
    if (window.innerWidth <= 768) {
        sidebar.classList.remove('mobile-active');
        sidebarOverlay.classList.remove('active');
    }
}

// 5. Ensure "Menu" button in bottom nav doesn't stay 'active' permanently 
// and that it actually highlights the current page on load
window.addEventListener('load', () => {
    const activePage = getActivePage() || 'dashboard';
    document.querySelectorAll('.bottom-nav-link').forEach(link => {
        if (link.getAttribute('data-page') === activePage) {
            link.classList.add('active');
        }
    });
});

// 2. Auto-close Sidebar when clicking a link
document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
            sidebar.classList.remove('mobile-active');
            const backdrop = document.getElementById('sidebarOverlay');
            if(backdrop) backdrop.classList.remove('active');
        }
    });
});



// ============================================
// CYCLE CLOSING & DUE MANAGEMENT
// ============================================
// ============================================
// REFINED CYCLE CLOSING LOGIC
// ============================================

const monthNames = ["January", "February", "March", "April", "May", "June", 
                    "July", "August", "September", "October", "November", "December"];

// 1. Open the Modal and Pre-fill
document.getElementById('closeMonthBtn').addEventListener('click', () => {
    const modal = document.getElementById('cycleCloseModal');
    const monthSelect = document.getElementById('newCycleMonth');
    const yearInput = document.getElementById('newCycleYear');
    
    // Populate Month Dropdown
    monthSelect.innerHTML = monthNames.map((m, i) => `<option value="${i}">${m}</option>`).join('');
    
    // Auto-select based on Old Cycle end date + 1 day
    const currentCycle = allCycles.find(c => c.id == currentCycleId);
    let targetDate = new Date();
    if (currentCycle) {
        targetDate = parseLocalDate(currentCycle.end_date);
        targetDate.setDate(targetDate.getDate() + 1);
    }
    
    monthSelect.value = targetDate.getMonth();
    yearInput.value = targetDate.getFullYear();
    
    updateCycleFields(); // Trigger first calculation
    modal.classList.add('active');
});

// 2. Helper to calculate dates when Month/Year changes
function updateCycleFields() {
    const month = parseInt(document.getElementById('newCycleMonth').value);
    const year = parseInt(document.getElementById('newCycleYear').value);
    
    // Calculate first and last day of selected month
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0); // Day 0 of next month is last day of this month
    
    // Format for inputs (YYYY-MM-DD)
    document.getElementById('newCycleStart').value = toLocalISO(firstDay);
    document.getElementById('newCycleEnd').value = toLocalISO(lastDay);
    document.getElementById('newCycleName').value = `${monthNames[month]} ${year}`;
}

// Attach change listeners
document.getElementById('newCycleMonth').addEventListener('change', updateCycleFields);
document.getElementById('newCycleYear').addEventListener('change', updateCycleFields);

// 3. Handle the Final Submission
document.getElementById('cycleCloseForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!confirm("Are you sure you want to close the current cycle and create the new one?")) return;

    const btn = e.target.querySelector('button[type="submit"]');
    btn.textContent = "Processing Balances...";
    btn.disabled = true;

    try {
        const name = document.getElementById('newCycleName').value;
        const start = document.getElementById('newCycleStart').value;
        const end = document.getElementById('newCycleEnd').value;

        // A. Calculate final balances of the cycle being closed
        const balances = await calculateMemberBalances(currentCycleId);
        const balancesWithDues = balances.filter(b => b.balance !== 0);

        // B. Deactivate current cycle
        const { error: deacError } = await supabase
            .from('cycles')
            .update({ is_active: false })
            .eq('id', currentCycleId);
        if (deacError) throw deacError;

        // C. Create new cycle
        const { data: newCycle, error: cycError } = await supabase
            .from('cycles')
            .insert({ name, start_date: start, end_date: end, is_active: true })
            .select().single();
        if (cycError) throw cycError;

        // D. Forward Dues (Debt/Credit)
        if (balancesWithDues.length > 0) {
            const dueRecords = balancesWithDues.map(b => ({
                from_cycle_id: currentCycleId,
                to_cycle_id: newCycle.id,
                member_id: b.member_id,
                due_amount: b.balance,
                status: 'pending',
                settled_amount: 0
            }));
            const { error: dueError } = await supabase.from('cycle_dues').insert(dueRecords);
            if (dueError) throw dueError;
        }

        // Success Cleanup
        await logActivity(`Admin finalized cycle and started "${name}" (${start} to ${end})`, 'other');
        showNotification("Cycle finalized successfully!", "success");
        location.reload(); // Hard refresh to reset all state

    } catch (err) {
        console.error(err);
        showNotification(err.message, "error");
        btn.textContent = "Confirm & Finalize";
        btn.disabled = false;
    }
});



// Helper: Calculate member balances for current cycle
async function calculateMemberBalances(cycleId) {
    try {
        // Fetch data
        const { data: meals } = await supabase.from('meals').select('*').eq('cycle_id', cycleId);
      // Find this part in calculateMemberBalances(cycleId)
const { data: expenses } = await supabase
    .from('expenses')
    .select('*')
    .eq('cycle_id', cycleId)
    .eq('status', 'approved'); // <--- ADD THIS FILTER
       // Change the deposit query to:
const { data: deposits } = await supabase
    .from('deposits')
    .select('*')
    .eq('cycle_id', cycleId)
    .neq('status', 'pending'); // <--- ADD THIS FILTER

        // Calculate meal rate
        const totalExpense = expenses?.reduce((sum, e) => sum + parseFloat(e.amount), 0) || 0;
        const totalMeals = meals?.reduce((sum, m) => sum + parseFloat(m.day_count) + parseFloat(m.night_count), 0) || 0;
        const mealRate = totalMeals > 0 ? totalExpense / totalMeals : 0;

        // Calculate per-member balances
        const balances = [];
        allMembers.forEach(member => {
            const memberMeals = meals?.filter(m => m.member_id === member.id)
                .reduce((sum, m) => sum + parseFloat(m.day_count) + parseFloat(m.night_count), 0) || 0;
            
            const memberDeposits = deposits?.filter(d => d.member_id === member.id)
                .reduce((sum, d) => sum + parseFloat(d.amount), 0) || 0;

            const memberCost = memberMeals * mealRate;
            const balance = memberDeposits - memberCost;

            balances.push({
                member_id: member.id,
                member_name: member.name,
                balance: parseFloat(balance.toFixed(2))
            });
        });

        return balances;

    } catch (err) {
        console.error("Balance calculation error:", err);
        throw err;
    }
}

// ============================================
// DUE SETTLEMENT UI
// ============================================

async function loadDueSettlement() {
    console.log("🔍 Loading due settlement for cycle:", currentCycleId);
    
    if (!currentCycleId) {
        console.warn("No cycle ID, skipping due settlement");
        return;
    }

    try {
        // Fetch dues for current cycle
        const { data: dues, error } = await supabase
            .from('cycle_dues')
            .select('*, members(name), from_cycle:cycles!cycle_dues_from_cycle_id_fkey(name)')
            .eq('to_cycle_id', currentCycleId)
            .order('due_amount', { ascending: true });

        console.log("📊 Dues data received:", dues);

        if (error) {
            console.error("❌ Error fetching dues:", error);
            throw error;
        }

        const card = document.getElementById('dueSettlementCard');
        
        if (!card) {
            console.error("❌ dueSettlementCard element not found in DOM!");
            return;
        }

        // Filter out fully settled
        const activeDues = dues?.filter(d => d.status !== 'settled') || [];

        // Show/hide card
        if (activeDues.length === 0) {
            console.log("✅ No active dues found, hiding card");
            card.style.display = 'none';
            return;
        }

        console.log(`✅ Found ${activeDues.length} active dues, showing card`);
        card.style.display = 'block';

        // Separate debtors and creditors
        const debtors = activeDues.filter(d => d.due_amount < 0);
        const creditors = activeDues.filter(d => d.due_amount > 0);

        console.log(`📉 Debtors: ${debtors.length}, 📈 Creditors: ${creditors.length}`);

        // Render Debtors
        const debtorsList = document.getElementById('debtorsList');
        if (debtors.length === 0) {
            debtorsList.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary);">No outstanding debts 🎉</div>';
        } else {
            debtorsList.innerHTML = debtors.map(d => renderDueItem(d, 'debtor')).join('');
        }

        // Render Creditors
        const creditorsList = document.getElementById('creditorsList');
        if (creditors.length === 0) {
            creditorsList.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary);">No pending credits</div>';
        } else {
            creditorsList.innerHTML = creditors.map(d => renderDueItem(d, 'creditor')).join('');
        }

    } catch (err) {
        console.error("❌ Due settlement load error:", err);
        showNotification("Failed to load due settlement: " + err.message, "error");
    }
}

function renderDueItem(due, type) {
    const absAmount = Math.abs(due.due_amount);
    const settled = Math.abs(due.settled_amount);
    const remaining = absAmount - settled;
    const progress = (settled / absAmount) * 100;

    const statusClass = due.status === 'pending' ? 'due-status-pending' : 
                       due.status === 'settling' ? 'due-status-settling' : 
                       'due-status-settled';

    return `
    <div class="due-item ${type}">
        <div class="due-item-header">
            <div class="due-item-name">${due.members.name}</div>
            <div class="due-item-amount ${type === 'debtor' ? 'balance-negative' : 'balance-positive'}">
                ${formatCurrency(remaining)}
            </div>
        </div>
        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 5px;">
            From: ${due.from_cycle.name} 
            <span class="due-status-badge ${statusClass}">${due.status}</span>
        </div>
        <div class="due-progress-bar">
            <div class="due-progress-fill" style="width: ${progress}%"></div>
        </div>
        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px;">
            Settled: ${formatCurrency(settled)} / ${formatCurrency(absAmount)} (${progress.toFixed(0)}%)
        </div>
    </div>
    `;
}

// Update loadSummary to include due settlement
const originalLoadSummary = loadSummary;
loadSummary = async function() {
    await originalLoadSummary();
    await loadDueSettlement();
};


async function checkGlobalBalanceWarning() {
    if (!currentUser || !currentUser.member_id || !currentCycleId) return;

    try {
        // 1. Fetch data needed for Meal Rate
        const { data: expenses } = await supabase.from('expenses')
            .select('amount').eq('cycle_id', currentCycleId).eq('status', 'approved');
        
        const { data: allMeals } = await supabase.from('meals')
            .select('day_count, night_count').eq('cycle_id', currentCycleId);

        // 2. Fetch User Specific data
        const { data: userMeals } = await supabase.from('meals')
            .select('day_count, night_count').eq('member_id', currentUser.member_id).eq('cycle_id', currentCycleId);
        
        const { data: userDeposits } = await supabase.from('deposits')
            .select('amount').eq('member_id', currentUser.member_id).eq('cycle_id', currentCycleId).neq('status', 'pending');

        // 3. Perform Calculations
        const totalExp = expenses?.reduce((sum, e) => sum + parseFloat(e.amount), 0) || 0;
        const totalGlobalMeals = allMeals?.reduce((sum, m) => sum + parseFloat(m.day_count) + parseFloat(m.night_count), 0) || 0;
        const mealRate = totalGlobalMeals > 0 ? totalExp / totalGlobalMeals : 0;

        const totalUserMeals = userMeals?.reduce((sum, m) => sum + parseFloat(m.day_count) + parseFloat(m.night_count), 0) || 0;
        const totalUserDeposit = userDeposits?.reduce((sum, d) => sum + parseFloat(d.amount), 0) || 0;
        
        const currentBalance = totalUserDeposit - (totalUserMeals * mealRate);

        // 4. Update Header UI
        const header = document.querySelector('.app-header');
        const nameDisplay = document.getElementById('headerUserName');

        if (currentBalance < 0) {
            header.classList.add('balance-warning');
            // Optional: Add a small warning icon next to the name
            if (!nameDisplay.innerHTML.includes('⚠️')) {
                nameDisplay.innerHTML = '⚠️ ' + nameDisplay.innerHTML;
            }
        } else {
            header.classList.remove('balance-warning');
            // Remove warning icon if balance is recovered
            nameDisplay.innerHTML = nameDisplay.innerHTML.replace('⚠️ ', '');
        }
    } catch (err) {
        console.error("Balance Warning Check Error:", err);
    }
}


// 2. Save logic (triggered on change)
async function saveDayMenu(dayIndex) {
    const night = document.getElementById(`night-${dayIndex}`).value;
    const day = document.getElementById(`day-${dayIndex}`).value;
    
    // Visual feedback: briefly highlight the inputs
    const inputs = [document.getElementById(`night-${dayIndex}`), document.getElementById(`day-${dayIndex}`)];
    
    try {
        const { error } = await supabase
            .from('weekly_menus')
            .update({ night_menu: night, day_menu: day })
            .eq('day_index', dayIndex);

        if (error) throw error;

        // Success: flash green border
        inputs.forEach(i => {
            i.style.borderColor = 'var(--success-color)';
            setTimeout(() => i.style.borderColor = '', 1000);
        });

        // Update dashboard if visible
        if (!document.getElementById('dashboardPage').classList.contains('hidden')) {
            updateDashboardMealPlan();
        }
    } catch (err) {
        // Error: flash red border
        inputs.forEach(i => {
            i.style.borderColor = 'var(--danger-color)';
            setTimeout(() => i.style.borderColor = '', 1000);
        });
        showNotification("Auto-save failed", "error");
    }
}


// --- Helper: Convert Date to Bengali Format ---
// Output: '১২ জানুয়ারি সোমবার'
function formatBengaliDate(dateObj) {
    const bnMonths = ["জানুয়ারি", "ফেব্রুয়ারি", "মার্চ", "এপ্রিল", "মে", "জুন", "জুলাই", "আগস্ট", "সেপ্টেম্বর", "অক্টোবর", "নভেম্বর", "ডিসেম্বর"];
    const bnDays = ["রবিবার", "সোমবার", "মঙ্গলবার", "বুধবার", "বৃহস্পতিবার", "শুক্রবার", "শনিবার"];
    
    const dayName = bnDays[dateObj.getDay()];
    const monthName = bnMonths[dateObj.getMonth()];
    const dateNum = toBn(dateObj.getDate()); // Uses your existing toBn helper

    return `${dateNum} ${monthName} ${dayName}`;
}

// --- Updated Function ---
async function updateDashboardMealPlan() {
    // 1. Calculate Dates
    const now = new Date();
    const todayStr = toLocalISO(now); // YYYY-MM-DD
    
    const tomorrow = new Date(now);
    tomorrow.setDate(now.getDate() + 1);
    const tomorrowStr = toLocalISO(tomorrow);

    try {
        // 2. Fetch Data (Menu, Defaults, Plans)
        const [menuRes, membersRes, plansRes] = await Promise.all([
            supabase.from('weekly_menus').select('*').eq('day_index', now.getDay()).maybeSingle(),
            supabase.from('members').select('id, default_day_on, default_night_on'),
            supabase.from('meal_plans').select('*').in('plan_date', [todayStr, tomorrowStr])
        ]);

        const members = membersRes.data || [];
        const plans = plansRes.data || [];
        const menu = menuRes.data;

        // 3. Calculate Totals
        let nightSum = 0; // Today Night
        let daySum = 0;   // Tomorrow Day

        members.forEach(m => {
            // Check for tonight's override
            const nPlan = plans.find(p => p.member_id === m.id && p.plan_date === todayStr);
            // Check for tomorrow morning's override
            const dPlan = plans.find(p => p.member_id === m.id && p.plan_date === tomorrowStr);

            nightSum += (nPlan ? Number(nPlan.night_count) : (m.default_night_on ? 1 : 0));
            daySum += (dPlan ? Number(dPlan.day_count) : (m.default_day_on ? 1 : 0));
        });

        // 4. Update Visuals
        
        // Dates (Using the new Bengali Formatter)
        document.getElementById('planNightDate').textContent = formatBengaliDate(now);
        document.getElementById('planDayDate').textContent = formatBengaliDate(tomorrow);

        // Counts (Using toBn for Bengali Digits)
        document.getElementById('planNightTotal').textContent = toBn(nightSum);
        document.getElementById('planDayTotal').textContent = toBn(daySum);

        // Menus
        if (menu) {
            document.getElementById('planNightMenu').textContent = menu.night_menu || "মেনু নেই";
            document.getElementById('planDayMenu').textContent = menu.day_menu || "মেনু নেই";
        }

    } catch (err) {
        console.error("Dashboard calculation failed:", err);
    }
}



// Cleanup intervals when page is hidden to prevent background processing
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        // Clear intervals when tab is inactive
        if (statusCycleInterval) {
            clearInterval(statusCycleInterval);
            statusCycleInterval = null;
        }
    } else {
        // Restart when tab becomes active
        updateEntryStatusIndicator();
        checkGlobalBalanceWarning();
    }
});

// Clear intervals on page unload
window.addEventListener('beforeunload', () => {
    if (statusCycleInterval) {
        clearInterval(statusCycleInterval);
    }
});



</script> 
</body>
</html>
