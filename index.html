<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MealCal 2.0</title>
   <style>
        /* =========================================
           1. THEME VARIABLES
           ========================================= */
        :root {
            --primary-color: #4F46E5;
            --primary-dark: #4338CA;
            --secondary-color: #10B981;
            --danger-color: #EF4444;
            --warning-color: #F59E0B;
            --bg-color: #F9FAFB;
            --card-bg: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --success-color: #10B981;
            
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            
            /* Dimensions */
            --header-height: 60px;
            --bottom-nav-height: 70px;
        }

        [data-theme="dark"] {
            --bg-color: #111827;
            --card-bg: #1F2937;
            --text-primary: #F9FAFB;
            --text-secondary: #9CA3AF;
            --border-color: #374151;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            /* Padding top to ensure content isn't hidden behind fixed header */
            padding-top: var(--header-height); 
        }

        /* =========================================
           2. LAYOUT CONTAINERS
           ========================================= */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Fixed Header */
        .app-header {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: var(--header-height);
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 900; 
            box-shadow: var(--shadow);
        }

        .header-left, .header-right { display: flex; align-items: center; gap: 10px; }
        
        .app-logo { font-weight: 800; font-size: 20px; color: var(--primary-color); }
        
        .cycle-badge {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }

        .user-info { text-align: right; line-height: 1.2; }
        .user-name { font-weight: 600; font-size: 13px; }
        .user-role { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }

        .header-clock {
            display: flex; flex-direction: column; align-items: center;
            font-variant-numeric: tabular-nums;
        }
        .clock-time { font-size: 16px; font-weight: 700; color: var(--text-primary); }
        .clock-date { font-size: 10px; color: var(--text-secondary); }

        /* =========================================
           3. SIDEBAR & NAVIGATION
           ========================================= */
        .sidebar {
            width: 260px;
            background-color: var(--card-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            position: fixed;
            top: var(--header-height);
            bottom: 0;
            z-index: 800;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .main-content {
            flex: 1;
            margin-left: 260px; /* Offset for sidebar */
            padding: 20px;
            width: 100%;
        }

        .nav-menu { list-style: none; }
        .nav-item { margin-bottom: 5px; }
        
        .nav-link {
            display: flex; align-items: center;
            padding: 10px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
            font-weight: 500;
        }
        .nav-link:hover, .nav-link.active { background-color: var(--primary-color); color: white; }
        .nav-icon { margin-right: 12px; font-size: 18px; }

        /* Mobile Bottom Nav */
        .bottom-nav {
            display: none; /* Hidden on Desktop */
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            height: var(--bottom-nav-height);
            z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .bottom-nav-list { display: flex; justify-content: space-around; list-style: none; height: 100%; }
        .bottom-nav-item { flex: 1; text-align: center; }
        
        .bottom-nav-link {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 10px;
            padding: 5px;
        }
        .bottom-nav-link span:first-child { font-size: 22px; margin-bottom: 2px; }
        .bottom-nav-link.active { color: var(--primary-color); }

        /* =========================================
           4. CARDS & GRID
           ========================================= */
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px;
        }
        .card-title { font-size: 16px; font-weight: 600; color: var(--text-primary); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .stat-label { font-size: 13px; opacity: 0.9; margin-bottom: 5px; }
        .stat-value { font-size: 24px; font-weight: 700; }

        /* =========================================
           5. FORMS & BUTTONS
           ========================================= */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-size: 14px;
            /* Fix for iOS zooming on input focus */
            appearance: none; 
        }
        .form-textarea { min-height: 80px; resize: vertical; }

        .btn {
            padding: 10px 16px;
            border: none; border-radius: 8px;
            font-size: 14px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
            display: inline-flex; align-items: center; justify-content: center;
            gap: 5px;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-secondary { background-color: #e5e7eb; color: var(--text-primary); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        /* =========================================
           6. NOTIFICATIONS & MODALS
           ========================================= */
        .notif-btn { background: none; border: none; font-size: 22px; position: relative; padding: 5px; cursor: pointer; }
        .notif-badge {
            position: absolute; top: 0; right: 0;
            background-color: var(--danger-color); color: white;
            font-size: 9px; width: 14px; height: 14px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }

        .notif-panel {
            position: fixed;
            top: var(--header-height);
            right: -400px; /* Hidden */
            width: 350px;
            height: calc(100vh - var(--header-height));
            background-color: var(--card-bg);
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            z-index: 1100; /* Above bottom nav */
            transition: right 0.3s ease;
            display: flex; flex-direction: column;
        }
        .notif-panel.active { right: 0; }
        
        .notif-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .notif-list { flex: 1; overflow-y: auto; padding: 10px; }
        .notif-item {
            padding: 10px; border-radius: 8px; background-color: var(--bg-color);
            margin-bottom: 8px; border-left: 4px solid transparent; cursor: pointer;
        }
        .notif-item.type-deposit { border-left-color: var(--success-color); }
        .notif-item.type-expense { border-left-color: var(--danger-color); }
        .notif-item.type-meal { border-left-color: var(--warning-color); }

        .notif-filters { display: flex; gap: 5px; padding: 10px; overflow-x: auto; border-bottom: 1px solid var(--border-color); }
        .filter-chip {
            padding: 4px 10px; border-radius: 15px; font-size: 11px;
            border: 1px solid var(--border-color); background: var(--card-bg); white-space: nowrap;
        }
        .filter-chip.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }

        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center; justify-content: center;
            padding: 20px;
        }
        .modal.active { display: flex; }
        
        .modal-content {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            width: 100%; max-width: 450px;
            max-height: 90vh; overflow-y: auto;
            position: relative;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-modal { font-size: 24px; padding: 5px; cursor: pointer; color: var(--text-secondary); }

        /* =========================================
           7. TABLES, LISTS & SPECIAL COMPONENTS
           ========================================= */
        .list-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .list-item:last-child { border-bottom: none; }
        .list-item-title { font-weight: 600; font-size: 14px; }
        .list-item-subtitle { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        .list-item-amount { font-weight: 700; font-size: 14px; }

        .balance-positive { color: var(--success-color); }
        .balance-negative { color: var(--danger-color); }

        /* Scheduler Horizontal Scroll */
        .scheduler-container { margin-top: 15px; }
        .scheduler-scroll {
            display: flex; overflow-x: auto; gap: 10px; padding: 5px 2px;
            -webkit-overflow-scrolling: touch; /* Smooth iOS scroll */
            scrollbar-width: none;
        }
        .scheduler-card {
            min-width: 120px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .scheduler-card.is-today { border: 2px solid var(--primary-color); background-color: rgba(79, 70, 229, 0.05); }
        .sched-btn {
            width: 100%; padding: 6px; border-radius: 6px; border: 1px solid var(--border-color);
            background: var(--bg-color); font-size: 11px; cursor: pointer;
        }
        .sched-btn.active { background-color: var(--success-color); color: white; border-color: var(--success-color); }

        /* Matrix Table */
        .matrix-wrapper {
            overflow: auto; max-height: 70vh;
            border: 1px solid var(--border-color); border-radius: 8px;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }
        .matrix-table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 12px; }
        .matrix-table th, .matrix-table td {
            padding: 0;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            min-width: 70px; height: 36px;
            text-align: center;
        }
        /* Sticky Headers */
        .matrix-table thead th { position: sticky; top: 0; background-color: var(--card-bg); z-index: 10; padding: 8px; }
        .matrix-table tbody td:first-child {
            position: sticky; left: 0; background-color: var(--bg-color);
            z-index: 5; border-right: 2px solid var(--border-color); padding: 4px;
        }
        .matrix-table thead th:first-child { left: 0; z-index: 20; background-color: var(--card-bg); }

        /* Matrix Cell Split */
        .cell-split { display: flex; width: 100%; height: 100%; }
        .cell-val {
            flex: 1; display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 700;
        }
        .cell-val.day-col { border-right: 1px solid var(--border-color); }
        .cell-val.active { background-color: rgba(16, 185, 129, 0.15); color: var(--success-color); }
        .cell-val.zero { color: #d1d5db; font-weight: 400; }

        /* Split View (Deposits) */
        .split-view-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .history-box { max-height: 400px; overflow-y: auto; background: var(--bg-color); padding: 10px; border-radius: 8px; }

        /* Toast */
        #toast-container {
            position: fixed; top: 10px; right: 20px; z-index: 3000;
            display: flex; flex-direction: column; gap: 10px; pointer-events: none;
        }
        .toast {
            pointer-events: auto; background: var(--card-bg); padding: 12px 16px;
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid var(--primary-color); display: flex; align-items: center; gap: 10px;
            min-width: 280px; animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* Status Badges & Box */
        .entry-status-badge { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 10px; text-transform: uppercase; }
        .status-pending { background: #FFF7ED; color: #C2410C; border: 1px solid #FED7AA; }
        .status-done { background: #ECFDF5; color: #047857; border: 1px solid #6EE7B7; }

        .status-box { padding: 15px; border-radius: 8px; display: flex; gap: 15px; }
        .status-box.success { background: #ECFDF5; border: 1px solid #6EE7B7; color: #065F46; }
        .status-box.pending { background: #FFF7ED; border: 1px solid #FED7AA; color: #9A3412; }
        
        /* Status Toggle Buttons (Summary Page) */
        .status-btn { padding: 4px 10px; border-radius: 15px; border:1px solid #ccc; cursor:pointer; font-size:10px; width:50px; }
        .status-btn.on { background: var(--success-color); color:white; border-color: var(--success-color); }
        .status-btn.off { background: var(--bg-color); color: var(--text-secondary); }

        /* Auth Page */
        .auth-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .auth-card { background: var(--card-bg); width: 100%; max-width: 400px; padding: 40px; border-radius: 12px; box-shadow: var(--shadow-lg); }

        /* Utils */
        .hidden { display: none !important; }
        .loading { text-align: center; padding: 20px; color: var(--text-secondary); font-size: 12px; }
        
        /* Profile Defaults */
        .defaults-container { background: var(--bg-color); padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;}
        .def-btn { padding: 4px 8px; font-size: 10px; border: 1px solid var(--border-color); background: var(--card-bg); border-radius: 4px; cursor: pointer; }
        .def-btn.active { background: var(--primary-color); color: white; }



        /* Due Settlement Styles */
.due-item {
    padding: 12px;
    background: var(--bg-color);
    border-radius: 8px;
    margin-bottom: 10px;
    border-left: 4px solid transparent;
}

.due-item.debtor {
    border-left-color: var(--danger-color);
}

.due-item.creditor {
    border-left-color: var(--success-color);
}

.due-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.due-item-name {
    font-weight: 700;
    font-size: 14px;
}

.due-item-amount {
    font-weight: 700;
    font-size: 16px;
}

.due-progress-bar {
    width: 100%;
    height: 6px;
    background: var(--border-color);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 8px;
}

.due-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success-color), var(--primary-color));
    transition: width 0.3s ease;
}

.due-status-badge {
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 8px;
    text-transform: uppercase;
    font-weight: 700;
}

.due-status-pending {
    background: #FEE2E2;
    color: #B91C1C;
}

.due-status-settling {
    background: #FEF3C7;
    color: #92400E;
}

.due-status-settled {
    background: #D1FAE5;
    color: #065F46;
}

/* Mobile responsive for due cards */
@media (max-width: 768px) {
    #dueSettlementCard > div[style*="grid"] {
        grid-template-columns: 1fr !important;
    }
}


    /* =========================================
           7. MOBILE RESPONSIVENESS (CRITICAL)
           ========================================= */
        @media (max-width: 768px) {
            /* 1. LAYOUT & SIDEBAR AS DRAWER */
            .main-content { margin-left: 0; padding: 15px; padding-bottom: 90px; }
            .bottom-nav { display: block; }
            
            .sidebar {
                transform: translateX(-100%);
                width: 280px; height: 100vh; top: 0; left: 0;
                z-index: 2500; box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            }
            .sidebar.mobile-active { transform: translateX(0); }

            /* 2. HEADER TWEAKS */
            .user-info { display: none; } /* Hide Name */
            .user-role { display: none; }
            .header-clock { 
                display: flex !important; /* Show clock container */
                align-items: flex-end; 
            }
            .clock-time, .clock-date { display: none; } /* Hide time text */
            
            #entryStatusBadge { margin: 0; font-size: 9px; padding: 3px 6px; } /* Only show Badge */

            /* 3. TOAST NOTIFICATION FIX */
            #toast-container {
                top: 70px; /* Below Header */
                left: 50%; transform: translateX(-50%); /* Center */
                width: 90%; max-width: 350px;
                right: auto;
            }
            .toast {
                width: 100%; min-width: auto;
                font-size: 12px; padding: 8px 12px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            }

            /* 4. CONTENT ADJUSTMENTS */
            .stats-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            .stat-value { font-size: 18px; }
            .split-view-container { grid-template-columns: 1fr; } /* Stack deposits */
            .notif-panel { width: 100%; right: -100%; }

            /* 5. INPUT FIX */
            .form-input, .form-select { font-size: 16px; } /* Prevents zoom */
        }


        /* Enhanced Transaction Log Styles */
.log-item {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.2s;
}

.log-item:hover { background-color: rgba(0,0,0,0.02); }

.log-main { display: flex; align-items: center; gap: 15px; }

.log-icon {
    width: 40px; height: 40px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
}

.log-icon.deposit { background: #EEF2FF; color: #4F46E5; }
.log-icon.settlement { background: #F3F4F6; color: #6B7280; }
.log-icon.charge { background: #FEF2F2; color: #EF4444; }

.log-details { display: flex; flex-direction: column; }

.log-member { 
    font-weight: 800; 
    font-size: 15px; 
    color: var(--text-primary); 
    display: flex; 
    align-items: center; 
    gap: 8px;
}

.log-type-tag {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.tag-deposit { background: #DBEAFE; color: #1E40AF; }
.tag-settle { background: #F3F4F6; color: #374151; }

.log-meta { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }

.log-amount-area { text-align: right; }

.log-amount { font-family: 'Courier New', monospace; font-weight: 900; font-size: 16px; }

/* Arrow indicator for settlements */
.transfer-info {
    font-size: 11px;
    color: var(--primary-color);
    background: #F5F3FF;
    padding: 2px 8px;
    border-radius: 12px;
    margin-top: 4px;
    display: inline-block;
}
    </style>

      <script>
        window.supabaseLoadError = false;
        function handleSupabaseLoadError() {
            console.error('Failed to load Supabase script');
            const notification = document.getElementById('login-notification');
            if (notification) {
                notification.innerHTML = '<p class="error">Failed to load Supabase. Please check your internet connection and try again later.</p>';
            }
            const loader = document.getElementById('loader');
            if (loader) loader.classList.add('hidden');
        }
        </script>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js" onerror="window.supabaseLoadError = true; handleSupabaseLoadError();"></script>
        <script>
        if (window.supabaseLoadError) {
            document.write('<script src="lib/supabase.min.js"><\/script>');
            console.warn('Loaded local Supabase script as fallback');
        }
        </script>
</head>
<body>
   <!-- Auth Page (Updated for Supabase Auth) -->
<div id="authPage" class="auth-container">
    <div class="auth-card">
        <h1 class="auth-title">MealCal 2.0</h1>
        
        <!-- Login Mode -->
       <form id="authForm">
    <div id="authError" style="color: red; font-size: 12px; margin-bottom: 10px; text-align: center; display: none;"></div>
    
    <!-- Username Field (Hidden by default, shown for Sign Up) -->
    <div class="form-group hidden" id="usernameField">
       <label for="authUsername" class="form-label">Username (Unique)</label>
        <input type="text" id="authUsername" class="form-input" placeholder="e.g. mess_hero_01">
    </div>

<div class="form-group">
   <label for="authEmail" class="form-label">Email or Username</label>
    <div style="display: flex; gap: 5px;">
        <!-- The text input (takes up available space) -->
        <input type="text" id="authEmail" class="form-input" placeholder="Type or select..." required style="flex: 1;">
        
        <!-- The dropdown (takes up necessary space) -->
        <select id="authUserDropdown" class="form-select" style="width: auto; max-width: 40%; font-size: 12px; cursor: pointer;">
            <option value="">Select User ‚ñº</option>
        </select>
    </div>
</div>
    
    <div class="form-group">
     <label for="authPassword" class="form-label">Password</label>
        <input type="password" id="authPassword" class="form-input" placeholder="Enter password" required>
    </div>

    <button type="submit" class="btn btn-primary" style="width: 100%;" id="authBtn">Login</button>
    
    <div style="margin-top: 15px; text-align: center; font-size: 13px;">
        <span id="authToggleText">Don't have an account?</span>
        <a href="#" id="authToggleBtn" style="color: var(--primary-color); font-weight: 600;">Sign Up</a>
    </div>
</form>
    </div>
</div>
    <!-- Main App -->
    <div id="mainApp" class="app-container hidden">

           <!-- FIXED HEADER -->
    <header class="app-header">
        <div class="header-left">
            <div class="app-logo">MealCal 2.0</div>
            <div class="cycle-badge" id="headerCycleName">Loading...</div>
        </div>

   <div class="header-clock">
            <div class="clock-time" id="clockTime">00:00:00</div>
            <div class="clock-date" id="clockDate">Mon, 01 Jan</div>
            <!-- NEW INDICATOR -->
            <div id="entryStatusBadge" class="entry-status-badge status-pending">Loading...</div>
        </div>

        <div class="header-right">
            <div class="user-info">
                <div class="user-name" id="headerUserName">User</div>
                <div class="user-role" id="headerUserRole">Role</div>
            </div>
            <button class="notif-btn" id="notifBellBtn">
                üîî
                <span class="notif-badge hidden" id="notifBadge">0</span>
            </button>
        </div>
    </header>

    <!-- NOTIFICATION PANEL -->
    <div class="notif-panel" id="notifPanel">
        <div class="notif-header">
            <h3>Notifications</h3>
            <button class="close-modal" id="closeNotifPanel">√ó</button>
        </div>
        <div class="notif-filters">
            <button class="filter-chip active" data-filter="all">All</button>
            <button class="filter-chip" data-filter="deposit">Deposits üí∞</button>
            <button class="filter-chip" data-filter="expense">Expenses üõí</button>
            <button class="filter-chip" data-filter="meal">Meals üçΩÔ∏è</button>
            <button class="filter-chip" data-filter="other">System ‚öôÔ∏è</button>
        </div>
        <div class="notif-list" id="notifListContainer">
            <div class="loading">Loading...</div>
        </div>
    </div>


        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">

            <div class="cycle-selector">
                <select id="cycleSelect" class="form-select">
                    <option value="">Loading cycles...</option>
                </select>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-page="dashboard">
                        <span class="nav-icon">üìä</span>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="profile">
                        <span class="nav-icon">üë§</span>
                        Profile
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="tracker">
                        <span class="nav-icon">üìÖ</span>
                        Meal Tracker
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="summary">
                        <span class="nav-icon">üìà</span>
                        Summary
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="expenses">
                        <span class="nav-icon">üõí</span>
                        Expenses
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="deposits">
                        <span class="nav-icon">üí∞</span>
                        Deposits
                    </a>
                </li>
                <li class="nav-item" id="adminMenuItem" style="display: none;">
                    <a class="nav-link" data-page="admin">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        Admin Panel
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="logoutBtn">
                        <span class="nav-icon">üö™</span>
                        Logout
                    </a>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page-content">
                <h2 style="margin-bottom: 20px;">Dashboard</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Meal Rate</div>
                        <div class="stat-value" id="statMealRate">‡ß≥0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #10B981, #059669);">
                        <div class="stat-label">Total Meals</div>
                        <div class="stat-value" id="statTotalMeals">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #F59E0B, #D97706);">
                        <div class="stat-label">Total Deposit</div>
                        <div class="stat-value" id="statTotalDeposit">‡ß≥0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #EF4444, #DC2626);">
                        <div class="stat-label">Total Expense</div>
                        <div class="stat-value" id="statTotalExpense">‡ß≥0</div>
                    </div>
                </div>

                <!-- NEW: System Status Card -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Daily Automation Status</h3>
        <div id="statusDateDisplay" style="font-size:12px; color:var(--text-secondary);"></div>
    </div>
    <div id="systemStatusContent">
        <div class="loading">Checking system logs...</div>
    </div>
</div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Activity</h3>
                    </div>
                    <div id="recentActivity">
                        <div class="loading">Loading activity...</div>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profilePage" class="page-content hidden">
                <h2 style="margin-bottom: 20px;">My Profile</h2>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title" id="profileName">Loading...</h3>
                    </div>


                    
                    <div class="stats-grid">
                        <div class="stat-card" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED);">
                            <div class="stat-label">My Total Meals</div>
                            <div class="stat-value" id="profileTotalMeals">0</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #10B981, #059669);">
                            <div class="stat-label">My Deposits</div>
                            <div class="stat-value" id="profileTotalDeposit">‡ß≥0</div>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #F59E0B, #D97706);">
                            <div class="stat-label">My Balance</div>
                            <div class="stat-value" id="profileBalance">‡ß≥0</div>
                        </div>
                    </div>

                    <h4 style="margin: 20px 0 10px;">Today's Meal Status</h4>

                    
                   <!-- Inside Profile Page -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">My Meal Schedule</h3>
        <div style="font-size: 11px; color: var(--text-secondary);" id="lockTimeDisplay">
            Lock Time: Loading...
        </div>
    </div>
    

      <!-- NEW: Default/Permanent Settings -->
    <div class="defaults-container">
        <div class="defaults-label">
            Set Default State
            <div style="font-weight:400; font-size:10px; margin-top:2px;">
                New schedule cards will auto-set to this.
            </div>
        </div>
        <div class="defaults-toggles">
            <button id="defDayBtn" class="def-btn" onclick="toggleDefaultPreference('day')">Day Default</button>
            <button id="defNightBtn" class="def-btn" onclick="toggleDefaultPreference('night')">Night Default</button>
        </div>
    </div>


    <!-- 7 Day Scrolling Container -->
    <div class="scheduler-container">
        <div class="scheduler-scroll" id="schedulerList">
            <div class="loading">Loading schedule...</div>
        </div>
    </div>
    
    <div style="margin-top: 15px; font-size: 11px; color: var(--warning-color); text-align: center;">
        ‚ö†Ô∏è Note: Meals are locked daily after bazar time.
    </div>
</div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">My Deposit History</h3>
                    </div>
                    <div id="profileDepositHistory">
                        <div class="loading">Loading deposits...</div>
                    </div>
                </div>
            </div>

<!-- Tracker Page -->
<div id="trackerPage" class="page-content hidden">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>Master Meal Tracker</h2>
        <button class="btn btn-primary btn-sm" onclick="loadMasterTracker()">üîÑ Refresh</button>
    </div>

    <div class="card">
        <div class="matrix-wrapper">
            <table class="matrix-table" id="masterMatrixTable">
                <thead>
                    <!-- Headers injected by JS -->
                </thead>
                <tbody>
                    <!-- Rows injected by JS -->
                </tbody>
            </table>
        </div>
<div style="margin-top: 10px; font-size: 11px; color: var(--text-secondary); text-align: center;">
    Format: <strong>[ Night üåô | Next Day üåû ]</strong> <br>
    Row Date indicates the Night meal.
</div>
    </div>
</div>

   <!-- Summary Page -->
<div id="summaryPage" class="page-content hidden">
    <h2 style="margin-bottom: 20px;">Summary Report</h2>
    
    <!-- Main Summary Table -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Member Summary</h3>
            <button class="btn btn-primary btn-sm" id="exportSummaryBtn">Export</button>
        </div>
        <div class="table-container">
            <table class="table" id="summaryTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Day Meals</th>
                        <th>Night Meals</th>
                        <th>Total Meals</th>
                        <th>Total Cost</th>
                        <th>Deposits</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody id="summaryTableBody">
                    <tr><td colspan="7" class="loading">Loading summary...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- NEW: Due Settlement Card -->
    <div class="card" id="dueSettlementCard" style="display: none;">
        <div class="card-header">
            <h3 class="card-title">üí≥ Cycle Due Settlement Tracker</h3>
            <button class="btn btn-sm btn-secondary" onclick="loadDueSettlement()">üîÑ Refresh</button>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
            <!-- Left: Debtors -->
            <div>
                <h4 style="font-size: 14px; color: var(--danger-color); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">
                    üìâ Outstanding Debts
                </h4>
                <div id="debtorsList" style="max-height: 400px; overflow-y: auto;">
                    <div class="loading">Loading debtors...</div>
                </div>
            </div>

            <!-- Right: Creditors -->
            <div>
                <h4 style="font-size: 14px; color: var(--success-color); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">
                    üìà Awaiting Settlement
                </h4>
                <div id="creditorsList" style="max-height: 400px; overflow-y: auto;">
                    <div class="loading">Loading creditors...</div>
                </div>
            </div>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: var(--bg-color); border-radius: 8px; font-size: 12px; color: var(--text-secondary);">
            <strong>How it works:</strong> When a debtor deposits money, it automatically settles with creditors in order. Progress bars show settlement status.
        </div>
    </div>
</div>

            <!-- Expenses Page -->
            <div id="expensesPage" class="page-content hidden">
                <h2 style="margin-bottom: 20px;">Expenses</h2>
                
                <div class="card" id="addExpenseCard">
                    <div class="card-header">
                        <h3 class="card-title">Add Expense</h3>
                    </div>
                    <form id="expenseForm">
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" id="expenseDate" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Shopper</label>
                            <select id="expenseMember" class="form-select" required>
                                <option value="">Select shopper...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea id="expenseDescription" class="form-textarea" placeholder="e.g., Chicken, Rice, Oil"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Amount (‡ß≥)</label>
                          <!-- Change step to 1 -->
<input type="number" id="expenseAmount" class="form-input" step="1" required 
       oninput="this.value = Math.round(this.value)">
                        </div>
                        <button type="submit" class="btn btn-primary">Add Expense</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Expense List</h3>
                    </div>
                    <div id="expenseList">
                        <div class="loading">Loading expenses...</div>
                    </div>
                </div>
            </div>
<!-- Deposits Page -->
<div id="depositsPage" class="page-content hidden">
    <h2 style="margin-bottom: 20px;">Deposits & Charges</h2>
    
    <!-- Consolidated Pending Approvals Section -->
    <div id="pendingDepositsCard" class="card" style="display: none; border-left: 5px solid var(--warning-color);">
        <div class="card-header">
            <h3 class="card-title">‚è≥ Pending Deposit Requests</h3>
        </div>
        <div id="pendingDepositList">
            <!-- JavaScript will inject items here -->
        </div>
    </div>

    <!-- Split View: Form + Specific History -->
    <div class="split-view-container" id="depositSplitView">
        
        <!-- LEFT: Transaction Form -->
        <div class="card" id="addDepositCard" style="height: fit-content;">
            <div class="card-header">
                <h3 class="card-title">New Transaction</h3>
            </div>
            <form id="depositForm">
                <div class="form-group">
                    <label class="form-label">Member</label>
                    <!-- Added onchange event here -->
                    <select id="depositMember" class="form-select" onchange="loadSelectedMemberHistory(this.value)" required>
                        <option value="">Select member...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Transaction Type</label>
                    <!-- Added onchange event here -->
                    <select id="depositType" class="form-select" onchange="autoUpdateDepositLabel()">
                        <option value="deposit">üí∞ Add Deposit (Credit)</option>
                        <option value="charge">üîª Deduct Charge (Debit)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Label (Editable)</label>
                    <input type="text" id="depositLabel" class="form-input" value="Deposit" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Amount (‡ß≥)</label>
                   <!-- Change step to 1 -->
<input type="number" id="depositAmount" class="form-input" step="1" min="0" required 
       oninput="this.value = Math.round(this.value)">
                </div>

                <div class="form-group">
                    <label class="form-label">Notes (Optional)</label>
                    <textarea id="depositNotes" class="form-textarea" style="min-height: 60px;"></textarea>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Submit Transaction</button>
            </form>
        </div>

        <!-- RIGHT: Selected Member History -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Member History</h3>
                <span id="historyMemberName" style="font-size: 12px; color: var(--primary-color);">No member selected</span>
            </div>
            <div id="selectedMemberHistoryList" class="history-box">
                <div class="history-empty">Select a member to view their specific log.</div>
            </div>
        </div>
    </div>

<!-- BOTTOM: Global Log with Filter -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Global Transaction Log</h3>
        
        <!-- NEW: Filter Dropdown -->
        <select id="depositLogFilter" class="form-select" style="width: 150px; font-size: 12px; padding: 6px;" onchange="loadDeposits()">
            <option value="">All Members</option>
            <!-- Options will be populated by JS -->
        </select>
    </div>
    <div id="depositList">
        <div class="loading">Loading deposits...</div>
    </div>
</div>
</div>

            <!-- Admin Page -->
            <div id="adminPage" class="page-content hidden">
                <h2 style="margin-bottom: 20px;">Admin Panel</h2>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Cycle Management</h3>
                    </div>


                    <form id="createCycleForm">
                        <div class="form-group">
                            <label class="form-label">Cycle Name</label>
                            <input type="text" id="cycleName" class="form-input" placeholder="e.g., April 2025" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Start Date</label>
                            <input type="date" id="cycleStartDate" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date</label>
                            <input type="date" id="cycleEndDate" class="form-input" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Create Cycle</button>
                    </form>

                    <!-- Inside Admin Page, replace closeMonthBtn div -->
<div class="form-group" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border-color);">
    <label class="form-label" style="color: var(--danger-color); font-size: 16px;">
        ‚ö†Ô∏è Danger Zone: Close Current Cycle
    </label>
    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">
        This will finalize the current cycle, calculate balances, and create a new cycle with automatic due forwarding.
    </p>
    <button type="button" class="btn btn-danger" id="closeMonthBtn" style="width: 100%;">
        üîí Close Current Cycle & Create New
    </button>
</div>



                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Member Management</h3>
                        <div style="font-size:12px; color:var(--text-secondary);">Adding a member automatically creates a user with password "123"</div>
                    </div>
                    <form id="addMemberForm">
                        <div class="form-group">
                            <label class="form-label">Member Name</label>
                            <input type="text" id="memberName" class="form-input" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Member</button>
                    </form>
                    <div id="membersList" style="margin-top: 20px;">
                        <div class="loading">Loading members...</div>
                    </div>
                </div>


                <!-- Inside Admin Page, add this card -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">System Settings</h3>
    </div>
  <form id="adminSettingsForm">
        <div class="form-group">
            <label class="form-label">Restricted Bazar Range (Lock Time)</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div style="flex:1">
                    <label for="settingLockTime" style="font-size: 11px;">Start Time</label>
                    <input type="time" id="settingLockTime" class="form-input" required>
                </div>
                <div style="font-weight:bold;">-</div>
                <div style="flex:1">
                    <label style="font-size: 11px;">End Time</label>
                    <input type="time" id="settingLockTimeEnd" class="form-input" required>
                </div>
            </div>
            <small style="color: var(--text-secondary); display:block; margin-top:5px;">
                Users cannot change meal status between these times on the day of the bazar.
            </small>
        </div>
        <button type="submit" class="btn btn-primary">Save Settings</button>
    </form>

    <!-- Inside adminSettingsForm -->
       <!-- Inside adminSettingsForm -->
<div class="form-group" style="margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 15px;">
    <label class="form-label">Auto-Entry / Finalize Time</label>
    <div style="display:flex; gap:10px; align-items:flex-end;">
        <input type="time" id="settingAutoTime" class="form-input" style="flex:1;" required>
        
        <!-- NEW BUTTON -->
        <button type="button" class="btn btn-danger" onclick="triggerManualAutoEntry()" style="font-size:12px; white-space:nowrap;">
            ‚ö° Force Run Now
        </button>
    </div>
    <small style="color: var(--primary-color);">
        System will snapshot meals at this time. Use "Force Run" to apply plans to tracker immediately.
    </small>
</div>

</div>

            </div>
        </main>

       <!-- MOBILE BOTTOM NAV -->
<nav class="bottom-nav">
    <ul class="bottom-nav-list">
        <!-- 1. Home -->
        <li class="bottom-nav-item">
            <a class="bottom-nav-link active" data-page="dashboard">
                <span>üìä</span>Home
            </a>
        </li>
        <!-- 2. Tracker -->
        <li class="bottom-nav-item">
            <a class="bottom-nav-link" data-page="tracker">
                <span>üìÖ</span>Tracker
            </a>
        </li>
        <!-- 3. Add Expense (Quick Access) -->
        <li class="bottom-nav-item">
            <a class="bottom-nav-link" data-page="expenses">
                <span>üõí</span>Exp
            </a>
        </li>
        <!-- 4. Wallet -->
        <li class="bottom-nav-item">
            <a class="bottom-nav-link" data-page="deposits">
                <span>üí∞</span>Wallet
            </a>
        </li>
        <!-- 5. MENU (Triggers Sidebar) -->
        <li class="bottom-nav-item">
            <a class="bottom-nav-link" id="mobileMenuBtn" href="#">
                <span>‚ò∞</span>Menu
            </a>
        </li>
    </ul>
</nav>

<!-- Sidebar Overlay (Must be added right after body tag or before sidebar) -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Modals -->
<!-- Edit Meal Modal (Session Edition) -->
<div id="mealModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="mealModalTitle">Edit Session</h3>
            <span class="close-modal" onclick="closeMealModal()">√ó</span>
        </div>
        <form id="mealForm">
            <!-- Hidden Fields store the TWO dates we are editing -->
            <input type="hidden" id="mealMemberId">
            <input type="hidden" id="mealDateSession"> <!-- For Night -->
            <input type="hidden" id="mealDateNext">    <!-- For Day -->

<div class="form-group">
                <label class="form-label" id="mealNightLabel">Night Meal</label>
                <!-- Added min="0", step="1" and oninput logic -->
                <input type="number" id="mealNightCount" class="form-input" step="1" min="0" 
                       oninput="this.value = !!this.value && Math.abs(this.value) >= 0 ? Math.abs(Math.round(this.value)) : null">
            </div>

            <div class="form-group">
                <label class="form-label" id="mealDayLabel">Day Meal</label>
                <!-- Added min="0", step="1" and oninput logic -->
                <input type="number" id="mealDayCount" class="form-input" step="1" min="0" 
                       oninput="this.value = !!this.value && Math.abs(this.value) >= 0 ? Math.abs(Math.round(this.value)) : null">
            </div>
            
            <div style="font-size:11px; color:var(--text-secondary); margin-bottom:15px; background:var(--bg-color); padding:8px; border-radius:6px;">
                ‚ÑπÔ∏è This updates the <strong>Night</strong> meal of the Bazar Date and the <strong>Day</strong> meal of the following morning.
            </div>

            <button type="submit" class="btn btn-primary" style="width:100%;">Save Session</button>
        </form>
    </div>
</div>

<!-- Edit Member Modal -->
<div id="editMemberModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit Member</h3>
            <span class="close-modal" onclick="document.getElementById('editMemberModal').classList.remove('active')">√ó</span>
        </div>
        <form id="editMemberForm">
            <input type="hidden" id="editMemberId">
            <input type="hidden" id="editUserId">
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" id="editMemberName" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">New Password (leave blank to keep current)</label>
                <input type="password" id="editMemberPassword" class="form-input" placeholder="New password...">
            </div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
    </div>
</div>


<!-- Toast Notification Container -->
<div id="toast-container"></div>


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>


    const SUPABASE_URL = 'https://bcardtccxcnktkkeszpp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJjYXJkdGNjeGNua3Rra2VzenBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NzU1NDIsImV4cCI6MjA4MDE1MTU0Mn0.xGxk81ThPGtyQgRCNoOxpvxsnXBUAzgmclrS0ru7g2Q';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================
    // STATE MANAGEMENT
    // ============================================

    let currentCycleId = null;
    let allMembers = [];
    let allCycles = [];


    // ============================================
// NEW SUPABASE AUTHENTICATION LOGIC
// ============================================

let isLoginMode = true; // Toggle between Login and Signup

// 1. Initialize Auth State Listener (Runs automatically on load)
async function initAuth() {
    // Check if user is already logged in
    const { data: { session } } = await supabase.auth.getSession();
    
    if (session) {
        await handleUserSession(session.user);
    } else {
        document.getElementById('authPage').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
    }

    // Listen for changes (Login, Logout, Auto-refresh)
    supabase.auth.onAuthStateChange(async (_event, session) => {
        if (session) {
            await handleUserSession(session.user);
        } else {
            currentUser = null;
            document.getElementById('authPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }
    });
}

// 2. Fetch Member Profile based on Login ID
async function handleUserSession(user) {
    try {
        // Fetch the profile linked to this Login ID
        let { data: member, error } = await supabase
            .from('members')
            .select('*')
            .eq('user_id', user.id)
             .maybeSingle();  

        if (member) {
            // Success: User is linked to a Member
            currentUser = { 
                ...user, 
                member_id: member.id,
                name: member.name, 
                role: member.role || 'user' // Read role from DB!
            };
        } else {
            // Unlinked User (Just signed up, not connected yet)
            console.log("User not linked to member profile");
            currentUser = { 
                ...user, 
                role: 'guest',
                name: user.email 
            };
        }

        // Redirect logic
        showApp();
        
        // Show/Hide Admin Tab based on REAL role
        if (currentUser.role === 'admin' || currentUser.role === 'manager') {
            document.getElementById('adminMenuItem').style.display = 'block';
        } else {
            document.getElementById('adminMenuItem').style.display = 'none';
        }

    } catch (err) {
        console.error("Session handling error:", err);
    }
}

// 3. Handle Form Submit (Login / Signup)
// --- NEW AUTH LOGIC (Supports Username) ---

// 1. Toggle Login / Sign Up UI
document.getElementById('authToggleBtn').addEventListener('click', (e) => {
    e.preventDefault();
    isLoginMode = !isLoginMode;
    
    const title = isLoginMode ? 'Login' : 'Sign Up';
    const linkText = isLoginMode ? 'Sign Up' : 'Login';
    const infoText = isLoginMode ? "Don't have an account?" : "Already have an account?";
    const emailLabel = isLoginMode ? "Email or Username" : "Email";

    // Show/Hide Username field
    if (isLoginMode) {
        document.getElementById('usernameField').classList.add('hidden');
        document.getElementById('authUsername').removeAttribute('required');
    } else {
        document.getElementById('usernameField').classList.remove('hidden');
        document.getElementById('authUsername').setAttribute('required', 'true');
    }
    
    document.getElementById('emailLabel').textContent = emailLabel;
    document.getElementById('authBtn').textContent = title;
    document.getElementById('authToggleBtn').textContent = linkText;
    document.getElementById('authToggleText').textContent = infoText;
});

// 2. Handle Submission (Improved with better debugging)
document.getElementById('authForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('authBtn');
    const originalText = btn.textContent;
    const emailOrUser = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPassword').value;
    const username = document.getElementById('authUsername').value.trim();
    const errorDiv = document.getElementById('authError');
    
    errorDiv.style.display = 'none';
    btn.textContent = 'Verifying...';
    btn.disabled = true;

    try {
        if (isLoginMode) {
            let finalEmail = emailOrUser;
            if (!emailOrUser.includes('@')) {
                const { data, error } = await supabase.from('members').select('email').eq('name', emailOrUser).maybeSingle();
                if (error || !data || !data.email) throw new Error("Username not found.");
                finalEmail = data.email;
            }
            const { data, error } = await supabase.auth.signInWithPassword({ email: finalEmail, password: password });
            if (error) throw error;
            await handleUserSession(data.user);
        } else {
            const { data, error } = await supabase.auth.signUp({
                email: emailOrUser,
                password: password,
                options: { data: { username: username } }
            });
            if (error) throw error;
            alert("Account created! Please log in.");
            document.getElementById('authToggleBtn').click();
        }
    } catch (err) {
        errorDiv.textContent = err.message;
        errorDiv.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
});

// 5. Update Logout
document.getElementById('logoutBtn').addEventListener('click', async () => {
    await supabase.auth.signOut();
    // onAuthStateChange will handle the UI update
});



// Function to populate the login dropdown
async function loadLoginUserDropdown() {
    const dropdown = document.getElementById('authUserDropdown');
    
    // We fetch from 'members' because it's usually public/readable even before login
    // assuming member names match usernames as per your logic
    try {
        const { data, error } = await supabase
            .from('members')
            .select('name')
            .order('name');

        if (error) throw error;

        // Clear and repopulate
        dropdown.innerHTML = '<option value="">Select User ‚ñº</option>';
        
        data.forEach(member => {
            const option = document.createElement('option');
            option.value = member.name;
            option.textContent = member.name;
            dropdown.appendChild(option);
        });

        // Add listener to auto-fill the input
        dropdown.addEventListener('change', (e) => {
            if (e.target.value) {
                document.getElementById('authEmail').value = e.target.value;
            }
        });

    } catch (err) {
        console.error("Error loading user dropdown:", err);
        // If error (e.g., RLS policy prevents reading), just hide the dropdown
        dropdown.style.display = 'none';
    }
}

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    
    // Simple hash function (for password hashing - in production use bcrypt)
    async function hashPassword(password) {
        const msgBuffer = new TextEncoder().encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function formatCurrency(amount) {
         return `‡ß≥${parseFloat(amount || 0).toFixed(2)}`;
    }

// This function handles both the name 'formatDate' and adds the Time
function formatDate(dateString) {
    if (!dateString) return "-";
    const date = new Date(dateString);
    
    // Formats to: 02 Jan ‚Ä¢ 10:30 AM
    return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }) + 
           ' ‚Ä¢ ' + 
           date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
}

// Optional: Keep this as an alias in case you already changed some calls
const formatDateTime = formatDate;


  function showNotification(message, type = 'info') {
    const container = document.getElementById('toast-container');
    
    // Create Toast Element
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    // Determine Icon
    let icon = '‚ÑπÔ∏è';
    if (type === 'success') icon = '‚úÖ';
    if (type === 'error') icon = '‚ùå';
    if (type === 'warning') icon = '‚ö†Ô∏è';

    // Set Content
    toast.innerHTML = `
        <div class="toast-icon">${icon}</div>
        <div class="toast-msg">${message}</div>
    `;

    // Add to DOM
    container.appendChild(toast);

    // Click to dismiss immediately
    toast.addEventListener('click', () => {
        removeToast(toast);
    });

    // Auto dismiss after 3 seconds
    setTimeout(() => {
        removeToast(toast);
    }, 2000);
}
function removeToast(toastElement) {
    toastElement.classList.add('hide');
    // Force removal after CSS transition time (300ms)
    setTimeout(() => {
        if (toastElement.parentNode) toastElement.remove();
    }, 300);
}

    // ============================================
    // AUTHENTICATION
    // ============================================
    


    document.getElementById('logoutBtn').addEventListener('click', () => {
        currentUser = null;
        localStorage.removeItem('mealcal_user');
        hideApp();
    });

    function showApp() {
        document.getElementById('authPage').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        
        // Show admin menu if user is admin
        if (currentUser.role === 'admin' || currentUser.role === 'manager') {
            document.getElementById('adminMenuItem').style.display = 'block';
        } else {
            document.getElementById('adminMenuItem').style.display = 'none';
        }
        
        initializeApp();
    }

    function hideApp() {
        document.getElementById('authPage').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('loginForm').reset();
        initLoginPage(); // Reload dropdown
    }

    // Check for saved session
// Check for saved session & Load Dropdown
window.addEventListener('DOMContentLoaded', () => {
    // Start the new Auth System
    initAuth();
    
    // NEW: Load the users into the login dropdown
    loadLoginUserDropdown(); 
});
// ==========================================
// EXPENSE APPROVAL HANDLER (GLOBAL)
// ==========================================

// Explicitly attach to 'window' to ensure HTML buttons can find it
window.handleExpenseApproval = async function(expenseId, newStatus) {
    console.log("Click triggered:", expenseId, newStatus); // Debugging check

    // Visual feedback on the button immediately
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = "...";
    btn.disabled = true;

    try {
        // 1. Update Database
        const { error } = await supabase
            .from('expenses')
            .update({ status: newStatus })
            .eq('id', expenseId);

        if (error) throw error;

        // 2. Fetch details for Logging (Optional, but good for history)
        const { data: expense } = await supabase
            .from('expenses')
            .select('description, amount, members(name)')
            .eq('id', expenseId)
            .maybeSingle();

        // 3. Log Activity
        const actor = currentUser.members ? currentUser.members.name : "Admin";
        const actionLabel = newStatus === 'approved' ? 'APPROVED' : 'REJECTED';
        
        await logActivity(
            `Expense ${actionLabel}: ${expense.description} (${formatCurrency(expense.amount)}) - Action by ${actor}`, 
            'expense'
        );

        // 4. Refresh List
        await loadExpenses();
        showNotification(`Expense ${newStatus} successfully`, 'success');

    } catch (err) {
        console.error('Approval Error:', err);
        showNotification(`Failed to ${newStatus} expense: ${err.message}`, 'error');
        
        // Revert button state on error
        btn.textContent = originalText;
        btn.disabled = false;
    }
};


window.handleDepositApproval = async function(depositId) {
    if (!confirm("Approve this deposit? This will apply the balance and trigger due settlements.")) return;
    
    const btn = event.target;
    btn.disabled = true;

    try {
        // 1. Get the pending deposit details
        const { data: dep, error: fetchErr } = await supabase
            .from('deposits')
            .select('*')
            .eq('id', depositId)
            .single();
        
        if (fetchErr) throw fetchErr;

        // 2. Delete the pending record (to avoid duplicates, or update status)
        // We update status to 'approved' and THEN run settlement logic
        const { error: updateErr } = await supabase
            .from('deposits')
            .update({ status: 'approved' })
            .eq('id', depositId);
        
        if (updateErr) throw updateErr;

        // 3. Run the Settlement Logic (Crucial!)
        // Since it's already in the DB as 'approved' now, we just need to 
        // trigger the settlement portion of your existing logic.
        // We reuse your client-side settlement function but modify it slightly 
        // OR just call it. For simplicity, we manually run the settlement part:
        
        await logActivity(`Deposit Approved: ${formatCurrency(dep.amount)} for member ID ${dep.member_id}`, 'deposit');
        
        // Refresh page - the settlement logic should ideally be a separate function 
        // but for now, we will re-run the "Approved" flow
        showNotification("Deposit Approved!", "success");
        refreshCurrentPage();

    } catch (err) {
        console.error(err);
        showNotification("Approval failed", "error");
    }
};

window.handleDepositRejection = async function(depositId) {
    if (!confirm("Reject and delete this request?")) return;

    try {
        const { error } = await supabase.from('deposits').delete().eq('id', depositId);
        if (error) throw error;
        showNotification("Request Rejected", "warning");
        refreshCurrentPage();
    } catch (err) {
        showNotification("Error", "error");
    }
};


window.handleDepositAction = async function(depositId, action) {
    console.log(`Action: ${action} triggered for ID: ${depositId}`);
    
    // Disable the button to prevent double-clicks
    const btn = event.target;
    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = "...";

    try {
        if (action === 'approve') {
            // 1. Fetch the data of the pending request
            const { data: dep, error: fError } = await supabase
                .from('deposits')
                .select('*')
                .eq('id', depositId)
                .single();

            if (fError || !dep) {
                console.error("Fetch Error:", fError);
                throw new Error("Could not find the pending request.");
            }

            console.log("Pending data found. Attempting to delete request row...");

            // 2. DELETE the pending record FIRST. 
            // If this fails, we stop (prevents duplicates).
            const { error: delError } = await supabase
                .from('deposits')
                .delete()
                .eq('id', depositId);
            
            if (delError) {
                console.error("Delete Error:", delError);
                throw new Error("Permission denied or database error during deletion.");
            }

            console.log("Pending request deleted. Now processing official settlement...");

            // 3. Process the NEW official deposit
            // We pass status: 'approved' explicitly to ensure it hits the history filter
            await processDepositWithClientSideSettlement(
                dep.member_id, 
                dep.cycle_id, 
                dep.amount, 
                dep.label || 'Deposit', 
                dep.notes
            );
            
            showNotification("Request Approved", "success");

        } else if (action === 'reject') {
            const { error: delError } = await supabase
                .from('deposits')
                .delete()
                .eq('id', depositId);
            
            if (delError) throw delError;
            showNotification("Request Rejected", "warning");
        }
        
        // 4. Force UI update
        console.log("Refreshing UI...");
        await loadDeposits(); 
        if (typeof loadDashboard === 'function') loadDashboard();

    } catch (err) {
        console.error("CRITICAL ERROR in handleDepositAction:", err.message);
        showNotification(err.message, "error");
        btn.disabled = false;
        btn.textContent = originalText;
    }
};

async function initializeApp() {
    try {
        // Load sequentially to prevent network congestion
        await loadCycles();
        await loadAppConfig();
        await loadMembers();

        initHeader();
        initNotifications();
        setupRobustRealtime(); 

        updateEntryStatusIndicator();
        setInterval(updateEntryStatusIndicator, 60000); 

        navigateToPage('dashboard');
    } catch (err) {
        console.error("Critical Init Error:", err);
    }
}

    function loadPageData(pageName) {
        switch(pageName) {
            case 'dashboard':
                loadDashboard();
                break;
            case 'profile':
                loadProfile();
                loadScheduler(); // <--- NEW CALL
                break;
            case 'tracker':
                loadTracker();
                  loadMasterTracker(); // <--- NEW CALL
                break;
            case 'summary':
                loadSummary();
                break;
            case 'expenses':
                loadExpenses();
                break;
            case 'deposits':
                loadDeposits();
                break;
            case 'admin':
                loadAdmin();
                break;
        }
    }

    // Add Handler for Admin Settings Form
document.getElementById('adminSettingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const start = document.getElementById('settingLockTime').value;
    const end = document.getElementById('settingLockTimeEnd').value;
    const autoTime = document.getElementById('settingAutoTime').value;
    
    const btn = e.target.querySelector('button[type="submit"]');
    btn.textContent = "Saving...";
    btn.disabled = true;

    try {
        const { error } = await supabase.from('app_config').upsert([
            { key_name: 'lock_time_start', value_text: start },
            { key_name: 'lock_time_end', value_text: end },
            { key_name: 'auto_entry_time', value_text: autoTime }
        ], { onConflict: 'key_name' });

        if (error) throw error;

        appConfig.lock_time_start = start;
        appConfig.lock_time_end = end;
        appConfig.auto_entry_time = autoTime;
        
        const actor = currentUser.members ? currentUser.members.name : "Admin";
        // LOG SETTINGS CHANGE
        await logActivity(`System Config: Bazar lock times and auto-entry schedule were updated by ${actor}`, 'other');

        showNotification("Settings saved successfully!", "success");
        loadScheduler();
    } catch (err) {
        showNotification("Failed to save settings", "error");
    } finally {
        btn.textContent = "Save Settings";
        btn.disabled = false;
    }
});



// Centralized Logic for "Active Session Date"
// Ensures consistency across Profile, Summary, and Dashboard
// Centralized Logic for "Active Session Date" (Timezone Safe)
async function getActiveSessionDate() {
    const today = new Date();
    
    // FORCE LOCAL DATE STRING (YYYY-MM-DD)
    // using components avoids UTC conversion issues at midnight
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const todayStr = `${year}-${month}-${day}`; // "2025-12-16" strictly local

    try {
        // Check System Log for LOCALLY calculated Today
        const { data: log } = await supabase
            .from('system_logs')
            .select('id')
            .eq('log_date', todayStr)
            .maybeSingle();

        let sessionDate = new Date(today);

        // Logic:
        // If log found for Today -> Today is done -> Target Tomorrow
        // If no log for Today -> Today is active -> Target Today
        if (log) {
            sessionDate.setDate(today.getDate() + 1);
        }

        return sessionDate;
    } catch (err) {
        console.error("Date Logic Error", err);
        return new Date(); 
    }
}

// Global Config
let appConfig = {
    lock_time_start: '17:00',
    lock_time_end: '19:00',
    auto_entry_time: '18:30' // Default
};

async function loadAppConfig() {
    try {
        const { data, error } = await supabase.from('app_config').select('*');
        if (data) {
            data.forEach(item => {
                appConfig[item.key_name] = item.value_text;
            });
        }
        
        // Update Admin UI inputs
        const startInput = document.getElementById('settingLockTime');
        const endInput = document.getElementById('settingLockTimeEnd');
        if(startInput) startInput.value = appConfig.lock_time_start;
        if(endInput) endInput.value = appConfig.lock_time_end;


        const autoInput = document.getElementById('settingAutoTime');
    if(autoInput) autoInput.value = appConfig.auto_entry_time;

        
        // Update Profile Display
        const lockDisplay = document.getElementById('lockTimeDisplay');
        if(lockDisplay) {
            lockDisplay.textContent = `Restricted: ${convertTo12Hour(appConfig.lock_time_start)} - ${convertTo12Hour(appConfig.lock_time_end)}`;
        }
        
    } catch (err) {
        console.error("Config Load Error", err);
    }
}

// Admin Form Saver
// Admin Form Saver
document.getElementById('adminSettingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // 1. Get Values
    const start = document.getElementById('settingLockTime').value;
    const end = document.getElementById('settingLockTimeEnd').value;
    const autoTime = document.getElementById('settingAutoTime').value; // <--- Make sure this ID exists in HTML
    
    const btn = e.target.querySelector('button[type="submit"]');
    btn.textContent = "Saving...";
    btn.disabled = true;

    try {
        // 2. Upsert All 3 Settings
        const { error } = await supabase.from('app_config').upsert([
            { key_name: 'lock_time_start', value_text: start },
            { key_name: 'lock_time_end', value_text: end },
            { key_name: 'auto_entry_time', value_text: autoTime } // <--- CRITICAL FIX
        ], { onConflict: 'key_name' });

        if (error) throw error;

        // 3. Update Local Config State
        appConfig.lock_time_start = start;
        appConfig.lock_time_end = end;
        appConfig.auto_entry_time = autoTime;
        
        // 4. Update UI
        const lockDisplay = document.getElementById('lockTimeDisplay');
        if(lockDisplay) lockDisplay.textContent = `Restricted: ${convertTo12Hour(start)} - ${convertTo12Hour(end)}`;
        
        showNotification("Settings saved successfully!", "success");
        loadScheduler(); // Refresh UI locks

    } catch (err) {
        console.error("Save Error", err);
        showNotification("Failed to save settings", "error");
    } finally {
        btn.textContent = "Save Settings";
        btn.disabled = false;
    }
});
// Helper: Convert 17:00 to 5:00 PM
function convertTo12Hour(timeStr) {
    if(!timeStr) return "";
    const [hour, min] = timeStr.split(':');
    const h = parseInt(hour);
    const ampm = h >= 12 ? 'PM' : 'AM';
    const h12 = h % 12 || 12;
    return `${h12}:${min} ${ampm}`;
}


/**
 * Checks if a specific meal slot is locked based on Bazar Time.
 * Logic: A "Bazar Session" locks Today's Night and Tomorrow's Day.
 */
function isMealLocked(dateString, mealType) {
    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];

    // 1. Determine "Session Date" (The date the Bazar happens)
    // Night Meal (e.g. 8th Night) -> Bazar is 8th.
    // Day Meal (e.g. 9th Day) -> Bazar is 8th (Previous Day).
    
    let sessionDateStr = dateString;
    if (mealType === 'day') {
        const d = new Date(dateString);
        d.setDate(d.getDate() - 1); // Subtract 1 day
        sessionDateStr = d.toISOString().split('T')[0];
    }

    // 2. Past Session Logic
    // If the bazar day is in the past, it's definitely locked (History).
    if (sessionDateStr < todayStr) return true;

    // 3. Future Session Logic
    // If bazar is tomorrow or later, it's Open.
    if (sessionDateStr > todayStr) return false;

    // 4. TODAY'S Session Logic (sessionDateStr === todayStr)
    // We are on the day of the Bazar. Check the Time Range.
    
    // Parse Config Times
    const [sH, sM] = appConfig.lock_time_start.split(':').map(Number);
    const [eH, eM] = appConfig.lock_time_end.split(':').map(Number);
    
    const startTime = new Date();
    startTime.setHours(sH, sM, 0, 0);
    
    const endTime = new Date();
    endTime.setHours(eH, eM, 0, 0); // e.g., 19:00:00

    // Range Logic: Locked ONLY if Start <= Now <= End
    if (now >= startTime && now <= endTime) {
        return true; // Locked inside range
    }

    return false; // Open before 5pm, Open after 7pm
}


async function loadScheduler() {
    if (!currentUser.member_id || !currentCycleId) return;
    
    const container = document.getElementById('schedulerList');
    container.innerHTML = '<div class="loading">Loading schedule...</div>';

    try {
        // 1. Fetch Member Defaults
        const { data: memberData } = await supabase
            .from('members')
            .select('*')
            .eq('id', currentUser.member_id)
            .maybeSingle();

        if (memberData) updateDefaultButtons(memberData);
        
        const defDay = memberData?.default_day_on || false;
        const defNight = memberData?.default_night_on || false;

        // 2. Calculate Dates (8 Days range)
        const startDate = await getActiveSessionDate();
        const dates = [];
        for(let i=0; i<=8; i++) { 
            const d = new Date(startDate);
            d.setDate(startDate.getDate() + i); 
            dates.push(d.toLocaleDateString('en-CA'));
        }

        // 3. Fetch Existing Plans from DB
        const { data: plans } = await supabase
            .from('meal_plans')
            .select('*')
            .eq('member_id', currentUser.member_id)
            .in('plan_date', dates);

        const planMap = {};
        plans?.forEach(p => planMap[p.plan_date] = p);

        // --- REMOVED: The old "Auto-Upsert" logic that was causing the freeze ---

        // 4. Render Cards
        container.innerHTML = '';
        const fmt = (dStr) => {
            const d = new Date(dStr);
            return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
        };

        for (let i = 0; i < 7; i++) {
            // These variables are defined INSIDE the loop
            const dateSession = dates[i];
            const dateNextDay = dates[i+1];
            
            const sessionLabel = fmt(dateSession);
            const nextDayLabel = fmt(dateNextDay);
            const isFirstCard = (i === 0);
            
            // LOGIC: Use DB value if it exists, otherwise use Member Defaults
            const nightActive = planMap[dateSession] ? planMap[dateSession].night_count > 0 : defNight;
            const dayActive = planMap[dateNextDay] ? planMap[dateNextDay].day_count > 0 : defDay;

            const card = document.createElement('div');
            card.className = `scheduler-card ${isFirstCard ? 'is-today' : ''}`;
            card.style.minWidth = "160px";
            
            card.innerHTML = `
                <div class="scheduler-date" style="font-size:10px; color:var(--text-secondary); text-transform:uppercase;">
                    ${isFirstCard ? 'Active Session' : 'Upcoming'} <br>
                    <span style="color:var(--primary-color); font-weight:700; font-size:14px;">
                        ${sessionLabel} <span style="background:var(--primary-color); color:white; padding:1px 4px; border-radius:4px; font-size:9px; vertical-align:middle;">BAZAR</span>
                    </span>
                </div>
                
                <div style="display:flex; flex-direction:column; gap:8px; width:100%;">
                    <!-- Night Plan Button -->
                    <button class="sched-btn ${nightActive ? 'active' : ''}" 
                        onclick="toggleSchedulerPlan('${dateSession}', 'night', this)">
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <span style="font-size:14px;">üåô</span> 
                            <div style="text-align:right;">
                                <div style="font-weight:700;">Night</div>
                                <div style="font-size:9px; opacity:0.8;">${sessionLabel} (Bazar)</div>
                            </div>
                        </div>
                    </button>
                    
                    <!-- Day Plan Button -->
                    <button class="sched-btn ${dayActive ? 'active' : ''}" 
                        onclick="toggleSchedulerPlan('${dateNextDay}', 'day', this)">
                         <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <span style="font-size:14px;">üåû</span> 
                            <div style="text-align:right;">
                                <div style="font-weight:700;">Day</div>
                                <div style="font-size:9px; opacity:0.8; color:${dayActive ? '#fff' : '#d97706'}">${nextDayLabel} (Next)</div>
                            </div>
                        </div>
                    </button>
                </div>
            `;
            container.appendChild(card);
        }
    } catch (err) {
        console.error("Scheduler Error:", err);
        container.innerHTML = '<div class="loading" style="color:red">Error loading schedule</div>';
    }
}
// Function triggered by clicking scheduler buttons
async function toggleSchedulerPlan(date, type, btnElement) {
    const wasActive = btnElement.classList.contains('active');
    if (wasActive) btnElement.classList.remove('active');
    else btnElement.classList.add('active');

    const newCount = wasActive ? 0 : 1;

    try {
        const { data: existing } = await supabase
            .from('meal_plans')
            .select('*')
            .eq('member_id', currentUser.member_id)
            .eq('plan_date', date)
            .maybeSingle();

        let updateData = {
            member_id: currentUser.member_id,
            plan_date: date,
            day_count: existing ? existing.day_count : 0,
            night_count: existing ? existing.night_count : 0
        };

        if (type === 'day') updateData.day_count = newCount;
        else updateData.night_count = newCount;

        const { error } = await supabase.from('meal_plans').upsert(updateData, { onConflict: 'member_id, plan_date' });
        if (error) throw error;

        // LOG INDIVIDUAL MEAL TOGGLE
        const actor = currentUser.members ? currentUser.members.name : "User";
        await logActivity(`${actor} updated their ${type} plan for ${new Date(date).toLocaleDateString('en-GB')} to ${newCount > 0 ? 'ON' : 'OFF'}`, 'meal');

    } catch (err) {
        console.error("Plan update failed", err);
        showNotification("Failed to save plan", "error");
        if (wasActive) btnElement.classList.add('active');
        else btnElement.classList.remove('active');
    }
}

 async function loadMasterTracker() {
    if (!currentCycleId) return;
    
    const tableHead = document.querySelector('#masterMatrixTable thead');
    const tableBody = document.querySelector('#masterMatrixTable tbody');
    if (!tableHead || !tableBody) return;

    tableBody.innerHTML = '<tr><td colspan="100" class="loading">Loading session matrix...</td></tr>';

    try {
        const cycle = allCycles.find(c => c.id == currentCycleId);
        if (!cycle) return;

        // Fetch data in one go
        const { data: meals } = await supabase.from('meals').select('*').eq('cycle_id', currentCycleId);

        const matrixData = {};
        meals?.forEach(m => {
            if (!matrixData[m.meal_date]) matrixData[m.meal_date] = {};
            matrixData[m.meal_date][m.member_id] = { d: m.day_count, n: m.night_count };
        });

        // 1. Build Header String
        let headerHTML = '<tr><th style="min-width: 90px; z-index:20;">Session Date</th>';
        allMembers.forEach(m => {
            headerHTML += `<th>${m.name.split(' ')[0]}</th>`; 
        });
        headerHTML += '</tr>';
        tableHead.innerHTML = headerHTML;

        // 2. Build Body String (Build the whole thing in memory first)
        let bodyHTML = '';
        let currentIter = new Date(cycle.start_date + 'T00:00:00');
        let endIter = new Date(cycle.end_date + 'T00:00:00');
        const todayStr = new Date().toISOString().split('T')[0];

        while (currentIter <= endIter) {
            const dateSessionStr = currentIter.toISOString().split('T')[0];
            const dNext = new Date(currentIter);
            dNext.setDate(currentIter.getDate() + 1);
            const dateNextStr = dNext.toISOString().split('T')[0];
            const isToday = (dateSessionStr === todayStr);

            bodyHTML += `<tr ${isToday ? 'style="background: rgba(79, 70, 229, 0.08);"' : ''}>
                <td style="font-weight:600; font-size:11px;">
                    ${currentIter.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })}
                </td>`;

            allMembers.forEach(m => {
                const nVal = matrixData[dateSessionStr]?.[m.id]?.n || 0;
                const dVal = matrixData[dateNextStr]?.[m.id]?.d || 0;
                
                bodyHTML += `
                    <td>
                        <div class="cell-split">
                            <div class="cell-val ${nVal > 0 ? 'active' : 'zero'}" 
                                 onclick="openMealModal('${m.id}', '${dateSessionStr}', ${nVal}, ${dVal})">
                                 ${nVal > 0 ? nVal : '-'}
                            </div>
                            <div class="cell-val ${dVal > 0 ? 'active' : 'zero'}" 
                                 onclick="openMealModal('${m.id}', '${dateSessionStr}', ${nVal}, ${dVal})">
                                 ${dVal > 0 ? dVal : '-'}
                            </div>
                        </div>
                    </td>`;
            });
            bodyHTML += '</tr>';
            currentIter.setDate(currentIter.getDate() + 1);
        }

        // ONE SINGLE DOM UPDATE (prevents freezing)
        tableBody.innerHTML = bodyHTML;

    } catch (err) {
        tableBody.innerHTML = '<tr><td colspan="100">Error loading matrix.</td></tr>';
    }
}
function initHeader() {
    // 1. Set User Info
    if (currentUser) {
        // Use member name if available, else username from auth
        const displayName = currentUser.members ? currentUser.members.name : (currentUser.user_metadata?.username || "User");
        const role = currentUser.role || 'user';
        
        // Update header with format: Name (ROLE)
        document.getElementById('headerUserName').textContent = `${displayName} (${role.toUpperCase()})`;
        
        // Clear the secondary role line since it's now combined
        document.getElementById('headerUserRole').textContent = "";
    }

    // 2. Start Clock
    updateClock();
    setInterval(updateClock, 1000);

    // 3. Update Cycle Name Badge
    const cycleSelect = document.getElementById('cycleSelect');
    if (cycleSelect.options[cycleSelect.selectedIndex]) {
        document.getElementById('headerCycleName').textContent = cycleSelect.options[cycleSelect.selectedIndex].text;
    }
}
function updateClock() {
    const now = new Date();
    
    // Time
    const timeString = now.toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' });
    document.getElementById('clockTime').textContent = timeString;

    // Date
    const dateString = now.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });
    document.getElementById('clockDate').textContent = dateString;
}


// ============================================
// NOTIFICATION LOGIC (FIXED)
// ============================================

let allNotifications = [];
let currentNotifFilter = 'all';

function initNotifications() {
    // 1. Attach Bell Click Listener
    const bellBtn = document.getElementById('notifBellBtn');
    const panel = document.getElementById('notifPanel');
    const closeBtn = document.getElementById('closeNotifPanel');

    // Remove old listeners to prevent duplicates (cloning trick)
    const newBell = bellBtn.cloneNode(true);
    bellBtn.parentNode.replaceChild(newBell, bellBtn);
    
    const newClose = closeBtn.cloneNode(true);
    closeBtn.parentNode.replaceChild(newClose, closeBtn);

    // Re-attach listeners
// Inside initNotifications() ...

    document.getElementById('notifBellBtn').addEventListener('click', (e) => {
        e.stopPropagation(); // Stop click from bubbling

        // 1. LOG & FORCE REFRESH (Bypassing Cooldown)
        console.log("üîÑ Refreshing view: NOTIFICATIONS");
        
        // Show loading state briefly in the list if you want, or just fetch
        const container = document.getElementById('notifListContainer');
        if(container.innerHTML.trim() === '') container.innerHTML = '<div class="loading">Syncing...</div>';
        
        loadNotifications().then(() => {
            console.log("‚úÖ Notifications Synced");
        });

        // 2. TOGGLE UI
        document.getElementById('notifPanel').classList.toggle('active');
        
        // 3. CLEAR BADGE
        document.getElementById('notifBadge').classList.add('hidden');
        // Reset badge count logic if you track it in a variable
        document.getElementById('notifBadge').textContent = '0';
    });

    document.getElementById('closeNotifPanel').addEventListener('click', () => {
        document.getElementById('notifPanel').classList.remove('active');
    });

    // 2. Filter Clicks
    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', (e) => {
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            e.target.classList.add('active');
            currentNotifFilter = e.target.getAttribute('data-filter');
            renderNotifications();
        });
    });

    // 3. Close panel when clicking outside
    document.addEventListener('click', (e) => {
        const p = document.getElementById('notifPanel');
        const b = document.getElementById('notifBellBtn');
        if (p.classList.contains('active') && !p.contains(e.target) && !b.contains(e.target)) {
            p.classList.remove('active');
        }
    });

    // 4. Start Loading
    loadNotifications();
}

async function loadNotifications() {
    if (!currentCycleId) return;

    try {
        const targetCycleId = parseInt(currentCycleId);
        console.log("üîî Fetching notifications for cycle:", targetCycleId);

        const { data, error } = await supabase
            .from('notifications')
            .select(`
                id, 
                message, 
                type, 
                created_at, 
                member_id,
                members (
                    name, 
                    role
                )
            `)
            .eq('cycle_id', targetCycleId)
            .order('created_at', { ascending: false })
            .limit(50);

        if (error) throw error;

        allNotifications = data || [];
        console.log("‚úÖ Notifications loaded:", allNotifications.length);
        renderNotifications();
        
    } catch (err) {
        console.error('‚ùå Notification Fetch Error:', err);
        const container = document.getElementById('notifListContainer');
        if(container) container.innerHTML = `<div class="loading" style="color:red">Failed to load history.</div>`;
    }
}

function renderNotifications() {
    const container = document.getElementById('notifListContainer');
    if (!container) return;

    // Filter logic
    const filtered = allNotifications.filter(n => {
        if (currentNotifFilter === 'all') return true;
        if (currentNotifFilter === 'meal') return n.type && n.type.includes('meal');
        return n.type === currentNotifFilter;
    });

    if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:40px 20px; color:#aaa;">No history found for this cycle.</div>';
        return;
    }

    container.innerHTML = filtered.map(notif => {
        let typeClass = 'type-other';
        let icon = '‚öôÔ∏è';
        if (notif.type === 'deposit') { typeClass = 'type-deposit'; icon = 'üí∞'; }
        if (notif.type === 'expense') { typeClass = 'type-expense'; icon = 'üõí'; }
        if (notif.type && notif.type.includes('meal')) { typeClass = 'type-meal'; icon = 'üçΩÔ∏è'; }

        const dateObj = new Date(notif.created_at);
        const displayTime = dateObj.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) + 
                          ' ‚Ä¢ ' + dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

        // AUTHOR LOGIC: Handle NULL members (System logs)
        let authorMarkup = '<span style="color:var(--text-secondary)">System</span>';
        
        if (notif.members) {
            if (notif.members.role === 'admin' || notif.members.role === 'manager') {
                authorMarkup = `<span style="color:var(--primary-color); font-weight:800;">Admin</span>`;
            } else {
                authorMarkup = `<span style="font-weight:600;">${notif.members.name}</span>`;
            }
        }

        return `
        <div class="notif-item ${typeClass}" onclick="handleNotifClick('${notif.type}')">
            <div style="display:flex; gap:10px; align-items:flex-start;">
                <div style="font-size:18px;">${icon}</div>
                <div style="flex:1;">
                    <div style="font-size:13px; color:var(--text-primary); line-height:1.4;">${notif.message}</div>
                    <div style="display:flex; justify-content:space-between; margin-top:6px; font-size:10px; color:var(--text-secondary);">
                        <span>${displayTime}</span>
                        <span>By: ${authorMarkup}</span>
                    </div>
                </div>
            </div>
        </div>
        `;
    }).join('');
}



// Updated Log Activity (Uses member_id)
async function logActivity(message, type = 'info') {
    if (!currentCycleId) return;
    try {
        await supabase
            .from('notifications')
            .insert({
                cycle_id: currentCycleId,
                message: message,
                type: type,
                member_id: currentUser?.member_id // FIXED: Use member_id
            });
    } catch (err) {
        console.error('Error logging activity:', err);
    }
}



// --- Deep Linking Action ---
function handleNotifClick(type) {
    document.getElementById('notifPanel').classList.remove('active');

    if (type === 'deposit') {
        navigateToPage('deposits');
    } else if (type === 'expense') {
        navigateToPage('expenses');
    } else if (type.includes('meal')) {
        navigateToPage('tracker');
    } else {
        navigateToPage('dashboard');
    }
}



// Helper to keep Dashboard synced
function updateDashboardActivity(data) {
    const container = document.getElementById('recentActivity');
    if (!container) return;
    
    const slice = data.slice(0, 10);
    if (slice.length === 0) {
        container.innerHTML = '<div class="loading">No recent activity</div>';
        return;
    }
    
    container.innerHTML = slice.map(notif => `
        <div class="list-item">
            <div class="list-item-info">
                <div class="list-item-title">${notif.message}</div>
                <div class="list-item-subtitle">${formatDateTime(notif.created_at)}</div>
            </div>
        </div>
    `).join('');
}




    async function loadCycles() {
    try {
        const { data, error } = await supabase
            .from('cycles')
            .select('*')
            .order('start_date', { ascending: false });

        if (error) throw error;

        allCycles = data || [];
        const cycleSelect = document.getElementById('cycleSelect');
        cycleSelect.innerHTML = '';

        if (allCycles.length === 0) {
            cycleSelect.innerHTML = '<option value="">No cycles available</option>';
            return;
        }

        // Locate this in your initialization or loadCycles
document.getElementById('cycleSelect').addEventListener('change', (e) => {
    currentCycleId = e.target.value;
    const selectedOption = e.target.options[e.target.selectedIndex];
    document.getElementById('headerCycleName').textContent = selectedOption.text;
    
    // This triggers the specific refresh logic for whatever page you are currently on
    refreshCurrentPage(); 
});

        // FIND THE ACTIVE ONE OR FALLBACK TO THE NEWEST
        const activeCycle = allCycles.find(c => c.is_active === true) || allCycles[0];
        currentCycleId = activeCycle.id;

        allCycles.forEach(cycle => {
            const option = document.createElement('option');
            option.value = cycle.id;
            option.textContent = cycle.name;
            if (cycle.id === currentCycleId) {
                option.selected = true;
            }
            cycleSelect.appendChild(option);
        });

        // Update the header badge
        document.getElementById('headerCycleName').textContent = activeCycle.name;

    } catch (err) {
        console.error('Error loading cycles:', err);
    }
}
    async function loadMembers() {
        try {
            const { data, error } = await supabase
                .from('members')
                .select('*')
                .order('name');

            if (error) throw error;

            allMembers = data || [];
            populateMemberSelects();
        } catch (err) {
            console.error('Error loading members:', err);
        }
    }

 function populateMemberSelects() {
    const selects = ['trackerMemberSelect', 'expenseMember', 'depositMember', 'depositLogFilter'];

    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        const firstOption = select.options[0];
        const currentValue = select.value; // Preserve value if reloading
        
        select.innerHTML = '';
        select.appendChild(firstOption);
        
        allMembers.forEach(member => {
            const option = document.createElement('option');
            option.value = member.id;
            option.textContent = member.name;
            select.appendChild(option);
        });

        // --- NEW LOGIC FOR USER CONVENIENCE ---
        // If this is the Expense form and I am a regular user, auto-select ME
        if (selectId === 'expenseMember' && currentUser.role === 'user' && currentUser.member_id) {
             select.value = currentUser.member_id;
             // Optional: Disable it so they can't change it
             // select.disabled = true; 
        } else if (currentValue) {
            select.value = currentValue;
        }
    });
}
    // ============================================
    // NAVIGATION
    // ============================================
    
    function navigateToPage(pageName) {
        // Hide all pages
        document.querySelectorAll('.page-content').forEach(page => {
            page.classList.add('hidden');
        });

        // Show selected page
        const targetPage = document.getElementById(pageName + 'Page');
        if (targetPage) {
            targetPage.classList.remove('hidden');
        }

        // Update active states
        document.querySelectorAll('.nav-link, .bottom-nav-link').forEach(link => {
            link.classList.remove('active');
        });

        document.querySelectorAll(`[data-page="${pageName}"]`).forEach(link => {
            link.classList.add('active');
        });

        // Load page data
        loadPageData(pageName);
    }


function refreshCurrentPage() {
    // Find which page is active (has no 'hidden' class)
    const activePage = document.querySelector('.page-content:not(.hidden)');
    
    if (activePage) {
        const pageId = activePage.id.replace('Page', '');
        console.log(`üîÑ Refreshing view: ${pageId}`);
        loadPageData(pageId);
        
        // Always refresh dashboard stats if on dashboard
        // (Because dashboard has multiple sub-components)
        if (pageId === 'dashboard') {
            loadDashboard();
            loadSystemStatus();
        }
    }
}
    // Setup navigation
    document.querySelectorAll('.nav-link, .bottom-nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const pageName = link.getAttribute('data-page');
            if (pageName) {
                navigateToPage(pageName);
            }
        });
    });

    // ============================================
    // DASHBOARD PAGE
    // ============================================
    
    async function loadDashboard() {
        if (!currentCycleId) return;

        try {
            // Calculate meal rate
         const { data: expenses } = await supabase
    .from('expenses')
    .select('amount')
    .eq('cycle_id', currentCycleId)
    .eq('status', 'approved'); // <--- ADD THIS FILTER

            const { data: meals } = await supabase
                .from('meals')
                .select('day_count, night_count')
                .eq('cycle_id', currentCycleId);


                const { data: log } = await supabase
    .from('system_logs')
    .select('*')
    .eq('log_date', new Date().toISOString().split('T')[0])
     .maybeSingle();  

if (log) {
    // Optional: Show a small badge somewhere
    console.log("‚úÖ Daily Automation Ran at: " + new Date(log.executed_at).toLocaleTimeString());
} else {
    console.log("‚è≥ Waiting for Auto-Entry Time...");
}



            const totalExpense = expenses?.reduce((sum, e) => sum + parseFloat(e.amount), 0) || 0;
            const totalMeals = meals?.reduce((sum, m) => sum + parseFloat(m.day_count) + parseFloat(m.night_count), 0) || 0;
const mealRate = totalMeals > 0 ? totalExpense / totalMeals : 0;

document.getElementById('statMealRate').textContent = formatCurrency(mealRate);
           document.getElementById('statTotalMeals').textContent = Math.round(totalMeals);
document.getElementById('statTotalExpense').textContent = formatCurrencyRound(totalExpense);

          // Inside loadSummary or loadDashboard
// Change the deposit query to:
const { data: deposits } = await supabase
    .from('deposits')
    .select('*')
    .eq('cycle_id', currentCycleId)
    .neq('label', 'Auto-Settlement')
    .neq('status', 'pending'); // <--- ADD THIS FILTER

            const totalDeposit = deposits?.reduce((sum, d) => sum + parseFloat(d.amount), 0) || 0;
          document.getElementById('statTotalDeposit').textContent = formatCurrencyRound(totalDeposit);

             loadSystemStatus(); 

            // Load recent activity
            await loadRecentActivity();

        } catch (err) {
            console.error('Error loading dashboard:', err);
        }
    }

    async function loadRecentActivity() {
        try {
            const { data, error } = await supabase
                .from('notifications')
                .select('*')
                .eq('cycle_id', currentCycleId)
                .order('created_at', { ascending: false })
                .limit(10);

            if (error) throw error;

            const container = document.getElementById('recentActivity');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="loading">No recent activity</div>';
                return;
            }

            container.innerHTML = data.map(notif => `
                <div class="list-item">
                    <div class="list-item-info">
                        <div class="list-item-title">${notif.message}</div>
                        <div class="list-item-subtitle">${formatDate(notif.created_at)}</div>
                    </div>
                </div>
            `).join('');

        } catch (err) {
            console.error('Error loading activity:', err);
        }
    }

    // ============================================
    // PROFILE PAGE
    // ============================================
    
    async function loadProfile() {
        if (!currentUser) return;
        
        // If admin (no member_id), show limited view
        if (!currentUser.member_id) {
            document.getElementById('profileName').textContent = "Administrator";
            document.getElementById('profileTotalMeals').textContent = "-";
            document.getElementById('profileTotalDeposit').textContent = "-";
            document.getElementById('profileBalance').textContent = "-";
            document.getElementById('profileDepositHistory').innerHTML = "<div class='loading'>Admins do not have meal records.</div>";
            return;
        }

        if (!currentCycleId) return;

        try {
            // Load member info
            const member = allMembers.find(m => m.id === currentUser.member_id);
            if (member) {
                document.getElementById('profileName').textContent = member.name;
            }

            // Calculate stats
            const { data: meals } = await supabase
                .from('meals')
                .select('day_count, night_count')
                .eq('cycle_id', currentCycleId)
                .eq('member_id', currentUser.member_id);

            const totalMeals = meals?.reduce((sum, m) => sum + parseFloat(m.day_count) + parseFloat(m.night_count), 0) || 0;
            document.getElementById('profileTotalMeals').textContent = Math.round(totalMeals);

// Change the deposit query to:
const { data: deposits } = await supabase
    .from('deposits')
    .select('amount')
    .eq('cycle_id', currentCycleId)
    .eq('member_id', currentUser.member_id)
    .neq('status', 'pending'); // <--- ADD THIS FILTER

            const totalDeposit = deposits?.reduce((sum, d) => sum + parseFloat(d.amount), 0) || 0;
           document.getElementById('profileTotalDeposit').textContent = formatCurrencyRound(totalDeposit);

            // Calculate balance
           const { data: allExpenses } = await supabase
    .from('expenses')
    .select('amount')
    .eq('cycle_id', currentCycleId)
    .eq('status', 'approved'); // <--- ADD THIS FILTER

            const { data: allMeals } = await supabase
                .from('meals')
                .select('day_count, night_count')
                .eq('cycle_id', currentCycleId);

            const totalExpense = allExpenses?.reduce((sum, e) => sum + parseFloat(e.amount), 0) || 0;
            const allTotalMeals = allMeals?.reduce((sum, m) => sum + parseFloat(m.day_count) + parseFloat(m.night_count), 0) || 0;
            const mealRate = allTotalMeals > 0 ? totalExpense / allTotalMeals : 0;
            const balance = totalDeposit - (totalMeals * mealRate);
            
            const balanceEl = document.getElementById('profileBalance');
            balanceEl.textContent = formatCurrency(balance);
            balanceEl.className = balance >= 0 ? 'stat-value balance-positive' : 'stat-value balance-negative';

 

            // Load deposit history
            await loadProfileDepositHistory();

        } catch (err) {
            console.error('Error loading profile:', err);
        }
    }

    async function loadTodayMealStatus() {
        if (!currentUser.member_id) return;
        const today = new Date().toISOString().split('T')[0];

        try {
            const { data } = await supabase
                .from('meals')
                .select('*')
                .eq('member_id', currentUser.member_id)
                .eq('meal_date', today)
                .maybeSingle();

            const dayCount = data?.day_count || 0;
            const nightCount = data?.night_count || 0;

            const dayToggle = document.getElementById('dayMealToggle');
            const nightToggle = document.getElementById('nightMealToggle');

            if (dayCount > 0) {
                dayToggle.classList.add('active');
                dayToggle.classList.remove('inactive');
                document.getElementById('dayMealStatus').textContent = 'ON';
            } else {
                dayToggle.classList.add('inactive');
                dayToggle.classList.remove('active');
                document.getElementById('dayMealStatus').textContent = 'OFF';
            }

            if (nightCount > 0) {
                nightToggle.classList.add('active');
                nightToggle.classList.remove('inactive');
                document.getElementById('nightMealStatus').textContent = 'ON';
            } else {
                nightToggle.classList.add('inactive');
                nightToggle.classList.remove('active');
                document.getElementById('nightMealStatus').textContent = 'OFF';
            }

        } catch (err) {
            console.error('Error loading meal status:', err);
        }
    }

    async function loadProfileDepositHistory() {
        if (!currentUser.member_id) return;
        try {
            const { data, error } = await supabase
                .from('deposits')
                .select('*')
                .eq('member_id', currentUser.member_id)
                .eq('cycle_id', currentCycleId)
                .order('created_at', { ascending: false });

            if (error) throw error;

            const container = document.getElementById('profileDepositHistory');

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="loading">No deposits yet</div>';
                return;
            }

            container.innerHTML = data.map(deposit => `
                <div class="list-item">
                    <div class="list-item-info">
                        <div class="list-item-title">${deposit.label || 'Deposit'}</div>
                       <div class="list-item-subtitle">${formatDateTime(deposit.created_at)}</div>
                    </div>
                    <div class="list-item-amount balance-positive">${formatCurrency(deposit.amount)}</div>
                </div>
            `).join('');

        } catch (err) {
            console.error('Error loading deposit history:', err);
        }
    }

    // Toggle meal status
    // document.getElementById('dayMealToggle').addEventListener('click', async () => {
    //     if (currentUser.member_id) await toggleMeal('day');
    // });

    // document.getElementById('nightMealToggle').addEventListener('click', async () => {
    //     if (currentUser.member_id) await toggleMeal('night');
    // });




    async function toggleDefaultPreference(type) {
    if (!currentUser.member_id) return;

    // 1. Get current member data from local list to check current state
    const member = allMembers.find(m => m.id === currentUser.member_id);
    if (!member) return;

    // 2. Determine new state (Toggle)
    let updates = {};
    if (type === 'day') {
        const newState = !member.default_day_on;
        updates = { default_day_on: newState };
        // Optimistic Update (Visual)
        member.default_day_on = newState; 
        updateDefaultButtons(member);
    } else {
        const newState = !member.default_night_on;
        updates = { default_night_on: newState };
        // Optimistic Update (Visual)
        member.default_night_on = newState; 
        updateDefaultButtons(member);
    }

    try {
        // 3. Save to DB
        const { error } = await supabase
            .from('members')
            .update(updates)
            .eq('id', currentUser.member_id);

        if (error) throw error;
        // console.log("Default updated");
        
        // 4. Reload Scheduler to apply new default to any *future missing* cards immediately?
        // Actually, we usually only apply defaults when a card is CREATED. 
        // Existing cards shouldn't change. So we don't reload scheduler here.

    } catch (err) {
        console.error("Failed to update defaults", err);
        showNotification("Failed to save default setting", "error");
    }
}

// Helper to update button colors
function updateDefaultButtons(member) {
    const dayBtn = document.getElementById('defDayBtn');
    const nightBtn = document.getElementById('defNightBtn');
    
    if (dayBtn) {
        dayBtn.className = `def-btn ${member.default_day_on ? 'active' : ''}`;
        dayBtn.textContent = `Default Day: ${member.default_day_on ? 'ON' : 'OFF'}`;
    }
    
    if (nightBtn) {
        nightBtn.className = `def-btn ${member.default_night_on ? 'active' : ''}`;
        nightBtn.textContent = `Default Night: ${member.default_night_on ? 'ON' : 'OFF'}`;
    }
}





   async function toggleMeal(mealType) {
    const today = new Date().toISOString().split('T')[0];

    try {
        const { data: existing } = await supabase
            .from('meals')
            .select('*')
            .eq('member_id', currentUser.member_id)
            .eq('meal_date', today)
            .maybeSingle();

        let dayCount = existing?.day_count || 0;
        let nightCount = existing?.night_count || 0;

        if (mealType === 'day') {
            dayCount = dayCount > 0 ? 0 : 1;
        } else {
            nightCount = nightCount > 0 ? 0 : 1;
        }

        if (existing) {
            await supabase
                .from('meals')
                .update({
                    day_count: dayCount,
                    night_count: nightCount,
                    updated_at: new Date().toISOString()
                })
                .eq('id', existing.id);
        } else {
            await supabase
                .from('meals')
                .insert({
                    cycle_id: currentCycleId,
                    member_id: currentUser.member_id,
                    meal_date: today,
                    day_count: dayCount,
                    night_count: nightCount
                });
        }

        // --- CRUCIAL UPDATE HERE ---
        // We get the name of the person performing the action
        const actorName = currentUser.members ? currentUser.members.name : currentUser.username;
        const actionType = mealType === 'day' ? (dayCount > 0 ? 'ON' : 'OFF') : (nightCount > 0 ? 'ON' : 'OFF');
        
        await logActivity(
            `${actorName} turned ${mealType.toUpperCase()} meal ${actionType} for today`, 
            'meal' 
        );
        // ---------------------------

        await loadTodayMealStatus();
        showNotification('Meal status updated', 'success');

    } catch (err) {
        console.error('Error toggling meal:', err);
        showNotification('Failed to update meal status', 'error');
    }
}

    // ============================================
    // TRACKER PAGE
    // ============================================
    
       function loadTracker() {
        // The old dropdown logic is gone. 
        // We simply load the master matrix now.
        loadMasterTracker();
    }


    async function loadMemberCalendar(memberId) {
        if (!currentCycleId) return;

        try {
            const cycle = allCycles.find(c => c.id === currentCycleId);
            if (!cycle) return;

            const startDate = new Date(cycle.start_date);
            const endDate = new Date(cycle.end_date);
            
            // Fetch meals for this member and cycle
            const { data: meals } = await supabase
                .from('meals')
                .select('*')
                .eq('cycle_id', currentCycleId)
                .eq('member_id', memberId);

            const mealMap = {};
            meals?.forEach(meal => {
                mealMap[meal.meal_date] = meal;
            });

            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';

            // Generate calendar days
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const meal = mealMap[dateStr];
                const totalMeals = meal ? parseFloat(meal.day_count) + parseFloat(meal.night_count) : 0;

                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day' + (totalMeals > 0 ? ' has-meal' : '');
                dayDiv.innerHTML = `
                    <div class="calendar-day-number">${d.getDate()}</div>
                    <div class="calendar-day-meals">${totalMeals > 0 ? totalMeals.toFixed(1) : '-'}</div>
                `;

                // Only managers and admins can edit
                if (currentUser.role === 'admin' || currentUser.role === 'manager') {
                    dayDiv.addEventListener('click', () => {
                        openMealModal(memberId, dateStr, meal);
                    });
                }

                calendarGrid.appendChild(dayDiv);
            }

        } catch (err) {
            console.error('Error loading calendar:', err);
        }
    }

function openMealModal(memberId, sessionDate, currentNightVal, nextDayVal) {
    // 1. Calculate Dates
    const dSession = new Date(sessionDate);
    const dNext = new Date(dSession);
    dNext.setDate(dSession.getDate() + 1);
    
    const nextDateStr = dNext.toISOString().split('T')[0];
    
    // 2. Format Labels
    const fmt = (d) => d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }); // "8 Dec"
    const fmtFull = (d) => d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }); // "8 Dec 2025"

    // 3. GET MEMBER NAME
    const member = allMembers.find(m => m.id == memberId);
    const memberName = member ? member.name : 'Member';

    // 4. Update Header (Name + Date)
    document.getElementById('mealModalTitle').innerHTML = `
        <div style="color:var(--primary-color); font-size:18px;">${memberName}</div>
        <div style="font-size:13px; color:var(--text-primary); font-weight:400; margin-top:2px;">
            Bazar Session of <strong>${fmtFull(dSession)}</strong>
        </div>
    `;
    
    // 5. Update Input Labels
    document.getElementById('mealNightLabel').innerHTML = `Night <span style="font-weight:400; color:var(--primary-color)">(${fmt(dSession)})</span>`;
    document.getElementById('mealDayLabel').innerHTML = `Day <span style="font-weight:400; color:#d97706">(${fmt(dNext)})</span>`;

    // 6. Set Inputs and Hidden IDs
    document.getElementById('mealMemberId').value = memberId;
    document.getElementById('mealDateSession').value = sessionDate;
    document.getElementById('mealDateNext').value = nextDateStr;

    // Round values before showing
    document.getElementById('mealNightCount').value = Math.round(parseFloat(currentNightVal || 0));
    document.getElementById('mealDayCount').value = Math.round(parseFloat(nextDayVal || 0));
    
    document.getElementById('mealModal').classList.add('active');
}
    function closeMealModal() {
        document.getElementById('mealModal').classList.remove('active');
    }

   // ==========================================
// UPDATED MEAL FORM HANDLER
// ==========================================
// ==========================================
// UPDATED MEAL FORM HANDLER (FIXED NOTIFICATION)
// ==========================================
document.getElementById('mealForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.textContent;
    
    const memberId = parseInt(document.getElementById('mealMemberId').value);
    const sessionDate = document.getElementById('mealDateSession').value;
    const nextDate = document.getElementById('mealDateNext').value;
    const nightVal = Math.round(parseFloat(document.getElementById('mealNightCount').value)) || 0;
    const dayVal = Math.round(parseFloat(document.getElementById('mealDayCount').value)) || 0;

    btn.textContent = "Saving...";
    btn.disabled = true;

    try {
        const { data: existingRows } = await supabase.from('meals').select('*').eq('member_id', memberId).in('meal_date', [sessionDate, nextDate]);
        const findRow = (d) => existingRows?.find(r => r.meal_date === d);
        const rowSession = findRow(sessionDate);
        const rowNext = findRow(nextDate);

        const upserts = [
            { cycle_id: currentCycleId, member_id: memberId, meal_date: sessionDate, night_count: nightVal, day_count: rowSession ? rowSession.day_count : 0 },
            { cycle_id: currentCycleId, member_id: memberId, meal_date: nextDate, day_count: dayVal, night_count: rowNext ? rowNext.night_count : 0 }
        ];

        const { error } = await supabase.from('meals').upsert(upserts, { onConflict: 'member_id, meal_date' });
        if (error) throw error;

        const actor = currentUser.members ? currentUser.members.name : "Admin";
        const targetMember = allMembers.find(m => m.id === memberId);
        await logActivity(`Tracker Override: ${targetMember?.name}'s session (${sessionDate}) set to N:${nightVal} D:${dayVal} by ${actor}`, 'meal');

        closeMealModal();
        await loadMasterTracker();
        showNotification("Session updated", "success");
    } catch (err) {
        showNotification(err.message, "error");
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
});

    // ============================================
    // SUMMARY PAGE
    // ============================================
    
async function loadSummary() {
    if (!currentCycleId) return;

    try {
        // 1. USE CENTRALIZED DATE LOGIC
        const sessionDate = await getActiveSessionDate();
        
        // Define Columns based on Active Session
        const nightDateStr = sessionDate.toLocaleDateString('en-CA');
        
        const nextDay = new Date(sessionDate);
        nextDay.setDate(sessionDate.getDate() + 1);
        const dayDateStr = nextDay.toLocaleDateString('en-CA');

        const fmt = (d) => d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });

        // 2. Fetch Data Separately
        // A. Billed Meals (History/Tracker) -> ONLY for calculating Total Cost/Meals
        const { data: meals } = await supabase
            .from('meals')
            .select('*')
            .eq('cycle_id', currentCycleId);
        
        // B. Plans (Future/Intent) -> ONLY for the Buttons
        const { data: plans } = await supabase
            .from('meal_plans')
            .select('*')
            .in('plan_date', [nightDateStr, dayDateStr]);
        
       // Change the deposit query to:
const { data: deposits } = await supabase
    .from('deposits')
    .select('*')
    .eq('cycle_id', currentCycleId)
    .neq('status', 'pending'); // <--- ADD THIS FILTER
    
       const { data: expenses } = await supabase
    .from('expenses')
    .select('*')
    .eq('cycle_id', currentCycleId)
    .eq('status', 'approved'); // <--- ADD THIS FILTER

        // 3. Fast Lookups
        const planMap = {};
        plans?.forEach(p => { planMap[`${p.member_id}_${p.plan_date}`] = p; });

        // 4. Financial Rates
        const totalExpense = expenses?.reduce((sum, e) => sum + parseFloat(e.amount), 0) || 0;
        const allTotalMeals = meals?.reduce((sum, m) => sum + parseFloat(m.day_count) + parseFloat(m.night_count), 0) || 0;
        const mealRate = allTotalMeals > 0 ? totalExpense / allTotalMeals : 0;

        // 5. Build Member Stats
        const memberStats = {};

        // Helper: Get Plan Status (Plan -> Default) 
        // STRICTLY IGNORES TRACKER ('meals' table)
        const getPlanStatus = (member, dateStr, type) => {
            const plan = planMap[`${member.id}_${dateStr}`];
            
            if (plan) {
                return type === 'night' ? plan.night_count : plan.day_count;
            }
            
            // Fallback to Default
            return type === 'night' ? (member.default_night_on ? 1 : 0) : (member.default_day_on ? 1 : 0);
        };

        allMembers.forEach(member => {
            // A. Calculate Historical Totals (From Tracker)
            let totalMeals = 0;
            meals?.filter(m => m.member_id === member.id).forEach(m => {
                totalMeals += (parseFloat(m.day_count) + parseFloat(m.night_count));
            });

            const memDeposits = deposits?.filter(d => d.member_id === member.id).reduce((sum, d) => sum + parseFloat(d.amount), 0) || 0;
            const totalCost = totalMeals * mealRate;

            memberStats[member.id] = {
                id: member.id,
                name: member.name,
                // B. Calculate Button Status (From Plan Only)
                // This ensures it matches the Profile Card exactly
                nightStatus: parseFloat(getPlanStatus(member, nightDateStr, 'night')),
                dayStatus: parseFloat(getPlanStatus(member, dayDateStr, 'day')),
                totalMeals: totalMeals,
                totalCost: totalCost,
                totalDeposit: memDeposits,
                balance: memDeposits - totalCost
            };
        });

        // Store original loadSummary function reference
const _originalLoadSummary = loadSummary;

// Override with enhanced version
loadSummary = async function() {
    await _originalLoadSummary();
    await loadDueSettlement();
};

        // 6. Header
        const realTodayStr = new Date().toLocaleDateString('en-CA');
        const isTargetingTomorrow = (nightDateStr !== realTodayStr);
        const dateLabelPrefix = isTargetingTomorrow ? "Target: " : "Active: ";

        const tableHead = document.querySelector('#summaryTable thead tr');
        tableHead.innerHTML = `
            <th>Name</th>
            <th style="text-align:center;">Night <br><span style="font-size:9px; color:var(--primary-color)">${dateLabelPrefix}${fmt(sessionDate)}</span></th>
            <th style="text-align:center;">Day <br><span style="font-size:9px; color:#d97706">${fmt(nextDay)}</span></th>
            <th>Total<br>Meals</th>
            <th>Total<br>Cost</th>
            <th>Deposits</th>
            <th>Balance</th>
        `;

        // 7. Render Body
        const isAdmin = (currentUser.role === 'admin' || currentUser.role === 'manager');
        const tbody = document.getElementById('summaryTableBody');
        
        tbody.innerHTML = Object.values(memberStats).map(stat => {
            const nightIsOn = stat.nightStatus > 0;
            const nightBtnClass = nightIsOn ? 'status-btn on' : 'status-btn off';
            const nightAction = isAdmin ? `onclick="quickToggleSummaryMeal(${stat.id}, '${nightDateStr}', 'night', ${stat.nightStatus})"` : 'disabled';
            
            const dayIsOn = stat.dayStatus > 0;
            const dayBtnClass = dayIsOn ? 'status-btn on' : 'status-btn off';
            const dayAction = isAdmin ? `onclick="quickToggleSummaryMeal(${stat.id}, '${dayDateStr}', 'day', ${stat.dayStatus})"` : 'disabled';

            return `
            <tr>
                <td style="vertical-align: middle;"><strong>${stat.name}</strong></td>
                <td style="text-align:center;"><button class="${nightBtnClass}" ${nightAction}>${nightIsOn ? 'ON' : 'OFF'}</button></td>
                <td style="text-align:center;"><button class="${dayBtnClass}" ${dayAction}>${dayIsOn ? 'ON' : 'OFF'}</button></td>
                <td style="vertical-align: middle;"><strong>${stat.totalMeals.toFixed(1)}</strong></td>
                <td style="vertical-align: middle;">${formatCurrency(stat.totalCost)}</td>
                <td style="vertical-align: middle;">${formatCurrency(stat.totalDeposit)}</td>
                <td style="vertical-align: middle;" class="${stat.balance >= 0 ? 'balance-positive' : 'balance-negative'}">
                    <strong>${formatCurrency(stat.balance)}</strong>
                </td>
            </tr>`;
        }).join('');

    } catch (err) {
        console.error('Error loading summary:', err);
    }
}
// Function to instantly toggle meal from Summary Page
// Function to toggle meal from Summary Page (STRICTLY PLANS)
async function quickToggleSummaryMeal(memberId, dateStr, type, currentVal) {
    const btn = event.target; // Optimistic UI
    const originalText = btn.textContent;
    btn.textContent = "...";
    btn.disabled = true;

    // 1. Calculate New Value
    const newVal = currentVal > 0 ? 0 : 1;

    try {
        // 2. Fetch existing PLAN to preserve the 'other' side (Day/Night)
        // We do NOT check the 'meals' (Tracker) table.
        const { data: existingPlan } = await supabase
            .from('meal_plans')
            .select('*')
            .eq('member_id', memberId)
            .eq('plan_date', dateStr)
            .maybeSingle();

        // 3. Prepare Upsert Data
        const upsertPlan = {
            member_id: memberId,
            plan_date: dateStr,
            // If plan exists, keep existing values, otherwise default to 0
            day_count: existingPlan ? existingPlan.day_count : 0,
            night_count: existingPlan ? existingPlan.night_count : 0
        };

        // 4. Update the specific field we clicked
        if (type === 'night') {
            upsertPlan.night_count = newVal;
        } else {
            upsertPlan.day_count = newVal;
        }

        // 5. Send to Database (meal_plans only)
        const { error } = await supabase
            .from('meal_plans')
            .upsert(upsertPlan, { onConflict: 'member_id, plan_date' });

        if (error) throw error;

        // 6. Log and Refresh
        const actor = currentUser.members ? currentUser.members.name : "Admin";
        // We don't need to fetch member name again, logic is fast enough
        await logActivity(`Plan Updated: ${type} for ${dateStr} set to ${newVal ? 'ON' : 'OFF'} by ${actor}`, 'meal');

        await loadSummary();
        showNotification("Schedule updated successfully", "success");

    } catch (err) {
        console.error("Quick Toggle Error", err);
        showNotification("Update failed", "error");
        btn.textContent = originalText;
        btn.disabled = false;
    }
}

    document.getElementById('exportSummaryBtn').addEventListener('click', () => {
        const table = document.getElementById('summaryTable');
        const wb = XLSX.utils.table_to_book(table);
        XLSX.writeFile(wb, `MealCal_Summary_${new Date().toISOString().split('T')[0]}.xlsx`);
    });

    // ============================================
    // EXPENSES PAGE
    // ============================================
    
 window.handleDepositAction = async function(depositId, action) {
    console.log(`Action: ${action} triggered for ID: ${depositId}`);
    const btn = event.target;
    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = "...";

    try {
        const { data: dep, error: fError } = await supabase
            .from('deposits')
            .select('*, members(name)')
            .eq('id', depositId)
            .single();

        if (fError || !dep) throw new Error("Could not find the pending request.");

        const actor = currentUser.members ? currentUser.members.name : "Admin";

        if (action === 'approve') {
            const { error: delError } = await supabase.from('deposits').delete().eq('id', depositId);
            if (delError) throw delError;

            await processDepositWithClientSideSettlement(
                dep.member_id, 
                dep.cycle_id, 
                dep.amount, 
                dep.label || 'Deposit', 
                dep.notes
            );
            
            // LOG THE APPROVAL ACT
            await logActivity(`Deposit Approved: ${dep.members.name}'s request for ${formatCurrency(dep.amount)} was approved by ${actor}`, 'deposit');
            showNotification("Request Approved", "success");

        } else if (action === 'reject') {
            const { error: delError } = await supabase.from('deposits').delete().eq('id', depositId);
            if (delError) throw delError;

            // LOG THE REJECTION ACT
            await logActivity(`Deposit Rejected: ${dep.members.name}'s request for ${formatCurrency(dep.amount)} was rejected by ${actor}`, 'deposit');
            showNotification("Request Rejected", "warning");
        }
        
        await loadDeposits(); 
        if (typeof loadDashboard === 'function') loadDashboard();

    } catch (err) {
        console.error("CRITICAL ERROR:", err.message);
        showNotification(err.message, "error");
        btn.disabled = false;
        btn.textContent = originalText;
    }
};

document.getElementById('expenseForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.textContent;
    
    const date = document.getElementById('expenseDate').value;
    const memberId = parseInt(document.getElementById('expenseMember').value);
    const description = document.getElementById('expenseDescription').value;
    const amount = Math.round(parseFloat(document.getElementById('expenseAmount').value));

    const isAdmin = (currentUser.role === 'admin' || currentUser.role === 'manager');
    const initialStatus = isAdmin ? 'approved' : 'pending';
    const actor = currentUser.members ? currentUser.members.name : "User";

    btn.textContent = "Processing...";
    btn.disabled = true;

    try {
        const { error } = await supabase.from('expenses').insert({
            cycle_id: currentCycleId,
            member_id: memberId,
            expense_date: date,
            description: description,
            amount: amount,
            status: initialStatus
        });

        if (error) throw error;

        const targetMember = allMembers.find(m => m.id === memberId);
        await logActivity(
            `Expense ${initialStatus.toUpperCase()}: ${formatCurrency(amount)} for "${description}" (Shopper: ${targetMember?.name}) added by ${actor}`, 
            'expense'
        );

        document.getElementById('expenseForm').reset();
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        
        showNotification(isAdmin ? "Expense added" : "Request sent to admin", 'success');
        await loadExpenses();
    } catch (err) {
        console.error(err);
        showNotification(err.message, 'error');
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
});


    // ============================================
    // DEPOSITS PAGE
    // ============================================
async function loadDeposits() {
    const filterId = document.getElementById('depositLogFilter').value;
    if (!currentCycleId) return;

    try {
        const { data, error } = await supabase
            .from('deposits')
            .select('*, members(name)')
            .eq('cycle_id', currentCycleId)
            .order('created_at', { ascending: false });

        if (error) throw error;

        const pendingCard = document.getElementById('pendingDepositsCard');
        const pendingList = document.getElementById('pendingDepositList');
        const historyContainer = document.getElementById('depositList');

        // STRICT FILTERING
        // Pending: only those explicitly marked 'pending'
        const pendingItems = data.filter(d => d.status === 'pending');
        
        // History: only those marked 'approved' OR legacy records (null status)
        const historyItems = data.filter(d => d.status === 'approved' || !d.status);

        // Render Pending
        if (pendingItems.length > 0) {
            pendingCard.style.display = 'block';
            const isAdmin = (currentUser.role === 'admin' || currentUser.role === 'manager');
            pendingList.innerHTML = pendingItems.map(t => `
                <div class="list-item" style="background: rgba(245, 158, 11, 0.05); padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #fed7aa;">
                    <div class="log-main">
                        <div class="log-details">
                            <div class="log-member">${t.members?.name} <span class="due-status-badge due-status-pending">PENDING REQUEST</span></div>
                            <div class="log-meta" style="font-weight:700;">${formatCurrency(t.amount)} ‚Ä¢ ${t.label || 'Deposit'}</div>
                        </div>
                    </div>
                    ${isAdmin ? `
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-success btn-sm" onclick="handleDepositAction(${t.id}, 'approve')">Approve</button>
                        <button class="btn btn-danger btn-sm" onclick="handleDepositAction(${t.id}, 'reject')">‚úï</button>
                    </div>` : ''}
                </div>
            `).join('');
        } else {
            pendingCard.style.display = 'none';
        }

        // Render History
        let filteredHistory = historyItems;
        if (filterId) filteredHistory = historyItems.filter(h => h.member_id == filterId);

        if (filteredHistory.length === 0) {
            historyContainer.innerHTML = '<div class="loading">No transaction history found.</div>';
            return;
        }

        historyContainer.innerHTML = filteredHistory.map(t => {
            const isSettlement = t.label === 'Auto-Settlement' || t.label === 'Reduction';
            const isNegative = t.amount < 0;
            
            // Icon & Style Logic
            let icon = 'üí∞';
            let iconClass = 'deposit';
            let tagClass = 'tag-deposit';
            let typeLabel = 'Deposit';

            if (t.label === 'Auto-Settlement') {
                icon = 'üîÑ';
                iconClass = 'settlement';
                tagClass = 'tag-settle';
                typeLabel = 'Settlement';
            } else if (isNegative) {
                icon = 'üîª';
                iconClass = 'charge';
                tagClass = 'tag-settle';
                typeLabel = 'Charge';
            }

         const dateStr = formatDateTime(t.created_at);

            return `
            <div class="log-item">
                <div class="log-main">
                    <div class="log-icon ${iconClass}">${icon}</div>
                    <div class="log-details">
                        <div class="log-member">
                            ${t.members?.name || 'Unknown'}
                            <span class="log-type-tag ${tagClass}">${typeLabel}</span>
                        </div>
                        <div class="log-meta">
                            ${dateStr} ${t.notes ? `‚Ä¢ ${t.notes}` : ''}
                        </div>
                        ${isSettlement && t.notes ? `<div class="transfer-info">üìå ${t.notes}</div>` : ''}
                    </div>
                </div>
                <div class="log-amount-area">
                    <div class="log-amount ${isNegative ? 'balance-negative' : 'balance-positive'}">
                        ${isNegative ? '-' : '+'}${formatCurrency(Math.abs(t.amount))}
                    </div>
                </div>
            </div>
            `;
        }).join('');

    } catch (err) {
        console.error('Error loading deposits:', err);
        historyContainer.innerHTML = '<div class="loading" style="color:red;">Error loading transactions.</div>';
    }
}


async function loadExpenses() {
    // 1. Ensure the Add Card is visible
    const addCard = document.getElementById('addExpenseCard');
    if (addCard) addCard.style.display = 'block';
    
    const isUser = currentUser.role === 'user';
    if (!currentCycleId) return;

    const expenseListContainer = document.getElementById('expenseList');
    expenseListContainer.innerHTML = '<div class="loading">Loading expenses...</div>';

    try {
        // 2. Fetch Data with Shopper Name Join
        const { data, error } = await supabase
            .from('expenses')
            .select('*, members(name)')
            .eq('cycle_id', currentCycleId)
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!data || data.length === 0) {
            expenseListContainer.innerHTML = '<div class="loading">No expenses found for this cycle.</div>';
            return;
        }

        // 3. Separate Data
        const pendingItems = data.filter(e => e.status === 'pending');
        const historyItems = data.filter(e => e.status !== 'pending'); 

        // 4. Helper to Render Row
        const renderRow = (expense, showButtons) => {
            let statusBadge = '';
            let rowBg = '';
            
            if (expense.status === 'pending') {
                statusBadge = '<span class="entry-status-badge status-pending" style="margin-left: 8px;">PENDING</span>';
                rowBg = 'background-color: rgba(245, 158, 11, 0.05);'; 
            } else if (expense.status === 'approved') {
                statusBadge = '<span class="entry-status-badge status-done" style="margin-left: 8px;">APPROVED</span>';
            } else if (expense.status === 'rejected') {
                statusBadge = '<span class="entry-status-badge" style="margin-left: 8px; background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca;">REJECTED</span>';
            }

            const shopperName = expense.members?.name || 'Unknown Member';
            const bazarDate = new Date(expense.expense_date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });

            return `
            <div class="list-item" style="${rowBg} padding: 15px; border-bottom: 1px solid var(--border-color);"> 
                <div class="list-item-info">
                    <div class="list-item-title" style="font-size: 15px; font-weight: 700;">
                        ${expense.description}
                        ${statusBadge}
                    </div>
                    <div class="list-item-subtitle" style="margin-top: 4px; line-height: 1.4;">
                        <span style="color: var(--primary-color); font-weight: 600;">üë§ Shopper: ${shopperName}</span><br>
                        <span style="color: var(--text-secondary);">
                            ‚è∞ Added: ${formatDate(expense.created_at)} <br>
                            üìÖ Bazar Date: ${bazarDate}
                        </span>
                    </div>
                </div>
                <div style="display:flex; flex-direction:column; align-items:flex-end; justify-content: center;">
                    <div class="list-item-amount" style="font-size: 16px; font-family: 'Courier New', monospace;">
                        ${formatCurrency(expense.amount)}
                    </div>
                    ${showButtons ? `
                        <div style="display:flex; gap:8px; margin-top:10px;">
                            <button class="btn btn-success btn-sm" onclick="handleExpenseApproval('${expense.id}', 'approved')" title="Approve">‚úì</button>
                            <button class="btn btn-danger btn-sm" onclick="handleExpenseApproval('${expense.id}', 'rejected')" title="Reject">‚úï</button>
                        </div>` : ''}
                </div>
            </div>`;
        };

        // 5. Build HTML Sections
        let finalHTML = '';

        if (pendingItems.length > 0) {
            finalHTML += `<div style="font-size:11px; font-weight:800; color:var(--warning-color); margin: 10px 0; text-transform:uppercase; letter-spacing:1px;">‚ö†Ô∏è Needs Approval</div>`;
            pendingItems.forEach(item => finalHTML += renderRow(item, !isUser));
            finalHTML += `<div style="border-bottom: 2px dashed var(--border-color); margin: 20px 0;"></div>`;
        }

        if (historyItems.length > 0) {
            finalHTML += `<div style="font-size:11px; font-weight:800; color:var(--text-secondary); margin: 10px 0; text-transform:uppercase; letter-spacing:1px;">Processed Expenses</div>`;
            historyItems.forEach(item => finalHTML += renderRow(item, false));
        }

        expenseListContainer.innerHTML = finalHTML;

    } catch (err) {
        console.error('Error loading expenses:', err);
        expenseListContainer.innerHTML = '<div class="loading" style="color:red">Error loading list.</div>';
    }
}


function autoUpdateDepositLabel() {
    const type = document.getElementById('depositType').value;
    const labelInput = document.getElementById('depositLabel');
    
    // Only update if the user hasn't typed something custom yet (optional logic, 
    // strictly replacing is usually safer for UX in this context)
    if (type === 'charge') {
        labelInput.value = 'Reduction';
    } else {
        labelInput.value = 'Deposit';
    }
}

async function loadSelectedMemberHistory(memberId) {
    const container = document.getElementById('selectedMemberHistoryList');
    const nameLabel = document.getElementById('historyMemberName');
    
    if (!memberId) {
        container.innerHTML = '<div class="history-empty">Select a member to view their specific log.</div>';
        nameLabel.textContent = "No member selected";
        return;
    }

    // Update Name Label
    const member = allMembers.find(m => m.id == memberId);
    nameLabel.textContent = member ? member.name : 'Unknown';

    container.innerHTML = '<div class="loading" style="padding:10px;">Loading history...</div>';

    try {
        const { data, error } = await supabase
            .from('deposits')
            .select('*')
            .eq('cycle_id', currentCycleId)
            .eq('member_id', memberId)
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!data || data.length === 0) {
            container.innerHTML = '<div class="history-empty">No transactions found for this cycle.</div>';
            return;
        }

        container.innerHTML = data.map(t => {
            const isNegative = t.amount < 0;
            const colorClass = isNegative ? 'balance-negative' : 'balance-positive';
            const dateStr = new Date(t.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
            
            return `
            <div style="padding: 10px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 600; font-size: 13px;">${t.label || (isNegative ? 'Charge' : 'Deposit')}</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">${dateStr}</div>
                </div>
                <div class="${colorClass}" style="font-weight: 700; font-size: 14px;">
                    ${formatCurrency(t.amount)}
                </div>
            </div>
            `;
        }).join('');

    } catch (err) {
        console.error("Error loading member history:", err);
        container.innerHTML = '<div class="history-empty" style="color:red">Error loading data.</div>';
    }
}

// Add this NEW function BEFORE the depositForm handler
async function processDepositWithClientSideSettlement(memberId, cycleId, amount, label, notes) {
    try {
        // Add this helper logic inside the loop in processDepositWithClientSideSettlement
const settleAmountRaw = Math.min(poolAvailable, creditorOwed);
const settleAmount = Math.round(settleAmountRaw * 100) / 100; // Limits to 2 decimals
        const targetCycleId = parseInt(cycleId); 

        // 1. Insert the official REAL cash deposit
        // We add status: 'approved' so it skips the pending queue and counts in math immediately
        const { data: mainDeposit, error: depError } = await supabase
            .from('deposits')
            .insert({
                cycle_id: targetCycleId,
                member_id: memberId,
                amount: amount,
                label: label,
                notes: notes,
                status: 'approved' // <--- AUTO-APPROVE
            })
            .select().single();

        if (depError) throw depError;

        const memberObj = allMembers.find(m => m.id == memberId);
        await logActivity(`Cash Deposit: ${formatCurrency(amount)} added for ${memberObj?.name}`, 'deposit');

        if (amount <= 0) return { settled: false, deposit_id: mainDeposit.id };

        // 2. Find Debtor Due
        const { data: debtorDue } = await supabase
            .from('cycle_dues')
            .select('*')
            .eq('member_id', memberId)
            .eq('to_cycle_id', targetCycleId)
            .in('status', ['pending', 'settling'])
            .lt('due_amount', 0)
            .maybeSingle();

        if (!debtorDue) return { settled: false, deposit_id: mainDeposit.id };

        // 3. Find Creditors
        const { data: creditors } = await supabase
            .from('cycle_dues')
            .select('*, members(name)')
            .eq('to_cycle_id', targetCycleId)
            .in('status', ['pending', 'settling'])
            .gt('due_amount', 0)
            .order('created_at', { ascending: true });

        if (!creditors || creditors.length === 0) return { settled: false, deposit_id: mainDeposit.id };

        let poolAvailable = Math.min(amount, Math.abs(debtorDue.due_amount) - Math.abs(debtorDue.settled_amount));
        let totalActuallySettled = 0;

        for (const creditor of creditors) {
            if (poolAvailable <= 0) break;

            const creditorOwed = creditor.due_amount - creditor.settled_amount;
            if (creditorOwed <= 0) continue;

            const settleAmount = Math.min(poolAvailable, creditorOwed);

            // 4. Create Transfer Logs (Auto-Settlements)
            // We MUST add status: 'approved' here so these transfers aren't hidden
            await supabase.from('deposits').insert([
                { 
                    cycle_id: targetCycleId, 
                    member_id: memberId, 
                    amount: -settleAmount, 
                    label: 'Auto-Settlement', 
                    notes: `Paid to ${creditor.members.name}`,
                    status: 'approved' // <--- AUTO-APPROVE
                },
                { 
                    cycle_id: targetCycleId, 
                    member_id: creditor.member_id, 
                    amount: settleAmount, 
                    label: 'Auto-Settlement', 
                    notes: `Received from ${memberObj.name}`,
                    status: 'approved' // <--- AUTO-APPROVE
                }
            ]);

            // Update Creditor Progress
            const newCreditorSettled = creditor.settled_amount + settleAmount;
            await supabase.from('cycle_dues').update({
                settled_amount: newCreditorSettled,
                status: newCreditorSettled >= creditor.due_amount ? 'settled' : 'settling',
                settled_at: newCreditorSettled >= creditor.due_amount ? new Date().toISOString() : null
            }).eq('id', creditor.id);

            poolAvailable -= settleAmount;
            totalActuallySettled += settleAmount;
        }

        // 5. Update Debtor Progress Record
        if (totalActuallySettled > 0) {
            const newDebtorSettled = Math.abs(debtorDue.settled_amount) + totalActuallySettled;
            const isFullySettled = newDebtorSettled >= Math.abs(debtorDue.due_amount);
            
            await supabase.from('cycle_dues').update({
                settled_amount: -newDebtorSettled,
                status: isFullySettled ? 'settled' : 'settling',
                settled_at: isFullySettled ? new Date().toISOString() : null
            }).eq('id', debtorDue.id);
        }

        return {
            settled: totalActuallySettled > 0,
            settled_amount: totalActuallySettled,
            deposit_id: mainDeposit.id
        };

    } catch (err) {
        console.error("Settlement Logic Crash:", err);
        throw err;
    }
}


document.getElementById('depositForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.textContent;

    const memberId = parseInt(document.getElementById('depositMember').value);
    const type = document.getElementById('depositType').value;
    const rawAmount = parseFloat(document.getElementById('depositAmount').value);
    const roundedAmount = Math.round(rawAmount); 
    const label = document.getElementById('depositLabel').value;
    const notes = document.getElementById('depositNotes').value;
    
    const finalAmount = type === 'charge' ? -Math.abs(roundedAmount) : Math.abs(roundedAmount);
    const isAdmin = (currentUser.role === 'admin' || currentUser.role === 'manager');
    const actor = currentUser.members ? currentUser.members.name : "User";

    btn.textContent = "Processing...";
    btn.disabled = true;

    try {
        const targetMember = allMembers.find(m => m.id === memberId);

        if (isAdmin) {
            let result;
            try {
                const { data, error } = await supabase.rpc('process_deposit_with_settlement', {
                    p_member_id: memberId,
                    p_cycle_id: parseInt(currentCycleId),
                    p_amount: finalAmount,
                    p_label: label,
                    p_notes: notes
                });
                if (error) throw error;
                result = data;
            } catch (rpcError) {
                result = await processDepositWithClientSideSettlement(memberId, currentCycleId, finalAmount, label, notes);
            }
            
            await logActivity(`Deposit Approved: ${formatCurrency(finalAmount)} added for ${targetMember?.name} by ${actor}`, 'deposit');
            showNotification("Transaction completed", 'success');
        } else {
            const { error } = await supabase.from('deposits').insert({
                cycle_id: parseInt(currentCycleId),
                member_id: memberId,
                amount: finalAmount,
                label: label,
                notes: notes,
                status: 'pending'
            });
            if (error) throw error;

            await logActivity(`Deposit Request: ${targetMember?.name} requested ${formatCurrency(finalAmount)} approval via ${actor}`, 'deposit');
            showNotification("Request submitted", 'info');
        }

        document.getElementById('depositAmount').value = '';
        document.getElementById('depositNotes').value = '';
        await loadDeposits();
    } catch (err) {
        showNotification(err.message, 'error');
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
});

    // ============================================
    // ADMIN PAGE
    // ============================================
    
    async function loadAdmin() {
        await loadMembersList();
    }

   document.getElementById('createCycleForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.textContent;
    const name = document.getElementById('cycleName').value;
    const startDate = document.getElementById('cycleStartDate').value;
    const endDate = document.getElementById('cycleEndDate').value;

    btn.textContent = "Creating...";
    btn.disabled = true;

    try {
        await supabase.from('cycles').update({ is_active: false }).neq('id', 0);
        const { error } = await supabase.from('cycles').insert({ name, start_date: startDate, end_date: endDate, is_active: true });
        if (error) throw error;

        const actor = currentUser.members ? currentUser.members.name : "Admin";
        await logActivity(`System: New cycle "${name}" created and activated by ${actor}`, 'other');

        document.getElementById('createCycleForm').reset();
        await loadCycles();
        showNotification('Cycle created', 'success');
    } catch (err) {
        showNotification(err.message, 'error');
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
});



    document.getElementById('addMemberForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = document.getElementById('memberName').value;

        try {
            // 1. Insert Member
            const { data: memberData, error: memberError } = await supabase
                .from('members')
                .insert({ name: name })
                .select()
                .maybeSingle();
            
            if (memberError) throw memberError;

            // 2. Automatically create User
            const defaultPass = await hashPassword("123");
            
            await supabase.from('users').insert({
                username: name,
                password: defaultPass,
                role: 'user',
                member_id: memberData.id
            });

            await logActivity(`New member added & user created: ${name}`, 'other');

            document.getElementById('addMemberForm').reset();
            await loadMembers();
            await loadMembersList();
            showNotification('Member added successfully. Default password is "123"', 'success');

        } catch (err) {
            console.error('Error adding member:', err);
            showNotification('Failed to add member', 'error');
        }
    });

  async function loadMembersList() {
    const container = document.getElementById('membersList');
    container.innerHTML = '<div class="loading">Loading members...</div>';

    try {
        // FIXED: Only fetch members. All info (role, user_id) is now in this table.
        const { data: members, error } = await supabase
            .from('members')
            .select('*')
            .order('name');
        
        if (error) throw error;

        if (!members || members.length === 0) {
            container.innerHTML = '<div class="loading">No members yet</div>';
            return;
        }

        container.innerHTML = members.map(member => {
            const isManager = member.role === 'manager';
            const isAdmin = member.role === 'admin';
            const hasLogin = member.user_id !== null;

            return `
            <div class="list-item" style="flex-wrap: wrap; gap: 10px;">
                <div class="list-item-info" style="min-width: 200px;">
                    <div class="list-item-title">
                        ${member.name} 
                        ${isAdmin ? '<span style="font-size:10px; background:#4F46E5; color:white; padding:2px 6px; border-radius:4px;">ADMIN</span>' : ''}
                        ${isManager ? '<span style="font-size:10px; background:#10B981; color:white; padding:2px 6px; border-radius:4px;">MANAGER</span>' : ''}
                    </div>
                    <div class="list-item-subtitle">
                        Status: ${hasLogin ? '<span style="color:var(--success-color)">Active User</span>' : '<span style="color:var(--warning-color)">No Login Linked</span>'}
                        <br>${member.email || ''}
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px;">
                    ${!isAdmin ? `
                    <button class="btn btn-sm ${isManager ? 'btn-secondary' : 'btn-success'}" 
                            onclick="toggleManagerRole('${member.id}', '${member.role}')">
                        ${isManager ? 'Demote' : 'Make Manager'}
                    </button>
                    ` : ''}
                    
                    <button class="btn btn-sm btn-primary" 
                            onclick="openEditMemberModal('${member.id}', '${member.name}', '')">
                        Edit
                    </button>
                </div>
            </div>
            `;
        }).join('');

    } catch (err) {
        console.error('Error loading members list:', err);
        container.innerHTML = '<div class="loading" style="color:red">Error loading list</div>';
    }
}


// --- Action 1: Toggle Manager Role ---
async function toggleManagerRole(memberId, currentRole) {
    const isManager = currentRole === 'manager';
    const newRole = isManager ? 'user' : 'manager';
    if (!confirm(`Change role to ${newRole}?`)) return;

    try {
        const { error } = await supabase.from('members').update({ role: newRole }).eq('id', memberId);
        if (error) throw error;

        const targetMember = allMembers.find(m => m.id == memberId);
        const actor = currentUser.members ? currentUser.members.name : "Admin";
        
        // LOG ROLE CHANGE
        await logActivity(`Access Control: ${targetMember.name} was ${isManager ? 'demoted to User' : 'promoted to Manager'} by ${actor}`, 'other');

        showNotification('Role updated successfully', 'success');
        await loadMembersList();
    } catch (err) {
        showNotification('Failed to update role', 'error');
    }
}

// --- Action 2: Delete Member ---
async function deleteMember(memberId, userId) {
    if (!confirm('WARNING: Deleting a member will remove their user account. If they have existing meal/deposit records, this might fail or cause data issues. Continue?')) return;

    try {
        // 1. Delete User Account first (if exists)
        if (userId) {
            const { error: uError } = await supabase.from('users').delete().eq('id', userId);
            if (uError) throw uError;
        }

        // 2. Delete Member
        const { error: mError } = await supabase.from('members').delete().eq('id', memberId);
        if (mError) {
            // If foreign key constraint fails (has meals/deposits)
            throw new Error("Cannot delete member: They likely have associated meals or deposits.");
        }

        showNotification('Member deleted successfully', 'success');
        await loadMembersList();
        await loadMembers(); // Refresh global list

    } catch (err) {
        console.error('Delete error:', err);
        showNotification(err.message, 'error');
    }
}

// --- Action 3: Edit Member (Modal & Save) ---
function openEditMemberModal(memberId, currentName, userId) {
    document.getElementById('editMemberId').value = memberId;
    document.getElementById('editUserId').value = userId;
    document.getElementById('editMemberName').value = currentName;
    document.getElementById('editMemberPassword').value = ''; // Reset password field
    document.getElementById('editMemberModal').classList.add('active');
}

document.getElementById('editMemberForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const memberId = document.getElementById('editMemberId').value;
    const userId = document.getElementById('editUserId').value;
    const newName = document.getElementById('editMemberName').value;
    const newPassword = document.getElementById('editMemberPassword').value;

    try {
        // 1. Update Member Name
        const { error: mError } = await supabase
            .from('members')
            .update({ name: newName })
            .eq('id', memberId);


               const actor = currentUser.members ? currentUser.members.name : "Admin";
        // LOG MEMBER EDIT
        await logActivity(`Member Profile: Account for "${newName}" was modified by ${actor}`, 'other');

        document.getElementById('editMemberModal').classList.remove('active');
        showNotification('Member updated successfully', 'success');
        
        if (mError) throw mError;

        // 2. Update User (Username and optionally Password)
        if (userId) {
            const userUpdates = { username: newName }; // Sync username with member name
            
            if (newPassword && newPassword.trim() !== "") {
                userUpdates.password = await hashPassword(newPassword);
            }

            const { error: uError } = await supabase
                .from('users')
                .update(userUpdates)
                .eq('id', userId);

            if (uError) throw uError;
        }

        await loadMembersList();
        await loadMembers(); // Refresh global list

    } catch (err) {
        console.error('Edit error:', err);
        showNotification('Failed to update member: ' + err.message, 'error');
    }
});


    // ============================================
    // UTILITY: LOG ACTIVITY
    // ============================================

    // Helper for whole number currency display
function formatCurrencyRound(amount) {
    return `‡ß≥${Math.round(parseFloat(amount || 0))}`;
}
    
async function logActivity(message, type = 'info') {
    if (!currentCycleId) {
        console.error("Cannot log activity: currentCycleId is missing.");
        return;
    }
    
    try {
        const { error } = await supabase
            .from('notifications')
            .insert({
                cycle_id: parseInt(currentCycleId), // Ensure it's an Integer
                message: message,
                type: type,
                member_id: currentUser?.member_id || null // NULL for system logs
            });

        if (error) throw error;
        
        // Refresh local notifications if the panel is open
        if (document.getElementById('notifPanel').classList.contains('active')) {
            loadNotifications();
        }
    } catch (err) {
        console.error('Logging Error:', err.message);
    }
}


async function triggerManualAutoEntry() {
    if (!confirm("‚ö†Ô∏è Are you sure? \n\nThis will FORCE the system to copy all 'Meal Plans' into the 'Tracker' for Today's Night and Tomorrow's Day.\n\nThis overwrites the tracker with the plans immediately.")) {
        return;
    }

    const btn = document.querySelector('button[onclick="triggerManualAutoEntry()"]');
    const originalText = btn.textContent;
    btn.textContent = "Running...";
    btn.disabled = true;

    try {
        // Call the RPC function with force_run = true
        const { error } = await supabase.rpc('handle_auto_meal_entry', { force_run: true });

        if (error) throw error;

        showNotification("‚úÖ Auto-entry forced successfully!", "success");
        await updateEntryStatusIndicator(); // <--- REFRESH BADGE IMMEDIATELY
        await loadDashboard(); // Reload logs
        await loadMasterTracker(); // Update tracker view if looking at it

    } catch (err) {
        console.error("Force Run Error", err);
        showNotification("Failed to run automation: " + err.message, "error");
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
}


// ==========================================
// ENTRY STATUS INDICATOR LOGIC
// ==========================================

async function updateEntryStatusIndicator() {
    try {
        // 1. Get the Calculated Active Date (Timezone Safe)
        const sessionDate = await getActiveSessionDate();
        
        // 2. Format for Display (e.g., "16 DEC")
        const dateLabel = sessionDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }).toUpperCase();
        
        // 3. Compare with Real Calendar Today to decide Color/Status
        const today = new Date();
        const isToday = sessionDate.getDate() === today.getDate();

        const badge = document.getElementById('entryStatusBadge');
        
        if (isToday) {
            // If Session Date is TODAY, it means auto-entry hasn't run yet.
            badge.textContent = `TARGET: ${dateLabel} BAZAR`;
            badge.className = 'entry-status-badge status-pending'; // Orange/Active
            badge.title = "Waiting for auto-entry tonight.";
        } else {
            // If Session Date is TOMORROW, it means Today is done.
            badge.textContent = `TARGET: ${dateLabel} BAZAR`;
            badge.className = 'entry-status-badge status-done'; // Green/Done
            badge.title = "Today's entry is complete. Next target is shown.";
        }

    } catch (err) {
        console.error("Status Check Error", err);
    }
}



async function loadSystemStatus() {
    const container = document.getElementById('systemStatusContent');
    const dateDisplay = document.getElementById('statusDateDisplay');
    
    // 1. Get Today's Date (Local/BD)
    const now = new Date();
    const todayStr = now.toISOString().split('T')[0];
    const niceDate = now.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' });
    
    if(dateDisplay) dateDisplay.textContent = niceDate;

    try {
        // 2. Fetch Log for Today
        const { data: log, error } = await supabase
            .from('system_logs')
            .select('*')
            .eq('log_date', todayStr)
            .maybeSingle();

        // 3. Render State
        if (log) {
            // === STATE: SUCCESS ===
            const runTime = new Date(log.executed_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            container.innerHTML = `
                <div class="status-box success">
                    <div class="status-icon">‚úÖ</div>
                    <div>
                        <div class="status-title">System Auto-Entry Completed</div>
                        <div class="status-desc">
                            The system successfully snapshotted meal plans and finalized the tracker.
                        </div>
                        <div class="status-meta">
                            LOG ID: #${log.id} ‚Ä¢ RUN TIME: ${runTime}
                        </div>
                        <div style="margin-top:5px; font-size:11px; font-style:italic;">
                            "${log.details}"
                        </div>
                    </div>
                </div>
            `;
        } else {
            // === STATE: PENDING ===
            // Get target time from our config variable
            const targetTime24 = appConfig.auto_entry_time || '18:30';
            const [h, m] = targetTime24.split(':');
            const targetTime12 = new Date(0, 0, 0, h, m).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

            container.innerHTML = `
                <div class="status-box pending">
                    <div class="status-icon">‚è≥</div>
                    <div>
                        <div class="status-title">Waiting for Auto-Entry</div>
                        <div class="status-desc">
                            System is monitoring for the scheduled time. Meal plans are still editable.
                        </div>
                        <div class="status-meta">
                            SCHEDULED TIME: ${targetTime12}
                        </div>
                    </div>
                </div>
            `;
        }

    } catch (err) {
        console.error("Status Load Error", err);
        container.innerHTML = '<div style="color:red; font-size:12px;">Failed to load status.</div>';
    }
}


function setupRobustRealtime() {
    console.log("üöÄ Starting Robust Realtime Engine...");

    const channel = supabase.channel('system-sync-' + Date.now());

    channel
        .on('postgres_changes', { event: '*', schema: 'public', table: 'notifications' }, () => {
            loadNotifications().then(() => {
                const badge = document.getElementById('notifBadge');
                badge.classList.remove('hidden');
                if (allNotifications.length > 0) {
                     showNotification(allNotifications[0].message, 'info');
                }
            });
        })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'meals' }, () => handleDataSignal('meals'))
        .on('postgres_changes', { event: '*', schema: 'public', table: 'meal_plans' }, () => handleDataSignal('plans'))
        .on('postgres_changes', { event: '*', schema: 'public', table: 'expenses' }, () => handleDataSignal('expenses'))
        .on('postgres_changes', { event: '*', schema: 'public', table: 'deposits' }, () => handleDataSignal('deposits'))
        .on('postgres_changes', { event: '*', schema: 'public', table: 'app_config' }, () => {
             loadAppConfig();
             if (!document.getElementById('profilePage').classList.contains('hidden')) {
                 loadScheduler();
             }
        })
        .subscribe((status) => {
            console.log(`üì° Realtime Status: ${status}`);
            
            // REMOVED: showNotification("Live Sync Connected", "success");
            
            if (status === 'CLOSED' || status === 'CHANNEL_ERROR') {
                console.log("Realtime disconnected. Retrying...");
                setTimeout(setupRobustRealtime, 5000); 
            }
        });
}

// Helper: Debounce refreshing to prevent flickering if multiple updates come at once
let isRefreshing = false;
let refreshTimeout;

function handleDataSignal(source) {
    if (isRefreshing) return; // Ignore signals if already busy

    if (refreshTimeout) clearTimeout(refreshTimeout);

    refreshTimeout = setTimeout(async () => {
        isRefreshing = true;
        try {
            console.log(`‚ö° Syncing UI due to ${source} update...`);
            await refreshCurrentPage();
        } finally {
            isRefreshing = false;
        }
    }, 800); // Increased to 800ms to allow DB operations to settle
}

// --- MOBILE MENU LOGIC ---
const mobileMenuBtn = document.getElementById('mobileMenuBtn');
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('sidebarOverlay'); // Make sure to add this DIV in HTML

// 1. Toggle Sidebar
mobileMenuBtn.addEventListener('click', (e) => {
    e.preventDefault();
    sidebar.classList.toggle('mobile-active');
    
    // Check if overlay exists, if not create it dynamically
    let backdrop = document.getElementById('sidebarOverlay');
    if (!backdrop) {
        backdrop = document.createElement('div');
        backdrop.id = 'sidebarOverlay';
        backdrop.className = 'sidebar-overlay';
        document.body.appendChild(backdrop);
        
        // Add click listener to new backdrop
        backdrop.addEventListener('click', () => {
            sidebar.classList.remove('mobile-active');
            backdrop.classList.remove('active');
        });
    }
    
    // Toggle Backdrop
    if (sidebar.classList.contains('mobile-active')) {
        backdrop.classList.add('active');
    } else {
        backdrop.classList.remove('active');
    }
});

// 2. Auto-close Sidebar when clicking a link
document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
            sidebar.classList.remove('mobile-active');
            const backdrop = document.getElementById('sidebarOverlay');
            if(backdrop) backdrop.classList.remove('active');
        }
    });
});



// ============================================
// CYCLE CLOSING & DUE MANAGEMENT
// ============================================
document.getElementById('closeMonthBtn').addEventListener('click', async () => {
    if (!currentCycleId) {
        showNotification("No active cycle to close", "error");
        return;
    }

    // 1. Confirm action
    if (!confirm("‚ö†Ô∏è WARNING: This will permanently close this cycle and forward balances. Continue?")) {
        return;
    }

    const btn = document.getElementById('closeMonthBtn');
    btn.textContent = "Processing...";
    btn.disabled = true;

    try {
        // 2. Get current cycle details (Use == to match string ID to number ID)
        const currentCycle = allCycles.find(c => c.id == currentCycleId);
        if (!currentCycle) throw new Error("Current cycle not found. Try refreshing.");

        // 3. Prompt for new cycle name
        const nextMonthDate = new Date(currentCycle.end_date);
        nextMonthDate.setDate(nextMonthDate.getDate() + 1);
        const monthNames = ["January", "February", "March", "April", "May", "June", 
                           "July", "August", "September", "October", "November", "December"];
        const suggestedName = `${monthNames[nextMonthDate.getMonth()]} ${nextMonthDate.getFullYear()}`;
        
        const newCycleName = prompt(`Enter new cycle name:`, suggestedName);
        
        // If user hits cancel
        if (newCycleName === null) {
            btn.textContent = "üîí Close Current Cycle & Create New";
            btn.disabled = false;
            return;
        }

        // 4. Calculate final balances
        const balances = await calculateMemberBalances(currentCycleId);
        const balancesWithDues = balances.filter(b => b.balance !== 0);

        // 5. Deactivate Current Cycle
        const { error: deactivateError } = await supabase
            .from('cycles')
            .update({ is_active: false })
            .eq('id', currentCycleId);
        if (deactivateError) throw deactivateError;

        // 6. Create New Cycle
        const startDateStr = new Date(nextMonthDate.getFullYear(), nextMonthDate.getMonth(), 1).toISOString().split('T')[0];
        const endDateStr = new Date(nextMonthDate.getFullYear(), nextMonthDate.getMonth() + 1, 0).toISOString().split('T')[0];

        const { data: newCycle, error: cycleError } = await supabase
            .from('cycles')
            .insert({
                name: newCycleName,
                start_date: startDateStr,
                end_date: endDateStr,
                is_active: true
            })
            .select().single();
        if (cycleError) throw cycleError;

        // 7. Forward Dues
        if (balancesWithDues.length > 0) {
            const dueRecords = balancesWithDues.map(b => ({
                from_cycle_id: currentCycleId,
                to_cycle_id: newCycle.id,
                member_id: b.member_id,
                due_amount: b.balance,
                status: 'pending',
                settled_amount: 0
            }));
            const { error: dueError } = await supabase.from('cycle_dues').insert(dueRecords);
            if (dueError) throw dueError;
        }

        await logActivity(`Cycle ${currentCycle.name} closed. New cycle ${newCycleName} started.`, 'other');
        showNotification("Cycle closed and dues forwarded!", "success");
        
        // Refresh app state
        location.reload(); 

    } catch (err) {
        console.error("Cycle closing error:", err);
        showNotification("Error: " + err.message, "error");
    } finally {
        btn.textContent = "üîí Close Current Cycle & Create New";
        btn.disabled = false;
    }
});



// Helper: Calculate member balances for current cycle
async function calculateMemberBalances(cycleId) {
    try {
        // Fetch data
        const { data: meals } = await supabase.from('meals').select('*').eq('cycle_id', cycleId);
      // Find this part in calculateMemberBalances(cycleId)
const { data: expenses } = await supabase
    .from('expenses')
    .select('*')
    .eq('cycle_id', cycleId)
    .eq('status', 'approved'); // <--- ADD THIS FILTER
       // Change the deposit query to:
const { data: deposits } = await supabase
    .from('deposits')
    .select('*')
    .eq('cycle_id', cycleId)
    .neq('status', 'pending'); // <--- ADD THIS FILTER

        // Calculate meal rate
        const totalExpense = expenses?.reduce((sum, e) => sum + parseFloat(e.amount), 0) || 0;
        const totalMeals = meals?.reduce((sum, m) => sum + parseFloat(m.day_count) + parseFloat(m.night_count), 0) || 0;
        const mealRate = totalMeals > 0 ? totalExpense / totalMeals : 0;

        // Calculate per-member balances
        const balances = [];
        allMembers.forEach(member => {
            const memberMeals = meals?.filter(m => m.member_id === member.id)
                .reduce((sum, m) => sum + parseFloat(m.day_count) + parseFloat(m.night_count), 0) || 0;
            
            const memberDeposits = deposits?.filter(d => d.member_id === member.id)
                .reduce((sum, d) => sum + parseFloat(d.amount), 0) || 0;

            const memberCost = memberMeals * mealRate;
            const balance = memberDeposits - memberCost;

            balances.push({
                member_id: member.id,
                member_name: member.name,
                balance: parseFloat(balance.toFixed(2))
            });
        });

        return balances;

    } catch (err) {
        console.error("Balance calculation error:", err);
        throw err;
    }
}

// ============================================
// DUE SETTLEMENT UI
// ============================================

async function loadDueSettlement() {
    console.log("üîç Loading due settlement for cycle:", currentCycleId);
    
    if (!currentCycleId) {
        console.warn("No cycle ID, skipping due settlement");
        return;
    }

    try {
        // Fetch dues for current cycle
        const { data: dues, error } = await supabase
            .from('cycle_dues')
            .select('*, members(name), from_cycle:cycles!cycle_dues_from_cycle_id_fkey(name)')
            .eq('to_cycle_id', currentCycleId)
            .order('due_amount', { ascending: true });

        console.log("üìä Dues data received:", dues);

        if (error) {
            console.error("‚ùå Error fetching dues:", error);
            throw error;
        }

        const card = document.getElementById('dueSettlementCard');
        
        if (!card) {
            console.error("‚ùå dueSettlementCard element not found in DOM!");
            return;
        }

        // Filter out fully settled
        const activeDues = dues?.filter(d => d.status !== 'settled') || [];

        // Show/hide card
        if (activeDues.length === 0) {
            console.log("‚úÖ No active dues found, hiding card");
            card.style.display = 'none';
            return;
        }

        console.log(`‚úÖ Found ${activeDues.length} active dues, showing card`);
        card.style.display = 'block';

        // Separate debtors and creditors
        const debtors = activeDues.filter(d => d.due_amount < 0);
        const creditors = activeDues.filter(d => d.due_amount > 0);

        console.log(`üìâ Debtors: ${debtors.length}, üìà Creditors: ${creditors.length}`);

        // Render Debtors
        const debtorsList = document.getElementById('debtorsList');
        if (debtors.length === 0) {
            debtorsList.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary);">No outstanding debts üéâ</div>';
        } else {
            debtorsList.innerHTML = debtors.map(d => renderDueItem(d, 'debtor')).join('');
        }

        // Render Creditors
        const creditorsList = document.getElementById('creditorsList');
        if (creditors.length === 0) {
            creditorsList.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-secondary);">No pending credits</div>';
        } else {
            creditorsList.innerHTML = creditors.map(d => renderDueItem(d, 'creditor')).join('');
        }

    } catch (err) {
        console.error("‚ùå Due settlement load error:", err);
        showNotification("Failed to load due settlement: " + err.message, "error");
    }
}

function renderDueItem(due, type) {
    const absAmount = Math.abs(due.due_amount);
    const settled = Math.abs(due.settled_amount);
    const remaining = absAmount - settled;
    const progress = (settled / absAmount) * 100;

    const statusClass = due.status === 'pending' ? 'due-status-pending' : 
                       due.status === 'settling' ? 'due-status-settling' : 
                       'due-status-settled';

    return `
    <div class="due-item ${type}">
        <div class="due-item-header">
            <div class="due-item-name">${due.members.name}</div>
            <div class="due-item-amount ${type === 'debtor' ? 'balance-negative' : 'balance-positive'}">
                ${formatCurrency(remaining)}
            </div>
        </div>
        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 5px;">
            From: ${due.from_cycle.name} 
            <span class="due-status-badge ${statusClass}">${due.status}</span>
        </div>
        <div class="due-progress-bar">
            <div class="due-progress-fill" style="width: ${progress}%"></div>
        </div>
        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px;">
            Settled: ${formatCurrency(settled)} / ${formatCurrency(absAmount)} (${progress.toFixed(0)}%)
        </div>
    </div>
    `;
}

// Update loadSummary to include due settlement
const originalLoadSummary = loadSummary;
loadSummary = async function() {
    await originalLoadSummary();
    await loadDueSettlement();
};


</script>
</body>
</html>
